<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virely Ops - Advanced Business Intelligence Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #0f1420;
            --bg-tertiary: #141b2e;
            --bg-glass: rgba(255,255,255,0.03);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #6ee7b7;
            --accent-secondary: #7c5cff;
            --accent-tertiary: #60a5fa;
            --accent-gold: #fbbf24;
            --danger: #ff6b6b;
            --warning: #ffb86b;
            --success: #4ade80;
            --glass-border: rgba(255,255,255,0.08);
            --glow-accent: 0 0 32px rgba(110,231,183,0.3);
            --glow-secondary: 0 0 32px rgba(124,92,255,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #050810 50%, #0a0e1a 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(110,231,183,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(124,92,255,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(96,165,250,0.05) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            border-radius: 4px;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .sidebar {
            width: 260px;
            background: rgba(15, 20, 32, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 24px;
        }

        .virely-logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .virely-logo-box {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #4a90e2, #2e5f8f);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.3),
                0 4px 12px rgba(74,144,226,0.4);
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: rgba(255,255,255,0.4);
            border-left-color: rgba(255,255,255,0.3);
            border-bottom-color: rgba(0,0,0,0.2);
            border-right-color: rgba(0,0,0,0.15);
            position: relative;
        }

        .virely-logo-box::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3), transparent);
            border-radius: 6px 6px 0 0;
        }

        .virely-v {
            font-size: 32px;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                0 -1px 1px rgba(255,255,255,0.2);
            font-family: 'Inter', sans-serif;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }

        .virely-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .virely-brand {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            line-height: 1;
        }

        .virely-tagline {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .nav-menu {
            padding: 0 12px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-item:hover {
            background: var(--bg-glass);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1));
            color: var(--accent-primary);
            box-shadow: var(--glow-accent);
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
            pointer-events: none;
        }
        
        .nav-item > span {
            pointer-events: none;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            margin-right: 420px;
            padding: 32px;
            position: relative;
            transition: margin-right 0.3s ease;
        }

        .ai-insights-sidebar {
            width: 420px;
            background: rgba(15, 20, 32, 0.8);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            padding: 24px;
            position: fixed;
            right: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 99;
            box-shadow: var(--shadow-lg);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .ai-insights-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .summary-tile {
            background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.4));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .summary-tile:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(110,231,183,0.2);
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6));
        }

        .summary-icon {
            font-size: 28px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-glass);
            border-radius: 10px;
            flex-shrink: 0;
        }

        .summary-content {
            flex: 1;
            min-width: 0;
        }

        .summary-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 2px;
        }

        .summary-detail {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .ai-insight-card {
            background: linear-gradient(135deg, rgba(20,27,46,0.5), rgba(10,14,26,0.3));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .ai-insight-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-accent);
            border-color: var(--accent-primary);
        }

        .ai-insight-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .ai-insight-label {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .ai-insight-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .ai-insight-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .ai-insight-trend {
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .trend-positive {
            background: rgba(110,231,183,0.15);
            color: var(--accent-primary);
        }

        .trend-negative {
            background: rgba(255,107,107,0.15);
            color: var(--danger);
        }

        .ai-recommendation {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-glass);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--glass-border);
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .greeting-message {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-primary);
            letter-spacing: -0.3px;
            margin-bottom: 4px;
        }

        .system-time {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header h2 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            min-width: 48px;
            min-height: 48px;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4), inset 0 -3px 8px rgba(0,0,0,0.3), inset 0 2px 6px rgba(255,255,255,0.15);
            white-space: nowrap;
        }
        
        /* Icon-only buttons (exactly 48px x 48px) */
        .btn.icon-only {
            width: 48px;
            height: 48px;
            padding: 0;
            min-width: 48px;
            min-height: 48px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: 12px 12px 0 0;
            pointer-events: none;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
            transition: width 0s, height 0s;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 -2px 6px rgba(0,0,0,0.3), inset 0 1px 4px rgba(255,255,255,0.1);
        }

        .btn-primary {
            /* Inherit base button styles */
            min-width: 48px;
            min-height: 48px;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            /* Enhanced primary button styles */
            background: linear-gradient(145deg, #6ee7b7 0%, #34d399 50%, #10b981 100%);
            color: #0a0e1a;
            text-shadow: 0 1px 2px rgba(255,255,255,0.4);
            box-shadow: 
                0 6px 20px rgba(110,231,183,0.35),
                inset 0 2px 6px rgba(255,255,255,0.3),
                inset 0 -3px 8px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,255,255,0.2);
            border-top: 1px solid rgba(255,255,255,0.4);
            border-left: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(0,0,0,0.2);
            border-right: 1px solid rgba(0,0,0,0.15);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 2px;
            right: 2px;
            height: 45%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            border-radius: 10px 10px 0 0;
            pointer-events: none;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            background: linear-gradient(145deg, #86efac 0%, #4ade80 50%, #22c55e 100%);
            box-shadow: 
                0 8px 28px rgba(110,231,183,0.6), 
                0 0 0 3px rgba(110,231,183,0.3), 
                inset 0 2px 8px rgba(255,255,255,0.35), 
                inset 0 -3px 10px rgba(0,0,0,0.2);
        }

        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 
                0 3px 12px rgba(110,231,183,0.3), 
                inset 0 3px 12px rgba(0,0,0,0.4), 
                inset 0 -1px 4px rgba(255,255,255,0.15);
        }

        .btn-secondary {
            /* Inherit base button styles */
            min-width: 48px;
            min-height: 48px;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            /* Enhanced secondary button styles */
            background: linear-gradient(145deg, #475569 0%, #334155 50%, #1e293b 100%);
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            box-shadow: 
                0 5px 16px rgba(0,0,0,0.4),
                inset 0 2px 6px rgba(255,255,255,0.12),
                inset 0 -3px 8px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-left: 1px solid rgba(255,255,255,0.15);
            border-bottom: 1px solid rgba(0,0,0,0.3);
            border-right: 1px solid rgba(0,0,0,0.25);
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 2px;
            right: 2px;
            height: 45%;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 100%);
            border-radius: 10px 10px 0 0;
            pointer-events: none;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #64748b 0%, #475569 50%, #334155 100%);
            box-shadow: 
                0 7px 24px rgba(110,231,183,0.3), 
                0 0 0 2px rgba(110,231,183,0.2), 
                inset 0 2px 8px rgba(255,255,255,0.15), 
                inset 0 -3px 10px rgba(0,0,0,0.3);
            transform: translateY(-3px);
        }

        .btn-secondary:active {
            transform: translateY(0px);
            box-shadow: 
                0 3px 12px rgba(0,0,0,0.4), 
                inset 0 3px 12px rgba(0,0,0,0.5), 
                inset 0 -1px 4px rgba(255,255,255,0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        /* Dark gray inputs and selects for better visibility */
        select, 
        input[type="text"], 
        input[type="email"], 
        input[type="tel"], 
        input[type="number"], 
        input[type="date"], 
        input[type="time"],
        input[type="password"],
        .search-box {
            min-height: 48px;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 10px;
            background: #1e293b !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--glass-border) !important;
            transition: all 0.3s ease;
        }
        
        textarea {
            min-height: 96px;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 10px;
            background: #1e293b !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--glass-border) !important;
            transition: all 0.3s ease;
            resize: vertical;
        }

        select:focus, 
        input:focus, 
        textarea:focus,
        .search-box:focus {
            background: #2d3748 !important;
            border-color: var(--accent-primary) !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(110,231,183,0.1);
        }

        select option {
            background: #1e293b;
            color: var(--text-primary);
        }

        /* Greeting Section */
        .greeting-section {
            background: linear-gradient(135deg, rgba(110,231,183,0.08), rgba(124,92,255,0.08));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .greeting-content h2 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .greeting-content p {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .time-display {
            text-align: right;
        }

        .current-time {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            margin-bottom: 4px;
        }

        .current-date {
            font-size: 14px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.4));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card::after {
            content: 'â†’';
            position: absolute;
            bottom: 16px;
            right: 16px;
            font-size: 20px;
            color: var(--accent-primary);
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover::after {
            opacity: 1;
            transform: translateX(0);
        }

        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 16px 48px rgba(110, 231, 183, 0.25), 0 0 0 1px rgba(110, 231, 183, 0.2);
            border-color: rgba(110, 231, 183, 0.4);
            background: linear-gradient(135deg, rgba(30,37,56,0.8), rgba(15,19,36,0.6));
        }

        .stat-card:active {
            transform: translateY(-4px) scale(0.98);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 13px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(110,231,183,0.15);
            color: var(--accent-primary);
        }

        .stat-change.negative {
            background: rgba(255,107,107,0.15);
            color: var(--danger);
        }

        .stat-change.warning {
            background: rgba(255,184,107,0.15);
            color: var(--warning);
        }

        .card {
            background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.4));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        th {
            background: var(--bg-glass);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        td {
            font-size: 14px;
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg-glass);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success { background: rgba(110,231,183,0.2); color: var(--accent-primary); }
        .badge-warning { background: rgba(255,184,107,0.2); color: var(--warning); }
        .badge-danger { background: rgba(255,107,107,0.2); color: var(--danger); }
        .badge-info { background: rgba(96,165,250,0.2); color: var(--accent-tertiary); }
        .badge-secondary { background: rgba(148,163,184,0.2); color: var(--text-secondary); }

        .action-btn {
            min-height: 48px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn.edit {
            background: rgba(96,165,250,0.2);
            color: var(--accent-tertiary);
        }

        .action-btn.delete {
            background: rgba(255,107,107,0.2);
            color: var(--danger);
        }

        .action-btn.view {
            background: rgba(110,231,183,0.2);
            color: var(--accent-primary);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgba(20,27,46,0.98), rgba(10,14,26,0.95));
            border: 1px solid rgba(110,231,183,0.2);
            border-radius: 20px;
            padding: 32px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(110,231,183,0.1);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                max-height: 500px;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                max-height: 500px;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                max-height: 0;
                transform: translateY(-20px);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid rgba(110,231,183,0.2);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(110,231,183,0.15);
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
        }

        .form-input:hover, .form-select:hover, .form-textarea:hover {
            border-color: rgba(110,231,183,0.4);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Enhanced input containers for modals and forms */
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="date"],
        input[type="time"],
        input[type="tel"],
        select,
        textarea {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
        }

        /* Checkbox and radio styling */
        input[type="checkbox"],
        input[type="radio"] {
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .data-item {
            padding: 16px;
            background: var(--bg-glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
        }

        .data-item-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .data-item-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-muted);
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .kanban-column {
            background: var(--bg-glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .kanban-title {
            font-size: 16px;
            font-weight: 700;
        }

        .kanban-count {
            background: rgba(110,231,183,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .task-card {
            background: linear-gradient(135deg, rgba(20,27,46,0.9), rgba(10,14,26,0.8));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(110,231,183,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: var(--bg-glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            padding: 8px;
        }

        .calendar-day:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            transform: scale(1.05);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            font-weight: 700;
        }

        .calendar-day.has-events {
            border: 2px solid var(--accent-primary);
            background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05));
        }

        .priority-high {
            background: rgba(255,107,107,0.2);
            color: var(--danger);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .priority-medium {
            background: rgba(255,184,107,0.2);
            color: var(--warning);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .priority-low {
            background: rgba(96,165,250,0.2);
            color: var(--accent-tertiary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .team-card {
            background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.4));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glow-accent);
            border-color: var(--accent-primary);
        }

        .team-avatar {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .team-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .team-role {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        @media (max-width: 1400px) {
            .ai-insights-sidebar {
                width: 360px;
            }
            .main-content {
                margin-right: 360px;
            }
            .calendar-grid {
                gap: 6px;
            }
            .calendar-day {
                font-size: 13px;
                min-height: 70px;
            }
        }

        @media (max-width: 1200px) {
            .ai-insights-sidebar {
                display: none;
            }
            .main-content {
                margin-right: 0;
            }
            .calendar-grid {
                gap: 8px;
            }
            .calendar-day {
                font-size: 14px;
                min-height: 80px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="logo">
                <div class="virely-logo-container">
                    <div class="virely-logo-box">
                        <div class="virely-v">V</div>
                    </div>
                    <div class="virely-text">
                        <div class="virely-brand">Virely</div>
                        <div class="virely-tagline">SaaS Marketing Technologies</div>
                    </div>
                </div>
                <div class="logo-subtitle">Business Intelligence</div>
            </div>
            <nav class="nav-menu" id="navMenu"></nav>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <h2 id="pageTitle">Dashboard</h2>
                    <p class="header-subtitle">Last updated: <span id="lastUpdated">--:--</span></p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="handleAdd()">âž• Add New</button>
                    <button class="btn btn-primary" onclick="saveData()">ðŸ’¾ Save</button>
                </div>
            </div>
            <div id="mainContent"></div>
        </div>

        <div class="ai-insights-sidebar">
            <div class="ai-insights-header">
                <div class="ai-insights-title">ðŸ“Š Business Summary</div>
            </div>
            <div id="summaryTiles" style="margin-bottom: 24px;"></div>
            
            <div class="ai-insights-header" style="margin-top: 24px;">
                <div class="ai-insights-title">ðŸ¤– AI Insights</div>
            </div>
            <div id="aiInsightsPanels"></div>
        </div>

        <div class="modal-overlay" id="modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Modal Title</h3>
                    <span class="modal-close" onclick="closeModal()">Ã—</span>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Input Masking Functions with Smart Logic
        function applyPhoneMask(input) {
            // Store cursor position
            const cursorPos = input.selectionStart;
            let value = input.value.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (value.length > 10) {
                value = value.slice(0, 10);
            }
            
            // Format as (XXX) XXX-XXXX
            let formatted = '';
            if (value.length >= 6) {
                formatted = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                formatted = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                formatted = `(${value})`;
            }
            
            input.value = formatted;
            
            // Restore cursor position intelligently
            if (cursorPos) {
                const newCursorPos = Math.min(cursorPos + (formatted.length - value.length), formatted.length);
                input.setSelectionRange(newCursorPos, newCursorPos);
            }
        }

        function applyEmailValidation(input) {
            let value = input.value.trim().toLowerCase();
            
            // Remove multiple spaces and invalid characters
            value = value.replace(/\s+/g, '').replace(/[^a-z0-9@._-]/g, '');
            input.value = value;
            
            // Enhanced email validation pattern
            const emailPattern = /^[a-z0-9][a-z0-9._-]*@[a-z0-9][a-z0-9.-]*\.[a-z]{2,}$/;
            
            if (value && !emailPattern.test(value)) {
                input.setCustomValidity('Please enter a valid email address (e.g., user@example.com)');
                input.style.borderColor = 'var(--danger)';
            } else {
                input.setCustomValidity('');
                input.style.borderColor = '';
            }
        }

        function initializeInputMasks() {
            // Apply to all phone inputs
            document.querySelectorAll('input[type="tel"], input[name*="phone"], input[id*="phone"], input[placeholder*="phone" i]').forEach(input => {
                // Remove existing listeners to prevent duplicates
                input.removeEventListener('input', handlePhoneInput);
                input.removeEventListener('keypress', handlePhoneKeypress);
                input.removeEventListener('paste', handlePhonePaste);
                
                // Add event listeners
                input.addEventListener('input', handlePhoneInput);
                input.addEventListener('keypress', handlePhoneKeypress);
                input.addEventListener('paste', handlePhonePaste);
                
                // Apply mask to existing value
                if (input.value) {
                    applyPhoneMask(input);
                }
            });
            
            // Apply to all email inputs
            document.querySelectorAll('input[type="email"], input[name*="email"], input[id*="email"], input[placeholder*="email" i]').forEach(input => {
                // Remove existing listeners
                input.removeEventListener('blur', handleEmailBlur);
                input.removeEventListener('input', handleEmailInput);
                
                // Add event listeners
                input.addEventListener('blur', handleEmailBlur);
                input.addEventListener('input', handleEmailInput);
                
                // Normalize existing value
                if (input.value) {
                    input.value = input.value.trim().toLowerCase();
                }
            });
        }

        // Event handler functions for better management
        function handlePhoneInput(e) {
            applyPhoneMask(this);
        }

        function handlePhoneKeypress(e) {
            // Only allow numbers and control keys
            const char = e.key;
            const controlKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (!/\d/.test(char) && !controlKeys.includes(char)) {
                e.preventDefault();
            }
        }

        function handlePhonePaste(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const digitsOnly = pastedText.replace(/\D/g, '');
            this.value = digitsOnly;
            applyPhoneMask(this);
        }

        function handleEmailBlur(e) {
            applyEmailValidation(this);
        }

        function handleEmailInput(e) {
            // Real-time formatting
            let value = this.value.trim().toLowerCase();
            // Remove spaces as user types
            value = value.replace(/\s+/g, '');
            this.value = value;
            // Clear error state while typing
            this.style.borderColor = '';
        }

        // MutationObserver to watch for dynamically added inputs
        function initInputMaskObserver() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        // Re-initialize masks when new nodes are added
                        setTimeout(initializeInputMasks, 100);
                    }
                });
            });

            // Observe the main content area for changes
            const mainContent = document.getElementById('mainContent');
            const modalContainer = document.getElementById('modal');
            
            if (mainContent) {
                observer.observe(mainContent, {
                    childList: true,
                    subtree: true
                });
            }
            
            if (modalContainer) {
                observer.observe(modalContainer, {
                    childList: true,
                    subtree: true
                });
            }
        }

        // Application State
        const appState = {
            currentSection: 'dashboard',
            hasShownDashboardGuidance: false,
            data: {
                transactions: [],
                divisions: [],
                contacts: [],
                campaigns: [],
                vendors: [],
                tasks: [],
                notes: [],
                team: [],
                events: [],
                deals: [],
                invoices: [],
                alerts: [],
                recentActivity: [], // Track all platform activities
                mrr: { current: 284750, growth: 12.4, target: 300000 },
                subscriptions: { active: 1847, growth: 8.3, churned: 23 },
                customers: { total: 3245, new: 187, churned: 23, churn_rate: 2.8 },
                revenue: { monthly: 284750, yearly: 3417000, forecast: 4200000 },
                cashflow: { incoming: 284750, outgoing: 42300, net: 242450, runway: 18.5 },
                budget: { monthly: 50000, spent: 42300, remaining: 7700 },
                strategicPlanning: {
                    businessUnits: [],
                    documents: [],
                    businessModelCanvas: {
                        keyPartners: '',
                        keyActivities: '',
                        keyResources: '',
                        valuePropositions: '',
                        customerRelationships: '',
                        channels: '',
                        customerSegments: '',
                        costStructure: '',
                        revenueStreams: ''
                    },
                    swotAnalysis: {
                        strengths: [],
                        weaknesses: [],
                        opportunities: [],
                        threats: []
                    },
                    goals: [],
                    kpis: []
                },
                apiKeys: [],
                webhooks: [],
                developerMode: false
            }
        };

        function initializeDefaultData() {
            appState.data.transactions = [
                { id: 1, date: '2025-11-15', description: 'AWS Infrastructure', amount: -1250, category: 'Infrastructure', vendor: 'AWS', recurring: true },
                { id: 2, date: '2025-11-14', description: 'Google Ads Campaign', amount: -5600, category: 'Marketing', vendor: 'Google', recurring: false },
                { id: 3, date: '2025-11-13', description: 'Customer Subscriptions', amount: 125000, category: 'Revenue', vendor: '', recurring: true },
                { id: 4, date: '2025-11-12', description: 'Stripe Processing Fees', amount: -3750, category: 'Processing', vendor: 'Stripe', recurring: true }
            ];

            appState.data.divisions = [
                { id: 1, name: 'Referrals', fullName: 'Dealsby.io', type: 'Product', revenue: 145000, expenses: 23000, employees: 12, status: 'Active', growth: 18.2, description: 'Referral marketing platform', mrr: 48333, customers: 856, mission: 'Transform word-of-mouth into measurable marketing ROI', vision: 'Become the leading referral marketing platform for SMBs worldwide', valueProposition: 'Turn your customers into your best marketers with automated referral tracking and rewards' },
                { id: 2, name: 'Appointments', fullName: 'Dealsby Appointments', type: 'Product', revenue: 89000, expenses: 15000, employees: 8, status: 'Active', growth: 12.5, description: 'Scheduling software', mrr: 29667, customers: 524, mission: 'Simplify appointment scheduling for service-based businesses', vision: 'Be the go-to scheduling solution for professionals across all industries', valueProposition: 'Reduce no-shows and administrative work with intelligent scheduling automation' },
                { id: 3, name: 'Reservations', fullName: 'Dealsby Reservations', type: 'Product', revenue: 51000, expenses: 12000, employees: 6, status: 'Active', growth: 24.8, description: 'Hospitality booking system', mrr: 17000, customers: 467, mission: 'Revolutionize how restaurants and venues manage reservations', vision: 'Power the reservation systems for hospitality businesses globally', valueProposition: 'Maximize table utilization and guest satisfaction with smart reservation management' },
                { id: 4, name: 'Growth Suite', fullName: 'Virely Growth Suite', type: 'Product', revenue: 285000, expenses: 50000, employees: 26, status: 'Active', growth: 35.6, description: 'Integrated marketing technology platform', mrr: 95000, customers: 1847 }
            ];

            appState.data.vendors = [
                { id: 1, name: 'AWS', type: 'Infrastructure', contact: 'support@aws.com', cost: 1250, contract: 'Monthly', renewal: '2026-01-01', status: 'Active' },
                { id: 2, name: 'Stripe', type: 'Payments', contact: 'support@stripe.com', cost: 3750, contract: 'Transaction %', renewal: 'Ongoing', status: 'Active' }
            ];

            appState.data.contacts = [
                { 
                    id: 1, 
                    name: 'John Smith', 
                    company: 'Tech Corp', 
                    email: 'john@techcorp.com', 
                    phone: '555-0101', 
                    status: 'Lead', 
                    value: 25000, 
                    source: 'Website', 
                    lastContact: '2025-11-15',
                    title: 'VP of Technology',
                    address: '123 Main St, San Francisco, CA 94105',
                    website: 'www.techcorp.com',
                    linkedin: 'linkedin.com/in/johnsmith',
                    twitter: '@johnsmith',
                    birthday: '1985-06-15',
                    industry: 'Technology',
                    tags: ['Enterprise', 'High Priority', 'Technical'],
                    notes: 'Interested in our enterprise solution. Previous conversation about API integration.',
                    timezone: 'PST',
                    preferredContact: 'Email'
                },
                { 
                    id: 2, 
                    name: 'Sarah Johnson', 
                    company: 'Design Studios', 
                    email: 'sarah@design.com', 
                    phone: '555-0102', 
                    status: 'Customer', 
                    value: 45000, 
                    source: 'Referral', 
                    lastContact: '2025-11-14',
                    title: 'Creative Director',
                    address: '456 Oak Ave, Austin, TX 78701',
                    website: 'www.designstudios.com',
                    linkedin: 'linkedin.com/in/sarahjohnson',
                    twitter: '@sarahdesigns',
                    birthday: '1988-03-22',
                    industry: 'Design',
                    tags: ['Customer', 'Referral Partner', 'Design Agency'],
                    notes: 'Current customer on Growth Plan. Referred 3 new clients last quarter.',
                    timezone: 'CST',
                    preferredContact: 'Phone'
                }
            ];

            appState.data.campaigns = [
                { id: 1, name: 'Q4 Google Ads', budget: 15000, spent: 8900, leads: 234, conversions: 45, roi: 3.2, status: 'Active', channel: 'Paid Search' },
                { id: 2, name: 'LinkedIn B2B', budget: 8000, spent: 5200, leads: 89, conversions: 23, roi: 2.8, status: 'Active', channel: 'Social Media' }
            ];

            appState.data.marketingChannels = [
                { id: 1, name: 'Facebook Ads', icon: 'ðŸ“˜', budget: 5000, spent: 3200, leads: 145, conversions: 28, roi: 2.4, cpl: 35, status: 'Active', enabled: true, loginUrl: 'https://business.facebook.com/adsmanager', impressions: 45000, clicks: 1240, ctr: 2.76 },
                { id: 2, name: 'Instagram Ads', icon: 'ðŸ“¸', budget: 4000, spent: 2800, leads: 112, conversions: 22, roi: 2.6, cpl: 36, status: 'Active', enabled: true, loginUrl: 'https://business.facebook.com/adsmanager', impressions: 38000, clicks: 980, ctr: 2.58 },
                { id: 3, name: 'Google Ads', icon: 'ðŸ”', budget: 15000, spent: 8900, leads: 234, conversions: 45, roi: 3.2, cpl: 38, status: 'Active', enabled: true, loginUrl: 'https://ads.google.com', impressions: 120000, clicks: 3400, ctr: 2.83 },
                { id: 4, name: 'LinkedIn Ads', icon: 'ðŸ’¼', budget: 8000, spent: 5200, leads: 89, conversions: 23, roi: 2.8, cpl: 58, status: 'Active', enabled: true, loginUrl: 'https://www.linkedin.com/campaignmanager', impressions: 28000, clicks: 750, ctr: 2.68 },
                { id: 5, name: 'Twitter/X Ads', icon: 'ðŸ¦', budget: 3000, spent: 1800, leads: 67, conversions: 12, roi: 2.1, cpl: 27, status: 'Active', enabled: true, loginUrl: 'https://ads.twitter.com', impressions: 25000, clicks: 890, ctr: 3.56 },
                { id: 6, name: 'TikTok Ads', icon: 'ðŸŽµ', budget: 6000, spent: 3500, leads: 189, conversions: 31, roi: 2.9, cpl: 19, status: 'Active', enabled: true, loginUrl: 'https://ads.tiktok.com', impressions: 95000, clicks: 2450, ctr: 2.58 }
            ];

            appState.data.tasks = [
                { id: 1, title: 'Q4 Marketing Launch', description: 'Launch Q4 campaign', status: 'In Progress', priority: 'High', assignee: 'Emily Rodriguez', dueDate: '2025-11-30', progress: 65 },
                { id: 2, title: 'API v2 Integration', description: 'Complete API integration', status: 'To Do', priority: 'High', assignee: 'Mike Chen', dueDate: '2025-12-15', progress: 0 }
            ];

            appState.data.notes = [
                { id: 1, title: 'Product Roadmap Q1 2026', content: 'Key features: API v2, Mobile app, Analytics', date: '2025-11-15', category: 'Product', author: 'CEO' },
                { id: 2, title: 'Team Meeting Notes', content: 'Discussed hiring for Q1, reviewed targets', date: '2025-11-14', category: 'Team', author: 'HR' }
            ];

            appState.data.team = [
                { 
                    id: 1, name: 'Sarah Johnson', role: 'CEO', email: 'sarah@virely.com', phone: '555-1001', 
                    department: 'Executive', status: 'Active', avatar: 'ðŸ‘©â€ðŸ’¼',
                    hireDate: '2020-01-15', location: 'San Francisco, CA', salary: 185000,
                    skills: ['Leadership', 'Strategy', 'Business Development', 'Fundraising'],
                    projects: ['Q4 Planning', 'Series B Fundraising', 'Product Vision 2026'],
                    performance: 95, tasksCompleted: 156, reportsTo: null,
                    linkedin: 'linkedin.com/in/sarahjohnson', github: null,
                    certifications: ['MBA Stanford', 'Six Sigma Black Belt'],
                    languages: ['English', 'Spanish'], timezone: 'PST',
                    yearsExperience: 15, previousCompany: 'Tech Giants Inc'
                },
                { 
                    id: 2, name: 'Mike Chen', role: 'CTO', email: 'mike@virely.com', phone: '555-1002', 
                    department: 'Technology', status: 'Active', avatar: 'ðŸ‘¨â€ðŸ’»',
                    hireDate: '2020-03-20', location: 'Seattle, WA', salary: 175000,
                    skills: ['Full Stack Development', 'Cloud Architecture', 'AI/ML', 'DevOps'],
                    projects: ['API v2 Development', 'Infrastructure Scaling', 'Security Audit'],
                    performance: 92, tasksCompleted: 243, reportsTo: 1,
                    linkedin: 'linkedin.com/in/mikechen', github: 'github.com/mikechen',
                    certifications: ['AWS Solutions Architect', 'Google Cloud Professional'],
                    languages: ['English', 'Mandarin'], timezone: 'PST',
                    yearsExperience: 12, previousCompany: 'Amazon Web Services'
                },
                { 
                    id: 3, name: 'Emily Rodriguez', role: 'VP Marketing', email: 'emily@virely.com', phone: '555-1003', 
                    department: 'Marketing', status: 'Active', avatar: 'ðŸ‘©â€ðŸŽ¨',
                    hireDate: '2021-06-10', location: 'Austin, TX', salary: 145000,
                    skills: ['Digital Marketing', 'Content Strategy', 'SEO/SEM', 'Analytics'],
                    projects: ['Q4 Campaign Launch', 'Brand Refresh', 'Marketing Automation'],
                    performance: 89, tasksCompleted: 178, reportsTo: 1,
                    linkedin: 'linkedin.com/in/emilyrodriguez', github: null,
                    certifications: ['Google Analytics', 'HubSpot Marketing', 'Facebook Blueprint'],
                    languages: ['English', 'Spanish'], timezone: 'CST',
                    yearsExperience: 9, previousCompany: 'Digital Marketing Pro'
                },
                { 
                    id: 4, name: 'James Wilson', role: 'Senior Developer', email: 'james@virely.com', phone: '555-1004', 
                    department: 'Technology', status: 'Active', avatar: 'ðŸ‘¨â€ðŸ’¼',
                    hireDate: '2021-09-15', location: 'Remote - NYC', salary: 135000,
                    skills: ['React', 'Node.js', 'Python', 'Database Design'],
                    projects: ['Frontend Redesign', 'API Integration', 'Performance Optimization'],
                    performance: 91, tasksCompleted: 312, reportsTo: 2,
                    linkedin: 'linkedin.com/in/jameswilson', github: 'github.com/jwilson',
                    certifications: ['MongoDB Certified Developer', 'React Professional'],
                    languages: ['English'], timezone: 'EST',
                    yearsExperience: 7, previousCompany: 'StartupXYZ'
                },
                { 
                    id: 5, name: 'Lisa Martinez', role: 'Head of Sales', email: 'lisa@virely.com', phone: '555-1005', 
                    department: 'Sales', status: 'Active', avatar: 'ðŸ‘©â€ðŸ’¼',
                    hireDate: '2022-02-01', location: 'Chicago, IL', salary: 155000,
                    skills: ['B2B Sales', 'Enterprise Deals', 'CRM Management', 'Team Leadership'],
                    projects: ['Enterprise Pipeline Growth', 'Sales Process Optimization', 'Team Expansion'],
                    performance: 94, tasksCompleted: 187, reportsTo: 1,
                    linkedin: 'linkedin.com/in/lisamartinez', github: null,
                    certifications: ['Salesforce Admin', 'Strategic Selling'],
                    languages: ['English', 'Spanish'], timezone: 'CST',
                    yearsExperience: 11, previousCompany: 'SaaS Solutions Corp'
                }
            ];

            appState.data.events = [
                { id: 1, title: 'Q4 Planning Meeting', date: '2025-11-25', time: '10:00 AM', type: 'Meeting', attendees: ['Sarah', 'Mike'], location: 'Conference Room A' },
                { id: 2, title: 'Product Launch', date: '2025-12-01', time: '2:00 PM', type: 'Event', attendees: ['All'], location: 'Online' }
            ];

            appState.data.deals = [
                { id: 1, name: 'Enterprise Plan - Tech Corp', value: 125000, stage: 'Proposal', probability: 75, contact: 'John Smith', closeDate: '2025-12-15', source: 'Website' },
                { id: 2, name: 'Growth Plan - Design Studios', value: 45000, stage: 'Negotiation', probability: 60, contact: 'Sarah Johnson', closeDate: '2025-11-30', source: 'Referral' }
            ];

            appState.data.invoices = [
                { id: 1, number: 'INV-1001', customer: 'Tech Corp', amount: 12500, dueDate: '2025-12-01', status: 'Pending', items: ['Monthly Subscription'], issued: '2025-11-01' },
                { id: 2, number: 'INV-1002', customer: 'Design Studios', amount: 4500, dueDate: '2025-11-25', status: 'Paid', items: ['Growth Plan'], issued: '2025-10-25' }
            ];

            appState.data.alerts = [
                { id: 1, type: 'warning', title: 'High CAC Alert', message: 'Customer acquisition cost increased 15%', priority: 'High', date: '2025-11-18', read: false, enabled: true },
                { id: 2, type: 'success', title: 'Revenue Target Met', message: 'Monthly revenue target exceeded', priority: 'Low', date: '2025-11-17', read: false, enabled: true },
                { id: 3, type: 'danger', title: 'Low Cash Flow Warning', message: 'Cash reserves below 30-day threshold', priority: 'Critical', date: '2025-11-18', read: false, enabled: true },
                { id: 4, type: 'info', title: 'New Lead Notification', message: '5 new leads added today', priority: 'Medium', date: '2025-11-18', read: false, enabled: true },
                { id: 5, type: 'warning', title: 'Invoice Overdue', message: '3 invoices are past due date', priority: 'High', date: '2025-11-17', read: false, enabled: true },
                { id: 6, type: 'success', title: 'Marketing ROI Up', message: 'Campaign ROI increased by 24%', priority: 'Low', date: '2025-11-16', read: false, enabled: true },
                { id: 7, type: 'warning', title: 'Deal Pipeline Stagnant', message: '4 deals haven\'t moved in 14+ days', priority: 'Medium', date: '2025-11-16', read: false, enabled: true },
                { id: 8, type: 'danger', title: 'Churn Risk Detected', message: '2 customers showing churn signals', priority: 'Critical', date: '2025-11-15', read: false, enabled: true },
                { id: 9, type: 'info', title: 'Team Milestone', message: 'Marketing team hit quarterly target', priority: 'Low', date: '2025-11-15', read: false, enabled: true },
                { id: 10, type: 'warning', title: 'Budget Threshold', message: 'Google Ads budget 85% utilized', priority: 'Medium', date: '2025-11-14', read: false, enabled: true },
                { id: 11, type: 'info', title: 'Product Update', message: 'New feature deployed to production', priority: 'Low', date: '2025-11-14', read: false, enabled: true },
                { id: 12, type: 'success', title: 'Conversion Rate Up', message: 'Lead conversion improved 12%', priority: 'Medium', date: '2025-11-13', read: false, enabled: true },
                { id: 13, type: 'warning', title: 'Vendor Contract Renewal', message: 'AWS contract expires in 45 days', priority: 'Medium', date: '2025-11-13', read: false, enabled: true },
                { id: 14, type: 'danger', title: 'Critical Task Overdue', message: 'High priority task missed deadline', priority: 'Critical', date: '2025-11-12', read: false, enabled: true },
                { id: 15, type: 'info', title: 'Team Expansion', message: 'New hire starts next Monday', priority: 'Low', date: '2025-11-12', read: false, enabled: true }
            ];
        }

        const navItems = [
            { id: 'dashboard', icon: 'ðŸ“Š', label: 'Dashboard' },
            { id: 'analytics', icon: 'ðŸ“ˆ', label: 'Advanced Analytics' },
            { id: 'financials', icon: 'ðŸ’°', label: 'Financial Overview' },
            { id: 'budgets', icon: 'ðŸ’¼', label: 'Operational Budgets' },
            { id: 'transactions', icon: 'ðŸ’³', label: 'Transactions' },
            { id: 'divisions', icon: 'ðŸ¢', label: 'Business Divisions' },
            { id: 'crm', icon: 'ðŸ‘¥', label: 'CRM & Contacts' },
            { id: 'deals', icon: 'ðŸ¤', label: 'Sales Pipeline' },
            { id: 'marketing', icon: 'ðŸ“¢', label: 'Marketing Hub' },
            { id: 'strategic-planning', icon: 'ðŸŽ¯', label: 'Strategic Planning' },
            { id: 'vendors', icon: 'ðŸ”§', label: 'Vendor Management' },
            { id: 'tasks', icon: 'âœ…', label: 'Task Management' },
            { id: 'invoices', icon: 'ðŸ“„', label: 'Invoices & Billing' },
            { id: 'alerts', icon: 'âš ï¸', label: 'Smart Alerts' },
            { id: 'notes', icon: 'ðŸ“', label: 'Notes & Docs' },
            { id: 'team', icon: 'ðŸ‘¨â€ðŸ’¼', label: 'Team Directory' },
            { id: 'calendar', icon: 'ðŸ“…', label: 'Calendar' },
            { id: 'integrations', icon: 'ðŸ”—', label: 'Integrations' },
            { id: 'reports', icon: 'ðŸ“‘', label: 'Reports & Export' },
            { id: 'settings', icon: 'âš™ï¸', label: 'Settings' }
        ];

        function saveData(silent = false) {
            try {
                localStorage.setItem('virelyOpsData', JSON.stringify(appState.data));
                if (!silent) {
                    showToast('Data saved successfully!');
                }
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                if (!silent) {
                    showToast('Error saving data');
                }
                return false;
            }
        }

        function addRecentActivity(type, description, details = '', priority = 'info') {
            // Initialize recentActivity if it doesn't exist
            if (!appState.data.recentActivity) {
                appState.data.recentActivity = [];
            }
            
            const activity = {
                id: Date.now(),
                type: type,
                description: description,
                details: details,
                priority: priority,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                icon: getActivityIcon(type),
                read: false
            };
            
            // Add to beginning of array
            appState.data.recentActivity.unshift(activity);
            
            // Keep only last 100 activities
            if (appState.data.recentActivity.length > 100) {
                appState.data.recentActivity = appState.data.recentActivity.slice(0, 100);
            }
            
            // Update summary tiles if on dashboard
            if (appState.currentSection === 'dashboard') {
                renderSummaryTiles();
            }
            
            saveData();
        }
        
        function getActivityIcon(type) {
            const icons = {
                'transaction': 'ðŸ’°',
                'contact': 'ðŸ‘¤',
                'deal': 'ðŸ¤',
                'event': 'ðŸ“…',
                'task': 'âœ“',
                'note': 'ðŸ“',
                'invoice': 'ðŸ“‹',
                'vendor': 'ðŸ¢',
                'team': 'ðŸ‘¥',
                'campaign': 'ðŸ“¢',
                'division': 'ðŸ­',
                'alert': 'ðŸ””',
                'update': 'âœï¸',
                'delete': 'ðŸ—‘ï¸',
                'create': 'âž•'
            };
            return icons[type] || 'ðŸ“Œ';
        }

        function loadData() {
            const savedData = localStorage.getItem('virelyOpsData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    appState.data = { ...appState.data, ...parsed };
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        function resetMockData() {
            if (confirm('âš ï¸ Are you sure you want to reset all data? This will remove all custom entries and restore the default mock data. This action cannot be undone.')) {
                // Clear localStorage
                localStorage.removeItem('virelyOpsData');
                
                // Reset appState to empty arrays
                appState.data.transactions = [];
                appState.data.divisions = [];
                appState.data.contacts = [];
                appState.data.campaigns = [];
                appState.data.vendors = [];
                appState.data.tasks = [];
                appState.data.notes = [];
                appState.data.team = [];
                appState.data.events = [];
                appState.data.deals = [];
                appState.data.invoices = [];
                appState.data.alerts = [];
                appState.data.recentActivity = [];
                
                // Reset financial metrics to default
                appState.data.mrr = { current: 0, growth: 0, target: 0 };
                appState.data.subscriptions = { active: 0, growth: 0, churned: 0 };
                appState.data.customers = { total: 0, new: 0, churned: 0, churn_rate: 0 };
                appState.data.revenue = { monthly: 0, yearly: 0, forecast: 0 };
                appState.data.cashflow = { incoming: 0, outgoing: 0, net: 0, runway: 0 };
                appState.data.budget = { monthly: 0, spent: 0, remaining: 0 };
                
                // Show success message
                showToast('âœ“ All mock data has been reset successfully!', 'success');
                
                // Reload the current section
                setTimeout(() => {
                    switchSection(appState.currentSection || 'dashboard');
                }, 500);
            }
        }

        function init() {
            initializeDefaultData();
            loadData();
            renderNavigation();
            switchSection('dashboard');
            renderSummaryTiles();
            renderAIInsights();
            updateTimestamp();
            updateGreeting();
            updateClock();
            setInterval(updateTimestamp, 60000);
            setInterval(updateClock, 1000);
            setInterval(updateGreeting, 60000);
            setInterval(renderSummaryTiles, 300000); // Update summary every 5 minutes
            
            // Auto-save data every 60 seconds
            setInterval(() => {
                saveData(true); // Silent auto-save
                console.log('Auto-saved at:', new Date().toLocaleTimeString());
            }, 60000);
            
            // Auto-refresh current section every 60 seconds
            setInterval(() => {
                const currentSection = appState.currentSection || 'dashboard';
                const mainContent = document.getElementById('mainContent');
                const sections = {
                    dashboard: renderDashboard,
                    analytics: renderAnalytics,
                    financials: renderFinancials,
                    transactions: renderTransactions,
                    divisions: renderDivisions,
                    crm: renderCRM,
                    deals: renderDeals,
                    marketing: renderMarketing,
                    'strategic-planning': renderStrategicPlanning,
                    vendors: renderVendors,
                    tasks: renderTasks,
                    invoices: renderInvoices,
                    alerts: renderAlerts,
                    notes: renderNotes,
                    team: renderTeam,
                    calendar: renderCalendar,
                    integrations: renderIntegrations,
                    reports: renderReports,
                    settings: renderSettings
                };
                
                if (sections[currentSection] && mainContent) {
                    sections[currentSection](mainContent);
                    renderSummaryTiles();
                    renderAIInsights();
                    console.log('Auto-refreshed at:', new Date().toLocaleTimeString());
                }
            }, 60000);
            
            // Initialize input masks for all phone and email fields
            setTimeout(() => {
                initializeInputMasks();
                initInputMaskObserver(); // Watch for dynamically added inputs
            }, 500);
            
            // Handle window resize for responsive sidebar
            window.addEventListener('resize', () => {
                // Re-apply sidebar logic when window is resized
                if (appState.currentSection) {
                    const mainContentWrapper = document.querySelector('.main-content');
                    const aiSidebar = document.querySelector('.ai-insights-sidebar');
                    
                    if (aiSidebar && mainContentWrapper) {
                        const isSmallScreen = window.innerWidth <= 1200;
                        
                        if (!isSmallScreen) {
                            aiSidebar.style.display = 'block';
                            if (window.innerWidth <= 1400) {
                                mainContentWrapper.style.marginRight = '360px';
                            } else {
                                mainContentWrapper.style.marginRight = '420px';
                            }
                        } else {
                            aiSidebar.style.display = 'none';
                            mainContentWrapper.style.marginRight = '0';
                        }
                    }
                }
            });
            
            // Smart welcome guidance
            setTimeout(() => {
                showToast('ðŸ‘‹ Welcome to Virely Ops! Check AI Insights below for personalized business guidance', 5000);
            }, 1000);
        }

        function updateTimestamp() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function updateGreeting() {
            const greetingElement = document.getElementById('greetingMessage');
            if (!greetingElement) return;
            
            const hour = new Date().getHours();
            let timeOfDay = 'evening';
            let emoji = 'ðŸŒ™';
            
            if (hour >= 5 && hour < 12) {
                timeOfDay = 'morning';
                emoji = 'â˜€ï¸';
            } else if (hour >= 12 && hour < 17) {
                timeOfDay = 'afternoon';
                emoji = 'ðŸŒ¤ï¸';
            } else if (hour >= 17 && hour < 21) {
                timeOfDay = 'evening';
                emoji = 'ðŸŒ†';
            }
            
            greetingElement.innerHTML = `${emoji} Good ${timeOfDay}, Brenton! I hope you have a great ${timeOfDay}.`;
        }

        function updateClock() {
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true 
                });
                timeElement.textContent = timeString;
            }
            
            if (dateElement) {
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                dateElement.textContent = dateString;
            }
        }

        function renderGreetingSection() {
            return `
                <div class="greeting-section">
                    <div class="greeting-content">
                        <h2 id="greetingMessage">Good morning, Brenton!</h2>
                        <p>Welcome back to your business intelligence dashboard</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button onclick="resetMockData()" class="btn-secondary" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                            <span>ðŸ”„</span> Reset Mock Data
                        </button>
                        <div class="time-display">
                            <div class="current-time" id="currentTime">--:--:--</div>
                            <div class="current-date" id="currentDate">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNavigation() {
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = navItems.map(item => `
                <div class="nav-item ${item.id === 'dashboard' ? 'active' : ''}" data-section="${item.id}">
                    <span class="nav-icon">${item.icon}</span>
                    <span>${item.label}</span>
                </div>
            `).join('');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    const section = this.getAttribute('data-section');
                    if (section) {
                        switchSection(section);
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
        }

        function switchSection(section) {
            appState.currentSection = section;
            const pageTitle = document.getElementById('pageTitle');
            const mainContent = document.getElementById('mainContent');
            const mainContentWrapper = document.querySelector('.main-content');
            const aiSidebar = document.querySelector('.ai-insights-sidebar');
            const headerActions = document.querySelector('.header-actions');
            
            const item = navItems.find(i => i.id === section);
            pageTitle.textContent = item ? item.label : 'Dashboard';
            
            // Hide buttons on Dashboard (analytics only page)
            if (headerActions) {
                if (section === 'dashboard') {
                    headerActions.style.display = 'none';
                } else {
                    headerActions.style.display = 'flex';
                }
            }
            
            // Show AI insights sidebar on ALL pages
            if (aiSidebar && mainContentWrapper) {
                const isSmallScreen = window.innerWidth <= 1200;
                
                if (!isSmallScreen) {
                    aiSidebar.style.display = 'block';
                    // Adjust margin based on screen size
                    if (window.innerWidth <= 1400) {
                        mainContentWrapper.style.marginRight = '360px';
                    } else {
                        mainContentWrapper.style.marginRight = '420px';
                    }
                } else {
                    aiSidebar.style.display = 'none';
                    mainContentWrapper.style.marginRight = '0';
                }
            }
            
            const sections = {
                dashboard: renderDashboard,
                analytics: renderAnalytics,
                financials: renderFinancials,
                budgets: renderBudgets,
                transactions: renderTransactions,
                divisions: renderDivisions,
                crm: renderCRM,
                deals: renderDeals,
                marketing: renderMarketing,
                'strategic-planning': renderStrategicPlanning,
                vendors: renderVendors,
                tasks: renderTasks,
                invoices: renderInvoices,
                alerts: renderAlerts,
                notes: renderNotes,
                team: renderTeam,
                calendar: renderCalendar,
                integrations: renderIntegrations,
                reports: renderReports,
                settings: renderSettings
            };

            if (sections[section]) {
                try {
                    sections[section](mainContent);
                    showSectionGuidance(section);
                } catch (error) {
                    console.error(`Error rendering ${section} section:`, error);
                    mainContent.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                            <h2 style="color: var(--danger); margin-bottom: 16px;">Error Loading Section</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                                There was an error loading the ${item ? item.label : section} section.
                            </p>
                            <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 20px;">
                                Error: ${error.message}
                            </p>
                            <button class="btn-primary" onclick="switchSection('dashboard')">Return to Dashboard</button>
                        </div>
                    `;
                }
            }
        }
        
        // Smart section guidance toasts
        function showSectionGuidance(section) {
            // Don't show guidance on initial dashboard load
            if (section === 'dashboard' && !appState.hasShownDashboardGuidance) {
                appState.hasShownDashboardGuidance = true;
                return;
            }
            
            const guidanceMessages = {
                'analytics': 'ðŸ“Š Analytics Hub: Track key metrics and identify growth opportunities',
                'financials': 'ðŸ’° Financial Overview: Monitor cash flow and profitability trends',
                'crm': 'ðŸ¤ Customer Management: Build stronger relationships with your customers',
                'deals': 'ðŸŽ¯ Sales Pipeline: Track deals through each stage to close more sales',
                'marketing': 'ðŸ“¢ Marketing Center: Launch campaigns and measure their effectiveness',
                'team': 'ðŸ‘¥ Team Directory: Manage your team and track performance',
                'reports': 'ðŸ“ˆ Comprehensive Reports: Generate insights across all business areas'
            };
            
            if (guidanceMessages[section]) {
                showToast(guidanceMessages[section], 3500);
            }
        }

        function renderSummaryTiles() {
            const container = document.getElementById('summaryTiles');
            
            // Calculate summary data
            const newCustomers = appState.data.contacts.filter(c => c.status === 'Customer').slice(0, 3).length;
            const totalCustomers = appState.data.contacts.filter(c => c.status === 'Customer').length;
            
            const invoicesDue = appState.data.invoices.filter(i => i.status === 'pending').length;
            const totalInvoiceValue = appState.data.invoices.filter(i => i.status === 'pending').reduce((sum, inv) => sum + inv.amount, 0);
            
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            
            const upcomingEvents = appState.data.events.filter(e => {
                const eventDate = new Date(e.date);
                const today = new Date();
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil >= 0 && daysUntil <= 7;
            }).length;
            
            // Detect recurring patterns in transactions
            const recurringTransactions = detectRecurringPatterns();
            
            // Get recent activity (last 5 actions)
            // Initialize recentActivity if it doesn't exist
            if (!appState.data.recentActivity) {
                appState.data.recentActivity = [];
            }
            
            const recentActivity = appState.data.recentActivity.slice(0, 10);
            
            container.innerHTML = `
                <!-- New Customers -->
                <div class="summary-tile" onclick="showNewCustomersDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ‘¥</div>
                    <div class="summary-content">
                        <div class="summary-label">New Customers</div>
                        <div class="summary-value">+${newCustomers}</div>
                        <div class="summary-detail">Total: ${totalCustomers}</div>
                    </div>
                </div>
                
                <!-- Invoices Due -->
                <div class="summary-tile" onclick="showInvoicesDueDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ“‹</div>
                    <div class="summary-content">
                        <div class="summary-label">Invoices Due</div>
                        <div class="summary-value">${invoicesDue}</div>
                        <div class="summary-detail">$${totalInvoiceValue.toLocaleString()}</div>
                    </div>
                </div>
                
                <!-- Recurring Patterns -->
                <div class="summary-tile" onclick="showRecurringPatternsDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ”„</div>
                    <div class="summary-content">
                        <div class="summary-label">Recurring Patterns</div>
                        <div class="summary-value">${recurringTransactions.length}</div>
                        <div class="summary-detail">Smart detected</div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="summary-tile" onclick="showRecentActivityDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ“</div>
                    <div class="summary-content">
                        <div class="summary-label">Recent Activity</div>
                        <div class="summary-value">${recentActivity.length}</div>
                        <div class="summary-detail">Latest actions</div>
                    </div>
                </div>
                
                <!-- Financial Summary -->
                <div class="summary-tile" onclick="showFinancialSummaryDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ’°</div>
                    <div class="summary-content">
                        <div class="summary-label">Financial Summary</div>
                        <div class="summary-value">$${(totalRevenue - totalExpenses).toLocaleString()}</div>
                        <div class="summary-detail">Net profit</div>
                    </div>
                </div>
                
                <!-- Operational Budgets -->
                ${renderBudgetSummaryTile()}
                
                <!-- Upcoming Events -->
                <div class="summary-tile" onclick="showUpcomingEventsDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">ðŸ“…</div>
                    <div class="summary-content">
                        <div class="summary-label">Upcoming Events</div>
                        <div class="summary-value">${upcomingEvents}</div>
                        <div class="summary-detail">Next 7 days</div>
                    </div>
                </div>
            `;
        }

        function renderBudgetSummaryTile() {
            // Initialize budgets if they don't exist
            if (!appState.data.budgets) {
                initializeBudgets();
            }
            
            const budgets = appState.data.budgets;
            
            // Calculate totals for each category
            const calculateCategoryTotals = (categoryItems) => {
                const allocated = categoryItems.reduce((sum, item) => sum + (item.allocated || 0), 0);
                const spent = categoryItems.reduce((sum, item) => sum + (item.spent || 0), 0);
                const remaining = allocated - spent;
                const percentage = allocated > 0 ? (spent / allocated * 100) : 0;
                return { allocated, spent, remaining, percentage };
            };
            
            const operationalTotals = calculateCategoryTotals(budgets.operational);
            const marketingTotals = calculateCategoryTotals(budgets.marketing);
            const sgaTotals = calculateCategoryTotals(budgets.sga);
            
            const grandTotal = {
                allocated: operationalTotals.allocated + marketingTotals.allocated + sgaTotals.allocated,
                spent: operationalTotals.spent + marketingTotals.spent + sgaTotals.spent,
                remaining: operationalTotals.remaining + marketingTotals.remaining + sgaTotals.remaining
            };
            grandTotal.percentage = grandTotal.allocated > 0 ? (grandTotal.spent / grandTotal.allocated * 100) : 0;
            
            // Get status color and icon
            const getStatusColor = (percentage) => {
                if (percentage >= 90) return 'var(--danger)';
                if (percentage >= 75) return 'var(--warning)';
                return 'var(--success)';
            };
            
            const getStatusIcon = (percentage) => {
                if (percentage >= 90) return 'ðŸ”´';
                if (percentage >= 75) return 'ðŸŸ¡';
                return 'ðŸŸ¢';
            };
            
            return `
                <div class="summary-tile" onclick="showBudgetSummaryDrillDown()" style="cursor: pointer;">
                    <div class="summary-icon">${getStatusIcon(grandTotal.percentage)}</div>
                    <div class="summary-content">
                        <div class="summary-label">Budget Health</div>
                        <div class="summary-value" style="color: ${getStatusColor(grandTotal.percentage)}">${grandTotal.percentage.toFixed(1)}%</div>
                        <div class="summary-detail">$${grandTotal.remaining.toLocaleString()} remaining</div>
                    </div>
                </div>
            `;
        }

        function detectRecurringPatterns() {
            // Simple pattern detection: find transactions with similar descriptions
            const transactions = appState.data.transactions;
            const patterns = [];
            const seen = new Set();
            
            transactions.forEach(t1 => {
                if (seen.has(t1.description)) return;
                
                const similar = transactions.filter(t2 => 
                    t2.description === t1.description && t2.id !== t1.id
                );
                
                if (similar.length >= 2) {
                    patterns.push({
                        description: t1.description,
                        count: similar.length + 1,
                        amount: t1.amount,
                        category: t1.category
                    });
                    seen.add(t1.description);
                }
            });
            
            return patterns;
        }

        function renderAIInsights() {
            const container = document.getElementById('aiInsightsPanels');
            const insights = [
                {
                    id: 'revenue-health',
                    icon: 'ðŸŽ¯',
                    label: 'Revenue Health Score',
                    value: '92/100',
                    description: 'Revenue metrics performing excellently. MRR growth 12.4% above target.',
                    trend: 'â†‘ 8 points vs last month',
                    trendClass: 'trend-positive',
                    recommendation: 'Continue current strategies. Consider expanding Dealsby.io.'
                },
                {
                    id: 'cashflow-forecast',
                    icon: 'ðŸ’°',
                    label: 'Cash Flow Forecast',
                    value: '$242.5K',
                    description: 'Projected net cash flow for next 30 days.',
                    trend: 'â†‘ 18.2% month-over-month',
                    trendClass: 'trend-positive',
                    recommendation: 'Strong position. Runway extends 18.5 months.'
                },
                {
                    id: 'customer-retention',
                    icon: 'ðŸ”’',
                    label: 'Customer Retention',
                    value: '97.2%',
                    description: 'Retention rate improved significantly this quarter.',
                    trend: 'â†‘ 2.1% from last quarter',
                    trendClass: 'trend-positive',
                    recommendation: 'Focus on Enterprise customers showing 99.1% retention.'
                },
                {
                    id: 'growth-velocity',
                    icon: 'ðŸš€',
                    label: 'Growth Velocity',
                    value: '+34%',
                    description: 'Compound monthly growth rate accelerating.',
                    trend: 'â†‘ Fastest growth in 12 months',
                    trendClass: 'trend-positive',
                    recommendation: 'Scale marketing spend 15-20% to capitalize on momentum.'
                },
                {
                    id: 'product-performance',
                    icon: 'â­',
                    label: 'Product Mix Health',
                    value: '85/100',
                    description: 'Dealsby.io leading with 51% of total revenue.',
                    trend: 'â†‘ Portfolio balanced well',
                    trendClass: 'trend-positive',
                    recommendation: 'Invest in Reservations - showing 24.8% growth rate.'
                },
                {
                    id: 'team-efficiency',
                    icon: 'âš¡',
                    label: 'Team Efficiency',
                    value: '$10.9K',
                    description: 'Revenue per employee increased 8.3% this quarter.',
                    trend: 'â†‘ Above industry benchmark',
                    trendClass: 'trend-positive',
                    recommendation: 'Maintain lean structure. Consider 2-3 strategic hires.'
                },
                {
                    id: 'market-opportunity',
                    icon: 'ðŸŽª',
                    label: 'Market Opportunity',
                    value: 'High',
                    description: 'TAM expansion detected in hospitality sector.',
                    trend: 'â†‘ 3 new market segments identified',
                    trendClass: 'trend-positive',
                    recommendation: 'Prioritize restaurant and salon verticals for Q1 expansion.'
                }
            ];
            
            container.innerHTML = insights.map(insight => `
                <div class="ai-insight-card" onclick="showAIInsightDrillDown('${insight.id}'); showInsightToast('${insight.id}', '${insight.label}');" style="cursor: pointer;">
                    <div class="ai-insight-icon">${insight.icon}</div>
                    <div class="ai-insight-label">${insight.label}</div>
                    <div class="ai-insight-value">${insight.value}</div>
                    <div class="ai-insight-description">${insight.description}</div>
                    <div class="ai-insight-trend ${insight.trendClass}">${insight.trend}</div>
                    ${insight.recommendation ? `<div class="ai-recommendation" onclick="event.stopPropagation(); showRecommendationToast('${insight.id}');">ðŸ’¡ ${insight.recommendation}</div>` : ''}
                </div>
            `).join('');
        }

        // Smart toast messages for AI insights
        function showInsightToast(insightId, label) {
            const toastMessages = {
                'revenue-health': 'ðŸŽ¯ Analyzing revenue health metrics - Your score is excellent!',
                'cashflow-forecast': 'ðŸ’° Loading cash flow projections - Strong financial position detected',
                'customer-retention': 'ðŸ”’ Examining retention data - Industry-leading performance!',
                'growth-velocity': 'ðŸš€ Calculating growth metrics - Accelerating momentum identified',
                'product-performance': 'â­ Reviewing product mix - Dealsby.io leading revenue contribution',
                'team-efficiency': 'âš¡ Evaluating team productivity - Above benchmark efficiency!',
                'market-opportunity': 'ðŸŽª Scanning market opportunities - High-potential segments found'
            };
            
            showToast(toastMessages[insightId] || `ðŸ“Š Opening ${label} analysis...`);
        }

        // Smart toast messages for recommendations
        function showRecommendationToast(insightId) {
            const recommendationToasts = {
                'revenue-health': 'ðŸ’¡ AI Recommendation: Consider expanding Dealsby.io to capitalize on current momentum',
                'cashflow-forecast': 'ðŸ’¡ Financial Guidance: Strong runway of 18.5 months - Perfect time for strategic investments',
                'customer-retention': 'ðŸ’¡ Retention Insight: Focus on Enterprise segment with 99.1% retention rate',
                'growth-velocity': 'ðŸ’¡ Growth Strategy: Increase marketing spend 15-20% to maximize momentum',
                'product-performance': 'ðŸ’¡ Product Insight: Invest in Reservations platform - showing 24.8% growth potential',
                'team-efficiency': 'ðŸ’¡ Hiring Guidance: Consider 2-3 strategic hires while maintaining lean efficiency',
                'market-opportunity': 'ðŸ’¡ Market Strategy: Prioritize restaurant and salon verticals for Q1 expansion'
            };
            
            showToast(recommendationToasts[insightId] || 'ðŸ’¡ Strategic recommendation available');
        }

        function showAIInsightDrillDown(insightId) {
            const drillDowns = {
                'revenue-health': () => {
                    showToast('ðŸ“Š Revenue Health: Top 15% performance! MRR growth 12.4% above target', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Overall Score</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">92/100</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Composite health metric</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">MRR Growth</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+12.4%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Above 10% target</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Revenue Quality</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">96/100</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">High recurring component</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Predictability</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">94/100</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Stable revenue streams</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <h3 style="margin-bottom: 16px;">Score Components</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Growth Rate (25%)</span>
                                        <span style="font-weight: 700; color: var(--success);">24/25</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 96%;"></div></div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Revenue Quality (25%)</span>
                                        <span style="font-weight: 700; color: var(--success);">24/25</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 96%;"></div></div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Predictability (25%)</span>
                                        <span style="font-weight: 700; color: var(--success);">23.5/25</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 94%;"></div></div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Diversification (25%)</span>
                                        <span style="font-weight: 700; color: var(--success);">20.5/25</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 82%;"></div></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸŽ¯ STRATEGIC INSIGHTS</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Your revenue health score of 92/100 places you in the top 15% of SaaS companies at your stage. The primary strength is high-quality recurring revenue (96% subscription-based). Consider improving product diversification by expanding Dealsby Reservations, which shows 24.8% growth potential.
                            </div>
                        </div>
                    `;
                    showModal('Revenue Health Score Analysis', modalContent);
                },
                'cashflow-forecast': () => {
                    showToast('ðŸ’° Cash Flow Analysis: 18.5 month runway - Break-even achieved!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">30-Day Forecast</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$242.5K</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Net cash position</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Runway</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">18.5mo</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">At current burn rate</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Burn</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$42.3K</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Average monthly spend</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Break-even</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">Achieved</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Profitable operations</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <h3 style="margin-bottom: 20px;">Cash Flow Breakdown</h3>
                            <div style="display: grid; gap: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">Incoming (Revenue)</span>
                                    <span style="font-size: 18px; font-weight: 700; color: var(--success);">+$284.8K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">Outgoing (Expenses)</span>
                                    <span style="font-size: 18px; font-weight: 700; color: var(--danger);">-$42.3K</span>
                                </div>
                                <div style="height: 1px; background: var(--glass-border); margin: 8px 0;"></div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600;">Net Cash Flow</span>
                                    <span style="font-size: 24px; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                        $242.5K
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ’° FINANCIAL POSITION</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Strong cash position with 18.5 months runway. With profitability achieved and positive cash flow of $242.5K/month, you're in excellent position to reinvest in growth. Consider allocating 15-20% to marketing expansion while maintaining 12+ month runway buffer.
                            </div>
                        </div>
                    `;
                    showModal('Cash Flow Forecast Analysis', modalContent);
                },
                'customer-retention': () => {
                    showToast('ðŸ”’ Retention Excellence: 97.2% rate - Enterprise customers at 99.1%!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Retention Rate</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">97.2%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Monthly retention</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Churn Rate</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">2.8%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Below industry avg (5%)</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Net Dollar Retention</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">112%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Including expansions</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Customer Life</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">35.7mo</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Expected lifetime</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px;">
                            <h3 style="margin-bottom: 16px;">Retention by Segment</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Enterprise</span>
                                        <span style="font-weight: 700; color: var(--success);">99.1%</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 99.1%;"></div></div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Pro</span>
                                        <span style="font-weight: 700; color: var(--success);">97.8%</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 97.8%;"></div></div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Basic</span>
                                        <span style="font-weight: 700; color: var(--warning);">93.4%</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 93.4%; background: linear-gradient(90deg, var(--warning), var(--accent-tertiary));"></div></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ”’ RETENTION INSIGHTS</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Excellent retention at 97.2%, nearly double the industry benchmark. Enterprise customers show exceptional stickiness at 99.1%. Focus retention efforts on Basic tier customers (93.4%) through enhanced onboarding and feature adoption programs. Net dollar retention of 112% indicates strong expansion revenue potential.
                            </div>
                        </div>
                    `;
                    showModal('Customer Retention Analysis', modalContent);
                },
                'growth-velocity': () => {
                    showToast('ðŸš€ Growth Acceleration: +34% velocity - Fastest in 12 months!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Growth</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+34%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Compound growth rate</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Acceleration</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+8%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Growth momentum</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Annual Run Rate</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$4.2M</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Projected ARR</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Time to $10M</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">22mo</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">At current velocity</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <h3 style="margin-bottom: 20px;">Growth Drivers</h3>
                            <div style="display: grid; gap: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">New Customer Acquisition</span>
                                    <span style="font-size: 18px; font-weight: 700; color: var(--success);">+45%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">Expansion Revenue</span>
                                    <span style="font-size: 18px; font-weight: 700; color: var(--success);">+28%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">Product Mix Optimization</span>
                                    <span style="font-size: 18px; font-weight: 700; color: var(--success);">+12%</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸš€ VELOCITY ANALYSIS</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Exceptional growth velocity of 34% compound monthly rate places you in top-tier performance. Growth is accelerating (+8% momentum), driven primarily by strong new customer acquisition. At current trajectory, you'll reach $10M ARR in 22 months. Consider increasing marketing investment 15-20% to capitalize on this momentum while maintaining unit economics.
                            </div>
                        </div>
                    `;
                    showModal('Growth Velocity Analysis', modalContent);
                },
                'product-performance': () => {
                    showToast('â­ Product Mix: Dealsby.io 51% revenue - Reservations +24.8% growth!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Mix Health Score</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">85/100</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Portfolio balance</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Lead Product</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">Dealsby.io</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">51% of revenue</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Growth Leader</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">Reservations</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">+24.8% growth</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Cross-sell Rate</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">23%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Multi-product adoption</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px;">
                            <h3 style="margin-bottom: 16px;">Revenue by Product</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Dealsby.io (Referrals)</span>
                                        <span style="font-weight: 700; color: var(--accent-primary);">$145K (51%)</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 51%;"></div></div>
                                    <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Growth: +18.2% | Margin: 82%</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Dealsby Appointments</span>
                                        <span style="font-weight: 700; color: var(--accent-tertiary);">$89K (31%)</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 31%; background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-secondary));"></div></div>
                                    <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Growth: +12.5% | Margin: 79%</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">Dealsby Reservations</span>
                                        <span style="font-weight: 700; color: var(--accent-secondary);">$51K (18%)</span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 18%; background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));"></div></div>
                                    <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Growth: +24.8% ðŸš€ | Margin: 76%</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">â­ PRODUCT INSIGHTS</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Healthy product mix with 85/100 score. Dealsby.io provides strong revenue base (51%), while Reservations shows exceptional growth potential at 24.8%. Consider doubling investment in Reservations product development and sales to capitalize on market momentum. Cross-sell rate of 23% indicates opportunity to bundle products for increased ARPU.
                            </div>
                        </div>
                    `;
                    showModal('Product Performance Analysis', modalContent);
                },
                'team-efficiency': () => {
                    showToast('âš¡ Team Performance: $10.9K per employee - 8.3% improvement!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Revenue per Employee</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$10.9K</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Monthly average</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Team Size</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">26</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Total headcount</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Efficiency Score</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">88/100</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Above benchmark</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Growth Rate</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+8.3%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Efficiency improved</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px;">
                            <h3 style="margin-bottom: 16px;">Team Distribution</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Engineering (12)</span>
                                    <span style="font-weight: 700;">46%</span>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Sales & Marketing (8)</span>
                                    <span style="font-weight: 700;">31%</span>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Product & Design (4)</span>
                                    <span style="font-weight: 700;">15%</span>
                                </div>
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>Operations (2)</span>
                                    <span style="font-weight: 700;">8%</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">âš¡ EFFICIENCY ANALYSIS</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                Excellent efficiency at $10.9K revenue per employee, 8.3% above last quarter. Your lean team structure (26 people) maintains high productivity while scaling. Recommended strategic hires: 1 Senior Product Manager for Reservations, 1 Enterprise Account Executive, 1 Customer Success Manager. This would bring headcount to 29 while maintaining >$9.8K/employee efficiency.
                            </div>
                        </div>
                    `;
                    showModal('Team Efficiency Analysis', modalContent);
                },
                'market-opportunity': () => {
                    showToast('ðŸŽª Market Expansion: +42% TAM growth - 3 new verticals identified!', 4000);
                    const modalContent = `
                        <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Opportunity Score</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">High</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Strong market signals</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">TAM Expansion</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+42%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Addressable market growth</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">New Segments</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">3</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Identified verticals</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Market Share</div>
                                    <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">0.8%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Significant room to grow</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 32px;">
                            <h3 style="margin-bottom: 16px;">Target Market Segments</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">ðŸ½ï¸ Restaurants & Hospitality</span>
                                        <span class="badge badge-success">High Priority</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        TAM: $2.8B | Growth: 18% YoY | Competition: Moderate
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        Strong fit for Dealsby Reservations. 47K potential customers in target regions.
                                    </div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">ðŸ’‡ Salons & Wellness</span>
                                        <span class="badge badge-success">High Priority</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        TAM: $1.9B | Growth: 22% YoY | Competition: Low
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        Underserved market with high booking frequency. 38K potential customers.
                                    </div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">ðŸ‹ï¸ Fitness & Recreation</span>
                                        <span class="badge badge-info">Medium Priority</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        TAM: $1.2B | Growth: 15% YoY | Competition: High
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        Competitive but growing market. 24K potential customers.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸŽª MARKET STRATEGY</div>
                            <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                                TAM expanded 42% with identification of 3 high-potential verticals. Prioritize restaurants/hospitality and salons for Q1 expansion - combined TAM of $4.7B with lower competition. Allocate 60% of expansion budget to restaurants (largest TAM), 30% to salons (fastest growth, lowest competition), 10% to fitness (testing). Current 0.8% market share provides significant scaling runway.
                            </div>
                        </div>
                    `;
                    showModal('Market Opportunity Analysis', modalContent);
                }
            };

            if (drillDowns[insightId]) {
                drillDowns[insightId]();
            }
        }

        // DASHBOARD
        function calculateLTVCACRatio() {
            // Calculate average revenue per customer across divisions
            const totalRevenue = appState.data.divisions.reduce((sum, d) => sum + d.revenue, 0);
            const totalCustomers = appState.data.divisions.reduce((sum, d) => sum + d.customers, 0);
            
            if (totalCustomers === 0) return '0:1';
            
            // Calculate average revenue per customer
            const avgRevenuePerCustomer = totalRevenue / totalCustomers;
            
            // Calculate marketing spend (assuming 15% of revenue for CAC)
            const marketingSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const newCustomers = appState.data.customers.new || 1;
            const cac = marketingSpend / newCustomers;
            
            // Assume 24 month average customer lifetime
            const avgLifetimeMonths = 24;
            const ltv = avgRevenuePerCustomer * avgLifetimeMonths;
            
            if (cac === 0) return 'N/A';
            
            const ratio = ltv / cac;
            return `${ratio.toFixed(1)}:1`;
        }

        function getLTVCACStatus() {
            const ratio = parseFloat(calculateLTVCACRatio().split(':')[0]);
            if (ratio >= 3) return 'Healthy ratio (>3:1)';
            if (ratio >= 2) return 'Acceptable ratio (2-3:1)';
            return 'Needs improvement (<2:1)';
        }

        function calculateCACPayback() {
            const marketingSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const newCustomers = appState.data.customers.new || 1;
            const cac = marketingSpend / newCustomers;
            
            const totalRevenue = appState.data.divisions.reduce((sum, d) => sum + d.revenue, 0);
            const totalCustomers = appState.data.divisions.reduce((sum, d) => sum + d.customers, 0);
            
            if (totalCustomers === 0 || cac === 0) return '0';
            
            const monthlyRevenuePerCustomer = totalRevenue / totalCustomers;
            const paybackMonths = cac / monthlyRevenuePerCustomer;
            
            return paybackMonths.toFixed(1);
        }

        function calculateGrossMargin() {
            const totalRevenue = appState.data.divisions.reduce((sum, d) => sum + d.revenue, 0);
            const totalExpenses = appState.data.divisions.reduce((sum, d) => sum + d.expenses, 0);
            
            if (totalRevenue === 0) return '0%';
            
            const grossProfit = totalRevenue - totalExpenses;
            const margin = (grossProfit / totalRevenue) * 100;
            
            return `${margin.toFixed(0)}%`;
        }

        function getGrossMarginStatus() {
            const margin = parseFloat(calculateGrossMargin());
            if (margin >= 70) return 'Strong margins';
            if (margin >= 50) return 'Healthy margins';
            if (margin >= 30) return 'Moderate margins';
            return 'Low margins';
        }

        function renderDashboard(container) {
            container.innerHTML = `
                ${renderGreetingSection()}
                <div class="stats-grid">
                    <div class="stat-card" onclick="showMRRDrillDown()">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Monthly Recurring Revenue</div>
                        <div class="stat-value">$${(appState.data.mrr.current/1000).toFixed(1)}K</div>
                        <div class="stat-change positive">+${appState.data.mrr.growth}%</div>
                    </div>
                    <div class="stat-card" onclick="showSubscriptionsDrillDown()">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-label">Active Subscriptions</div>
                        <div class="stat-value">${appState.data.subscriptions.active}</div>
                        <div class="stat-change positive">+${appState.data.subscriptions.growth}%</div>
                    </div>
                    <div class="stat-card" onclick="showCustomersDrillDown()">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-label">Total Customers</div>
                        <div class="stat-value">${appState.data.customers.total}</div>
                        <div class="stat-change positive">+${appState.data.customers.new} new</div>
                    </div>
                    <div class="stat-card" onclick="showChurnDrillDown()">
                        <div class="stat-icon">ðŸ“‰</div>
                        <div class="stat-label">Churn Rate</div>
                        <div class="stat-value">${appState.data.customers.churn_rate}%</div>
                        <div class="stat-change negative">${appState.data.customers.churned} churned</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="showRevenueDrillDown()">
                        <div class="stat-icon">ðŸ’µ</div>
                        <div class="stat-label">Annual Revenue</div>
                        <div class="stat-value">$${(appState.data.revenue.yearly/1000000).toFixed(2)}M</div>
                        <div class="stat-change positive">On track for $${(appState.data.revenue.forecast/1000000).toFixed(2)}M</div>
                    </div>
                    <div class="stat-card" onclick="showCashflowDrillDown()">
                        <div class="stat-icon">ðŸ”„</div>
                        <div class="stat-label">Monthly Cashflow</div>
                        <div class="stat-value">$${(appState.data.cashflow.net/1000).toFixed(1)}K</div>
                        <div class="stat-change positive">${appState.data.cashflow.runway} months runway</div>
                    </div>
                    <div class="stat-card" onclick="showBudgetDrillDown()">
                        <div class="stat-icon">ðŸ’³</div>
                        <div class="stat-label">Budget Remaining</div>
                        <div class="stat-value">$${(appState.data.budget.remaining/1000).toFixed(1)}K</div>
                        <div class="stat-change">${((appState.data.budget.remaining/appState.data.budget.monthly)*100).toFixed(0)}% of monthly budget</div>
                    </div>
                    <div class="stat-card" onclick="showARRDrillDown()">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-label">Annual Recurring Revenue</div>
                        <div class="stat-value">$${((appState.data.mrr.current * 12)/1000000).toFixed(2)}M</div>
                        <div class="stat-change positive">Growing ${appState.data.mrr.growth}% MoM</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Revenue Trends</div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-title">Quick Financial Overview</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px;">
                            <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onclick="showLTVCACDrillDown()">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 8px; text-transform: uppercase;">LTV:CAC Ratio</div>
                                <div style="font-weight: 800; font-size: 32px; color: var(--accent-primary); margin-bottom: 4px;">${calculateLTVCACRatio()}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${getLTVCACStatus()}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onclick="showPaybackDrillDown()">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 8px; text-transform: uppercase;">CAC Payback Period</div>
                                <div style="font-weight: 800; font-size: 32px; color: var(--accent-secondary); margin-bottom: 4px;">${calculateCACPayback()}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">months to recover CAC</div>
                            </div>
                            <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onclick="showGrossMarginDrillDown()">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 8px; text-transform: uppercase;">Gross Margin</div>
                                <div style="font-weight: 800; font-size: 32px; color: var(--accent-gold); margin-bottom: 4px;">${calculateGrossMargin()}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${getGrossMarginStatus()}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const ctx = document.getElementById('revenueChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [{
                                label: 'Revenue ($K)',
                                data: [220, 235, 245, 255, 260, 268, 275, 280, 285, 290, 295, 300],
                                borderColor: 'rgba(110,231,183,1)',
                                backgroundColor: 'rgba(110,231,183,0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            }, {
                                label: 'Expenses ($K)',
                                data: [52, 48, 51, 49, 50, 47, 45, 44, 42, 43, 42, 41],
                                borderColor: 'rgba(124,92,255,1)',
                                backgroundColor: 'rgba(124,92,255,0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { 
                                legend: { 
                                    labels: { 
                                        color: '#94a3b8',
                                        font: { size: 13, weight: 600 },
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(10,14,26,0.95)',
                                    titleColor: '#fff',
                                    bodyColor: '#94a3b8',
                                    borderColor: 'rgba(110,231,183,0.3)',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: true
                                }
                            },
                            scales: {
                                y: { 
                                    ticks: { 
                                        color: '#64748b',
                                        callback: function(value) { return '$' + value + 'K'; }
                                    }, 
                                    grid: { color: 'rgba(255,255,255,0.05)' } 
                                },
                                x: { 
                                    ticks: { color: '#64748b' }, 
                                    grid: { color: 'rgba(255,255,255,0.05)' } 
                                }
                            }
                        }
                    });
                }
            }, 100);
        }


        // ANALYTICS - showing example implementation
        function renderAnalytics(container) {
            // Calculate comprehensive analytics
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = ((netProfit / totalRevenue) * 100).toFixed(1);
            
            const totalContacts = appState.data.contacts.length;
            const avgContactValue = appState.data.contacts.reduce((sum, c) => sum + c.value, 0) / totalContacts;
            const customerCount = appState.data.contacts.filter(c => c.status === 'Customer').length;
            const leadCount = appState.data.contacts.filter(c => c.status === 'Lead').length;
            
            const totalMarketingSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const totalMarketingLeads = appState.data.campaigns.reduce((sum, c) => sum + c.leads, 0);
            const avgCostPerLead = (totalMarketingSpend / totalMarketingLeads).toFixed(2);
            
            const totalDealValue = appState.data.deals.reduce((sum, d) => sum + d.value, 0);
            const avgDealSize = totalDealValue / appState.data.deals.length;
            const avgProbability = appState.data.deals.reduce((sum, d) => sum + d.probability, 0) / appState.data.deals.length;
            const weightedPipeline = appState.data.deals.reduce((sum, d) => sum + (d.value * d.probability / 100), 0);
            
            container.innerHTML = `
                ${renderGreetingSection()}
                <div class="stats-grid">
                    <div class="stat-card" onclick="showRevenueGrowthDrillDown()" style="cursor: pointer;">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-label">Revenue Growth Rate</div>
                        <div class="stat-value">24.5%</div>
                        <div class="stat-change positive">â†‘ 3.2% vs last period</div>
                    </div>
                    <div class="stat-card" onclick="showCLVDrillDown()" style="cursor: pointer;">
                        <div class="stat-icon">ðŸ’Ž</div>
                        <div class="stat-label">Customer Lifetime Value</div>
                        <div class="stat-value">$${avgContactValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                        <div class="stat-change positive">â†‘ 18.3% from last month</div>
                    </div>
                    <div class="stat-card" onclick="showProfitMarginDrillDown()" style="cursor: pointer;">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Profit Margin</div>
                        <div class="stat-value">${profitMargin}%</div>
                        <div class="stat-change ${parseFloat(profitMargin) > 0 ? 'positive' : 'negative'}">
                            Net: $${netProfit.toLocaleString()}
                        </div>
                    </div>
                    <div class="stat-card" onclick="showCACDrillDown()" style="cursor: pointer;">
                        <div class="stat-icon">ðŸŽ¯</div>
                        <div class="stat-label">CAC (Customer Acquisition Cost)</div>
                        <div class="stat-value">$${avgCostPerLead}</div>
                        <div class="stat-change positive">Per customer acquired</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Revenue & Expense Breakdown</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div onclick="showTotalRevenueDrillDown()" style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">TOTAL REVENUE</div>
                            <div style="font-weight: 800; font-size: 28px; color: var(--accent-primary); margin-bottom: 4px;">
                                $${totalRevenue.toLocaleString()}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">All revenue transactions</div>
                        </div>
                        <div onclick="showTotalExpensesDrillDown()" style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(124,92,255,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">TOTAL EXPENSES</div>
                            <div style="font-weight: 800; font-size: 28px; color: var(--accent-secondary); margin-bottom: 4px;">
                                $${totalExpenses.toLocaleString()}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">All expense transactions</div>
                        </div>
                        <div onclick="showNetProfitDrillDown()" style="background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.15)); 
                             padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">NET PROFIT</div>
                            <div style="font-weight: 800; font-size: 28px; color: ${netProfit > 0 ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 4px;">
                                $${netProfit.toLocaleString()}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">${profitMargin}% profit margin</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Sales Pipeline Analytics</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div onclick="showTotalPipelineDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">TOTAL PIPELINE</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-primary);">$${totalDealValue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${appState.data.deals.length} deals</div>
                        </div>
                        <div onclick="showWeightedPipelineDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(251,191,36,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">WEIGHTED PIPELINE</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-gold);">$${weightedPipeline.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">By probability</div>
                        </div>
                        <div onclick="showAvgDealSizeDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(124,92,255,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">AVG DEAL SIZE</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-secondary);">$${avgDealSize.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Per opportunity</div>
                        </div>
                        <div onclick="showWinProbabilityDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(74,222,128,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">WIN PROBABILITY</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--success);">${avgProbability.toFixed(0)}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Average across pipeline</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Customer & Lead Metrics</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div onclick="showTotalContactsDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">TOTAL CONTACTS</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-primary);">${totalContacts}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">In database</div>
                        </div>
                        <div onclick="showCustomerMetricsDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(74,222,128,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CUSTOMERS</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--success);">${customerCount}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Active accounts</div>
                        </div>
                        <div onclick="showLeadMetricsDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(96,165,250,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">LEADS</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-tertiary);">${leadCount}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Potential customers</div>
                        </div>
                        <div onclick="showConversionRateDrillDown()" style="background: var(--bg-glass); padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(251,191,36,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CONVERSION RATE</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-gold);">${((customerCount / totalContacts) * 100).toFixed(1)}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Lead to customer</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Marketing ROI Analysis</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div onclick="showMarketingSpendDrillDown()" style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                             padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(124,92,255,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">MARKETING SPEND</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-secondary); margin-bottom: 8px;">
                                $${totalMarketingSpend.toLocaleString()}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Across ${appState.data.campaigns.length} campaigns</div>
                        </div>
                        <div onclick="showLeadsGeneratedDrillDown()" style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                             padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(96,165,250,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">LEADS GENERATED</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-tertiary); margin-bottom: 8px;">
                                ${totalMarketingLeads}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">From marketing efforts</div>
                        </div>
                        <div onclick="showCostPerLeadDrillDown()" style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                             padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">COST PER LEAD</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-primary); margin-bottom: 8px;">
                                $${avgCostPerLead}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Average acquisition cost</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Business Division Performance</div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Division</th>
                                    <th>Type</th>
                                    <th>Revenue</th>
                                    <th>Expenses</th>
                                    <th>Profit</th>
                                    <th>Margin</th>
                                    <th>Growth</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.data.divisions.map(d => {
                                    const profit = d.revenue - d.expenses;
                                    const margin = ((profit / d.revenue) * 100).toFixed(1);
                                    return `
                                    <tr>
                                        <td style="font-weight: 600;">${d.name}</td>
                                        <td><span class="badge badge-info">${d.type}</span></td>
                                        <td style="font-weight: 600; color: var(--accent-primary);">$${d.revenue.toLocaleString()}</td>
                                        <td>$${d.expenses.toLocaleString()}</td>
                                        <td style="font-weight: 600; color: var(--success);">$${profit.toLocaleString()}</td>
                                        <td>${margin}%</td>
                                        <td><span class="badge badge-success">â†‘ ${d.growth}%</span></td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // FINANCIALS
        function renderFinancials(container) {
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            
            // Initialize financial statements if not present
            if (!appState.data.financialStatements) {
                appState.data.financialStatements = {
                    profitAndLoss: {
                        revenue: { productSales: 0, serviceSales: 0, otherIncome: 0 },
                        costOfGoodsSold: { materials: 0, labor: 0, overhead: 0 },
                        operatingExpenses: { salesMarketing: 0, generalAdmin: 0, researchDev: 0, depreciation: 0 },
                        otherExpenses: { interestExpense: 0, taxes: 0, other: 0 }
                    },
                    cashFlow: {
                        operatingActivities: { netIncome: 0, depreciation: 0, changesInAR: 0, changesInAP: 0, changesInInventory: 0 },
                        investingActivities: { equipmentPurchases: 0, investments: 0, assetSales: 0 },
                        financingActivities: { loanProceeds: 0, loanRepayments: 0, equityIssuance: 0, dividends: 0 }
                    },
                    projections: {
                        nextQuarter: { projectedRevenue: 0, projectedExpenses: 0, projectedProfit: 0, assumptions: '' },
                        nextYear: { projectedRevenue: 0, projectedExpenses: 0, projectedProfit: 0, assumptions: '' },
                        threeYear: { projectedRevenue: 0, projectedExpenses: 0, projectedProfit: 0, assumptions: '' }
                    }
                };
            }
            
            const fs = appState.data.financialStatements;
            
            // Calculate P&L totals
            const totalPLRevenue = Object.values(fs.profitAndLoss.revenue).reduce((sum, val) => sum + val, 0);
            const totalCOGS = Object.values(fs.profitAndLoss.costOfGoodsSold).reduce((sum, val) => sum + val, 0);
            const grossProfit = totalPLRevenue - totalCOGS;
            const totalOpEx = Object.values(fs.profitAndLoss.operatingExpenses).reduce((sum, val) => sum + val, 0);
            const operatingIncome = grossProfit - totalOpEx;
            const totalOtherEx = Object.values(fs.profitAndLoss.otherExpenses).reduce((sum, val) => sum + val, 0);
            const netIncome = operatingIncome - totalOtherEx;
            
            // Calculate Cash Flow totals
            const operatingCash = Object.values(fs.cashFlow.operatingActivities).reduce((sum, val) => sum + val, 0);
            const investingCash = Object.values(fs.cashFlow.investingActivities).reduce((sum, val) => sum + val, 0);
            const financingCash = Object.values(fs.cashFlow.financingActivities).reduce((sum, val) => sum + val, 0);
            const netCashFlow = operatingCash + investingCash + financingCash;
            
            container.innerHTML = `
                ${renderGreetingSection()}
                
                <div class="stats-grid">
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownRevenue()">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Transaction Revenue</div>
                        <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                        <div class="stat-change positive">From transactions</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownExpenses()">
                        <div class="stat-icon">ðŸ’¸</div>
                        <div class="stat-label">Transaction Expenses</div>
                        <div class="stat-value">$${totalExpenses.toLocaleString()}</div>
                        <div class="stat-change negative">From transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-label">P&L Net Income</div>
                        <div class="stat-value" style="color: ${netIncome >= 0 ? 'var(--success)' : 'var(--danger)'};">$${netIncome.toLocaleString()}</div>
                        <div class="stat-change">From P&L statement</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’µ</div>
                        <div class="stat-label">Net Cash Flow</div>
                        <div class="stat-value" style="color: ${netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'};">$${netCashFlow.toLocaleString()}</div>
                        <div class="stat-change">From cash flow statement</div>
                    </div>
                </div>
                
                <!-- Profit & Loss Statement -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ðŸ“ˆ Profit & Loss Statement</span>
                        <button class="btn-secondary" onclick="saveProfitLoss()">ðŸ’¾ Save P&L</button>
                    </div>
                    
                    <div style="display: grid; gap: 24px; margin-top: 20px;">
                        <!-- Revenue Section -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">Revenue</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Product Sales:</label>
                                    <input type="number" id="pl_productSales" value="${fs.profitAndLoss.revenue.productSales}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Revenue from products</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Service Sales:</label>
                                    <input type="number" id="pl_serviceSales" value="${fs.profitAndLoss.revenue.serviceSales}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Revenue from services</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Other Income:</label>
                                    <input type="number" id="pl_otherIncome" value="${fs.profitAndLoss.revenue.otherIncome}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Other revenue sources</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700;">Total Revenue:</span>
                                    <span style="font-weight: 700; font-size: 20px; color: var(--accent-primary);">$${totalPLRevenue.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cost of Goods Sold -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-secondary);">Cost of Goods Sold (COGS)</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Materials:</label>
                                    <input type="number" id="pl_materials" value="${fs.profitAndLoss.costOfGoodsSold.materials}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Raw materials cost</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Direct Labor:</label>
                                    <input type="number" id="pl_labor" value="${fs.profitAndLoss.costOfGoodsSold.labor}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Production labor</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Manufacturing Overhead:</label>
                                    <input type="number" id="pl_overhead" value="${fs.profitAndLoss.costOfGoodsSold.overhead}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Overhead costs</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700;">Total COGS:</span>
                                    <span style="font-weight: 700; font-size: 20px; color: var(--danger);">$${totalCOGS.toLocaleString()}</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 2px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700; font-size: 18px;">Gross Profit:</span>
                                    <span style="font-weight: 700; font-size: 24px; color: ${grossProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${grossProfit.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operating Expenses -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-tertiary);">Operating Expenses</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Sales & Marketing:</label>
                                    <input type="number" id="pl_salesMarketing" value="${fs.profitAndLoss.operatingExpenses.salesMarketing}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">S&M expenses</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">General & Admin:</label>
                                    <input type="number" id="pl_generalAdmin" value="${fs.profitAndLoss.operatingExpenses.generalAdmin}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">G&A expenses</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Research & Development:</label>
                                    <input type="number" id="pl_researchDev" value="${fs.profitAndLoss.operatingExpenses.researchDev}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">R&D expenses</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Depreciation:</label>
                                    <input type="number" id="pl_depreciation" value="${fs.profitAndLoss.operatingExpenses.depreciation}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Asset depreciation</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700;">Total Operating Expenses:</span>
                                    <span style="font-weight: 700; font-size: 20px; color: var(--danger);">$${totalOpEx.toLocaleString()}</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 2px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700; font-size: 18px;">Operating Income:</span>
                                    <span style="font-weight: 700; font-size: 24px; color: ${operatingIncome >= 0 ? 'var(--success)' : 'var(--danger)'};">$${operatingIncome.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other Expenses -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--warning);">Other Expenses</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Interest Expense:</label>
                                    <input type="number" id="pl_interestExpense" value="${fs.profitAndLoss.otherExpenses.interestExpense}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Loan interest</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Taxes:</label>
                                    <input type="number" id="pl_taxes" value="${fs.profitAndLoss.otherExpenses.taxes}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Income taxes</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Other Expenses:</label>
                                    <input type="number" id="pl_other" value="${fs.profitAndLoss.otherExpenses.other}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Miscellaneous</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700;">Total Other Expenses:</span>
                                    <span style="font-weight: 700; font-size: 20px; color: var(--danger);">$${totalOtherEx.toLocaleString()}</span>
                                </div>
                                <div style="padding-top: 16px; border-top: 3px solid var(--accent-primary); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 16px; border-radius: 8px; margin-top: 8px;">
                                    <span style="font-weight: 800; font-size: 20px;">NET INCOME:</span>
                                    <span style="font-weight: 800; font-size: 28px; color: ${netIncome >= 0 ? 'var(--success)' : 'var(--danger)'};">$${netIncome.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cash Flow Statement -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ðŸ’µ Cash Flow Statement</span>
                        <button class="btn-secondary" onclick="saveCashFlow()">ðŸ’¾ Save Cash Flow</button>
                    </div>
                    
                    <div style="display: grid; gap: 24px; margin-top: 20px;">
                        <!-- Operating Activities -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">Operating Activities</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Net Income:</label>
                                    <input type="number" id="cf_netIncome" value="${fs.cashFlow.operatingActivities.netIncome}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">From P&L</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Depreciation/Amortization:</label>
                                    <input type="number" id="cf_depreciation" value="${fs.cashFlow.operatingActivities.depreciation}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Non-cash expense</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Changes in Accounts Receivable:</label>
                                    <input type="number" id="cf_changesInAR" value="${fs.cashFlow.operatingActivities.changesInAR}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">A/R changes</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Changes in Accounts Payable:</label>
                                    <input type="number" id="cf_changesInAP" value="${fs.cashFlow.operatingActivities.changesInAP}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">A/P changes</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Changes in Inventory:</label>
                                    <input type="number" id="cf_changesInInventory" value="${fs.cashFlow.operatingActivities.changesInInventory}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Inventory changes</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 2px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700; font-size: 16px;">Cash from Operations:</span>
                                    <span style="font-weight: 700; font-size: 22px; color: ${operatingCash >= 0 ? 'var(--success)' : 'var(--danger)'};">$${operatingCash.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Investing Activities -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-secondary);">Investing Activities</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Equipment Purchases:</label>
                                    <input type="number" id="cf_equipmentPurchases" value="${fs.cashFlow.investingActivities.equipmentPurchases}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">CapEx spending</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Investments:</label>
                                    <input type="number" id="cf_investments" value="${fs.cashFlow.investingActivities.investments}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Securities purchased</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Asset Sales:</label>
                                    <input type="number" id="cf_assetSales" value="${fs.cashFlow.investingActivities.assetSales}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Asset disposals</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 2px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700; font-size: 16px;">Cash from Investing:</span>
                                    <span style="font-weight: 700; font-size: 22px; color: ${investingCash >= 0 ? 'var(--success)' : 'var(--danger)'};">$${investingCash.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financing Activities -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-tertiary);">Financing Activities</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Loan Proceeds:</label>
                                    <input type="number" id="cf_loanProceeds" value="${fs.cashFlow.financingActivities.loanProceeds}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">New borrowings</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Loan Repayments:</label>
                                    <input type="number" id="cf_loanRepayments" value="${fs.cashFlow.financingActivities.loanRepayments}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Debt payments</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Equity Issuance:</label>
                                    <input type="number" id="cf_equityIssuance" value="${fs.cashFlow.financingActivities.equityIssuance}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Stock issued</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 250px 1fr 150px; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Dividends Paid:</label>
                                    <input type="number" id="cf_dividends" value="${fs.cashFlow.financingActivities.dividends}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                    <span style="color: var(--text-muted); font-size: 13px;">Dividends distributed</span>
                                </div>
                                <div style="padding-top: 12px; border-top: 2px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 700; font-size: 16px;">Cash from Financing:</span>
                                    <span style="font-weight: 700; font-size: 22px; color: ${financingCash >= 0 ? 'var(--success)' : 'var(--danger)'};">$${financingCash.toLocaleString()}</span>
                                </div>
                                <div style="padding-top: 16px; border-top: 3px solid var(--accent-primary); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 16px; border-radius: 8px; margin-top: 8px;">
                                    <span style="font-weight: 800; font-size: 20px;">NET CASH FLOW:</span>
                                    <span style="font-weight: 800; font-size: 28px; color: ${netCashFlow >= 0 ? 'var(--success)' : 'var(--danger)'};">$${netCashFlow.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Projections -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ðŸ”® Financial Projections</span>
                        <button class="btn-secondary" onclick="saveProjections()">ðŸ’¾ Save Projections</button>
                    </div>
                    
                    <div style="display: grid; gap: 24px; margin-top: 20px;">
                        <!-- Next Quarter -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">Next Quarter Projection</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Revenue:</label>
                                    <input type="number" id="proj_q_revenue" value="${fs.projections.nextQuarter.projectedRevenue}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Expenses:</label>
                                    <input type="number" id="proj_q_expenses" value="${fs.projections.nextQuarter.projectedExpenses}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Profit:</label>
                                    <input type="number" id="proj_q_profit" value="${fs.projections.nextQuarter.projectedProfit}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px;">
                                    <label style="color: var(--text-secondary); align-self: start;">Assumptions:</label>
                                    <textarea id="proj_q_assumptions" rows="3" 
                                              style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary); resize: vertical;">${fs.projections.nextQuarter.assumptions}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Next Year -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-secondary);">Next Year Projection</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Revenue:</label>
                                    <input type="number" id="proj_y_revenue" value="${fs.projections.nextYear.projectedRevenue}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Expenses:</label>
                                    <input type="number" id="proj_y_expenses" value="${fs.projections.nextYear.projectedExpenses}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Profit:</label>
                                    <input type="number" id="proj_y_profit" value="${fs.projections.nextYear.projectedProfit}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px;">
                                    <label style="color: var(--text-secondary); align-self: start;">Assumptions:</label>
                                    <textarea id="proj_y_assumptions" rows="3" 
                                              style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary); resize: vertical;">${fs.projections.nextYear.assumptions}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Three Year -->
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-tertiary);">Three Year Projection</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Revenue:</label>
                                    <input type="number" id="proj_3y_revenue" value="${fs.projections.threeYear.projectedRevenue}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Expenses:</label>
                                    <input type="number" id="proj_3y_expenses" value="${fs.projections.threeYear.projectedExpenses}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px; align-items: center;">
                                    <label style="color: var(--text-secondary);">Projected Profit:</label>
                                    <input type="number" id="proj_3y_profit" value="${fs.projections.threeYear.projectedProfit}" 
                                           style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 12px;">
                                    <label style="color: var(--text-secondary); align-self: start;">Assumptions:</label>
                                    <textarea id="proj_3y_assumptions" rows="3" 
                                              style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-primary); resize: vertical;">${fs.projections.threeYear.assumptions}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // OPERATIONAL BUDGETS
        function renderBudgets(container) {
            if (!appState.data.budgets) {
                initializeBudgets();
            }
            
            const budgets = appState.data.budgets;
            
            // Calculate totals for each category
            const calculateCategoryTotals = (categoryItems) => {
                const allocated = categoryItems.reduce((sum, item) => sum + (item.allocated || 0), 0);
                const spent = categoryItems.reduce((sum, item) => sum + (item.spent || 0), 0);
                const remaining = allocated - spent;
                const percentage = allocated > 0 ? (spent / allocated * 100) : 0;
                return { allocated, spent, remaining, percentage };
            };
            
            const operationalTotals = calculateCategoryTotals(budgets.operational);
            const marketingTotals = calculateCategoryTotals(budgets.marketing);
            const sgaTotals = calculateCategoryTotals(budgets.sga);
            const grandTotal = {
                allocated: operationalTotals.allocated + marketingTotals.allocated + sgaTotals.allocated,
                spent: operationalTotals.spent + marketingTotals.spent + sgaTotals.spent,
                remaining: operationalTotals.remaining + marketingTotals.remaining + sgaTotals.remaining
            };
            grandTotal.percentage = grandTotal.allocated > 0 ? (grandTotal.spent / grandTotal.allocated * 100) : 0;
            
            const getStatusColor = (percentage) => {
                if (percentage >= 90) return 'var(--danger)';
                if (percentage >= 75) return 'var(--warning)';
                return 'var(--success)';
            };
            
            const getStatusIcon = (percentage) => {
                if (percentage >= 90) return 'ðŸ”´';
                if (percentage >= 75) return 'ðŸŸ¡';
                return 'ðŸŸ¢';
            };
            
            const renderBudgetCategory = (title, items, categoryKey, totals) => {
                return `
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 700; font-size: 22px; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Budget allocated: $${totals.allocated.toLocaleString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 32px; font-weight: 800; color: ${getStatusColor(totals.percentage)}; margin-bottom: 4px;">
                                    ${getStatusIcon(totals.percentage)} ${totals.percentage.toFixed(1)}%
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    $${totals.remaining.toLocaleString()} remaining
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                            ${items.map((item, index) => {
                                const itemPercentage = item.allocated > 0 ? (item.spent / item.allocated * 100) : 0;
                                const itemRemaining = item.allocated - item.spent;
                                return `
                                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.4), rgba(10,14,26,0.2)); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--glass-border)'">
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 100px 80px; gap: 16px; align-items: center;">
                                            <div>
                                                <div style="font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px;">${item.name}</div>
                                                <div style="font-size: 12px; color: var(--text-muted);">${item.description || 'No description'}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ALLOCATED</div>
                                                <div style="font-weight: 700; font-size: 16px; color: var(--text-secondary);">$${item.allocated.toLocaleString()}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">SPENT</div>
                                                <div style="font-weight: 700; font-size: 16px; color: ${getStatusColor(itemPercentage)}">$${item.spent.toLocaleString()}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">REMAINING</div>
                                                <div style="font-weight: 700; font-size: 16px; color: ${itemRemaining > 0 ? 'var(--success)' : 'var(--danger)'}">$${itemRemaining.toLocaleString()}</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 24px; font-weight: 800; color: ${getStatusColor(itemPercentage)}">${getStatusIcon(itemPercentage)} ${itemPercentage.toFixed(0)}%</div>
                                            </div>
                                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                                <button onclick="editBudgetItem('${categoryKey}', ${index})" style="padding: 8px 12px; background: var(--accent-tertiary); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='var(--accent-primary)'" onmouseout="this.style.background='var(--accent-tertiary)'">âœï¸</button>
                                                <button onclick="deleteBudgetItem('${categoryKey}', ${index})" style="padding: 8px 12px; background: var(--danger); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">ðŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${Math.min(itemPercentage, 100)}%; height: 100%; background: linear-gradient(90deg, ${getStatusColor(itemPercentage)}, ${getStatusColor(itemPercentage)}); transition: width 0.3s ease;"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="addBudgetItem('${categoryKey}')" class="btn btn-secondary" style="flex: 1;">
                                âž• Add ${title} Item
                            </button>
                            <button onclick="replenishBudget('${categoryKey}')" class="btn btn-primary" style="flex: 1;">
                                ðŸ’° Replenish Budget
                            </button>
                        </div>
                    </div>
                `;
            };
            
            container.innerHTML = `
                <!-- Grand Total Overview -->
                <div class="card" style="margin-bottom: 32px; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); border: 2px solid var(--accent-primary);">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 16px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 2px;">Total Budget Overview</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">TOTAL ALLOCATED</div>
                                <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary);">$${grandTotal.allocated.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">TOTAL SPENT</div>
                                <div style="font-size: 32px; font-weight: 800; color: ${getStatusColor(grandTotal.percentage)}">$${grandTotal.spent.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">REMAINING</div>
                                <div style="font-size: 32px; font-weight: 800; color: ${grandTotal.remaining > 0 ? 'var(--success)' : 'var(--danger)'}">$${grandTotal.remaining.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">UTILIZED</div>
                                <div style="font-size: 32px; font-weight: 800; color: ${getStatusColor(grandTotal.percentage)}">${getStatusIcon(grandTotal.percentage)} ${grandTotal.percentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div style="width: 100%; height: 16px; background: var(--bg-secondary); border-radius: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                            <div style="width: ${Math.min(grandTotal.percentage, 100)}%; height: 100%; background: linear-gradient(90deg, var(--success), ${getStatusColor(grandTotal.percentage)}); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Operational Expenses -->
                ${renderBudgetCategory('ðŸ’» Operational Expenses', budgets.operational, 'operational', operationalTotals)}
                
                <!-- Marketing Expenses -->
                ${renderBudgetCategory('ðŸ“¢ Marketing Expenses', budgets.marketing, 'marketing', marketingTotals)}
                
                <!-- SG&A Expenses -->
                ${renderBudgetCategory('ðŸ¢ Selling, General & Administrative (SG&A)', budgets.sga, 'sga', sgaTotals)}
            `;
        }
        
        function initializeBudgets() {
            appState.data.budgets = {
                operational: [
                    { name: 'Cloud Infrastructure & Hosting', description: 'AWS, Azure, GCP hosting costs', allocated: 50000, spent: 38500 },
                    { name: 'Software & Development Tools', description: 'GitHub, IDEs, development software', allocated: 25000, spent: 18750 },
                    { name: 'Customer Support Tools', description: 'Zendesk, Intercom, support systems', allocated: 15000, spent: 12000 },
                    { name: 'Development & Engineering', description: 'R&D, feature development', allocated: 120000, spent: 95000 },
                    { name: 'Data Storage & Bandwidth', description: 'S3, CDN, data transfer costs', allocated: 30000, spent: 22500 },
                    { name: 'Security & Compliance', description: 'Security audits, compliance certifications', allocated: 20000, spent: 15000 }
                ],
                marketing: [
                    { name: 'Digital Advertising', description: 'Google Ads, Facebook Ads, LinkedIn', allocated: 80000, spent: 72000 },
                    { name: 'Content Marketing', description: 'Blog, videos, content creation', allocated: 35000, spent: 28000 },
                    { name: 'SEO/SEM', description: 'Search optimization, paid search', allocated: 25000, spent: 19500 },
                    { name: 'Events & Conferences', description: 'Trade shows, sponsorships', allocated: 45000, spent: 32000 },
                    { name: 'Marketing Tools & Software', description: 'HubSpot, analytics, automation tools', allocated: 20000, spent: 18000 },
                    { name: 'Brand & Creative', description: 'Design, branding, creative assets', allocated: 30000, spent: 22500 }
                ],
                sga: [
                    { name: 'Salaries & Benefits', description: 'Employee compensation, benefits', allocated: 450000, spent: 375000 },
                    { name: 'Office & Facilities', description: 'Rent, utilities, office supplies', allocated: 60000, spent: 50000 },
                    { name: 'Professional Services', description: 'Legal, accounting, consulting', allocated: 40000, spent: 32000 },
                    { name: 'Insurance', description: 'Business, liability, health insurance', allocated: 35000, spent: 29000 },
                    { name: 'Travel & Entertainment', description: 'Business travel, client entertainment', allocated: 25000, spent: 18500 },
                    { name: 'Administrative Software', description: 'HR software, payroll, admin tools', allocated: 15000, spent: 12750 }
                ]
            };
            saveData();
        }
        
        function addBudgetItem(category) {
            const categoryNames = {
                operational: 'Operational',
                marketing: 'Marketing',
                sga: 'SG&A'
            };
            
            const formHTML = `
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Item Name *</label>
                        <input type="text" id="budget_name" placeholder="e.g., Cloud Infrastructure" 
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Description</label>
                        <textarea id="budget_description" rows="3" placeholder="Brief description of this budget item" 
                                  style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Allocated Budget *</label>
                            <input type="number" id="budget_allocated" placeholder="0" min="0" step="100"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Current Spent</label>
                            <input type="number" id="budget_spent" placeholder="0" min="0" step="100" value="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                    </div>
                    <button onclick="saveBudgetItem('${category}')" class="btn btn-primary" style="margin-top: 8px;">
                        âž• Add Budget Item
                    </button>
                </div>
            `;
            
            showModal(`Add ${categoryNames[category]} Budget Item`, formHTML);
        }
        
        function saveBudgetItem(category) {
            const name = document.getElementById('budget_name').value.trim();
            const description = document.getElementById('budget_description').value.trim();
            const allocated = parseFloat(document.getElementById('budget_allocated').value) || 0;
            const spent = parseFloat(document.getElementById('budget_spent').value) || 0;
            
            if (!name) {
                showToast('Please enter an item name');
                return;
            }
            
            if (allocated <= 0) {
                showToast('Please enter an allocated budget amount');
                return;
            }
            
            const newItem = {
                name,
                description,
                allocated,
                spent
            };
            
            appState.data.budgets[category].push(newItem);
            saveData();
            closeModal();
            switchSection('budgets');
            showToast(`Budget item "${name}" added successfully!`);
            addRecentActivity('budget', `Added budget item: ${name}`, `$${allocated.toLocaleString()} allocated`, 'success');
        }
        
        function editBudgetItem(category, index) {
            const item = appState.data.budgets[category][index];
            
            const categoryNames = {
                operational: 'Operational',
                marketing: 'Marketing',
                sga: 'SG&A'
            };
            
            const formHTML = `
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Item Name *</label>
                        <input type="text" id="budget_name" value="${item.name}" 
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Description</label>
                        <textarea id="budget_description" rows="3" 
                                  style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); resize: vertical;">${item.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Allocated Budget *</label>
                            <input type="number" id="budget_allocated" value="${item.allocated}" min="0" step="100"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Current Spent</label>
                            <input type="number" id="budget_spent" value="${item.spent}" min="0" step="100"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                    </div>
                    <button onclick="updateBudgetItem('${category}', ${index})" class="btn btn-primary" style="margin-top: 8px;">
                        ðŸ’¾ Save Changes
                    </button>
                </div>
            `;
            
            showModal(`Edit ${categoryNames[category]} Budget Item`, formHTML);
        }
        
        function updateBudgetItem(category, index) {
            const name = document.getElementById('budget_name').value.trim();
            const description = document.getElementById('budget_description').value.trim();
            const allocated = parseFloat(document.getElementById('budget_allocated').value) || 0;
            const spent = parseFloat(document.getElementById('budget_spent').value) || 0;
            
            if (!name) {
                showToast('Please enter an item name');
                return;
            }
            
            if (allocated <= 0) {
                showToast('Please enter an allocated budget amount');
                return;
            }
            
            appState.data.budgets[category][index] = {
                name,
                description,
                allocated,
                spent
            };
            
            saveData();
            closeModal();
            switchSection('budgets');
            showToast(`Budget item "${name}" updated successfully!`);
            addRecentActivity('budget', `Updated budget item: ${name}`, `$${allocated.toLocaleString()} allocated`, 'info');
        }
        
        function deleteBudgetItem(category, index) {
            const item = appState.data.budgets[category][index];
            
            if (confirm(`Are you sure you want to delete "${item.name}"?`)) {
                appState.data.budgets[category].splice(index, 1);
                saveData();
                switchSection('budgets');
                showToast(`Budget item "${item.name}" deleted`);
                addRecentActivity('budget', `Deleted budget item: ${item.name}`, '', 'warning');
            }
        }
        
        function replenishBudget(category) {
            const categoryNames = {
                operational: 'Operational Expenses',
                marketing: 'Marketing Expenses',
                sga: 'SG&A Expenses'
            };
            
            const currentTotal = appState.data.budgets[category].reduce((sum, item) => sum + item.allocated, 0);
            
            const formHTML = `
                <div style="display: grid; gap: 16px;">
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">CURRENT TOTAL BUDGET</div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--accent-primary);">$${currentTotal.toLocaleString()}</div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Replenishment Amount *</label>
                        <input type="number" id="replenish_amount" placeholder="0" min="0" step="1000"
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Enter the additional budget amount to add to this category</div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Distribution Method</label>
                        <select id="replenish_method" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                            <option value="proportional">Proportional (based on current allocations)</option>
                            <option value="equal">Equal (distribute evenly across all items)</option>
                            <option value="new">New Item (create a new budget item)</option>
                        </select>
                    </div>
                    
                    <div id="new_item_fields" style="display: none; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--glass-border);">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">New Item Name</label>
                        <input type="text" id="new_item_name" placeholder="e.g., Additional Cloud Infrastructure" 
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    
                    <button onclick="saveReplenishment('${category}')" class="btn btn-primary" style="margin-top: 8px; font-size: 16px;">
                        ðŸ’° Replenish ${categoryNames[category]} Budget
                    </button>
                </div>
            `;
            
            showModal(`ðŸ’° Replenish ${categoryNames[category]} Budget`, formHTML);
            
            // Add event listener after modal is shown
            setTimeout(() => {
                const methodSelect = document.getElementById('replenish_method');
                if (methodSelect) {
                    methodSelect.addEventListener('change', function(e) {
                        const newItemFields = document.getElementById('new_item_fields');
                        if (newItemFields) {
                            if (e.target.value === 'new') {
                                newItemFields.style.display = 'block';
                            } else {
                                newItemFields.style.display = 'none';
                            }
                        }
                    });
                }
            }, 100);
        }
        
        function saveReplenishment(category) {
            const amount = parseFloat(document.getElementById('replenish_amount').value) || 0;
            const method = document.getElementById('replenish_method').value;
            
            if (amount <= 0) {
                showToast('Please enter a replenishment amount');
                return;
            }
            
            const categoryNames = {
                operational: 'Operational Expenses',
                marketing: 'Marketing Expenses',
                sga: 'SG&A Expenses'
            };
            
            if (method === 'new') {
                const newItemName = document.getElementById('new_item_name').value.trim();
                if (!newItemName) {
                    showToast('Please enter a name for the new budget item');
                    return;
                }
                
                appState.data.budgets[category].push({
                    name: newItemName,
                    description: 'Budget replenishment item',
                    allocated: amount,
                    spent: 0
                });
            } else if (method === 'equal') {
                const itemCount = appState.data.budgets[category].length;
                const amountPerItem = amount / itemCount;
                
                appState.data.budgets[category].forEach(item => {
                    item.allocated += amountPerItem;
                });
            } else if (method === 'proportional') {
                const totalAllocated = appState.data.budgets[category].reduce((sum, item) => sum + item.allocated, 0);
                
                appState.data.budgets[category].forEach(item => {
                    const proportion = item.allocated / totalAllocated;
                    item.allocated += (amount * proportion);
                });
            }
            
            saveData();
            closeModal();
            switchSection('budgets');
            showToast(`${categoryNames[category]} budget replenished by $${amount.toLocaleString()}!`);
            addRecentActivity('budget', `Replenished ${categoryNames[category]}`, `Added $${amount.toLocaleString()}`, 'success');
        }

        // TRANSACTIONS
        function renderTransactions(container) {
            const revenues = appState.data.transactions.filter(t => t.amount > 0);
            const expenses = appState.data.transactions.filter(t => t.amount < 0);
            
            container.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h2>Transactions</h2>
                    </div>
                    <div class="header-actions" style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="showImportTransactionsCSV()">ðŸ“¥ Import CSV</button>
                        <button class="btn btn-primary" onclick="showAddTransaction()">âž• Add Transaction</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-title">Revenue Trends</div>
                        <div style="margin-top: 20px;">
                            <canvas id="revenueLineChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Expense Trends</div>
                        <div style="margin-top: 20px;">
                            <canvas id="expenseLineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-title">Revenue by Category</div>
                        <div style="margin-top: 20px;">
                            <canvas id="revenueBarChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Expenses by Category</div>
                        <div style="margin-top: 20px;">
                            <canvas id="expenseBarChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Sub-Category</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.data.transactions.map(t => `
                                    <tr>
                                        <td>${t.date}</td>
                                        <td><strong>${t.description}</strong></td>
                                        <td><span class="badge ${t.amount > 0 || (t.type && t.type === 'Revenue') ? 'badge-success' : 'badge-danger'}">${t.type || (t.amount > 0 ? 'Revenue' : 'Expenses')}</span></td>
                                        <td><span class="badge badge-info">${t.category}</span></td>
                                        <td style="color: ${t.amount > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">
                                            ${t.amount > 0 ? '+' : ''}$${Math.abs(t.amount).toLocaleString()}
                                        </td>
                                        <td>
                                            <button class="action-btn" onclick="editTransaction(${t.id})" style="background: var(--accent-tertiary); margin-right: 8px;">Edit</button>
                                            <button class="action-btn delete" onclick="deleteTransaction(${t.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Render revenue line chart
            setTimeout(() => {
                const revenueLineCtx = document.getElementById('revenueLineChart');
                if (revenueLineCtx) {
                    const revenueByMonth = {};
                    revenues.forEach(t => {
                        const month = t.date.substring(0, 7);
                        revenueByMonth[month] = (revenueByMonth[month] || 0) + t.amount;
                    });
                    
                    new Chart(revenueLineCtx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(revenueByMonth).sort(),
                            datasets: [{
                                label: 'Revenue',
                                data: Object.values(revenueByMonth),
                                borderColor: 'rgba(110, 231, 183, 1)',
                                backgroundColor: 'rgba(110, 231, 183, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                            }
                        }
                    });
                }

                // Render expense line chart
                const expenseLineCtx = document.getElementById('expenseLineChart');
                if (expenseLineCtx) {
                    const expenseByMonth = {};
                    expenses.forEach(t => {
                        const month = t.date.substring(0, 7);
                        expenseByMonth[month] = (expenseByMonth[month] || 0) + Math.abs(t.amount);
                    });
                    
                    new Chart(expenseLineCtx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(expenseByMonth).sort(),
                            datasets: [{
                                label: 'Expenses',
                                data: Object.values(expenseByMonth),
                                borderColor: 'rgba(255, 107, 107, 1)',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                            }
                        }
                    });
                }

                // Render revenue bar chart
                const revenueBarCtx = document.getElementById('revenueBarChart');
                if (revenueBarCtx) {
                    const revenueByCategory = {};
                    revenues.forEach(t => {
                        revenueByCategory[t.category] = (revenueByCategory[t.category] || 0) + t.amount;
                    });
                    
                    new Chart(revenueBarCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(revenueByCategory),
                            datasets: [{
                                label: 'Revenue',
                                data: Object.values(revenueByCategory),
                                backgroundColor: 'rgba(110, 231, 183, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                            }
                        }
                    });
                }

                // Render expense bar chart
                const expenseBarCtx = document.getElementById('expenseBarChart');
                if (expenseBarCtx) {
                    const expenseByCategory = {};
                    expenses.forEach(t => {
                        expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Math.abs(t.amount);
                    });
                    
                    new Chart(expenseBarCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(expenseByCategory),
                            datasets: [{
                                label: 'Expenses',
                                data: Object.values(expenseByCategory),
                                backgroundColor: 'rgba(255, 107, 107, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                            }
                        }
                    });
                }
            }, 100);
        }

        // DIVISIONS

        function showDivisionStrategy(divisionId) {
            const division = appState.data.divisions.find(d => d.id === divisionId);
            if (!division) return;

            const modalContent = `
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 24px; font-weight: 800; color: var(--accent-primary); margin-bottom: 8px;">
                        ${division.fullName}
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted);">
                        ${division.description}
                    </div>
                </div>

                <div style="display: grid; gap: 24px;">
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--accent-primary);">ðŸŽ¯ Mission</div>
                            <button class="btn-secondary" onclick="editDivisionField(${divisionId}, 'mission')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                        </div>
                        <div id="mission_display_${divisionId}" style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            ${division.mission || 'No mission statement defined'}
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--accent-secondary);">ðŸ”® Vision</div>
                            <button class="btn-secondary" onclick="editDivisionField(${divisionId}, 'vision')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                        </div>
                        <div id="vision_display_${divisionId}" style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            ${division.vision || 'No vision statement defined'}
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--accent-tertiary);">ðŸ’¡ Value Proposition</div>
                            <button class="btn-secondary" onclick="editDivisionField(${divisionId}, 'valueProposition')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                        </div>
                        <div id="valueProposition_display_${divisionId}" style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            ${division.valueProposition || 'No value proposition defined'}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                    <button class="btn-primary" onclick="editDivision(${appState.data.divisions.findIndex(d => d.id === divisionId)})" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>âœï¸</span> Edit Division
                    </button>
                    <button class="btn-secondary" onclick="toggleDivisionStatus(${appState.data.divisions.findIndex(d => d.id === divisionId)})" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>${division.status === 'Active' ? 'â¸ï¸' : 'â–¶ï¸'}</span> 
                        ${division.status === 'Active' ? 'Disable' : 'Enable'}
                    </button>
                </div>
                <button class="btn-secondary" onclick="closeModal()" style="width: 100%; margin-top: 12px;">Close</button>
            `;

            showModal(`${division.fullName} - Strategic Overview`, modalContent);
        }

        function editDivisionField(divisionId, field) {
            const division = appState.data.divisions.find(d => d.id === divisionId);
            if (!division) return;

            const fieldNames = {
                'mission': 'Mission Statement',
                'vision': 'Vision Statement',
                'valueProposition': 'Value Proposition'
            };

            const formHTML = `
                <form onsubmit="saveDivisionField(event, ${divisionId}, '${field}')" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">
                            ${fieldNames[field]}
                        </label>
                        <textarea id="field_value" rows="4" required
                                  style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; font-family: inherit; line-height: 1.6;"
                        >${division[field] || ''}</textarea>
                    </div>
                    <button type="submit" class="btn-primary">Save</button>
                </form>
            `;

            showModal(`Edit ${fieldNames[field]} - ${division.fullName}`, formHTML);
        }

        function saveDivisionField(event, divisionId, field) {
            event.preventDefault();
            const division = appState.data.divisions.find(d => d.id === divisionId);
            if (!division) return;

            division[field] = document.getElementById('field_value').value;
            saveData();
            closeModal();
            showToast(`âœ“ ${field} updated successfully!`, 'success');
            setTimeout(() => showDivisionStrategy(divisionId), 100);
        }
        function renderDivisions(container) {
            const totalRevenue = appState.data.divisions.reduce((sum, d) => sum + d.revenue, 0);
            const totalExpenses = appState.data.divisions.reduce((sum, d) => sum + d.expenses, 0);
            const totalEmployees = appState.data.divisions.reduce((sum, d) => sum + d.employees, 0);
            const totalProfit = totalRevenue - totalExpenses;
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value">$${(totalRevenue/1000).toFixed(1)}K</div>
                        <div class="stat-change positive">All divisions combined</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-label">Total Profit</div>
                        <div class="stat-value">$${(totalProfit/1000).toFixed(1)}K</div>
                        <div class="stat-change positive">â†‘ ${((totalProfit/totalRevenue)*100).toFixed(1)}% margin</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-label">Total Team</div>
                        <div class="stat-value">${totalEmployees}</div>
                        <div class="stat-change">Employees across divisions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ¢</div>
                        <div class="stat-label">Active Divisions</div>
                        <div class="stat-value">${appState.data.divisions.length}</div>
                        <div class="stat-change positive">All operational</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div class="card-title">Business Divisions Overview</div>
                        <button class="btn-primary" onclick="showAddDivision()">+ Add Division</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 32px;">
                        ${appState.data.divisions.map((d, index) => {
                            const profit = d.revenue - d.expenses;
                            const profitMargin = ((profit / d.revenue) * 100).toFixed(1);
                            const revenuePerEmployee = (d.revenue / d.employees).toFixed(0);
                            
                            return `
                            <div class="division-card" style="background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.4)); 
                                 border: 1px solid var(--glass-border); border-radius: 16px; padding: 24px; 
                                 transition: all 0.3s ease; cursor: pointer;" 
                                 onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)'; this.style.borderColor='var(--accent-primary)';"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='var(--glass-border)';">
                                
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">
                                            ${d.name}
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                            ${d.fullName}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${d.description}
                                        </div>
                                    </div>
                                    <span class="badge badge-success">${d.status}</span>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                                    <div style="background: var(--bg-glass); padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Revenue</div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">
                                            $${(d.revenue/1000).toFixed(1)}K
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            MRR: $${(d.mrr/1000).toFixed(1)}K
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-glass); padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Profit</div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--success);">
                                            $${(profit/1000).toFixed(1)}K
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            ${profitMargin}% margin
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-glass); padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Growth</div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-gold);">
                                            +${d.growth}%
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            Year over year
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-glass); padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Customers</div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-tertiary);">
                                            ${d.customers}
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            Active accounts
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; color: var(--text-muted);">Team Size</div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                            ${d.employees} employees
                                        </div>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; color: var(--text-muted);">Rev/Employee</div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                            $${parseInt(revenuePerEmployee).toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); viewDivisionDetails(${index})" 
                                            style="width: 100%; padding: 10px; font-size: 13px;">
                                        View Detailed Analytics â†’
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Division Performance Comparison</div>
                    <div style="margin-top: 24px;">
                        <canvas id="divisionsChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Revenue Distribution</div>
                    <div style="display: grid; gap: 12px; margin-top: 20px;">
                        ${appState.data.divisions.map(d => {
                            const percentage = ((d.revenue / totalRevenue) * 100).toFixed(1);
                            return `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <div>
                                        <span style="font-weight: 600; font-size: 16px;">${d.name}</span>
                                        <span style="color: var(--text-muted); font-size: 13px; margin-left: 8px;">
                                            $${(d.revenue/1000).toFixed(1)}K
                                        </span>
                                    </div>
                                    <span style="font-weight: 700; color: var(--accent-primary); font-size: 16px;">
                                        ${percentage}%
                                    </span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;

            // Render chart
            setTimeout(() => {
                const ctx = document.getElementById('divisionsChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: appState.data.divisions.map(d => d.name),
                            datasets: [
                                {
                                    label: 'Revenue',
                                    data: appState.data.divisions.map(d => d.revenue / 1000),
                                    backgroundColor: 'rgba(110, 231, 183, 0.6)',
                                    borderColor: 'rgba(110, 231, 183, 1)',
                                    borderWidth: 2
                                },
                                {
                                    label: 'Expenses',
                                    data: appState.data.divisions.map(d => d.expenses / 1000),
                                    backgroundColor: 'rgba(255, 107, 107, 0.6)',
                                    borderColor: 'rgba(255, 107, 107, 1)',
                                    borderWidth: 2
                                },
                                {
                                    label: 'Profit',
                                    data: appState.data.divisions.map(d => (d.revenue - d.expenses) / 1000),
                                    backgroundColor: 'rgba(96, 165, 250, 0.6)',
                                    borderColor: 'rgba(96, 165, 250, 1)',
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#94a3b8' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#94a3b8',
                                        callback: value => '$' + value + 'K'
                                    },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        function showAddDivision() {
            const formHTML = `
                <form onsubmit="handleDivisionSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Division Name</label>
                            <input type="text" id="division_name" required placeholder="New Division"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Full Name</label>
                            <input type="text" id="division_fullName" required placeholder="Full Product Name"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <input type="text" id="division_description" required placeholder="Brief description"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Revenue ($)</label>
                            <input type="number" id="division_revenue" required min="0" value="50000"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Expenses ($)</label>
                            <input type="number" id="division_expenses" required min="0" value="15000"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">MRR ($)</label>
                            <input type="number" id="division_mrr" required min="0" value="16667"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Employees</label>
                            <input type="number" id="division_employees" required min="1" value="5"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customers</label>
                            <input type="number" id="division_customers" required min="0" value="200"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Growth Rate (%)</label>
                            <input type="number" id="division_growth" required step="0.1" value="15.0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Create Division</button>
                </form>
            `;
            showModal('Add New Division', formHTML);
        }

        function handleDivisionSubmit(event) {
            event.preventDefault();
            const newDivision = {
                id: Date.now(),
                name: document.getElementById('division_name').value,
                fullName: document.getElementById('division_fullName').value,
                description: document.getElementById('division_description').value,
                type: 'Product',
                revenue: parseInt(document.getElementById('division_revenue').value),
                expenses: parseInt(document.getElementById('division_expenses').value),
                mrr: parseInt(document.getElementById('division_mrr').value),
                employees: parseInt(document.getElementById('division_employees').value),
                customers: parseInt(document.getElementById('division_customers').value),
                growth: parseFloat(document.getElementById('division_growth').value),
                status: 'Active'
            };
            appState.data.divisions.push(newDivision);
            saveData();
            closeModal();
            showToast('Division created successfully!');
            switchSection('divisions');
        }

        function viewDivisionDetails(index) {
            const division = appState.data.divisions[index];
            const profit = division.revenue - division.expenses;
            const profitMargin = ((profit / division.revenue) * 100).toFixed(1);
            const revenuePerEmployee = (division.revenue / division.employees).toFixed(0);
            const revenuePerCustomer = (division.revenue / division.customers).toFixed(0);

            const modalContent = `
                <div style="display: grid; gap: 20px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                         border-radius: 12px; border: 1px solid var(--glass-border);">
                        <h2 style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 8px;">
                            ${division.name}
                        </h2>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 4px;">
                            ${division.fullName}
                        </div>
                        <div style="font-size: 14px; color: var(--text-muted);">
                            ${division.description}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Monthly Revenue</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">
                                $${(division.revenue/1000).toFixed(1)}K
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                MRR: $${(division.mrr/1000).toFixed(1)}K
                            </div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Net Profit</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">
                                $${(profit/1000).toFixed(1)}K
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                ${profitMargin}% margin
                            </div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Growth Rate</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-gold);">
                                +${division.growth}%
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                Year over year
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600;">Team Metrics</div>
                            <div style="display: grid; gap: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Team Size:</span>
                                    <span style="font-weight: 600;">${division.employees} employees</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Revenue per Employee:</span>
                                    <span style="font-weight: 600; color: var(--accent-primary);">$${parseInt(revenuePerEmployee).toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Monthly Expenses:</span>
                                    <span style="font-weight: 600;">$${(division.expenses/1000).toFixed(1)}K</span>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600;">Customer Metrics</div>
                            <div style="display: grid; gap: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Active Customers:</span>
                                    <span style="font-weight: 600;">${division.customers}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Revenue per Customer:</span>
                                    <span style="font-weight: 600; color: var(--accent-primary);">$${parseInt(revenuePerCustomer).toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Status:</span>
                                    <span class="badge badge-success">${division.status}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); 
                         border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600;">Financial Summary</div>
                        <div style="display: grid; gap: 8px;">
                            <div class="progress-bar" style="margin-bottom: 4px;">
                                <div class="progress-fill" style="width: ${profitMargin}%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: var(--text-secondary);">Profit Margin:</span>
                                <span style="font-weight: 600; color: var(--success);">${profitMargin}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; padding-top: 8px; border-top: 1px solid var(--glass-border);">
                                <span style="color: var(--text-secondary);">Annual Revenue Projection:</span>
                                <span style="font-weight: 600; color: var(--accent-primary);">$${((division.revenue * 12)/1000).toFixed(1)}K</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                        <button class="btn-primary" onclick="editDivision(${index})" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>âœï¸</span> Edit Division
                        </button>
                        <button class="btn-secondary" onclick="toggleDivisionStatus(${index})" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>${division.status === 'Active' ? 'â¸ï¸' : 'â–¶ï¸'}</span> 
                            ${division.status === 'Active' ? 'Disable' : 'Enable'}
                        </button>
                    </div>
                </div>
            `;
            showModal(`${division.name} - Detailed Analytics`, modalContent);
        }

        function editDivision(index) {
            const division = appState.data.divisions[index];
            
            const formHTML = `
                <form onsubmit="saveDivisionEdit(event, ${index})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Short Name</label>
                            <input type="text" id="edit_division_name" value="${division.name}" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Full Name</label>
                            <input type="text" id="edit_division_fullName" value="${division.fullName}" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <input type="text" id="edit_division_description" value="${division.description}" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Revenue ($)</label>
                            <input type="number" id="edit_division_revenue" value="${division.revenue}" required min="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Expenses ($)</label>
                            <input type="number" id="edit_division_expenses" value="${division.expenses}" required min="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">MRR ($)</label>
                            <input type="number" id="edit_division_mrr" value="${division.mrr}" required min="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Employees</label>
                            <input type="number" id="edit_division_employees" value="${division.employees}" required min="1"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customers</label>
                            <input type="number" id="edit_division_customers" value="${division.customers}" required min="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Growth Rate (%)</label>
                            <input type="number" id="edit_division_growth" value="${division.growth}" required step="0.1"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </form>
            `;
            
            showModal(`Edit ${division.name}`, formHTML);
        }

        function saveDivisionEdit(event, index) {
            event.preventDefault();
            const division = appState.data.divisions[index];
            
            division.name = document.getElementById('edit_division_name').value;
            division.fullName = document.getElementById('edit_division_fullName').value;
            division.description = document.getElementById('edit_division_description').value;
            division.revenue = parseInt(document.getElementById('edit_division_revenue').value);
            division.expenses = parseInt(document.getElementById('edit_division_expenses').value);
            division.mrr = parseInt(document.getElementById('edit_division_mrr').value);
            division.employees = parseInt(document.getElementById('edit_division_employees').value);
            division.customers = parseInt(document.getElementById('edit_division_customers').value);
            division.growth = parseFloat(document.getElementById('edit_division_growth').value);
            
            saveData();
            closeModal();
            showToast('âœ“ Division updated successfully!', 'success');
            setTimeout(() => switchSection('divisions'), 100);
        }

        function toggleDivisionStatus(index) {
            const division = appState.data.divisions[index];
            division.status = division.status === 'Active' ? 'Disabled' : 'Active';
            
            saveData();
            closeModal();
            showToast(`âœ“ Division ${division.status === 'Active' ? 'enabled' : 'disabled'} successfully!`, 'success');
            setTimeout(() => switchSection('divisions'), 100);
        }

        // CRM
        function renderCRM(container) {
            const totalContacts = appState.data.contacts.length;
            const avgValue = appState.data.contacts.reduce((sum, c) => sum + c.value, 0) / totalContacts;
            const customers = appState.data.contacts.filter(c => c.status === 'Customer').length;
            const leads = appState.data.contacts.filter(c => c.status === 'Lead').length;
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownCRMStats('all')">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-label">Total Contacts</div>
                        <div class="stat-value">${totalContacts}</div>
                        <div class="stat-change">${customers} Customers â€¢ ${leads} Leads</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownCRMStats('value')">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Avg Contact Value</div>
                        <div class="stat-value">$${avgValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                        <div class="stat-change positive">Potential revenue per contact</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownCRMStats('conversion')">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-label">Conversion Rate</div>
                        <div class="stat-value">${((customers / totalContacts) * 100).toFixed(1)}%</div>
                        <div class="stat-change positive">Lead to customer</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownCRMStats('pipeline')">
                        <div class="stat-icon">â­</div>
                        <div class="stat-label">Total Pipeline Value</div>
                        <div class="stat-value">$${appState.data.contacts.reduce((sum, c) => sum + c.value, 0).toLocaleString()}</div>
                        <div class="stat-change positive">Combined opportunity value</div>
                    </div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div class="card-title">CRM & Contacts</div>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" placeholder="Search contacts..." 
                                   onkeyup="filterTable(this.value, 'crmTable')"
                                   style="padding: 8px 16px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px; width: 250px;">
                            <button class="btn-primary" onclick="showAddContact()" style="white-space: nowrap;">+ Add Contact</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="crmTable">
                            <thead>
                                <tr>
                                    <th onclick="sortCRMTable('name')" style="cursor: pointer; user-select: none;">Name â‡…</th>
                                    <th onclick="sortCRMTable('company')" style="cursor: pointer; user-select: none;">Company â‡…</th>
                                    <th onclick="sortCRMTable('email')" style="cursor: pointer; user-select: none;">Email â‡…</th>
                                    <th onclick="sortCRMTable('phone')" style="cursor: pointer; user-select: none;">Phone â‡…</th>
                                    <th onclick="sortCRMTable('status')" style="cursor: pointer; user-select: none;">Status â‡…</th>
                                    <th onclick="sortCRMTable('value')" style="cursor: pointer; user-select: none;">Value â‡…</th>
                                    <th onclick="sortCRMTable('source')" style="cursor: pointer; user-select: none;">Source â‡…</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crmTableBody">
                                ${renderCRMTableRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div class="card-title">Contact Sources & Channels</div>
                        <button class="btn-primary" onclick="showAddContactSource()" style="white-space: nowrap;">+ Add Source</button>
                    </div>
                    <div class="stats-grid">
                        <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--accent-primary)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='var(--glass-border)';"
                             onclick="drilldownContactSource('Website')">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸŒ</div>
                            <div style="font-weight: 700; font-size: 20px; margin-bottom: 4px;">Website</div>
                            <div style="color: var(--text-secondary);">${appState.data.contacts.filter(c => c.source === 'Website').length} contacts</div>
                            <div style="color: var(--accent-primary); font-weight: 600; margin-top: 8px;">Direct inquiry</div>
                        </div>
                        <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--accent-gold)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='var(--glass-border)';"
                             onclick="drilldownContactSource('Referral')">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ¤</div>
                            <div style="font-weight: 700; font-size: 20px; margin-bottom: 4px;">Referral</div>
                            <div style="color: var(--text-secondary);">${appState.data.contacts.filter(c => c.source === 'Referral').length} contacts</div>
                            <div style="color: var(--accent-gold); font-weight: 600; margin-top: 8px;">Word of mouth</div>
                        </div>
                        <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--accent-tertiary)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='var(--glass-border)';"
                             onclick="drilldownContactSource('Social')">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ“±</div>
                            <div style="font-weight: 700; font-size: 20px; margin-bottom: 4px;">Social Media</div>
                            <div style="color: var(--text-secondary);">${appState.data.contacts.filter(c => c.source === 'Social').length} contacts</div>
                            <div style="color: var(--accent-tertiary); font-weight: 600; margin-top: 8px;">LinkedIn, Twitter</div>
                        </div>
                        <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--warning)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='var(--glass-border)';"
                             onclick="drilldownContactSource('Email')">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ“§</div>
                            <div style="font-weight: 700; font-size: 20px; margin-bottom: 4px;">Email Campaign</div>
                            <div style="color: var(--text-secondary);">${appState.data.contacts.filter(c => c.source === 'Email').length} contacts</div>
                            <div style="color: var(--text-muted); font-weight: 600; margin-top: 8px;">Marketing emails</div>
                        </div>
                    </div>
                </div>
            `;
        }

        let crmSortColumn = null;
        let crmSortAscending = true;

        function renderCRMTableRows() {
            let contacts = [...appState.data.contacts];
            
            if (crmSortColumn) {
                contacts.sort((a, b) => {
                    let valA = a[crmSortColumn];
                    let valB = b[crmSortColumn];
                    
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    
                    if (valA < valB) return crmSortAscending ? -1 : 1;
                    if (valA > valB) return crmSortAscending ? 1 : -1;
                    return 0;
                });
            }
            
            return contacts.map((c, index) => `
                <tr>
                    <td style="font-weight: 600;">${c.name}</td>
                    <td>${c.company}</td>
                    <td style="font-size: 13px; color: var(--text-secondary);">${c.email}</td>
                    <td style="font-size: 13px; color: var(--text-secondary);">${c.phone}</td>
                    <td><span class="badge ${c.status === 'Customer' ? 'badge-success' : 'badge-info'}">${c.status}</span></td>
                    <td style="font-weight: 600; color: var(--accent-primary);">$${c.value.toLocaleString()}</td>
                    <td><span class="badge badge-warning" style="font-size: 11px;">${c.source}</span></td>
                    <td>
                        <button class="btn-secondary" onclick="editContact(${c.id})" 
                                style="padding: 6px 12px; font-size: 12px; margin-right: 6px;">âœï¸ Edit</button>
                        <button class="btn-secondary" onclick="viewContactDetails(${c.id})" 
                                style="padding: 6px 12px; font-size: 12px; margin-right: 6px;">ðŸ‘ï¸ View</button>
                        <button class="btn-secondary" onclick="deleteContact(${c.id})" 
                                style="padding: 6px 12px; font-size: 12px; background: var(--danger); color: white;">ðŸ—‘ï¸ Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function sortCRMTable(column) {
            if (crmSortColumn === column) {
                crmSortAscending = !crmSortAscending;
            } else {
                crmSortColumn = column;
                crmSortAscending = true;
            }
            
            const tbody = document.getElementById('crmTableBody');
            if (tbody) {
                tbody.innerHTML = renderCRMTableRows();
            }
        }

        function drilldownCRMStats(type) {
            let title, content;
            const contacts = appState.data.contacts;
            
            switch(type) {
                case 'all':
                    title = 'All Contacts Overview';
                    content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Total Contacts: ${contacts.length}</div>
                                <div style="color: var(--text-secondary);">
                                    â€¢ ${contacts.filter(c => c.status === 'Customer').length} Customers<br>
                                    â€¢ ${contacts.filter(c => c.status === 'Lead').length} Leads
                                </div>
                            </div>
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Recent Activity</div>
                                <div style="color: var(--text-secondary);">
                                    ${contacts.slice(0, 5).map(c => `â€¢ ${c.name} from ${c.company}`).join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'value':
                    title = 'Contact Value Analysis';
                    const topContacts = [...contacts].sort((a,b) => b.value - a.value).slice(0, 5);
                    content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 12px;">Top 5 Highest Value Contacts</div>
                                ${topContacts.map((c, i) => `
                                    <div style="padding: 8px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                        ${i+1}. ${c.name} - <span style="color: var(--accent-primary); font-weight: 600;">$${c.value.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                case 'conversion':
                    title = 'Conversion Metrics';
                    const customers = contacts.filter(c => c.status === 'Customer');
                    content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Conversion Rate: ${((customers.length / contacts.length) * 100).toFixed(1)}%</div>
                                <div style="color: var(--text-secondary); margin-bottom: 12px;">
                                    ${customers.length} out of ${contacts.length} contacts converted to customers
                                </div>
                                <div style="font-weight: 600; margin-top: 16px; margin-bottom: 8px;">Recent Conversions</div>
                                ${customers.slice(0, 5).map(c => `
                                    <div style="padding: 8px; margin-bottom: 6px;">â€¢ ${c.name} - ${c.company}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                case 'pipeline':
                    title = 'Pipeline Value Breakdown';
                    const totalValue = contacts.reduce((sum, c) => sum + c.value, 0);
                    const byStatus = {
                        Customer: contacts.filter(c => c.status === 'Customer').reduce((sum, c) => sum + c.value, 0),
                        Lead: contacts.filter(c => c.status === 'Lead').reduce((sum, c) => sum + c.value, 0)
                    };
                    content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; font-size: 18px; margin-bottom: 12px;">Total Pipeline: $${totalValue.toLocaleString()}</div>
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-weight: 600;">Customer Value:</div>
                                    <div style="color: var(--accent-primary); font-size: 16px;">$${byStatus.Customer.toLocaleString()}</div>
                                </div>
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-weight: 600;">Lead Value:</div>
                                    <div style="color: var(--accent-tertiary); font-size: 16px;">$${byStatus.Lead.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content);
        }

        function drilldownContactSource(source) {
            const filtered = appState.data.contacts.filter(c => c.source === source);
            const title = `${source} Contacts`;
            const content = `
                <div style="display: grid; gap: 12px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 12px;">Total: ${filtered.length} contacts</div>
                        ${filtered.length > 0 ? `
                            ${filtered.map(c => `
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-weight: 600;">${c.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">${c.company} â€¢ ${c.email}</div>
                                    <div style="margin-top: 6px;">
                                        <span class="badge ${c.status === 'Customer' ? 'badge-success' : 'badge-info'}" style="font-size: 11px;">${c.status}</span>
                                        <span style="color: var(--accent-primary); font-weight: 600; margin-left: 12px;">$${c.value.toLocaleString()}</span>
                                    </div>
                                </div>
                            `).join('')}
                        ` : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No contacts from this source yet</div>'}
                    </div>
                </div>
            `;
            showModal(title, content);
        }
        
        

        function viewContactDetails(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const detailsHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-glass); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ‘¤</div>
                        <h2 style="margin-bottom: 8px;">${contact.name}</h2>
                        <div style="color: var(--accent-primary); margin-bottom: 4px; font-size: 16px;">${contact.title || 'No title set'}</div>
                        <div style="color: var(--text-secondary); margin-bottom: 8px;">${contact.company}</div>
                        <span class="badge ${contact.status === 'Customer' ? 'badge-success' : 'badge-info'}">${contact.status}</span>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Contact Information</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Email:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--accent-tertiary); word-break: break-all;">${contact.email}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'email', '${contact.email}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Phone:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.phone}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'phone', '${contact.phone}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Title:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.title || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'title', '${contact.title || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Address:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 13px;">${contact.address || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'address', '${contact.address || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Birthday:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.birthday || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'birthday', '${contact.birthday || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Timezone:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.timezone || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'timezone', '${contact.timezone || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Preferred Contact:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.preferredContact || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'preferredContact', '${contact.preferredContact || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Business Details</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Industry:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.industry || 'â€”'}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'industry', '${contact.industry || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Website:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${contact.website ? `<a href="https://${contact.website}" target="_blank" style="color: var(--accent-tertiary); text-decoration: none;">${contact.website} â†’</a>` : '<span style="color: var(--text-muted);">â€”</span>'}
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'website', '${contact.website || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Potential Value:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--accent-primary); font-weight: 700;">$${contact.value.toLocaleString()}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'value', ${contact.value})" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Source:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${contact.source}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'source', '${contact.source}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Status:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="badge ${contact.status === 'Customer' ? 'badge-success' : 'badge-info'}">${contact.status}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'status', '${contact.status}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Last Contact:</span>
                                <span>${contact.lastContact}</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">Tags & Notes</div>
                            <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'tags', '${(contact.tags || []).join(', ')}')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit Tags</button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                            ${(contact.tags && contact.tags.length > 0) ? contact.tags.map(tag => `<span class="badge badge-info">${tag}</span>`).join('') : '<span style="color: var(--text-muted);">No tags set</span>'}
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Notes:</div>
                                <button class="btn-secondary" onclick="event.stopPropagation(); editContactFieldNotes(${contactId})" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                            </div>
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; min-height: 60px; white-space: pre-wrap;">
                                ${contact.notes || 'No notes added yet'}
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Social Links</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">LinkedIn:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${contact.linkedin ? `<a href="https://${contact.linkedin}" target="_blank" style="color: var(--accent-tertiary); text-decoration: none;">View Profile â†’</a>` : '<span style="color: var(--text-muted);">â€”</span>'}
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'linkedin', '${contact.linkedin || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Twitter/X:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${contact.twitter ? `<span style="color: var(--accent-tertiary);">${contact.twitter}</span>` : '<span style="color: var(--text-muted);">â€”</span>'}
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editContactField(${contactId}, 'twitter', '${contact.twitter || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <button class="btn-primary" onclick="closeModal(); editContact(${contact.id});">
                            âœï¸ Edit All
                        </button>
                        <button class="btn-secondary" onclick="closeModal(); sendEmailToContact(${contact.id});" style="background: var(--accent-tertiary);">
                            ðŸ“§ Send Email
                        </button>
                        <button class="btn-secondary" onclick="closeModal(); showContactCommunicationChoice(${contact.id});" style="background: var(--accent-secondary);">
                            ðŸ“ž Contact
                        </button>
                        <button class="btn-secondary" onclick="deleteContact(${contact.id});" style="background: var(--danger); color: white;">
                            ðŸ—‘ï¸ Delete
                        </button>
                    </div>
                </div>
            `;
            showModal('Contact Details', detailsHTML);
        }

        // INLINE EDIT CONTACT FIELD
        function editContactField(contactId, field, currentValue) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;

            let inputHTML = '';
            let fieldLabel = field.charAt(0).toUpperCase() + field.slice(1).replace(/([A-Z])/g, ' $1');

            // Handle different field types
            if (field === 'notes') {
                inputHTML = `<textarea id="edit_field_input" rows="6" 
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;">${currentValue.replace(/\\n/g, '\n')}</textarea>`;
            } else if (field === 'tags') {
                inputHTML = `<input type="text" id="edit_field_input" value="${currentValue}" placeholder="Enter tags separated by commas"
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">ðŸ’¡ Separate tags with commas</div>`;
            } else if (field === 'value') {
                inputHTML = `<input type="number" id="edit_field_input" value="${currentValue}" min="0" step="1000"
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else if (field === 'status') {
                inputHTML = `<select id="edit_field_input" 
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    <option value="Lead" ${currentValue === 'Lead' ? 'selected' : ''}>Lead</option>
                    <option value="Customer" ${currentValue === 'Customer' ? 'selected' : ''}>Customer</option>
                </select>`;
            } else if (field === 'source') {
                inputHTML = `<select id="edit_field_input" 
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    <option value="Website" ${currentValue === 'Website' ? 'selected' : ''}>Website</option>
                    <option value="Referral" ${currentValue === 'Referral' ? 'selected' : ''}>Referral</option>
                    <option value="Social" ${currentValue === 'Social' ? 'selected' : ''}>Social Media</option>
                    <option value="Email" ${currentValue === 'Email' ? 'selected' : ''}>Email Campaign</option>
                    <option value="Direct" ${currentValue === 'Direct' ? 'selected' : ''}>Direct</option>
                    <option value="Event" ${currentValue === 'Event' ? 'selected' : ''}>Event</option>
                </select>`;
            } else if (field === 'birthday') {
                inputHTML = `<input type="date" id="edit_field_input" value="${currentValue}"
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else if (field === 'email') {
                inputHTML = `<input type="email" id="edit_field_input" value="${currentValue}"
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else {
                inputHTML = `<input type="text" id="edit_field_input" value="${currentValue}"
                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            }

            const formHTML = `
                <form onsubmit="handleContactFieldEdit(event, ${contactId}, '${field}')" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 700; margin-bottom: 4px;">${contact.name}</div>
                        <div style="color: var(--text-secondary); font-size: 13px;">${contact.company}</div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">${fieldLabel}:</label>
                        ${inputHTML}
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2;">Save Changes</button>
                    </div>
                </form>
            `;

            showModal(`Edit ${fieldLabel}`, formHTML);
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById('edit_field_input');
                if (input) input.focus();
            }, 100);
        }

        function handleContactFieldEdit(event, contactId, field) {
            event.preventDefault();
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;

            const newValue = document.getElementById('edit_field_input').value;

            // Process based on field type
            if (field === 'tags') {
                contact[field] = newValue.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            } else if (field === 'value') {
                contact[field] = parseInt(newValue) || 0;
            } else {
                contact[field] = newValue;
            }

            // Update last contact date
            contact.lastContact = new Date().toISOString().split('T')[0];

            // Log activity
            addRecentActivity('contact', `Updated contact field`, `${contact.name}: ${field} updated`, 'info');

            saveData();
            closeModal();
            showToast(`âœ… ${field.charAt(0).toUpperCase() + field.slice(1)} updated successfully!`, 'success');

            // Reopen the contact details view
            setTimeout(() => viewContactDetails(contactId), 100);
        }

        // Helper function to edit notes field (avoids backtick issues)
        function editContactFieldNotes(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;

            const currentValue = contact.notes || '';
            editContactField(contactId, 'notes', currentValue);
        }

        function editContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const formHTML = `
                <form onsubmit="handleContactEdit(event, ${contactId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Full Name</label>
                            <input type="text" id="edit_contact_name" required value="${contact.name}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Company</label>
                            <input type="text" id="edit_contact_company" required value="${contact.company}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                            <input type="email" id="edit_contact_email" required value="${contact.email}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Phone</label>
                            <input type="tel" id="edit_contact_phone" required value="${contact.phone}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="edit_contact_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Lead" ${contact.status === 'Lead' ? 'selected' : ''}>Lead</option>
                                <option value="Customer" ${contact.status === 'Customer' ? 'selected' : ''}>Customer</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Value ($)</label>
                            <input type="number" id="edit_contact_value" required step="1000" min="0" value="${contact.value}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Source</label>
                            <select id="edit_contact_source" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Website" ${contact.source === 'Website' ? 'selected' : ''}>Website</option>
                                <option value="Referral" ${contact.source === 'Referral' ? 'selected' : ''}>Referral</option>
                                <option value="Social" ${contact.source === 'Social' ? 'selected' : ''}>Social Media</option>
                                <option value="Email" ${contact.source === 'Email' ? 'selected' : ''}>Email Campaign</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Contact</button>
                </form>
            `;
            showModal('Edit Contact', formHTML);
        }

        function handleContactEdit(event, contactId) {
            event.preventDefault();
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (contact) {
                const oldName = contact.name;
                contact.name = document.getElementById('edit_contact_name').value;
                contact.company = document.getElementById('edit_contact_company').value;
                contact.email = document.getElementById('edit_contact_email').value;
                contact.phone = document.getElementById('edit_contact_phone').value;
                contact.status = document.getElementById('edit_contact_status').value;
                contact.value = parseInt(document.getElementById('edit_contact_value').value);
                contact.source = document.getElementById('edit_contact_source').value;
                contact.lastContact = new Date().toISOString().split('T')[0];
                
                // Log activity
                addRecentActivity('contact', `Updated contact: ${contact.name}`, `${contact.email} â€¢ ${contact.status}`, 'info');
                
                saveData();
                closeModal();
                showToast('Contact updated successfully!');
                switchSection('crm');
            }
        }

        // DELETE CONTACT
        function deleteContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const confirmHTML = `
                <div style="text-align: center; max-width: 500px; margin: 0 auto;">
                    <div style="font-size: 64px; margin-bottom: 16px;">âš ï¸</div>
                    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--danger);">
                        Delete Contact?
                    </h2>
                    <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                        Are you sure you want to permanently delete <strong style="color: var(--text-primary);">${contact.name}</strong>?
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px;">CONTACT INFORMATION TO BE DELETED:</div>
                        <div style="display: grid; gap: 8px; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Name:</span>
                                <span style="font-weight: 600;">${contact.name}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Email:</span>
                                <span style="color: var(--accent-tertiary);">${contact.email}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Phone:</span>
                                <span>${contact.phone}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Company:</span>
                                <span>${contact.company}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Status:</span>
                                <span class="badge ${contact.status === 'Customer' ? 'badge-success' : 'badge-info'}">${contact.status}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-muted);">Value:</span>
                                <span style="color: var(--accent-gold);">$${contact.value.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 107, 107, 0.15); padding: 16px; border-radius: 8px; border: 1px solid var(--danger); margin-bottom: 24px;">
                        <div style="font-weight: 700; font-size: 13px; color: var(--danger); margin-bottom: 4px;">
                            âš ï¸ WARNING: THIS ACTION CANNOT BE UNDONE
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            All contact information, notes, tags, and history will be permanently deleted.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeModal()" class="btn-secondary" style="flex: 1; padding: 12px;">
                            Cancel
                        </button>
                        <button onclick="confirmDeleteContact(${contactId})" class="btn-primary" 
                                style="flex: 1; padding: 12px; background: var(--danger); color: white; font-weight: 700;">
                            ðŸ—‘ï¸ Yes, Delete Contact
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Delete Contact', confirmHTML);
        }

        function confirmDeleteContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const contactName = contact.name;
            
            // Remove the contact from the array
            const index = appState.data.contacts.findIndex(c => c.id === contactId);
            if (index > -1) {
                appState.data.contacts.splice(index, 1);
            }
            
            // Log the deletion
            addRecentActivity('delete', 'Contact Deleted', `Removed ${contactName} from CRM`, 'warning');
            
            // Save and update
            saveData();
            closeModal();
            switchSection('crm');
            showToast(`âœ… Contact "${contactName}" has been deleted`, 'success');
        }

        // SEND EMAIL TO CONTACT
        function sendEmailToContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            appState.currentEmailContact = contact; // Store for template access
            
            const emailFormHTML = `
                <form onsubmit="handleSendEmail(event, ${contactId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="font-size: 32px;">ðŸ‘¤</div>
                            <div>
                                <div style="font-weight: 700;">${contact.name}</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">${contact.company}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--accent-tertiary);">
                            <span>ðŸ“§</span>
                            <span style="font-weight: 600;">${contact.email}</span>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">From:</label>
                        <input type="email" id="email_from" value="sales@virely.com" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Subject:</label>
                        <input type="text" id="email_subject" placeholder="Email subject..." required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Message:</label>
                        <textarea id="email_message" rows="8" placeholder="Type your message..." required
                                  style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                                padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">QUICK TEMPLATES:</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn-secondary" onclick="applyEmailTemplate('followup')" 
                                    style="padding: 6px 12px; font-size: 12px;">Follow-up</button>
                            <button type="button" class="btn-secondary" onclick="applyEmailTemplate('introduction')" 
                                    style="padding: 6px 12px; font-size: 12px;">Introduction</button>
                            <button type="button" class="btn-secondary" onclick="applyEmailTemplate('meeting')" 
                                    style="padding: 6px 12px; font-size: 12px;">Meeting Request</button>
                            <button type="button" class="btn-secondary" onclick="applyEmailTemplate('proposal')" 
                                    style="padding: 6px 12px; font-size: 12px;">Proposal</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2; background: var(--accent-tertiary);">
                            ðŸ“§ Send Email
                        </button>
                    </div>
                </form>
            `;
            
            showModal('Send Email', emailFormHTML);
        }
        
        function applyEmailTemplate(template) {
            const contact = appState.currentEmailContact;
            const firstName = contact ? contact.name.split(' ')[0] : 'there';
            const templates = {
                followup: {
                    subject: `Following up on our conversation`,
                    message: `Hi ${firstName},\n\nI wanted to follow up on our recent conversation about [topic]. \n\nI believe our solution could really help ${contact ? contact.company : 'your company'} with [specific benefit].\n\nWould you be available for a brief call this week to discuss next steps?\n\nBest regards,\n[Your Name]`
                },
                introduction: {
                    subject: `Introduction - Virely & ${contact ? contact.company : 'Your Company'}`,
                    message: `Hi ${firstName},\n\nI hope this email finds you well. My name is [Your Name] and I'm reaching out from Virely.\n\nWe specialize in [your service/product] and I noticed that ${contact ? contact.company : 'your company'} might benefit from [specific value proposition].\n\nI'd love to schedule a brief 15-minute call to explore if there's a potential fit.\n\nBest regards,\n[Your Name]`
                },
                meeting: {
                    subject: `Meeting Request - ${contact ? contact.company : 'Discussion'}`,
                    message: `Hi ${firstName},\n\nI'd like to schedule a meeting to discuss [topic/opportunity].\n\nWould any of these times work for you?\nâ€¢ [Date/Time Option 1]\nâ€¢ [Date/Time Option 2]\nâ€¢ [Date/Time Option 3]\n\nPlease let me know what works best for you, or suggest an alternative time.\n\nLooking forward to connecting!\n\nBest regards,\n[Your Name]`
                },
                proposal: {
                    subject: `Proposal for ${contact ? contact.company : 'Your Company'}`,
                    message: `Hi ${firstName},\n\nThank you for your interest in our services. I'm excited to present a tailored proposal for ${contact ? contact.company : 'your company'}.\n\nKey highlights:\nâ€¢ [Benefit 1]\nâ€¢ [Benefit 2]\nâ€¢ [Benefit 3]\n\nI've attached a detailed proposal document. I'd be happy to walk you through it on a call at your convenience.\n\nBest regards,\n[Your Name]`
                }
            };
            
            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('email_subject').value = selectedTemplate.subject;
                document.getElementById('email_message').value = selectedTemplate.message;
            }
        }
        
        function handleSendEmail(event, contactId) {
            event.preventDefault();
            const contact = appState.data.contacts.find(c => c.id === contactId);
            
            const emailData = {
                from: document.getElementById('email_from').value,
                to: contact.email,
                subject: document.getElementById('email_subject').value,
                message: document.getElementById('email_message').value,
                contactName: contact.name,
                contactCompany: contact.company,
                timestamp: new Date().toISOString()
            };
            
            // Log the email send activity
            addRecentActivity('email', `Email Sent`, `Sent email to ${contact.name} (${contact.company}) - Subject: "${emailData.subject}"`, 'info');
            
            // Update last contact date
            const contactIndex = appState.data.contacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                appState.data.contacts[contactIndex].lastContact = new Date().toLocaleDateString();
            }
            
            closeModal();
            saveData();
            showToast(`âœ… Email sent to ${contact.name}!`, 'success');
            
            // Show confirmation with details
            setTimeout(() => {
                showToast(`ðŸ“§ Check your email client to complete sending`, 'info');
            }, 2000);
        }

        // CONTACT COMMUNICATION CHOICE (Call or SMS)
        function showContactCommunicationChoice(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;

            const choiceHTML = `
                <div style="text-align: center;">
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ‘¤</div>
                        <div style="font-weight: 700; font-size: 20px; margin-bottom: 8px;">${contact.name}</div>
                        <div style="color: var(--text-secondary); margin-bottom: 8px;">${contact.company}</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px;">
                            <span style="font-size: 20px;">ðŸ“±</span>
                            <span style="font-weight: 600; color: var(--accent-primary); font-size: 18px;">${contact.phone}</span>
                        </div>
                    </div>

                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                        How would you like to contact ${contact.name.split(' ')[0]}?
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <button class="btn-primary" onclick="closeModal(); callContact(${contactId});" 
                                style="padding: 20px; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 32px;">ðŸ“ž</span>
                            <span>Call</span>
                        </button>
                        <button class="btn-secondary" onclick="closeModal(); sendSMSToContact(${contactId});" 
                                style="padding: 20px; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--accent-secondary);">
                            <span style="font-size: 32px;">ðŸ’¬</span>
                            <span>Send SMS</span>
                        </button>
                    </div>

                    <button class="btn-secondary" onclick="closeModal();" style="margin-top: 16px; width: 100%;">
                        Cancel
                    </button>
                </div>
            `;

            showModal('Contact Options', choiceHTML);
        }

        // CALL CONTACT
        function callContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Log the call activity
            addRecentActivity('phone', `Call Initiated`, `Called ${contact.name} (${contact.company}) at ${contact.phone}`, 'info');
            
            // Update last contact date
            const contactIndex = appState.data.contacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                appState.data.contacts[contactIndex].lastContact = new Date().toISOString().split('T')[0];
            }
            
            saveData();
            
            // Attempt to initiate phone call (works on mobile devices)
            window.location.href = `tel:${contact.phone}`;
            
            // Show confirmation
            showToast(`ðŸ“ž Calling ${contact.name}...`, 'success');
        }

        // SEND SMS TO CONTACT
        function sendSMSToContact(contactId) {
            const contact = appState.data.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            appState.currentSMSContact = contact; // Store for template access
            
            const smsFormHTML = `
                <form onsubmit="handleSendSMS(event, ${contactId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="font-size: 32px;">ðŸ‘¤</div>
                            <div>
                                <div style="font-weight: 700;">${contact.name}</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">${contact.company}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--accent-secondary);">
                            <span>ðŸ“±</span>
                            <span style="font-weight: 600;">${contact.phone}</span>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">
                            Message: <span style="font-size: 12px; color: var(--text-muted);" id="sms_char_count">0/160 characters</span>
                        </label>
                        <textarea id="sms_message" rows="5" placeholder="Type your SMS message..." required
                                  maxlength="160" oninput="updateSMSCharCount()"
                                  style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            ðŸ’¡ Keep messages under 160 characters for single SMS
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(124,92,255,0.1), rgba(110,231,183,0.1)); 
                                padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">QUICK TEMPLATES:</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn-secondary" onclick="applySMSTemplate('followup')" 
                                    style="padding: 6px 12px; font-size: 12px;">Follow-up</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTemplate('meeting')" 
                                    style="padding: 6px 12px; font-size: 12px;">Meeting Reminder</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTemplate('thankyou')" 
                                    style="padding: 6px 12px; font-size: 12px;">Thank You</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTemplate('checkin')" 
                                    style="padding: 6px 12px; font-size: 12px;">Check-in</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2; background: var(--accent-secondary);">
                            ðŸ’¬ Send SMS
                        </button>
                    </div>
                </form>
            `;
            
            showModal('Send SMS', smsFormHTML);
        }
        
        function updateSMSCharCount() {
            const textarea = document.getElementById('sms_message');
            const counter = document.getElementById('sms_char_count');
            if (textarea && counter) {
                counter.textContent = `${textarea.value.length}/160 characters`;
            }
        }
        
        function applySMSTemplate(template) {
            const contact = appState.currentSMSContact;
            const firstName = contact ? contact.name.split(' ')[0] : 'there';
            const templates = {
                followup: `Hi ${firstName}, following up on our conversation. Do you have time for a quick call this week? - [Your Name]`,
                meeting: `Hi ${firstName}, reminder about our meeting tomorrow at [TIME]. Looking forward to it! - [Your Name]`,
                thankyou: `Hi ${firstName}, thank you for your time today! I'll send over the information we discussed. - [Your Name]`,
                checkin: `Hi ${firstName}, just checking in to see if you had any questions about our proposal. Happy to help! - [Your Name]`
            };
            
            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('sms_message').value = selectedTemplate;
                updateSMSCharCount();
            }
        }
        
        function handleSendSMS(event, contactId) {
            event.preventDefault();
            const contact = appState.data.contacts.find(c => c.id === contactId);
            
            const smsData = {
                to: contact.phone,
                message: document.getElementById('sms_message').value,
                contactName: contact.name,
                contactCompany: contact.company,
                timestamp: new Date().toISOString()
            };
            
            // Log the SMS send activity
            addRecentActivity('sms', `SMS Sent`, `Sent SMS to ${contact.name} (${contact.phone}) - "${smsData.message.substring(0, 50)}${smsData.message.length > 50 ? '...' : ''}"`, 'info');
            
            // Update last contact date
            const contactIndex = appState.data.contacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                appState.data.contacts[contactIndex].lastContact = new Date().toLocaleDateString();
            }
            
            closeModal();
            saveData();
            showToast(`âœ… SMS sent to ${contact.name}!`, 'success');
            
            // Show confirmation with details
            setTimeout(() => {
                showToast(`ðŸ“± Message: "${smsData.message.substring(0, 30)}..."`, 'info');
            }, 2000);
        }

        function showAddContactSource() {
            const formHTML = `
                <form onsubmit="handleAddContactSource(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Source Name</label>
                        <input type="text" id="new_source_name" required 
                               placeholder="e.g., Trade Show, Partner Network, Cold Outreach"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Icon (Emoji)</label>
                        <input type="text" id="new_source_icon" required 
                               placeholder="Click an emoji below or type your own"
                               maxlength="2"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; margin-bottom: 12px;">
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; text-transform: uppercase;">
                                Popular Emojis - Click to Select
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px;">
                                ${['ðŸŽ¯', 'ðŸŽª', 'ðŸ“ž', 'ðŸ’¼', 'ðŸŒ', 'ðŸ“§', 'ðŸ“±', 'ðŸ¤', 'ðŸ’¡', 'ðŸš€', 'â­', 'ðŸŽ', 'ðŸ†', 'ðŸ“Š', 'ðŸ’°', 'ðŸŽ‰', 'ðŸ‘¥', 'ðŸ”—', 'ðŸ“£', 'ðŸŽ“', 'ðŸ¢', 'ðŸ’»', 'ðŸ“ˆ', 'ðŸŒŸ', 'ðŸŽ¨', 'ðŸ“', 'ðŸ””', 'ðŸ’¬', 'ðŸŽ¤', 'ðŸ“º'].map(emoji => 
                                    `<button type="button" onclick="document.getElementById('new_source_icon').value='${emoji}'" 
                                            style="padding: 10px; font-size: 24px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                            border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;
                                            hover:transform: scale(1.1);"
                                            onmouseover="this.style.background='var(--accent-primary)'; this.style.transform='scale(1.1)'"
                                            onmouseout="this.style.background='var(--bg-glass)'; this.style.transform='scale(1)'">${emoji}</button>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <input type="text" id="new_source_description" required 
                               placeholder="Brief description of this source"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                            <strong>Note:</strong> This will add a new contact source option that will appear:
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            â€¢ In the Contact Sources & Channels section<br>
                            â€¢ As a dropdown option when adding/editing contacts
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Contact Source</button>
                </form>
            `;
            showModal('Add Contact Source / Channel', formHTML);
        }

        function handleAddContactSource(event) {
            event.preventDefault();
            const sourceName = document.getElementById('new_source_name').value;
            const sourceIcon = document.getElementById('new_source_icon').value;
            const sourceDescription = document.getElementById('new_source_description').value;
            
            // For demonstration, we'll show a success message
            // In a real implementation, you'd add this to a contactSources array
            closeModal();
            showToast(`Contact source "${sourceName}" added! You can now use it when adding contacts.`);
            
            // Note: To fully implement this, you would need to:
            // 1. Create an appState.data.contactSources array
            // 2. Dynamically render source tiles from that array
            // 3. Dynamically populate the source dropdown from that array
        }

        // DEALS
        function renderDeals(container) {
            renderDealsEnhanced(container);
        }

        // MARKETING - NOW FULLY IMPLEMENTED
        function renderMarketing(container) {
            renderMarketingEnhanced(container);
        }
        
        function showAddCampaign() {
            const channels = appState.data.marketingChannels.map(c => ({ id: c.id, name: c.name, icon: c.icon }));
            
            const inputStyle = `
                width: 100%; 
                padding: 14px 16px; 
                background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
                border: 1px solid rgba(110,231,183,0.2); 
                border-radius: 12px; 
                color: var(--text-primary); 
                font-size: 14px;
                font-family: 'Inter', sans-serif;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                backdrop-filter: blur(10px);
            `;
            
            const labelStyle = `
                display: block; 
                margin-bottom: 10px; 
                color: var(--accent-primary); 
                font-weight: 600;
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 1.2px;
            `;
            
            const formHTML = `
                <form onsubmit="handleCampaignSubmit(event)" style="display: flex; flex-direction: column; gap: 24px;">
                    <div>
                        <label style="${labelStyle}">Campaign Name</label>
                        <input type="text" id="campaign_name" required 
                               placeholder="Q4 Holiday Campaign"
                               onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                               onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                               style="${inputStyle}">
                    </div>
                    
                    <div>
                        <label style="${labelStyle}">Campaign Type</label>
                        <select id="campaign_type" required
                                onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)';"
                                onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none';"
                                style="${inputStyle}">
                            <option value="Awareness">Brand Awareness</option>
                            <option value="Lead Generation">Lead Generation</option>
                            <option value="Conversion">Conversion Campaign</option>
                            <option value="Engagement">Engagement Campaign</option>
                            <option value="Retention">Customer Retention</option>
                        </select>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <label style="${labelStyle} margin-bottom: 0;">
                                Marketing Channels (Select all that apply)
                            </label>
                            <button type="button" onclick="toggleCustomChannelForm()" 
                                    style="padding: 8px 14px; 
                                           background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary)); 
                                           color: white; border: none; border-radius: 8px; cursor: pointer; 
                                           font-size: 12px; font-weight: 700;
                                           box-shadow: 0 3px 10px rgba(124,92,255,0.3);
                                           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                           display: flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 16px rgba(124,92,255,0.5)';"
                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 3px 10px rgba(124,92,255,0.3)';">
                                <span style="font-size: 14px;">+</span> Add Custom Channel
                            </button>
                        </div>
                        
                        <!-- Custom Channel Creation Form (Hidden by default) -->
                        <div id="customChannelForm" style="display: none; margin-bottom: 16px; padding: 20px; 
                                                            background: linear-gradient(135deg, rgba(124,92,255,0.1), rgba(96,165,250,0.1)); 
                                                            border-radius: 12px; border: 2px solid var(--accent-secondary);
                                                            animation: slideDown 0.3s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div style="font-size: 16px; font-weight: 700; color: var(--accent-secondary);">
                                    âœ¨ Create Custom Marketing Channel
                                </div>
                                <button type="button" onclick="toggleCustomChannelForm()" 
                                        style="background: transparent; border: none; color: var(--text-muted); 
                                               font-size: 24px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.color='var(--danger)'; this.style.transform='rotate(90deg)';"
                                        onmouseout="this.style.color='var(--text-muted)'; this.style.transform='';">Ã—</button>
                            </div>
                            
                            <div style="display: grid; gap: 12px;">
                                <div style="display: grid; grid-template-columns: 1fr 80px; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Channel Name *</label>
                                        <input type="text" id="custom_channel_name" 
                                               placeholder="e.g., Podcast Advertising, Influencer Marketing"
                                               style="${inputStyle} font-size: 13px; padding: 10px 12px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Icon *</label>
                                        <select id="custom_channel_icon" required
                                                style="${inputStyle} font-size: 20px; padding: 10px 8px; text-align: center; cursor: pointer;"
                                                onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)';"
                                                onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none';">
                                            <option value="">Select Icon...</option>
                                            <optgroup label="ðŸ“± Digital Marketing">
                                                <option value="ðŸ“±">ðŸ“± Mobile</option>
                                                <option value="ðŸ’»">ðŸ’» Desktop</option>
                                                <option value="ðŸ“§">ðŸ“§ Email</option>
                                                <option value="ðŸ’¬">ðŸ’¬ Messaging</option>
                                                <option value="ðŸ“²">ðŸ“² SMS</option>
                                                <option value="ðŸŒ">ðŸŒ Web</option>
                                                <option value="ðŸ”">ðŸ” SEO/Search</option>
                                                <option value="ðŸ“Š">ðŸ“Š Analytics</option>
                                            </optgroup>
                                            <optgroup label="ðŸ“¢ Social Media">
                                                <option value="ðŸ‘¥">ðŸ‘¥ Social Networks</option>
                                                <option value="ðŸ“·">ðŸ“· Instagram</option>
                                                <option value="ðŸ¦">ðŸ¦ Twitter</option>
                                                <option value="ðŸ’¼">ðŸ’¼ LinkedIn</option>
                                                <option value="ðŸ“˜">ðŸ“˜ Facebook</option>
                                                <option value="ðŸŽµ">ðŸŽµ TikTok</option>
                                                <option value="ðŸ“¹">ðŸ“¹ YouTube</option>
                                                <option value="ðŸ“¸">ðŸ“¸ Stories</option>
                                                <option value="ðŸ’­">ðŸ’­ Forums</option>
                                            </optgroup>
                                            <optgroup label="ðŸŽ™ï¸ Content & Media">
                                                <option value="ðŸŽ™ï¸">ðŸŽ™ï¸ Podcast</option>
                                                <option value="ðŸŽ¬">ðŸŽ¬ Video</option>
                                                <option value="ðŸ“º">ðŸ“º Streaming/TV</option>
                                                <option value="ðŸ“»">ðŸ“» Radio</option>
                                                <option value="ðŸ“°">ðŸ“° News/Press</option>
                                                <option value="ðŸ“">ðŸ“ Blog</option>
                                                <option value="ðŸ“–">ðŸ“– Publications</option>
                                                <option value="ðŸŽ¨">ðŸŽ¨ Creative</option>
                                            </optgroup>
                                            <optgroup label="ðŸ’° Paid Advertising">
                                                <option value="ðŸ’°">ðŸ’° Paid Ads</option>
                                                <option value="ðŸŽ¯">ðŸŽ¯ Display Ads</option>
                                                <option value="ðŸ”—">ðŸ”— Sponsored Links</option>
                                                <option value="ðŸ“£">ðŸ“£ Programmatic</option>
                                                <option value="ðŸŽª">ðŸŽª Banner Ads</option>
                                                <option value="ðŸ›ï¸">ðŸ›ï¸ Shopping Ads</option>
                                                <option value="ðŸ’³">ðŸ’³ Retargeting</option>
                                            </optgroup>
                                            <optgroup label="ðŸ¤ Partnerships & Affiliates">
                                                <option value="ðŸ¤">ðŸ¤ Partnerships</option>
                                                <option value="ðŸ‘¤">ðŸ‘¤ Influencers</option>
                                                <option value="â­">â­ Brand Ambassadors</option>
                                                <option value="ðŸ”„">ðŸ”„ Affiliate Network</option>
                                                <option value="ðŸ¤²">ðŸ¤² Referral Program</option>
                                                <option value="ðŸŽ">ðŸŽ Gift/Giveaway</option>
                                            </optgroup>
                                            <optgroup label="ðŸ¢ Events & Offline">
                                                <option value="ðŸ¢">ðŸ¢ Trade Shows</option>
                                                <option value="ðŸŽª">ðŸŽª Events</option>
                                                <option value="ðŸŽ¤">ðŸŽ¤ Conference</option>
                                                <option value="ðŸŽ«">ðŸŽ« Sponsorship</option>
                                                <option value="ðŸª">ðŸª Retail</option>
                                                <option value="ðŸšª">ðŸšª Door-to-Door</option>
                                                <option value="ðŸ“®">ðŸ“® Direct Mail</option>
                                                <option value="ðŸ—ºï¸">ðŸ—ºï¸ Outdoor/Billboard</option>
                                            </optgroup>
                                            <optgroup label="ðŸŽ® Emerging Channels">
                                                <option value="ðŸŽ®">ðŸŽ® Gaming</option>
                                                <option value="ðŸ•¹ï¸">ðŸ•¹ï¸ Esports</option>
                                                <option value="ðŸ¥½">ðŸ¥½ VR/AR</option>
                                                <option value="ðŸ¤–">ðŸ¤– Chatbots</option>
                                                <option value="ðŸ”Š">ðŸ”Š Voice/Alexa</option>
                                                <option value="ðŸ’Ž">ðŸ’Ž NFT/Web3</option>
                                                <option value="ðŸŒŒ">ðŸŒŒ Metaverse</option>
                                            </optgroup>
                                            <optgroup label="ðŸ“ž Direct Communication">
                                                <option value="ðŸ“ž">ðŸ“ž Phone</option>
                                                <option value="â˜Žï¸">â˜Žï¸ Telemarketing</option>
                                                <option value="ðŸ’Œ">ðŸ’Œ Direct Message</option>
                                                <option value="âœ‰ï¸">âœ‰ï¸ Newsletter</option>
                                                <option value="ðŸ“¨">ðŸ“¨ Drip Campaign</option>
                                                <option value="ðŸ“¬">ðŸ“¬ Postal Mail</option>
                                            </optgroup>
                                            <optgroup label="ðŸŽ“ Educational & Content">
                                                <option value="ðŸŽ“">ðŸŽ“ Webinars</option>
                                                <option value="ðŸ“š">ðŸ“š E-books</option>
                                                <option value="ðŸ“„">ðŸ“„ Whitepapers</option>
                                                <option value="ðŸŽ¯">ðŸŽ¯ Case Studies</option>
                                                <option value="ðŸ’¡">ðŸ’¡ Workshops</option>
                                                <option value="ðŸŽ¬">ðŸŽ¬ Demos</option>
                                            </optgroup>
                                            <optgroup label="âš¡ Other">
                                                <option value="âš¡">âš¡ Other</option>
                                                <option value="ðŸŒŸ">ðŸŒŸ Special</option>
                                                <option value="ðŸš€">ðŸš€ Launch</option>
                                                <option value="ðŸ”¥">ðŸ”¥ Trending</option>
                                                <option value="âœ¨">âœ¨ Premium</option>
                                                <option value="ðŸŽ‰">ðŸŽ‰ Promotion</option>
                                                <option value="ðŸ†">ðŸ† Awards</option>
                                                <option value="ðŸ’«">ðŸ’« Viral</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Initial Budget ($)</label>
                                        <input type="number" id="custom_channel_budget" 
                                               placeholder="5000"
                                               min="0" step="100" value="5000"
                                               style="${inputStyle} font-size: 13px; padding: 10px 12px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Login URL (Optional)</label>
                                        <input type="url" id="custom_channel_url" 
                                               placeholder="https://..."
                                               style="${inputStyle} font-size: 13px; padding: 10px 12px;">
                                    </div>
                                </div>
                                
                                <button type="button" onclick="addCustomMarketingChannel()" 
                                        style="padding: 12px; margin-top: 8px;
                                               background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary)); 
                                               color: white; border: none; border-radius: 10px; cursor: pointer; 
                                               font-size: 14px; font-weight: 700;
                                               box-shadow: 0 4px 12px rgba(124,92,255,0.3);
                                               transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                               display: flex; align-items: center; justify-content: center; gap: 8px;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(124,92,255,0.5)';"
                                        onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(124,92,255,0.3)';">
                                    <span style="font-size: 18px;">âœ¨</span> Add Channel to List
                                </button>
                            </div>
                        </div>
                        
                        <div id="channelsContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 280px; overflow-y: auto; 
                                    padding: 16px; background: linear-gradient(135deg, rgba(20,27,46,0.6), rgba(10,14,26,0.6)); 
                                    border-radius: 12px; border: 1px solid rgba(110,231,183,0.15);">
                            ${channels.map(channel => `
                                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; 
                                              background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
                                              border: 1px solid rgba(255,255,255,0.05);
                                              border-radius: 10px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
                                       onmouseover="this.style.background='linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1))'; this.style.borderColor='var(--accent-primary)'; this.style.transform='translateX(4px)';" 
                                       onmouseout="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))'; this.style.borderColor='rgba(255,255,255,0.05)'; this.style.transform='';">
                                    <input type="checkbox" name="campaign_channels" value="${channel.id}" 
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary);">
                                    <span style="font-size: 20px;">${channel.icon}</span>
                                    <span style="font-size: 13px; font-weight: 600;">${channel.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="${labelStyle}">Status</label>
                            <select id="campaign_status" required
                                    onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)';"
                                    onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none';"
                                    style="${inputStyle}">
                                <option value="Planning">Planning</option>
                                <option value="Active">Active</option>
                                <option value="Paused">Paused</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label style="${labelStyle}">Start Date</label>
                            <input type="date" id="campaign_start" required
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">End Date</label>
                            <input type="date" id="campaign_end" required
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="${labelStyle}">Total Budget ($)</label>
                            <input type="number" id="campaign_budget" required step="100" min="0" value="10000"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">Amount Spent ($)</label>
                            <input type="number" id="campaign_spent" required step="100" min="0" value="0"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="${labelStyle}">Target Leads</label>
                            <input type="number" id="campaign_target_leads" required min="0" value="500"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">Actual Leads</label>
                            <input type="number" id="campaign_leads" required min="0" value="0"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">Conversions</label>
                            <input type="number" id="campaign_conversions" required min="0" value="0"
                                   onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                   onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                   style="${inputStyle}">
                        </div>
                    </div>
                    
                    <div>
                        <label style="${labelStyle}">Campaign Description</label>
                        <textarea id="campaign_description" rows="4" placeholder="Describe the campaign goals and strategy..."
                                  onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)'; this.style.transform='translateY(-2px)';"
                                  onblur="this.style.borderColor='rgba(110,231,183,0.2)'; this.style.boxShadow='none'; this.style.transform='';"
                                  style="${inputStyle} resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary" 
                            style="margin-top: 8px; padding: 16px; font-size: 16px; font-weight: 700;
                                   background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                                   border: none; border-radius: 12px; cursor: pointer; 
                                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                   box-shadow: 0 4px 20px rgba(110,231,183,0.3);
                                   display: flex; align-items: center; justify-content: center; gap: 10px;"
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 32px rgba(110,231,183,0.5)';"
                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 20px rgba(110,231,183,0.3)';">
                        <span style="font-size: 20px;">ðŸ“¢</span>
                        <span>Create Campaign</span>
                    </button>
                </form>
            `;
            showModal('Create New Marketing Campaign', formHTML);
        }

        function handleCampaignSubmit(event) {
            event.preventDefault();
            
            // Get selected channels
            const selectedChannels = Array.from(document.querySelectorAll('input[name="campaign_channels"]:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedChannels.length === 0) {
                showToast('âš ï¸ Please select at least one marketing channel', 'warning');
                return;
            }
            
            const budget = parseFloat(document.getElementById('campaign_budget').value);
            const spent = parseFloat(document.getElementById('campaign_spent').value);
            const leads = parseInt(document.getElementById('campaign_leads').value);
            const conversions = parseInt(document.getElementById('campaign_conversions').value);
            const targetLeads = parseInt(document.getElementById('campaign_target_leads').value);
            
            // Calculate smart metrics
            const costPerLead = leads > 0 ? (spent / leads).toFixed(2) : 0;
            const costPerConversion = conversions > 0 ? (spent / conversions).toFixed(2) : 0;
            const conversionRate = leads > 0 ? ((conversions / leads) * 100).toFixed(1) : 0;
            const roi = spent > 0 ? ((conversions * 100 - spent) / spent).toFixed(2) : 0; // Assuming $100 per conversion value
            const progressToTarget = targetLeads > 0 ? ((leads / targetLeads) * 100).toFixed(1) : 0;
            
            const newCampaign = {
                id: Date.now(),
                name: document.getElementById('campaign_name').value,
                type: document.getElementById('campaign_type').value,
                channels: selectedChannels,
                channelNames: selectedChannels.map(id => {
                    const channel = appState.data.marketingChannels.find(c => c.id === id);
                    return channel ? channel.name : '';
                }).filter(n => n),
                status: document.getElementById('campaign_status').value,
                startDate: document.getElementById('campaign_start').value,
                endDate: document.getElementById('campaign_end').value,
                budget: budget,
                spent: spent,
                leads: leads,
                targetLeads: targetLeads,
                conversions: conversions,
                description: document.getElementById('campaign_description').value,
                // Calculated metrics
                costPerLead: parseFloat(costPerLead),
                costPerConversion: parseFloat(costPerConversion),
                conversionRate: parseFloat(conversionRate),
                roi: parseFloat(roi),
                progressToTarget: parseFloat(progressToTarget),
                budgetUtilization: budget > 0 ? ((spent / budget) * 100).toFixed(1) : 0,
                created: new Date().toISOString().split('T')[0]
            };
            
            // Initialize campaigns array if needed
            if (!appState.data.campaigns) {
                appState.data.campaigns = [];
            }
            
            appState.data.campaigns.unshift(newCampaign);
            
            // Update channel metrics
            selectedChannels.forEach(channelId => {
                const channel = appState.data.marketingChannels.find(c => c.id === channelId);
                if (channel) {
                    channel.spent += spent / selectedChannels.length; // Distribute spend across channels
                    channel.leads += Math.floor(leads / selectedChannels.length);
                    channel.conversions += Math.floor(conversions / selectedChannels.length);
                }
            });
            
            // Log activity
            addRecentActivity('campaign', `Campaign Created: ${newCampaign.name}`, 
                `${newCampaign.type} â€¢ ${newCampaign.channelNames.join(', ')} â€¢ Budget: $${budget.toLocaleString()}`, 'info');
            
            if (saveData()) {
                closeModal();
                showToast('âœ… Campaign created successfully!', 'success');
                switchSection('marketing');
            }
        }

        // Custom Marketing Channel Functions
        function toggleCustomChannelForm() {
            const form = document.getElementById('customChannelForm');
            if (form) {
                if (form.style.display === 'none' || !form.style.display) {
                    form.style.display = 'block';
                    form.style.animation = 'slideDown 0.3s ease';
                } else {
                    form.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        form.style.display = 'none';
                    }, 250);
                }
            }
        }

        function addCustomMarketingChannel() {
            const name = document.getElementById('custom_channel_name')?.value.trim();
            const icon = document.getElementById('custom_channel_icon')?.value.trim();
            const budget = parseFloat(document.getElementById('custom_channel_budget')?.value || 5000);
            const loginUrl = document.getElementById('custom_channel_url')?.value.trim();
            
            // Validation
            if (!name) {
                showToast('âš ï¸ Please enter a channel name', 'warning');
                return;
            }
            
            if (!icon) {
                showToast('âš ï¸ Please select an icon from the dropdown', 'warning');
                return;
            }
            
            // Check for duplicate channel name
            const existingChannel = appState.data.marketingChannels.find(c => 
                c.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingChannel) {
                showToast('âš ï¸ A channel with this name already exists', 'warning');
                return;
            }
            
            // Create new channel with smart defaults
            const newChannel = {
                id: Date.now(),
                name: name,
                icon: icon,
                budget: budget,
                spent: 0,
                leads: 0,
                conversions: 0,
                status: 'Active',
                enabled: true,
                loginUrl: loginUrl || null,
                cpl: 0,
                conversionRate: 0,
                custom: true, // Flag to identify custom channels
                createdDate: new Date().toISOString()
            };
            
            // Add to marketingChannels array
            appState.data.marketingChannels.push(newChannel);
            
            // Save data
            saveData(true);
            
            // Refresh the channels container
            refreshChannelsContainer();
            
            // Clear form inputs
            document.getElementById('custom_channel_name').value = '';
            document.getElementById('custom_channel_icon').value = '';
            document.getElementById('custom_channel_budget').value = 5000;
            document.getElementById('custom_channel_url').value = '';
            
            // Hide form
            toggleCustomChannelForm();
            
            // Show success message
            showToast(`âœ… Custom channel "${name}" added successfully!`, 'success');
            
            // Log activity
            addRecentActivity('marketing', `Custom Channel Created: ${name}`, 
                `${icon} ${name} â€¢ Budget: $${budget.toLocaleString()}`, 'info');
        }

        function refreshChannelsContainer() {
            const container = document.getElementById('channelsContainer');
            if (!container) return;
            
            const channels = appState.data.marketingChannels.map(c => ({ 
                id: c.id, 
                name: c.name, 
                icon: c.icon,
                custom: c.custom || false
            }));
            
            container.innerHTML = channels.map(channel => `
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; 
                              background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
                              border: 1px solid ${channel.custom ? 'rgba(124,92,255,0.3)' : 'rgba(255,255,255,0.05)'};
                              border-radius: 10px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                              position: relative;"
                       onmouseover="this.style.background='linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1))'; this.style.borderColor='var(--accent-primary)'; this.style.transform='translateX(4px)';" 
                       onmouseout="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))'; this.style.borderColor='${channel.custom ? 'rgba(124,92,255,0.3)' : 'rgba(255,255,255,0.05)'}'; this.style.transform='';">
                    ${channel.custom ? '<div style="position: absolute; top: 2px; right: 2px; background: var(--accent-secondary); color: white; font-size: 8px; padding: 2px 6px; border-radius: 4px; font-weight: 700;">CUSTOM</div>' : ''}
                    <input type="checkbox" name="campaign_channels" value="${channel.id}" 
                           style="width: 18px; height: 18px; cursor: pointer; accent-color: ${channel.custom ? 'var(--accent-secondary)' : 'var(--accent-primary)'};">
                    <span style="font-size: 20px;">${channel.icon}</span>
                    <span style="font-size: 13px; font-weight: 600;">${channel.name}</span>
                </label>
            `).join('');
        }
        
        function viewCampaignDetails(campaignId) {
            const campaign = appState.data.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const costPerLead = campaign.leads > 0 ? (campaign.spent / campaign.leads).toFixed(2) : 0;
            const costPerConversion = campaign.conversions > 0 ? (campaign.spent / campaign.conversions).toFixed(2) : 0;
            const conversionRate = campaign.leads > 0 ? ((campaign.conversions / campaign.leads) * 100).toFixed(1) : 0;
            const revenue = (campaign.conversions * 100).toFixed(0); // Assuming $100 per conversion
            const profit = revenue - campaign.spent;
            const budgetRemaining = campaign.budget - campaign.spent;
            const daysRunning = campaign.startDate ? Math.ceil((new Date() - new Date(campaign.startDate)) / (1000 * 60 * 60 * 24)) : 0;
            const daysRemaining = campaign.endDate ? Math.ceil((new Date(campaign.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
            
            // Channel performance breakdown
            const channelBreakdown = campaign.channels ? campaign.channels.map(channelId => {
                const channel = appState.data.marketingChannels.find(c => c.id === channelId);
                return channel ? `<span class="badge badge-info" style="margin: 2px;">${channel.icon} ${channel.name}</span>` : '';
            }).join('') : '';
            
            // Smart insights
            let insights = [];
            if (campaign.roi > 3) {
                insights.push({ type: 'success', text: 'ðŸŽ‰ Excellent ROI performance - campaign is highly profitable!' });
            } else if (campaign.roi < 1) {
                insights.push({ type: 'warning', text: 'âš ï¸ Low ROI detected - consider optimizing targeting or creative' });
            }
            
            if (campaign.progressToTarget > 100) {
                insights.push({ type: 'success', text: 'ðŸŽ¯ Target exceeded! Campaign performing above expectations' });
            } else if (campaign.progressToTarget < 50 && daysRemaining < 7) {
                insights.push({ type: 'danger', text: 'ðŸš¨ Behind target with limited time remaining - action needed' });
            }
            
            if (campaign.conversionRate > 5) {
                insights.push({ type: 'success', text: 'ðŸ’ª Strong conversion rate - quality leads are converting well' });
            } else if (campaign.conversionRate < 2) {
                insights.push({ type: 'warning', text: 'ðŸ“‰ Low conversion rate - review lead quality and nurturing' });
            }
            
            if (budgetRemaining < campaign.budget * 0.1) {
                insights.push({ type: 'warning', text: 'ðŸ’° Budget nearly depleted - prepare for campaign conclusion' });
            }
            
            const detailsHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px; max-height: 70vh; overflow-y: auto;">
                    <!-- Campaign Header -->
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“¢</div>
                        <h2 style="margin-bottom: 8px; color: white;">${campaign.name}</h2>
                        <div style="margin-bottom: 12px;">
                            <span class="badge" style="background: white; color: var(--accent-secondary);">${campaign.type}</span>
                            <span class="badge badge-${campaign.status === 'Active' ? 'success' : campaign.status === 'Completed' ? 'info' : 'warning'}" style="margin-left: 8px;">${campaign.status}</span>
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 14px;">
                            ${campaign.startDate} to ${campaign.endDate}
                        </div>
                    </div>
                    
                    <!-- Channels Used -->
                    ${campaign.channels && campaign.channels.length > 0 ? `
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border-left: 4px solid var(--accent-primary);">
                        <div style="font-weight: 700; margin-bottom: 8px; color: var(--accent-primary);">Marketing Channels</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${channelBreakdown}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${campaign.description ? `
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 8px; color: var(--text-secondary);">Campaign Description</div>
                        <div style="color: var(--text-primary); line-height: 1.6;">${campaign.description}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.2), rgba(110,231,183,0.05)); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                            <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Total Budget</div>
                            <div style="font-weight: 800; font-size: 24px; color: var(--accent-primary);">$${campaign.budget.toLocaleString()}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(124,92,255,0.2), rgba(124,92,255,0.05)); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent-secondary);">
                            <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Amount Spent</div>
                            <div style="font-weight: 800; font-size: 24px; color: var(--accent-secondary);">$${campaign.spent.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${campaign.budgetUtilization}% utilized</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(96,165,250,0.05)); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent-tertiary);">
                            <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Leads Generated</div>
                            <div style="font-weight: 800; font-size: 24px; color: var(--accent-tertiary);">${campaign.leads}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${campaign.progressToTarget}% of ${campaign.targetLeads} target</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(74,222,128,0.05)); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">
                            <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Conversions</div>
                            <div style="font-weight: 800; font-size: 24px; color: var(--success);">${campaign.conversions}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${conversionRate}% rate</div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 16px; font-size: 16px;">Performance Analytics</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Cost per Lead</div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--accent-tertiary);">$${costPerLead}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Cost per Conversion</div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--accent-secondary);">$${costPerConversion}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">ROI</div>
                                <div style="font-weight: 700; font-size: 18px; color: ${campaign.roi > 1 ? 'var(--success)' : 'var(--danger)'};">${campaign.roi}x</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Revenue Generated</div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--accent-gold);">$${revenue}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Profit/Loss</div>
                                <div style="font-weight: 700; font-size: 18px; color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${profit.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Budget Remaining</div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--text-primary);">$${budgetRemaining.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Smart Insights -->
                    ${insights.length > 0 ? `
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; margin-bottom: 12px; font-size: 16px;">ðŸ¤– AI Insights & Recommendations</div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${insights.map(insight => `
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--${insight.type}); font-size: 14px;">
                                    ${insight.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Timeline -->
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 12px;">Campaign Timeline</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Days Running</div>
                                <div style="font-weight: 600; font-size: 18px;">${daysRunning}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Days Remaining</div>
                                <div style="font-weight: 600; font-size: 18px; color: ${daysRemaining < 7 ? 'var(--warning)' : 'var(--text-primary)'};">${daysRemaining}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">Created</div>
                                <div style="font-weight: 600; font-size: 14px;">${campaign.created || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 8px;">
                        <button class="btn-secondary" onclick="closeModal(); editCampaign(${campaign.id});" style="background: var(--accent-tertiary);">
                            âœï¸ Edit
                        </button>
                        <button class="btn-secondary" onclick="toggleCampaignStatus(${campaign.id})" 
                                style="background: ${campaign.status === 'Paused' ? 'var(--success)' : 'var(--warning)'};">
                            ${campaign.status === 'Paused' ? 'â–¶ï¸ Activate' : 'â¸ï¸ Pause'}
                        </button>
                        <button class="btn-secondary" onclick="deleteCampaign(${campaign.id})" style="background: var(--danger);">
                            ðŸ—‘ï¸ Delete
                        </button>
                    </div>
                </div>
            `;
            showModal(`Campaign Analytics - ${campaign.name}`, detailsHTML);
        }
        
        function editCampaign(campaignId) {
            showToast('Campaign editing feature coming soon!', 'info');
            // TODO: Implement edit functionality
        }
        
        function deleteCampaign(campaignId) {
            const campaign = appState.data.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            // Smart confirmation with context
            const warningMsg = `
âš ï¸ DELETE CAMPAIGN: ${campaign.name}

This will permanently delete:
â€¢ Campaign budget: $${campaign.budget.toLocaleString()}
â€¢ Spent amount: $${campaign.spent.toLocaleString()}
â€¢ ${campaign.leads} leads generated
â€¢ ${campaign.conversions} conversions tracked
â€¢ All campaign performance data

${campaign.status === 'Active' ? 'âš ï¸ WARNING: This campaign is currently ACTIVE!\n' : ''}
This action CANNOT be undone.

Are you absolutely sure you want to delete this campaign?`;

            if (confirm(warningMsg)) {
                const index = appState.data.campaigns.findIndex(c => c.id === campaignId);
                if (index !== -1) {
                    appState.data.campaigns.splice(index, 1);
                    
                    // Log deletion with details
                    addRecentActivity('delete', `Campaign Deleted: ${campaign.name}`, 
                        `Budget: $${campaign.budget.toLocaleString()} | Spent: $${campaign.spent.toLocaleString()} | ${campaign.leads} leads`, 
                        'warning');
                    
                    if (saveData()) {
                        closeModal();
                        showToast(`âœ… Campaign "${campaign.name}" has been permanently deleted`, 'success');
                        switchSection('marketing');
                    }
                }
            }
        }
        
        // Toggle campaign status between Active and Paused
        function toggleCampaignStatus(campaignId) {
            const campaign = appState.data.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            // Smart status toggling logic
            if (campaign.status === 'Paused') {
                campaign.status = 'Active';
                showToast(`âœ… Campaign "${campaign.name}" is now ACTIVE and running!`, 'success');
                addRecentActivity('update', `Campaign Activated: ${campaign.name}`, 
                    `Resumed campaign operations â€¢ Budget: $${campaign.budget.toLocaleString()}`, 'success');
            } else if (campaign.status === 'Active') {
                campaign.status = 'Paused';
                showToast(`â¸ï¸ Campaign "${campaign.name}" has been PAUSED`, 'warning');
                addRecentActivity('update', `Campaign Paused: ${campaign.name}`, 
                    `Campaign spending frozen â€¢ Spent so far: $${campaign.spent.toLocaleString()}`, 'warning');
            } else if (campaign.status === 'Completed') {
                // Allow reactivating completed campaigns
                if (confirm(`Campaign "${campaign.name}" is marked as Completed. Do you want to reactivate it?`)) {
                    campaign.status = 'Active';
                    showToast(`âœ… Campaign "${campaign.name}" has been REACTIVATED!`, 'success');
                    addRecentActivity('update', `Campaign Reactivated: ${campaign.name}`, 
                        `Previously completed campaign resumed`, 'info');
                } else {
                    return; // Don't save if user cancels
                }
            } else if (campaign.status === 'Planning') {
                campaign.status = 'Active';
                showToast(`ðŸš€ Campaign "${campaign.name}" launched from planning!`, 'success');
                addRecentActivity('update', `Campaign Launched: ${campaign.name}`, 
                    `Campaign moved from planning to active status`, 'success');
            }
            
            saveData();
            closeModal();
            
            // Show updated details
            setTimeout(() => viewCampaignDetails(campaignId), 300);
        }

        // STRATEGIC PLANNING WORKSPACE - COMPREHENSIVE BUSINESS PLANNING
        function renderStrategicPlanning(container) {
            const planning = appState.data.strategicPlanning;
            const businessUnits = planning.businessUnits || [];
            const documents = planning.documents || [];
            const goals = planning.goals || [];
            
            container.innerHTML = `
                <div style="display: grid; gap: 24px;">
                    <!-- Header Stats -->
                    <div class="stats-grid">
                        <div class="stat-card" style="cursor: pointer;" onclick="switchStrategicTab('units')">
                            <div class="stat-icon">ðŸ¢</div>
                            <div class="stat-label">Business Units</div>
                            <div class="stat-value">${businessUnits.length}</div>
                            <div class="stat-change">Active units</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="switchStrategicTab('documents')">
                            <div class="stat-icon">ðŸ“„</div>
                            <div class="stat-label">Planning Documents</div>
                            <div class="stat-value">${documents.length}</div>
                            <div class="stat-change">Stored files</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="switchStrategicTab('canvas')">
                            <div class="stat-icon">ðŸŽ¯</div>
                            <div class="stat-label">Strategic Goals</div>
                            <div class="stat-value">${goals.length}</div>
                            <div class="stat-change">Active goals</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="switchStrategicTab('swot')">
                            <div class="stat-icon">ðŸ“Š</div>
                            <div class="stat-label">SWOT Analysis</div>
                            <div class="stat-value">${(planning.swotAnalysis.strengths.length + planning.swotAnalysis.opportunities.length)}</div>
                            <div class="stat-change">Total insights</div>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 12px; border-bottom: 2px solid var(--glass-border); padding-bottom: 12px; flex-wrap: wrap;">
                        <button onclick="switchStrategicTab('mission')" class="strategic-tab" data-tab="mission" 
                                style="padding: 12px 24px; background: var(--accent-primary); color: var(--bg-primary); 
                                border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸŽ¯ Mission/Vision
                        </button>
                        <button onclick="switchStrategicTab('units')" class="strategic-tab" data-tab="units" 
                                style="padding: 12px 24px; background: var(--bg-glass); color: var(--text-primary); 
                                border: 1px solid var(--glass-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸ¢ Business Units
                        </button>
                        <button onclick="switchStrategicTab('documents')" class="strategic-tab" data-tab="documents"
                                style="padding: 12px 24px; background: var(--bg-glass); color: var(--text-primary); 
                                border: 1px solid var(--glass-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸ“„ Documents
                        </button>
                        <button onclick="switchStrategicTab('canvas')" class="strategic-tab" data-tab="canvas"
                                style="padding: 12px 24px; background: var(--bg-glass); color: var(--text-primary); 
                                border: 1px solid var(--glass-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸŽ¯ Business Model Canvas
                        </button>
                        <button onclick="switchStrategicTab('swot')" class="strategic-tab" data-tab="swot"
                                style="padding: 12px 24px; background: var(--bg-glass); color: var(--text-primary); 
                                border: 1px solid var(--glass-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸ“Š SWOT Analysis
                        </button>
                        <button onclick="switchStrategicTab('goals')" class="strategic-tab" data-tab="goals"
                                style="padding: 12px 24px; background: var(--bg-glass); color: var(--text-primary); 
                                border: 1px solid var(--glass-border); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ðŸŽ¯ Strategic Goals
                        </button>
                    </div>

                    <!-- Tab Content Areas -->
                    <div id="strategic-content"></div>
                </div>
            `;
            
            // Show default tab
            switchStrategicTab('mission');
        }

        function switchStrategicTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.strategic-tab').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.style.background = 'var(--accent-primary)';
                    btn.style.color = 'var(--bg-primary)';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'var(--bg-glass)';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.border = '1px solid var(--glass-border)';
                }
            });
            
            const content = document.getElementById('strategic-content');
            
            switch(tab) {
                case 'mission':
                    renderMissionVisionValues(content);
                    break;
                case 'units':
                    renderBusinessUnits(content);
                    break;
                case 'documents':
                    renderPlanningDocuments(content);
                    break;
                case 'canvas':
                    renderBusinessModelCanvas(content);
                    break;
                case 'swot':
                    renderSWOTAnalysis(content);
                    break;
                case 'goals':
                    renderStrategicGoals(content);
                    break;
            }
        }

        function renderMissionVisionValues(container) {
            // Initialize if not exists
            if (!appState.data.strategicPlanning.mission) {
                appState.data.strategicPlanning.mission = '';
                appState.data.strategicPlanning.vision = '';
                appState.data.strategicPlanning.valueProposition = '';
            }
            
            const planning = appState.data.strategicPlanning;
            
            container.innerHTML = `
                <div style="display: grid; gap: 24px;">
                    <!-- Mission Statement -->
                    <div class="card">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 32px; text-align: center; margin-bottom: 12px;">ðŸŽ¯</div>
                            <div style="font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 8px; color: var(--accent-primary);">Mission Statement</div>
                            <div style="font-size: 14px; color: var(--text-muted); text-align: center;">Define your organization's purpose and core reason for existence</div>
                        </div>
                        
                        <div style="position: relative;">
                            <textarea id="mission_statement" 
                                      style="width: 100%; min-height: 150px; padding: 16px; background: var(--bg-glass); border: 2px solid var(--glass-border); 
                                      border-radius: 12px; color: var(--text-primary); font-size: 15px; line-height: 1.6; resize: vertical; font-family: inherit;"
                                      placeholder="Our mission is to...">${planning.mission || ''}</textarea>
                            <button onclick="saveMissionVisionValues('mission')" 
                                    style="margin-top: 12px; padding: 12px 24px; background: var(--accent-primary); color: var(--bg-primary); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ðŸ’¾ Save Mission
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vision Statement -->
                    <div class="card">
                        <div style="background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(124,92,255,0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 32px; text-align: center; margin-bottom: 12px;">ðŸ”®</div>
                            <div style="font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 8px; color: var(--accent-tertiary);">Vision Statement</div>
                            <div style="font-size: 14px; color: var(--text-muted); text-align: center;">Paint a picture of your organization's desired future state</div>
                        </div>
                        
                        <div style="position: relative;">
                            <textarea id="vision_statement" 
                                      style="width: 100%; min-height: 150px; padding: 16px; background: var(--bg-glass); border: 2px solid var(--glass-border); 
                                      border-radius: 12px; color: var(--text-primary); font-size: 15px; line-height: 1.6; resize: vertical; font-family: inherit;"
                                      placeholder="Our vision is to become...">${planning.vision || ''}</textarea>
                            <button onclick="saveMissionVisionValues('vision')" 
                                    style="margin-top: 12px; padding: 12px 24px; background: var(--accent-tertiary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ðŸ’¾ Save Vision
                            </button>
                        </div>
                    </div>
                    
                    <!-- Value Proposition -->
                    <div class="card">
                        <div style="background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(124,92,255,0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 32px; text-align: center; margin-bottom: 12px;">ðŸ’Ž</div>
                            <div style="font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 8px; color: var(--accent-gold);">Value Proposition</div>
                            <div style="font-size: 14px; color: var(--text-muted); text-align: center;">Articulate the unique value you deliver to customers</div>
                        </div>
                        
                        <div style="position: relative;">
                            <textarea id="value_proposition" 
                                      style="width: 100%; min-height: 150px; padding: 16px; background: var(--bg-glass); border: 2px solid var(--glass-border); 
                                      border-radius: 12px; color: var(--text-primary); font-size: 15px; line-height: 1.6; resize: vertical; font-family: inherit;"
                                      placeholder="We help our customers...">${planning.valueProposition || ''}</textarea>
                            <button onclick="saveMissionVisionValues('valueProposition')" 
                                    style="margin-top: 12px; padding: 12px 24px; background: var(--accent-gold); color: var(--bg-primary); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ðŸ’¾ Save Value Proposition
                            </button>
                        </div>
                    </div>
                    
                    <!-- Save All Button -->
                    <div style="display: flex; justify-content: center; padding: 20px;">
                        <button onclick="saveMissionVisionValues('all')" 
                                style="padding: 16px 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); 
                                color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; 
                                box-shadow: 0 4px 12px rgba(110,231,183,0.3); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(110,231,183,0.4)';"
                                onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(110,231,183,0.3)';">
                            ðŸ’¾ Save All Changes
                        </button>
                    </div>
                </div>
            `;
        }

        function saveMissionVisionValues(type) {
            if (type === 'mission' || type === 'all') {
                const missionValue = document.getElementById('mission_statement').value;
                appState.data.strategicPlanning.mission = missionValue;
                addRecentActivity('strategic_update', 'Updated Mission Statement', 'info');
            }
            
            if (type === 'vision' || type === 'all') {
                const visionValue = document.getElementById('vision_statement').value;
                appState.data.strategicPlanning.vision = visionValue;
                addRecentActivity('strategic_update', 'Updated Vision Statement', 'info');
            }
            
            if (type === 'valueProposition' || type === 'all') {
                const valueValue = document.getElementById('value_proposition').value;
                appState.data.strategicPlanning.valueProposition = valueValue;
                addRecentActivity('strategic_update', 'Updated Value Proposition', 'info');
            }
            
            saveData();
            
            if (type === 'all') {
                showToast('âœ… All strategic statements saved successfully!', 'success');
            } else {
                const labels = {
                    mission: 'Mission Statement',
                    vision: 'Vision Statement',
                    valueProposition: 'Value Proposition'
                };
                showToast(`âœ… ${labels[type]} saved successfully!`, 'success');
            }
        }

        function renderBusinessUnits(container) {
            const businessUnits = appState.data.strategicPlanning.businessUnits || [];
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Business Units</div>
                        <button class="btn-primary" onclick="showAddBusinessUnit()">+ Add Business Unit</button>
                    </div>
                    ${businessUnits.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ¢</div>
                            <div style="font-size: 18px; margin-bottom: 8px;">No Business Units Yet</div>
                            <div style="font-size: 14px;">Add your first business unit to start planning</div>
                        </div>
                    ` : `
                        <div style="display: grid; gap: 16px; padding: 20px;">
                            ${businessUnits.map(unit => `
                                <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div>
                                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">${unit.name}</div>
                                            <div style="color: var(--text-secondary);">${unit.description || 'No description'}</div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="action-btn" onclick="editBusinessUnit(${unit.id})" style="background: var(--accent-tertiary);">Edit</button>
                                            <button class="action-btn delete" onclick="deleteBusinessUnit(${unit.id})">Delete</button>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">TYPE</div>
                                            <div style="font-weight: 600;">${unit.type}</div>
                                        </div>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">STATUS</div>
                                            <div style="font-weight: 600;">
                                                <span class="badge ${unit.status === 'Active' ? 'badge-success' : 'badge-warning'}">${unit.status}</span>
                                            </div>
                                        </div>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">DOCUMENTS</div>
                                            <div style="font-weight: 600;">${unit.documentsCount || 0}</div>
                                        </div>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">CREATED</div>
                                            <div style="font-weight: 600;">${unit.created}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderPlanningDocuments(container) {
            const documents = appState.data.strategicPlanning.documents || [];
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Planning Documents</div>
                        <button class="btn-primary" onclick="showUploadDocument()">ðŸ“¤ Upload Document</button>
                    </div>
                    ${documents.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div>
                            <div style="font-size: 18px; margin-bottom: 8px;">No Documents Uploaded</div>
                            <div style="font-size: 14px;">Upload .docx, Google Sheets, marketing assessments, and business plans</div>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Document Name</th>
                                        <th>Type</th>
                                        <th>Business Unit</th>
                                        <th>Upload Date</th>
                                        <th>Size</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${documents.map(doc => `
                                        <tr>
                                            <td><strong>${doc.name}</strong></td>
                                            <td><span class="badge badge-info">${doc.type}</span></td>
                                            <td>${doc.businessUnit || 'General'}</td>
                                            <td>${doc.uploadDate}</td>
                                            <td>${doc.size}</td>
                                            <td>
                                                <button class="action-btn" onclick="viewDocument(${doc.id})" style="background: var(--accent-tertiary); margin-right: 8px;">View</button>
                                                <button class="action-btn delete" onclick="deleteDocument(${doc.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        function renderBusinessModelCanvas(container) {
            const canvas = appState.data.strategicPlanning.businessModelCanvas;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Business Model Canvas</div>
                        <button class="btn-primary" onclick="saveBusinessModelCanvas()">ðŸ’¾ Save Canvas</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 16px;">
                            <!-- Row 1 -->
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border: 2px solid var(--accent-primary);">
                                <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-primary);">ðŸ¤ Key Partners</div>
                                <textarea id="canvas_keyPartners" placeholder="Who are your key partners and suppliers?"
                                          style="width: 100%; min-height: 150px; padding: 12px; background: var(--bg-secondary); 
                                          border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                          font-size: 13px; font-family: inherit; resize: vertical;">${canvas.keyPartners || ''}</textarea>
                            </div>
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border: 2px solid var(--accent-secondary); grid-column: span 2;">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-secondary);">âš¡ Key Activities</div>
                                        <textarea id="canvas_keyActivities" placeholder="What key activities does your value proposition require?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.keyActivities || ''}</textarea>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-secondary);">ðŸŽ Value Propositions</div>
                                        <textarea id="canvas_valuePropositions" placeholder="What value do you deliver to customers?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.valuePropositions || ''}</textarea>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-secondary);">ðŸ’¡ Key Resources</div>
                                        <textarea id="canvas_keyResources" placeholder="What key resources does your value proposition require?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.keyResources || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border: 2px solid var(--accent-tertiary); grid-column: span 2;">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-tertiary);">ðŸ¤ Customer Relationships</div>
                                        <textarea id="canvas_customerRelationships" placeholder="What type of relationship does each customer segment expect?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.customerRelationships || ''}</textarea>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-tertiary);">ðŸ“¡ Channels</div>
                                        <textarea id="canvas_channels" placeholder="Through which channels do customers want to be reached?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.channels || ''}</textarea>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-tertiary);">ðŸ‘¥ Customer Segments</div>
                                        <textarea id="canvas_customerSegments" placeholder="For whom are you creating value?"
                                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-secondary); 
                                                  border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                                  font-size: 13px; font-family: inherit; resize: vertical;">${canvas.customerSegments || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2 - Bottom -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border: 2px solid var(--danger);">
                                <div style="font-weight: 700; margin-bottom: 12px; color: var(--danger);">ðŸ’¸ Cost Structure</div>
                                <textarea id="canvas_costStructure" placeholder="What are the most important costs? Which key resources/activities are most expensive?"
                                          style="width: 100%; min-height: 150px; padding: 12px; background: var(--bg-secondary); 
                                          border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                          font-size: 13px; font-family: inherit; resize: vertical;">${canvas.costStructure || ''}</textarea>
                            </div>
                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; border: 2px solid var(--success);">
                                <div style="font-weight: 700; margin-bottom: 12px; color: var(--success);">ðŸ’° Revenue Streams</div>
                                <textarea id="canvas_revenueStreams" placeholder="For what value are customers willing to pay? How and what do they currently pay?"
                                          style="width: 100%; min-height: 150px; padding: 12px; background: var(--bg-secondary); 
                                          border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); 
                                          font-size: 13px; font-family: inherit; resize: vertical;">${canvas.revenueStreams || ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSWOTAnalysis(container) {
            const swot = appState.data.strategicPlanning.swotAnalysis;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">SWOT Analysis</div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Strengths -->
                            <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(110,231,183,0.05)); 
                                        padding: 20px; border-radius: 12px; border: 2px solid var(--success);">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--success); display: flex; align-items: center; gap: 12px;">
                                    <span>ðŸ’ª</span> Strengths
                                    <button onclick="addSWOTItem('strengths')" 
                                            style="margin-left: auto; padding: 10px 18px; 
                                                   background: linear-gradient(135deg, var(--success), #2ecc71); 
                                                   color: white; border: none; border-radius: 10px; cursor: pointer; 
                                                   font-size: 13px; font-weight: 700;
                                                   box-shadow: 0 4px 12px rgba(74,222,128,0.3);
                                                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                                   display: flex; align-items: center; gap: 6px;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(74,222,128,0.5)';"
                                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(74,222,128,0.3)';">
                                        <span style="font-size: 16px;">+</span> Add Strength
                                    </button>
                                </div>
                                <div id="swot-strengths" style="display: grid; gap: 10px;">
                                    ${swot.strengths.map((item, i) => `
                                        <div style="display: flex; gap: 10px; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <input value="${item}" onchange="updateSWOTItem('strengths', ${i}, this.value)" 
                                                   style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px;">
                                            <button onclick="removeSWOTItem('strengths', ${i})" 
                                                    style="background: linear-gradient(135deg, var(--danger), #e74c3c); color: white; 
                                                           border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
                                                           font-size: 14px; font-weight: 700;
                                                           transition: all 0.2s ease;
                                                           box-shadow: 0 2px 8px rgba(255,107,107,0.3);"
                                                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255,107,107,0.5)';"
                                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';">Ã—</button>
                                        </div>
                                    `).join('')}
                                    ${swot.strengths.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No strengths added</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- Weaknesses -->
                            <div style="background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,107,107,0.05)); 
                                        padding: 20px; border-radius: 12px; border: 2px solid var(--danger);">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--danger); display: flex; align-items: center; gap: 12px;">
                                    <span>âš ï¸</span> Weaknesses
                                    <button onclick="addSWOTItem('weaknesses')" 
                                            style="margin-left: auto; padding: 10px 18px; 
                                                   background: linear-gradient(135deg, var(--danger), #e74c3c); 
                                                   color: white; border: none; border-radius: 10px; cursor: pointer; 
                                                   font-size: 13px; font-weight: 700;
                                                   box-shadow: 0 4px 12px rgba(255,107,107,0.3);
                                                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                                   display: flex; align-items: center; gap: 6px;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255,107,107,0.5)';"
                                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(255,107,107,0.3)';">
                                        <span style="font-size: 16px;">+</span> Add Weakness
                                    </button>
                                </div>
                                <div id="swot-weaknesses" style="display: grid; gap: 10px;">
                                    ${swot.weaknesses.map((item, i) => `
                                        <div style="display: flex; gap: 10px; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <input value="${item}" onchange="updateSWOTItem('weaknesses', ${i}, this.value)" 
                                                   style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px;">
                                            <button onclick="removeSWOTItem('weaknesses', ${i})" 
                                                    style="background: linear-gradient(135deg, var(--danger), #e74c3c); color: white; 
                                                           border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
                                                           font-size: 14px; font-weight: 700;
                                                           transition: all 0.2s ease;
                                                           box-shadow: 0 2px 8px rgba(255,107,107,0.3);"
                                                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255,107,107,0.5)';"
                                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';">Ã—</button>
                                        </div>
                                    `).join('')}
                                    ${swot.weaknesses.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No weaknesses added</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- Opportunities -->
                            <div style="background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(96,165,250,0.05)); 
                                        padding: 20px; border-radius: 12px; border: 2px solid var(--accent-tertiary);">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-tertiary); display: flex; align-items: center; gap: 12px;">
                                    <span>ðŸŽ¯</span> Opportunities
                                    <button onclick="addSWOTItem('opportunities')" 
                                            style="margin-left: auto; padding: 10px 18px; 
                                                   background: linear-gradient(135deg, var(--accent-tertiary), #3b82f6); 
                                                   color: white; border: none; border-radius: 10px; cursor: pointer; 
                                                   font-size: 13px; font-weight: 700;
                                                   box-shadow: 0 4px 12px rgba(96,165,250,0.3);
                                                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                                   display: flex; align-items: center; gap: 6px;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(96,165,250,0.5)';"
                                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(96,165,250,0.3)';">
                                        <span style="font-size: 16px;">+</span> Add Opportunity
                                    </button>
                                </div>
                                <div id="swot-opportunities" style="display: grid; gap: 10px;">
                                    ${swot.opportunities.map((item, i) => `
                                        <div style="display: flex; gap: 10px; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <input value="${item}" onchange="updateSWOTItem('opportunities', ${i}, this.value)" 
                                                   style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px;">
                                            <button onclick="removeSWOTItem('opportunities', ${i})" 
                                                    style="background: linear-gradient(135deg, var(--danger), #e74c3c); color: white; 
                                                           border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
                                                           font-size: 14px; font-weight: 700;
                                                           transition: all 0.2s ease;
                                                           box-shadow: 0 2px 8px rgba(255,107,107,0.3);"
                                                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255,107,107,0.5)';"
                                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';">Ã—</button>
                                        </div>
                                    `).join('')}
                                    ${swot.opportunities.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No opportunities added</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- Threats -->
                            <div style="background: linear-gradient(135deg, rgba(255,182,107,0.1), rgba(255,182,107,0.05)); 
                                        padding: 20px; border-radius: 12px; border: 2px solid var(--warning);">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--warning); display: flex; align-items: center; gap: 12px;">
                                    <span>âš¡</span> Threats
                                    <button onclick="addSWOTItem('threats')" 
                                            style="margin-left: auto; padding: 10px 18px; 
                                                   background: linear-gradient(135deg, var(--warning), #f39c12); 
                                                   color: white; border: none; border-radius: 10px; cursor: pointer; 
                                                   font-size: 13px; font-weight: 700;
                                                   box-shadow: 0 4px 12px rgba(255,182,107,0.3);
                                                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                                   display: flex; align-items: center; gap: 6px;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255,182,107,0.5)';"
                                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(255,182,107,0.3)';">
                                        <span style="font-size: 16px;">+</span> Add Threat
                                    </button>
                                </div>
                                <div id="swot-threats" style="display: grid; gap: 10px;">
                                    ${swot.threats.map((item, i) => `
                                        <div style="display: flex; gap: 10px; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <input value="${item}" onchange="updateSWOTItem('threats', ${i}, this.value)" 
                                                   style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px;">
                                            <button onclick="removeSWOTItem('threats', ${i})" 
                                                    style="background: linear-gradient(135deg, var(--danger), #e74c3c); color: white; 
                                                           border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
                                                           font-size: 14px; font-weight: 700;
                                                           transition: all 0.2s ease;
                                                           box-shadow: 0 2px 8px rgba(255,107,107,0.3);"
                                                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(255,107,107,0.5)';"
                                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(255,107,107,0.3)';">Ã—</button>
                                        </div>
                                    `).join('')}
                                    ${swot.threats.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No threats added</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStrategicGoals(container) {
            const goals = appState.data.strategicPlanning.goals || [];
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Strategic Goals & KPIs</div>
                        <button class="btn-primary" onclick="showAddStrategicGoal()" 
                                style="padding: 10px 20px; 
                                       background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); 
                                       color: white; border: none; border-radius: 10px; cursor: pointer; 
                                       font-size: 14px; font-weight: 700;
                                       box-shadow: 0 4px 12px rgba(110,231,183,0.3);
                                       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                       display: flex; align-items: center; gap: 8px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(110,231,183,0.5)';"
                                onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(110,231,183,0.3)';">
                            <span style="font-size: 18px;">+</span> Add Goal
                        </button>
                    </div>
                    ${goals.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸŽ¯</div>
                            <div style="font-size: 18px; margin-bottom: 8px;">No Strategic Goals Set</div>
                            <div style="font-size: 14px;">Define your strategic objectives and key results</div>
                        </div>
                    ` : `
                        <div style="padding: 20px; display: grid; gap: 16px;">
                            ${goals.map(goal => `
                                <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-primary);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${goal.title}</div>
                                            <div style="color: var(--text-secondary); font-size: 14px;">${goal.description}</div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="action-btn" onclick="editStrategicGoal(${goal.id})" style="background: var(--accent-tertiary);">Edit</button>
                                            <button class="action-btn delete" onclick="deleteStrategicGoal(${goal.id})">Delete</button>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">TARGET DATE</div>
                                            <div style="font-weight: 600;">${goal.targetDate}</div>
                                        </div>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">OWNER</div>
                                            <div style="font-weight: 600;">${goal.owner || 'Not assigned'}</div>
                                        </div>
                                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">PROGRESS</div>
                                            <div style="font-weight: 600; color: var(--accent-primary);">${goal.progress}%</div>
                                        </div>
                                    </div>
                                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                                        <div style="background: var(--accent-primary); height: 100%; width: ${goal.progress}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Business Unit CRUD Functions
        function showAddBusinessUnit() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleBusinessUnitSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Unit Name</label>
                        <input type="text" id="unit_name" required placeholder="e.g., Product Development"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="unit_description" placeholder="Brief description of the business unit"
                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="unit_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Product">Product</option>
                                <option value="Service">Service</option>
                                <option value="Department">Department</option>
                                <option value="Division">Division</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="unit_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Planning">Planning</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Create Business Unit</button>
                </form>
            `;
            showModal('Add Business Unit', formHTML);
        }

        function handleBusinessUnitSubmit(event) {
            event.preventDefault();
            const newUnit = {
                id: Date.now(),
                name: document.getElementById('unit_name').value,
                description: document.getElementById('unit_description').value,
                type: document.getElementById('unit_type').value,
                status: document.getElementById('unit_status').value,
                created: new Date().toISOString().split('T')[0],
                documentsCount: 0
            };
            
            if (!appState.data.strategicPlanning.businessUnits) {
                appState.data.strategicPlanning.businessUnits = [];
            }
            
            appState.data.strategicPlanning.businessUnits.push(newUnit);
            saveData();
            closeModal();
            showToast('Business unit created successfully!');
            switchSection('strategic-planning');
        }

        function editBusinessUnit(id) {
            const unit = appState.data.strategicPlanning.businessUnits.find(u => u.id === id);
            if (!unit) return;
            
            const formHTML = `
                <form onsubmit="handleBusinessUnitEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Unit Name</label>
                        <input type="text" id="unit_name" required value="${unit.name}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="unit_description"
                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;">${unit.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="unit_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Product" ${unit.type === 'Product' ? 'selected' : ''}>Product</option>
                                <option value="Service" ${unit.type === 'Service' ? 'selected' : ''}>Service</option>
                                <option value="Department" ${unit.type === 'Department' ? 'selected' : ''}>Department</option>
                                <option value="Division" ${unit.type === 'Division' ? 'selected' : ''}>Division</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="unit_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active" ${unit.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Planning" ${unit.status === 'Planning' ? 'selected' : ''}>Planning</option>
                                <option value="On Hold" ${unit.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Business Unit</button>
                </form>
            `;
            showModal('Edit Business Unit', formHTML);
        }

        function handleBusinessUnitEdit(event, id) {
            event.preventDefault();
            const unit = appState.data.strategicPlanning.businessUnits.find(u => u.id === id);
            if (!unit) return;
            
            unit.name = document.getElementById('unit_name').value;
            unit.description = document.getElementById('unit_description').value;
            unit.type = document.getElementById('unit_type').value;
            unit.status = document.getElementById('unit_status').value;
            
            saveData();
            closeModal();
            showToast('Business unit updated successfully!');
            switchSection('strategic-planning');
        }

        function deleteBusinessUnit(id) {
            if (confirm('Delete this business unit?')) {
                appState.data.strategicPlanning.businessUnits = 
                    appState.data.strategicPlanning.businessUnits.filter(u => u.id !== id);
                saveData();
                switchSection('strategic-planning');
                showToast('Business unit deleted');
            }
        }

        // Document Upload Functions
        function showUploadDocument() {
            const businessUnits = appState.data.strategicPlanning.businessUnits || [];
            const formHTML = `
                <form onsubmit="handleDocumentUpload(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            ðŸ“Œ <strong>Supported formats:</strong> .docx, .xlsx, .pdf, .pptx, Google Sheets links, marketing assessments
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Document Name</label>
                        <input type="text" id="doc_name" required placeholder="e.g., Q4 Marketing Strategy"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Document Type</label>
                        <select id="doc_type" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <option value="Business Plan">Business Plan</option>
                            <option value="Marketing Assessment">Marketing Assessment</option>
                            <option value="Financial Analysis">Financial Analysis</option>
                            <option value="Strategy Document">Strategy Document</option>
                            <option value="Market Research">Market Research</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Business Unit (Optional)</label>
                        <select id="doc_unit"
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <option value="">General</option>
                            ${businessUnits.map(u => `<option value="${u.name}">${u.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Upload File or Link</label>
                        <input type="file" id="doc_file" accept=".docx,.xlsx,.pdf,.pptx"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; cursor: pointer;">
                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                            Or paste Google Sheets/Drive link:
                        </div>
                        <input type="url" id="doc_link" placeholder="https://docs.google.com/..."
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Upload Document</button>
                </form>
            `;
            showModal('Upload Planning Document', formHTML);
        }

        function handleDocumentUpload(event) {
            event.preventDefault();
            const file = document.getElementById('doc_file').files[0];
            const link = document.getElementById('doc_link').value;
            
            if (!file && !link) {
                showToast('Please select a file or enter a link');
                return;
            }
            
            const newDocument = {
                id: Date.now(),
                name: document.getElementById('doc_name').value,
                type: document.getElementById('doc_type').value,
                businessUnit: document.getElementById('doc_unit').value || 'General',
                uploadDate: new Date().toISOString().split('T')[0],
                size: file ? `${(file.size / 1024).toFixed(2)} KB` : 'Link',
                link: link || null,
                fileName: file ? file.name : null
            };
            
            if (!appState.data.strategicPlanning.documents) {
                appState.data.strategicPlanning.documents = [];
            }
            
            appState.data.strategicPlanning.documents.push(newDocument);
            saveData();
            closeModal();
            showToast('Document uploaded successfully!');
            switchSection('strategic-planning');
        }

        function viewDocument(id) {
            const doc = appState.data.strategicPlanning.documents.find(d => d.id === id);
            if (!doc) return;
            
            const content = `
                <div style="display: grid; gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-glass); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“„</div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">${doc.name}</div>
                        <span class="badge badge-info">${doc.type}</span>
                    </div>
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Business Unit:</span>
                                <span>${doc.businessUnit}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Upload Date:</span>
                                <span>${doc.uploadDate}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Size:</span>
                                <span>${doc.size}</span>
                            </div>
                            ${doc.link ? `
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">Link:</div>
                                    <a href="${doc.link}" target="_blank" style="color: var(--accent-tertiary); word-break: break-all;">${doc.link}</a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        ${doc.link ? `<button class="btn-primary" onclick="window.open('${doc.link}', '_blank')" style="flex: 1;">Open Link</button>` : ''}
                        <button class="btn-secondary" onclick="closeModal()" style="flex: 1;">Close</button>
                    </div>
                </div>
            `;
            showModal('Document Details', content);
        }

        function deleteDocument(id) {
            if (confirm('Delete this document?')) {
                appState.data.strategicPlanning.documents = 
                    appState.data.strategicPlanning.documents.filter(d => d.id !== id);
                saveData();
                switchSection('strategic-planning');
                showToast('Document deleted');
            }
        }

        // Business Model Canvas Functions
        function saveBusinessModelCanvas() {
            appState.data.strategicPlanning.businessModelCanvas = {
                keyPartners: document.getElementById('canvas_keyPartners').value,
                keyActivities: document.getElementById('canvas_keyActivities').value,
                keyResources: document.getElementById('canvas_keyResources').value,
                valuePropositions: document.getElementById('canvas_valuePropositions').value,
                customerRelationships: document.getElementById('canvas_customerRelationships').value,
                channels: document.getElementById('canvas_channels').value,
                customerSegments: document.getElementById('canvas_customerSegments').value,
                costStructure: document.getElementById('canvas_costStructure').value,
                revenueStreams: document.getElementById('canvas_revenueStreams').value
            };
            saveData();
            showToast('Business Model Canvas saved successfully!');
        }

        // SWOT Analysis Functions
        function addSWOTItem(category) {
            const newItem = prompt(`Add new ${category.slice(0, -1)}:`);
            if (newItem && newItem.trim()) {
                appState.data.strategicPlanning.swotAnalysis[category].push(newItem.trim());
                saveData();
                switchStrategicTab('swot');
                showToast(`${category.charAt(0).toUpperCase() + category.slice(1, -1)} added`);
            }
        }

        function updateSWOTItem(category, index, value) {
            appState.data.strategicPlanning.swotAnalysis[category][index] = value;
            saveData();
        }

        function removeSWOTItem(category, index) {
            if (confirm('Remove this item?')) {
                appState.data.strategicPlanning.swotAnalysis[category].splice(index, 1);
                saveData();
                switchStrategicTab('swot');
            }
        }

        function saveSWOTAnalysis() {
            saveData();
            showToast('SWOT Analysis saved successfully!');
        }

        // Strategic Goals Functions
        function showAddStrategicGoal() {
            const formHTML = `
                <form onsubmit="handleStrategicGoalSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Goal Title</label>
                        <input type="text" id="goal_title" required placeholder="e.g., Increase market share by 25%"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="goal_description" placeholder="Detailed description of the goal"
                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Target Date</label>
                            <input type="date" id="goal_targetDate" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Owner</label>
                            <input type="text" id="goal_owner" placeholder="Goal owner"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Progress (%)</label>
                            <input type="number" id="goal_progress" min="0" max="100" value="0"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Create Goal</button>
                </form>
            `;
            showModal('Add Strategic Goal', formHTML);
        }

        function handleStrategicGoalSubmit(event) {
            event.preventDefault();
            const newGoal = {
                id: Date.now(),
                title: document.getElementById('goal_title').value,
                description: document.getElementById('goal_description').value,
                targetDate: document.getElementById('goal_targetDate').value,
                owner: document.getElementById('goal_owner').value,
                progress: parseInt(document.getElementById('goal_progress').value),
                created: new Date().toISOString().split('T')[0]
            };
            
            if (!appState.data.strategicPlanning.goals) {
                appState.data.strategicPlanning.goals = [];
            }
            
            appState.data.strategicPlanning.goals.push(newGoal);
            saveData();
            closeModal();
            showToast('Strategic goal created successfully!');
            switchSection('strategic-planning');
        }

        function editStrategicGoal(id) {
            const goal = appState.data.strategicPlanning.goals.find(g => g.id === id);
            if (!goal) return;
            
            const formHTML = `
                <form onsubmit="handleStrategicGoalEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Goal Title</label>
                        <input type="text" id="goal_title" required value="${goal.title}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="goal_description"
                                  style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;">${goal.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Target Date</label>
                            <input type="date" id="goal_targetDate" required value="${goal.targetDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Owner</label>
                            <input type="text" id="goal_owner" value="${goal.owner || ''}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Progress (%)</label>
                            <input type="number" id="goal_progress" min="0" max="100" value="${goal.progress}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Goal</button>
                </form>
            `;
            showModal('Edit Strategic Goal', formHTML);
        }

        function handleStrategicGoalEdit(event, id) {
            event.preventDefault();
            const goal = appState.data.strategicPlanning.goals.find(g => g.id === id);
            if (!goal) return;
            
            goal.title = document.getElementById('goal_title').value;
            goal.description = document.getElementById('goal_description').value;
            goal.targetDate = document.getElementById('goal_targetDate').value;
            goal.owner = document.getElementById('goal_owner').value;
            goal.progress = parseInt(document.getElementById('goal_progress').value);
            
            saveData();
            closeModal();
            showToast('Strategic goal updated successfully!');
            switchSection('strategic-planning');
        }

        function deleteStrategicGoal(id) {
            if (confirm('Delete this strategic goal?')) {
                appState.data.strategicPlanning.goals = 
                    appState.data.strategicPlanning.goals.filter(g => g.id !== id);
                saveData();
                switchSection('strategic-planning');
                showToast('Strategic goal deleted');
            }
        }

        // VENDORS - NOW FULLY IMPLEMENTED
        function renderVendors(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Vendor Management</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Vendor</th>
                                    <th>Type</th>
                                    <th>Cost</th>
                                    <th>Contract</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.data.vendors.map(v => `
                                    <tr style="cursor: pointer;" onclick="drilldownVendor(${v.id})">
                                        <td><strong>${v.name}</strong></td>
                                        <td><span class="badge badge-info">${v.type}</span></td>
                                        <td>$${v.cost.toLocaleString()}</td>
                                        <td>${v.contract}</td>
                                        <td><span class="badge badge-success">${v.status}</span></td>
                                        <td onclick="event.stopPropagation()">
                                            <button class="action-btn edit" onclick="editVendor(${v.id})">Edit</button>
                                            <button class="action-btn delete" onclick="deleteVendor(${v.id})">Delete</button>
                                            <button class="action-btn view" onclick="drilldownVendor(${v.id})">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // TASKS - NOW FULLY IMPLEMENTED
        function renderTasks(container) {
            const todoTasks = appState.data.tasks.filter(t => t.status === 'To Do');
            const inProgressTasks = appState.data.tasks.filter(t => t.status === 'In Progress');
            const doneTasks = appState.data.tasks.filter(t => t.status === 'Done');

            container.innerHTML = `
                <div class="kanban-board">
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <div class="kanban-title">ðŸ“‹ To Do</div>
                            <div class="kanban-count">${todoTasks.length}</div>
                        </div>
                        ${todoTasks.map(t => `
                            <div class="task-card" style="cursor: pointer;" onclick="drilldownTask(${t.id})">
                                <strong>${t.title}</strong>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">${t.description}</div>
                                <div style="margin-top: 8px;">
                                    <span class="priority-${t.priority.toLowerCase()}">${t.priority}</span>
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; gap: 8px;">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">âœï¸ Edit</button>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); deleteTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">ðŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <div class="kanban-title">âš¡ In Progress</div>
                            <div class="kanban-count">${inProgressTasks.length}</div>
                        </div>
                        ${inProgressTasks.map(t => `
                            <div class="task-card" style="cursor: pointer;" onclick="drilldownTask(${t.id})">
                                <strong>${t.title}</strong>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">${t.description}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${t.progress}%"></div>
                                </div>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">${t.progress}% complete</div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; gap: 8px;">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">âœï¸ Edit</button>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); deleteTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">ðŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <div class="kanban-title">âœ… Done</div>
                            <div class="kanban-count">${doneTasks.length}</div>
                        </div>
                        ${doneTasks.map(t => `
                            <div class="task-card" style="cursor: pointer;" onclick="drilldownTask(${t.id})">
                                <strong style="text-decoration: line-through; opacity: 0.7;">${t.title}</strong>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">${t.description}</div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); display: flex; gap: 8px;">
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">âœï¸ Edit</button>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); deleteTask(${t.id})" style="padding: 4px 8px; font-size: 11px; flex: 1;">ðŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // INVOICES - NOW FULLY IMPLEMENTED
        function renderInvoices(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Invoices & Billing</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.data.invoices.map(inv => `
                                    <tr>
                                        <td><strong>${inv.number}</strong></td>
                                        <td>${inv.customer}</td>
                                        <td>$${inv.amount.toLocaleString()}</td>
                                        <td>${inv.dueDate}</td>
                                        <td><span class="badge ${inv.status === 'Paid' ? 'badge-success' : 'badge-warning'}">${inv.status}</span></td>
                                        <td>
                                            <button class="action-btn edit" onclick="editInvoice(${inv.id})">Edit</button>
                                            <button class="action-btn delete" onclick="deleteInvoice(${inv.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ALERTS - NOW FULLY IMPLEMENTED
        function renderAlerts(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Smart Alerts (${appState.data.alerts.filter(a => a.enabled).length}/${appState.data.alerts.length} enabled)</div>
                    ${appState.data.alerts.map(alert => {
                        const bgClass = alert.enabled ? 
                            (alert.read ? 'var(--bg-glass)' : 'linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05))') :
                            'rgba(0,0,0,0.2)';
                        const opacity = alert.enabled ? '1' : '0.5';
                        const priorityBadge = alert.priority === 'Critical' ? 'badge-danger' :
                                             alert.priority === 'High' ? 'badge-warning' :
                                             alert.priority === 'Medium' ? 'badge-info' : 'badge-success';
                        const typeBadge = alert.type === 'danger' ? 'ðŸ”´' :
                                         alert.type === 'warning' ? 'âš ï¸' :
                                         alert.type === 'success' ? 'âœ…' : 'â„¹ï¸';
                        
                        return `
                        <div style="background: ${bgClass}; 
                             border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; margin-bottom: 16px; opacity: ${opacity};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">${typeBadge}</span>
                                        <strong style="font-size: 16px;">${alert.title}</strong>
                                        <span class="badge ${priorityBadge}">${alert.priority}</span>
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">${alert.message}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${alert.date}</div>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <button class="btn-secondary" onclick="editAlert(${alert.id})" style="padding: 4px 12px; font-size: 11px;">âœï¸ Edit</button>
                                    <button class="btn-secondary" onclick="deleteAlert(${alert.id})" style="padding: 4px 12px; font-size: 11px;">ðŸ—‘ï¸ Delete</button>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                                        <input type="checkbox" ${alert.enabled ? 'checked' : ''} 
                                               onchange="toggleAlert(${alert.id})"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 12px; color: var(--text-secondary);">${alert.enabled ? 'Enabled' : 'Disabled'}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        // NOTES - NOW FULLY IMPLEMENTED
        function renderNotes(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Notes & Documentation</div>
                    ${appState.data.notes.map(note => `
                        <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); 
                             border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center;">
                                <strong style="font-size: 18px;">${note.title}</strong>
                                <div style="display: flex; gap: 8px;">
                                    <span class="badge badge-info">${note.category}</span>
                                    <button class="btn-secondary" onclick="editNote(${note.id})" style="padding: 4px 12px; font-size: 11px;">âœï¸ Edit</button>
                                    <button class="btn-secondary" onclick="deleteNote(${note.id})" style="padding: 4px 12px; font-size: 11px;">ðŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); line-height: 1.6;">${note.content}</div>
                            <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                                ${note.date} â€¢ ${note.author}${note.updated ? ' â€¢ Updated: ' + new Date(note.updated).toLocaleDateString() : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // TEAM - NOW FULLY IMPLEMENTED
        function renderTeam(container) {
            container.innerHTML = `
                <div class="stats-grid">
                    ${appState.data.team.map(member => `
                        <div class="team-card" onclick='viewTeamMemberDetails(${member.id})' style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div class="team-avatar">${member.avatar}</div>
                            <div class="team-name">${member.name}</div>
                            <div class="team-role">${member.role}</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                ðŸ“§ ${member.email}<br>
                                ðŸ“± ${member.phone}<br>
                                ðŸ“ ${member.location}
                            </div>
                            <div style="margin-top: 12px;">
                                <span class="badge badge-success">${member.status}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // CALENDAR - NOW FULLY IMPLEMENTED
        // Calendar state
        let calendarDate = new Date();

        function renderCalendar(container) {
            const today = new Date();
            const daysInMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1).getDay();
            const monthName = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            let calendarHTML = `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="card-title">${monthName}</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-secondary" onclick="changeCalendarMonth(-1)" style="padding: 8px 12px;">â† Previous</button>
                        <button class="btn-secondary" onclick="resetCalendar()" style="padding: 8px 12px;">Today</button>
                        <button class="btn-secondary" onclick="changeCalendarMonth(1)" style="padding: 8px 12px;">Next â†’</button>
                        <button class="btn-primary" onclick="showGoogleCalendarSync()" style="padding: 8px 16px;">ðŸ”— Google Calendar</button>
                    </div>
                </div>
                <div class="calendar-grid">`;
            
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<div style="text-align: center; font-weight: 700; color: var(--text-muted);">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && 
                                calendarDate.getMonth() === today.getMonth() && 
                                calendarDate.getFullYear() === today.getFullYear();
                const dateStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = appState.data.events.filter(e => e.date === dateStr);
                const hasEvents = dayEvents.length > 0;
                
                let eventsHTML = '';
                if (hasEvents) {
                    // Show up to 2 event titles with start time on the calendar
                    eventsHTML = dayEvents.slice(0, 2).map(event => 
                        `<div style="font-size: 9px; color: var(--accent-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px; padding: 2px 4px; background: rgba(110,231,183,0.1); border-radius: 3px;">
                            ${event.time} ${event.title}
                        </div>`
                    ).join('');
                    if (dayEvents.length > 2) {
                        eventsHTML += `<div style="font-size: 8px; color: var(--text-muted); margin-top: 2px;">+${dayEvents.length - 2} more</div>`;
                    }
                }
                
                calendarHTML += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvents ? 'has-events' : ''}" 
                                      data-date="${dateStr}" 
                                      onclick="showDayEvents('${dateStr}')" 
                                      style="cursor: pointer; position: relative; padding: 6px; overflow: hidden;">
                                      <div style="font-weight: 600; margin-bottom: 4px;">${day}</div>
                                      <div style="width: 100%; overflow: hidden;">
                                          ${eventsHTML}
                                      </div>
                                 </div>`;
            }
            
            calendarHTML += '</div></div>';
            
            calendarHTML += '<div class="card"><div class="card-title">Upcoming Events</div>';
            appState.data.events.forEach(event => {
                calendarHTML += `
                    <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); 
                         border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease;"
                         onmouseover="this.style.transform='translateX(4px)'; this.style.borderColor='var(--accent-primary)'"
                         onmouseout="this.style.transform=''; this.style.borderColor='var(--glass-border)'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div onclick="showEventDetails(${JSON.stringify(event).replace(/'/g, '&#39;')})" style="flex: 1;">
                                <strong>${event.title}</strong>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                    ðŸ“… ${event.date} â€¢ â° ${event.time} â€¢ ðŸ“ ${event.location || 'No location'}
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="event.stopPropagation(); editEvent(${event.id})" 
                                    style="padding: 6px 12px; font-size: 11px;">âœï¸ Edit</button>
                        </div>
                    </div>
                `;
            });
            calendarHTML += '</div>';
            
            container.innerHTML = calendarHTML;
        }


        function changeCalendarMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            switchSection('calendar');
        }

        function resetCalendar() {
            calendarDate = new Date();
            switchSection('calendar');
        }

        function showGoogleCalendarSync() {
            const modalContent = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">ðŸ“…</div>
                        <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 12px; color: var(--text-primary);">Connect Google Calendar</h2>
                        <p style="color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
                            Sync your events seamlessly and manage your schedule from Virely Ops
                        </p>
                    </div>
                    
                    <!-- Features Grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 32px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ”„</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Two-Way Sync</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Real-time updates</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ”’</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Secure OAuth</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Google verified</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">ðŸ“±</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Cross-Platform</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">All your devices</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">âš¡</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Instant Sync</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">No delays</div>
                        </div>
                    </div>
                    
                    <!-- What You'll Get -->
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1) 0%, rgba(124,92,255,0.1) 100%); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 32px;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">What You'll Get:</div>
                        <div style="display: grid; gap: 12px; font-size: 14px; color: var(--text-secondary);">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px;">âœ“</span>
                                <span>Automatic event synchronization across all your calendars</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px;">âœ“</span>
                                <span>Prevent double-booking with real-time availability checking</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px;">âœ“</span>
                                <span>Create and manage events from within Virely Ops</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px;">âœ“</span>
                                <span>Receive notifications for upcoming meetings and appointments</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px;">âœ“</span>
                                <span>Share your availability with team members and clients</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sign In Button -->
                    <button class="btn-primary" onclick="initiateGoogleCalendarAuth()" 
                            style="width: 100%; padding: 18px; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); box-shadow: 0 8px 24px rgba(110,231,183,0.3); transition: all 0.3s ease;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(110,231,183,0.4)'"
                            onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 24px rgba(110,231,183,0.3)'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                            <line x1="7" y1="7" x2="7.01" y2="7"></line>
                        </svg>
                        Sign in with Google
                    </button>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                            ðŸ”’ Your data is encrypted and secure<br>
                            We use Google's OAuth 2.0 for authentication<br>
                            You can revoke access at any time from your Google Account settings
                        </div>
                    </div>
                </div>
            `;
            showModal('Google Calendar Integration', modalContent);
        }

        function initiateGoogleCalendarAuth() {
            // Close modal and trigger OAuth flow
            closeModal();
            redirectToOAuth('googleCalendar');
        }
        function showDayEvents(dateStr) {
            const dayEvents = appState.data.events.filter(e => e.date === dateStr);
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            if (dayEvents.length === 0) {
                const modalContent = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">ðŸ“…</div>
                        <div style="font-size: 18px; color: var(--text-secondary); margin-bottom: 8px;">No events scheduled</div>
                        <div style="font-size: 14px; color: var(--text-muted);">This day is free</div>
                    </div>
                    <button class="btn btn-primary" onclick="closeModal(); showAddEvent();" style="width: 100%; margin-top: 20px;">
                        âž• Add Event for This Day
                    </button>
                `;
                showModal(`Events for ${formattedDate}`, modalContent);
                return;
            }
            
            const modalContent = `
                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(110,231,183,0.08), rgba(124,92,255,0.08)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 14px; color: var(--accent-primary); font-weight: 600;">${dayEvents.length} Event${dayEvents.length > 1 ? 's' : ''} Scheduled</div>
                </div>
                <div style="display: grid; gap: 16px;">
                    ${dayEvents.sort((a, b) => a.time.localeCompare(b.time)).map(event => `
                        <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${event.title}</div>
                                    <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: var(--text-secondary);">
                                        <div>â° ${event.time}</div>
                                        <div>ðŸ“ ${event.location}</div>
                                        <div><span class="badge badge-info">${event.type}</span></div>
                                    </div>
                                </div>
                            </div>
                            ${event.description ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); font-size: 14px; color: var(--text-secondary); line-height: 1.6;">${event.description}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-secondary" onclick="closeModal(); showAddEvent();" style="width: 100%; margin-top: 20px;">
                    âž• Add Another Event
                </button>
            `;
            showModal(`Events for ${formattedDate}`, modalContent);
        }

        function showEventDetails(event) {
            const modalContent = `
                <div style="padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.08), rgba(124,92,255,0.08)); border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 12px;">${event.title}</div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 14px; color: var(--text-secondary);">
                        <div>ðŸ“… ${event.date}</div>
                        <div>â° ${event.time}</div>
                        <div>ðŸ“ ${event.location}</div>
                    </div>
                </div>
                
                <div style="background: var(--bg-glass); border-radius: 12px; padding: 20px; border: 1px solid var(--glass-border); margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Event Details</div>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Type</div>
                            <span class="badge badge-info">${event.type}</span>
                        </div>
                        ${event.description ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Description</div>
                                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">${event.description}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-primary" onclick="closeModal();">
                        âœ“ Close
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal(); showAddEvent();">
                        âž• Add Event
                    </button>
                </div>
            `;
            showModal('Event Details', modalContent);
        }



        // ===========================================
        // API INTEGRATION CONFIGURATIONS
        // ===========================================

        const apiConfigurations = {
            stripe: {
                name: 'Stripe',
                authUrl: 'https://connect.stripe.com/oauth/authorize',
                clientId: 'YOUR_STRIPE_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/stripe/callback',
                scope: 'read_write',
                webhookUrl: '/api/webhooks/stripe',
                endpoints: {
                    payments: 'https://api.stripe.com/v1/charges',
                    customers: 'https://api.stripe.com/v1/customers',
                    subscriptions: 'https://api.stripe.com/v1/subscriptions',
                    invoices: 'https://api.stripe.com/v1/invoices'
                }
            },
            quickbooks: {
                name: 'QuickBooks',
                authUrl: 'https://appcenter.intuit.com/connect/oauth2',
                clientId: 'YOUR_QUICKBOOKS_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/quickbooks/callback',
                scope: 'com.intuit.quickbooks.accounting',
                endpoints: {
                    company: '/v3/company/{realmId}/companyinfo/{companyId}',
                    invoice: '/v3/company/{realmId}/invoice',
                    expense: '/v3/company/{realmId}/purchase',
                    customer: '/v3/company/{realmId}/customer'
                }
            },
            hubspot: {
                name: 'HubSpot',
                authUrl: 'https://app.hubspot.com/oauth/authorize',
                clientId: 'YOUR_HUBSPOT_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/hubspot/callback',
                scope: 'contacts crm.objects.contacts.read crm.objects.contacts.write',
                endpoints: {
                    contacts: 'https://api.hubapi.com/crm/v3/objects/contacts',
                    deals: 'https://api.hubapi.com/crm/v3/objects/deals',
                    companies: 'https://api.hubapi.com/crm/v3/objects/companies',
                    engagements: 'https://api.hubapi.com/engagements/v1/engagements'
                }
            },
            googleAnalytics: {
                name: 'Google Analytics',
                authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
                clientId: 'YOUR_GOOGLE_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/google/callback',
                scope: 'https://www.googleapis.com/auth/analytics.readonly',
                endpoints: {
                    reports: 'https://analyticsreporting.googleapis.com/v4/reports:batchGet',
                    metadata: 'https://www.googleapis.com/analytics/v3/metadata/ga/columns'
                }
            },
            googleCalendar: {
                name: 'Google Calendar',
                authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
                clientId: 'YOUR_GOOGLE_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/google-calendar/callback',
                scope: 'https://www.googleapis.com/auth/calendar',
                endpoints: {
                    events: 'https://www.googleapis.com/calendar/v3/calendars/{calendarId}/events',
                    calendarList: 'https://www.googleapis.com/calendar/v3/users/me/calendarList',
                    settings: 'https://www.googleapis.com/calendar/v3/users/me/settings'
                }
            },
            gmail: {
                name: 'Gmail',
                authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
                clientId: 'YOUR_GOOGLE_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/gmail/callback',
                scope: 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.compose',
                endpoints: {
                    send: 'https://www.googleapis.com/gmail/v1/users/me/messages/send',
                    messages: 'https://www.googleapis.com/gmail/v1/users/me/messages',
                    drafts: 'https://www.googleapis.com/gmail/v1/users/me/drafts',
                    labels: 'https://www.googleapis.com/gmail/v1/users/me/labels',
                    threads: 'https://www.googleapis.com/gmail/v1/users/me/threads'
                }
            },
            googleDrive: {
                name: 'Google Drive',
                authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
                clientId: 'YOUR_GOOGLE_CLIENT_ID', // Replace with actual client ID
                redirectUri: window.location.origin + '/integrations/google-drive/callback',
                scope: 'https://www.googleapis.com/auth/drive.file',
                endpoints: {
                    files: 'https://www.googleapis.com/drive/v3/files',
                    upload: 'https://www.googleapis.com/upload/drive/v3/files',
                    download: 'https://www.googleapis.com/drive/v3/files/{fileId}'
                }
            }
        };

        // Store integration states
        const integrationStates = {
            stripe: { connected: false, lastSync: null },
            quickbooks: { connected: false, lastSync: null },
            hubspot: { connected: false, lastSync: null },
            googleAnalytics: { connected: false, lastSync: null },
            googleCalendar: { connected: false, lastSync: null },
            gmail: { connected: false, lastSync: null },
            googleDrive: { connected: false, lastSync: null }
        };


        function redirectToOAuth(service) {
            const oauthUrls = {
                'stripe': 'https://connect.stripe.com/oauth/authorize?response_type=code&client_id=ca_DEMO&scope=read_write',
                'quickbooks': 'https://appcenter.intuit.com/connect/oauth2',
                'hubspot': 'https://app.hubspot.com/oauth/authorize',
                'googleAnalytics': 'https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/analytics.readonly',
                'googleCalendar': 'https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/calendar',
                'gmail': 'https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/gmail.send%20https://www.googleapis.com/auth/gmail.readonly',
                'googleDrive': 'https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/drive.file'
            };

            const url = oauthUrls[service];
            if (url) {
                // Show info before redirect
                const serviceNames = {
                    'stripe': 'Stripe',
                    'quickbooks': 'QuickBooks',
                    'hubspot': 'HubSpot',
                    'googleAnalytics': 'Google Analytics',
                    'googleCalendar': 'Google Calendar',
                    'gmail': 'Gmail',
                    'googleDrive': 'Google Drive'
                };
                
                if (confirm(`You will be redirected to ${serviceNames[service]} to authorize the connection.\n\nNote: You need to configure your API credentials first (see documentation).\n\nContinue?`)) {
                    window.open(url, '_blank', 'width=600,height=700');
                }
            } else {
                showToast('OAuth URL not configured for this service', 'error');
            }
        }
        // OAuth initialization function
        function initiateOAuthFlow(service) {
            const config = apiConfigurations[service];
            if (!config) {
                showToast(`Configuration for ${service} not found`, 'error');
                return;
            }

            // Build OAuth URL
            const state = btoa(JSON.stringify({ service, timestamp: Date.now() }));
            const params = new URLSearchParams({
                client_id: config.clientId,
                redirect_uri: config.redirectUri,
                scope: config.scope,
                response_type: 'code',
                state: state
            });

            const authUrl = `${config.authUrl}?${params.toString()}`;
            
            // Open OAuth flow in popup or redirect
            const popup = window.open(authUrl, 'oauth', 'width=600,height=700');
            
            // Listen for OAuth callback
            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) return;
                
                if (event.data.type === 'oauth_success') {
                    handleOAuthSuccess(service, event.data);
                }
            });
        }

        // Handle successful OAuth
        function handleOAuthSuccess(service, data) {
            integrationStates[service].connected = true;
            integrationStates[service].lastSync = new Date().toISOString();
            integrationStates[service].accessToken = data.accessToken;
            integrationStates[service].refreshToken = data.refreshToken;
            
            // Save to localStorage
            localStorage.setItem('virely_integrations', JSON.stringify(integrationStates));
            
            showToast(`âœ… ${apiConfigurations[service].name} connected successfully!`, 'success');
            switchSection('integrations');
        }

        // Sync data from integration
        async function syncIntegration(service) {
            const state = integrationStates[service];
            if (!state.connected) {
                showToast('Please connect the integration first', 'error');
                return;
            }

            showToast(`ðŸ”„ Syncing ${apiConfigurations[service].name}...`, 'info');

            // Implement service-specific sync logic
            try {
                switch(service) {
                    case 'stripe':
                        await syncStripeData(state.accessToken);
                        break;
                    case 'quickbooks':
                        await syncQuickBooksData(state.accessToken);
                        break;
                    case 'googleCalendar':
                        await syncGoogleCalendarData(state.accessToken);
                        break;
                    // Add other services...
                }
                
                state.lastSync = new Date().toISOString();
                localStorage.setItem('virely_integrations', JSON.stringify(integrationStates));
                showToast(`âœ… ${apiConfigurations[service].name} synced successfully!`, 'success');
            } catch (error) {
                showToast(`âŒ Sync failed: ${error.message}`, 'error');
            }
        }

        // Example: Sync Stripe payments
        async function syncStripeData(accessToken) {
            const endpoint = apiConfigurations.stripe.endpoints.payments;
            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch Stripe data');
            
            const data = await response.json();
            // Process and store payment data
            // ... implementation ...
        }

        // Example: Sync Google Calendar events
        async function syncGoogleCalendarData(accessToken) {
            const endpoint = apiConfigurations.googleCalendar.endpoints.events.replace('{calendarId}', 'primary');
            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch calendar data');
            
            const data = await response.json();
            
            // Convert Google Calendar events to app events
            if (data.items) {
                data.items.forEach(event => {
                    const newEvent = {
                        id: Date.now() + Math.random(),
                        title: event.summary,
                        date: event.start.date || event.start.dateTime.split('T')[0],
                        time: event.start.dateTime ? new Date(event.start.dateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '00:00',
                        location: event.location || 'No location',
                        type: 'Meeting',
                        description: event.description || '',
                        googleEventId: event.id
                    };
                    
                    // Check if event already exists
                    const exists = appState.data.events.find(e => e.googleEventId === event.id);
                    if (!exists) {
                        appState.data.events.push(newEvent);
                    }
                });
                
                saveData();
            }
        }

        // Disconnect integration
        function disconnectIntegration(service) {
            if (confirm(`Are you sure you want to disconnect ${apiConfigurations[service].name}?`)) {
                integrationStates[service] = { connected: false, lastSync: null };
                localStorage.setItem('virely_integrations', JSON.stringify(integrationStates));
                showToast(`${apiConfigurations[service].name} disconnected`, 'info');
                switchSection('integrations');
            }
        }

        // Load integration states on init
        function loadIntegrationStates() {
            const saved = localStorage.getItem('virely_integrations');
            if (saved) {
                Object.assign(integrationStates, JSON.parse(saved));
            }
        }

        function renderIntegrations(container) {
            const integrations = [
                {
                    name: 'Stripe',
                    service: 'stripe',
                    icon: 'ðŸ’³',
                    description: 'Payment processing and subscription management',
                    status: 'Not Connected',
                    color: 'var(--accent-tertiary)',
                    benefits: ['Process payments', 'Manage subscriptions', 'Track revenue', 'Handle refunds']
                },
                {
                    name: 'QuickBooks',
                    service: 'quickbooks',
                    icon: 'ðŸ“š',
                    description: 'Accounting and financial management',
                    status: 'Not Connected',
                    color: 'var(--success)',
                    benefits: ['Sync transactions', 'Track expenses', 'Generate reports', 'Tax management']
                },
                {
                    name: 'HubSpot',
                    service: 'hubspot',
                    icon: 'ðŸŽ¯',
                    description: 'CRM and marketing automation',
                    status: 'Not Connected',
                    color: 'var(--warning)',
                    benefits: ['Manage contacts', 'Track deals', 'Email campaigns', 'Analytics']
                },
                {
                    name: 'Google Analytics',
                    service: 'googleAnalytics',
                    icon: 'ðŸ“Š',
                    description: 'Website and app analytics',
                    status: 'Not Connected',
                    color: 'var(--accent-primary)',
                    benefits: ['Track visitors', 'User behavior', 'Conversion rates', 'Traffic sources']
                },
                {
                    name: 'Google Calendar',
                    service: 'googleCalendar',
                    icon: 'ðŸ“…',
                    description: 'Calendar synchronization',
                    status: 'Not Connected',
                    color: 'var(--accent-tertiary)',
                    benefits: ['Sync events', 'Manage schedules', 'Avoid conflicts', 'Share availability']
                },
                {
                    name: 'Gmail',
                    service: 'gmail',
                    icon: 'ðŸ“§',
                    description: 'Email integration and automation',
                    status: 'Not Connected',
                    color: '#EA4335',
                    benefits: ['Send emails', 'Track conversations', 'Automate responses', 'Manage contacts']
                },
                {
                    name: 'Google Drive',
                    service: 'googleDrive',
                    icon: 'ðŸ“',
                    description: 'Cloud storage and file management',
                    status: 'Not Connected',
                    color: 'var(--accent-secondary)',
                    benefits: ['Store files', 'Share documents', 'Collaborate', 'Backup data']
                }
            ];

            container.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h2>API Integrations</h2>
                        <p style="color: var(--text-secondary); margin-top: 8px;">Connect your favorite tools and automate your workflow</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 24px; margin-bottom: 32px;">
                    ${integrations.map(integration => `
                        <div class="card" style="transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.2)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
                            
                            <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 20px;">
                                <div style="font-size: 48px; line-height: 1;">${integration.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 22px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);">
                                        ${integration.name}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                        ${integration.description}
                                    </div>
                                </div>
                                <span class="badge" style="background: ${integrationStates[integration.service] && integrationStates[integration.service].connected ? 'var(--success)' : 'var(--bg-secondary)'}; color: ${integrationStates[integration.service] && integrationStates[integration.service].connected ? 'white' : 'var(--text-muted)'}; border: 1px solid var(--glass-border);">
                                    ${integrationStates[integration.service] && integrationStates[integration.service].connected ? 'âœ… Connected' : 'Not Connected'}
                                </span>
                            </div>

                            <div style="background: var(--bg-glass); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">
                                    Key Benefits
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    ${integration.benefits.map(benefit => `
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);">
                                            <div style="width: 6px; height: 6px; border-radius: 50%; background: ${integration.color};"></div>
                                            <span>${benefit}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <button class="btn-primary" onclick="redirectToOAuth('${integration.service}')" style="width: 100%;">
                                ðŸ”— Connect ${integration.name}
                            </button>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <div class="card-title">Integration Features</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center; padding: 24px;">
                            <div style="font-size: 36px; margin-bottom: 12px;">ðŸ”„</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Data Synchronization</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                Keep information consistent across all your connected platforms
                            </div>
                        </div>
                        <div style="text-align: center; padding: 24px;">
                            <div style="font-size: 36px; margin-bottom: 12px;">âš¡</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Workflow Automation</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                Trigger actions automatically when events occur in connected services
                            </div>
                        </div>
                        <div style="text-align: center; padding: 24px;">
                            <div style="font-size: 36px; margin-bottom: 12px;">ðŸ”’</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Secure Connections</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                OAuth 2.0 authentication for enterprise-grade security
                            </div>
                        </div>
                        <div style="text-align: center; padding: 24px;">
                            <div style="font-size: 36px; margin-bottom: 12px;">ðŸ“Š</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Unified Dashboard</div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                View all your data from multiple sources in one place
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function connectIntegration(name) {
            const serviceMap = {
                'Stripe': 'stripe',
                'QuickBooks': 'quickbooks',
                'HubSpot': 'hubspot',
                'Google Analytics': 'googleAnalytics',
                'Google Calendar': 'googleCalendar',
                'Google Drive': 'googleDrive'
            };

            const service = serviceMap[name];
            
            if (!service) {
                showToast('Service not found', 'error');
                return;
            }

            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”—</div>
                    <h3 style="margin-bottom: 16px; color: var(--accent-primary);">Connect ${name}</h3>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 24px; text-align: left;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Connection Details:</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <div style="margin-bottom: 8px;">ðŸ”’ <strong>Secure OAuth 2.0</strong> authentication</div>
                            <div style="margin-bottom: 8px;">ðŸ”„ <strong>Two-way data sync</strong> enabled</div>
                            <div style="margin-bottom: 8px;">âš¡ <strong>Real-time updates</strong> when connected</div>
                            <div>ðŸ“Š <strong>Automatic data</strong> synchronization</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(251,191,36,0.1); padding: 16px; border-radius: 8px; border: 1px solid rgba(251,191,36,0.3); margin-bottom: 24px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">âš ï¸ Configuration Required</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            Please configure your API credentials in the apiConfigurations object before connecting. Set your CLIENT_ID for ${name}.
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="initiateOAuthFlow('${service}')" style="width: 100%; padding: 16px; font-size: 16px; margin-bottom: 12px;">
                        ðŸš€ Connect ${name}
                    </button>
                    
                    ${integrationStates[service].connected ? `
                        <div style="margin-top: 16px; padding: 12px; background: rgba(74,222,128,0.1); border-radius: 8px; border: 1px solid rgba(74,222,128,0.3);">
                            <div style="font-size: 13px; color: var(--success); font-weight: 600; margin-bottom: 8px;">âœ… Connected</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Last synced: ${integrationStates[service].lastSync ? new Date(integrationStates[service].lastSync).toLocaleString() : 'Never'}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <button class="btn-secondary" onclick="closeModal(); syncIntegration('${service}')">ðŸ”„ Sync Now</button>
                                <button class="btn-secondary" onclick="closeModal(); disconnectIntegration('${service}')" style="background: var(--danger);">ðŸ”Œ Disconnect</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button class="btn-secondary" onclick="closeModal()" style="width: 100%; margin-top: 12px;">Cancel</button>
                </div>
            `;
            showModal(`Connect ${name}`, modalContent);
        }

        // REPORTS - NOW FULLY IMPLEMENTED
        function renderReports(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Reports & Export</div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="exportData()">
                            <div class="stat-icon">ðŸ“Š</div>
                            <div class="stat-label">Financial Report</div>
                            <div class="stat-value">Export</div>
                            <div class="stat-change">Download complete financial data</div>
                        </div>
                        <div class="stat-card" onclick="exportData()">
                            <div class="stat-icon">ðŸ‘¥</div>
                            <div class="stat-label">Customer Report</div>
                            <div class="stat-value">Export</div>
                            <div class="stat-change">Download customer data</div>
                        </div>
                        <div class="stat-card" onclick="exportData()">
                            <div class="stat-icon">ðŸ“ˆ</div>
                            <div class="stat-label">Analytics Report</div>
                            <div class="stat-value">Export</div>
                            <div class="stat-change">Download analytics data</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // SETTINGS - NOW FULLY IMPLEMENTED
        function renderSettings(container) {
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¤</div>
                        <div class="stat-label">Account Status</div>
                        <div class="stat-value">Active</div>
                        <div class="stat-change positive">Premium Plan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’¾</div>
                        <div class="stat-label">Data Usage</div>
                        <div class="stat-value">2.4 GB</div>
                        <div class="stat-change">of 10 GB used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ”</div>
                        <div class="stat-label">Security Status</div>
                        <div class="stat-value">Strong</div>
                        <div class="stat-change positive">2FA Enabled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“…</div>
                        <div class="stat-label">Member Since</div>
                        <div class="stat-value">Jan 2024</div>
                        <div class="stat-change">11 months</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Account Settings</div>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Profile Information</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Update your name, email, and contact details</div>
                            </div>
                            <button class="btn-secondary" onclick="showToast('Profile settings coming soon!')">Edit</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Password & Security</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Change password and manage security settings</div>
                            </div>
                            <button class="btn-secondary" onclick="showToast('Security settings coming soon!')">Manage</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Two-Factor Authentication</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Enhanced security with 2FA â€¢ Currently: <span style="color: var(--success);">Enabled</span></div>
                            </div>
                            <button class="btn-secondary" onclick="showToast('2FA settings coming soon!')">Configure</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Billing & Subscription</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Manage your plan and payment methods</div>
                            </div>
                            <button class="btn-secondary" onclick="showToast('Billing settings coming soon!')">Manage</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Notification Preferences</div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Email Notifications</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Receive updates via email</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" checked onchange="showToast('Email notifications ' + (this.checked ? 'enabled' : 'disabled'))" 
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                       background-color: var(--accent-primary); transition: .4s; border-radius: 24px;
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Push Notifications</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Browser push notifications for alerts</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" onchange="showToast('Push notifications ' + (this.checked ? 'enabled' : 'disabled'))" 
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                       background-color: var(--text-muted); transition: .4s; border-radius: 24px;
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">SMS Alerts</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Critical alerts via text message</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" checked onchange="showToast('SMS alerts ' + (this.checked ? 'enabled' : 'disabled'))" 
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                       background-color: var(--accent-primary); transition: .4s; border-radius: 24px;
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Appearance & Display</div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Theme</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Currently: Dark Mode</div>
                            </div>
                            <select onchange="showToast('Theme changed to ' + this.value)" 
                                    style="padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Dark">Dark Mode</option>
                                <option value="Light">Light Mode</option>
                                <option value="Auto">Auto (System)</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Compact Mode</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Reduce spacing for more content</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" onchange="showToast('Compact mode ' + (this.checked ? 'enabled' : 'disabled'))" 
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                       background-color: var(--text-muted); transition: .4s; border-radius: 24px;
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Data & Privacy</div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Export All Data</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Download a copy of all your data</div>
                            </div>
                            <button class="btn-secondary" onclick="exportData()">Export</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Clear All Data</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Remove all data from local storage</div>
                            </div>
                            <button class="btn-secondary" onclick="if(confirm('Are you sure? This will clear all local data.')) { localStorage.clear(); showToast('All data cleared!'); location.reload(); }" 
                                    style="background: var(--danger); color: white;">Clear</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Privacy Policy</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Review our privacy policy and terms</div>
                            </div>
                            <button class="btn-secondary" onclick="showToast('Opening privacy policy...')">View</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Advanced Settings</div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">API Access</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Manage API keys and integrations</div>
                            </div>
                            <button class="btn-secondary" onclick="manageAPIKeys()">Manage</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Webhooks</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Configure webhook endpoints</div>
                            </div>
                            <button class="btn-secondary" onclick="manageWebhooks()">Configure</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; 
                             background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Developer Mode</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Enable advanced developer features â€¢ Currently: <span id="devModeStatus" style="color: ${appState.data.developerMode ? 'var(--success)' : 'var(--text-muted)'};">${appState.data.developerMode ? 'Enabled' : 'Disabled'}</span></div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" ${appState.data.developerMode ? 'checked' : ''} onchange="toggleDeveloperMode(this.checked)" 
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
                                       background-color: ${appState.data.developerMode ? 'var(--accent-primary)' : 'var(--text-muted)'}; transition: .4s; border-radius: 24px;
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="border: 2px solid var(--danger); background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,107,107,0.05));">
                    <div class="card-title" style="color: var(--danger); display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">âš ï¸</span>
                        Danger Zone
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid rgba(255,107,107,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px; color: var(--danger);">
                                        ðŸ”„ Reset Platform
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px;">
                                        Completely reset the platform to its initial empty state. This action will:
                                    </div>
                                    <ul style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px; margin-bottom: 12px;">
                                        <li>Clear CRM contacts, vendors, invoices, divisions, and activity logs</li>
                                        <li><strong>PRESERVE Transactions</strong> - All transaction data remains intact</li>
                                        <li><strong>PRESERVE Marketing Hub</strong> - Campaigns and channels (statistics reset to 0)</li>
                                        <li><strong>PRESERVE Team Directory</strong> - All team members remain</li>
                                        <li><strong>PRESERVE Task Management</strong> - All tasks remain</li>
                                        <li><strong>PRESERVE Sales Pipeline</strong> - All deals remain</li>
                                        <li><strong>PRESERVE Notes & Documentation</strong> - All notes remain</li>
                                        <li><strong>PRESERVE Communications Settings</strong> - WhatsApp/SMS configuration and history remain</li>
                                        <li><strong>PRESERVE Strategic Planning</strong> - All goals, KPIs, and planning data remain</li>
                                        <li><strong>PRESERVE Smart Alerts</strong> - All alert configurations remain intact</li>
                                        <li><strong>PRESERVE Operational Budgets</strong> - All budget categories and allocations remain</li>
                                        <li>Reset all dashboard metrics and counters to zero</li>
                                        <li>Clear financial statements and projections</li>
                                        <li>Remove calendar events</li>
                                    </ul>
                                    <div style="padding: 12px; background: rgba(255,107,107,0.15); border-left: 3px solid var(--danger); border-radius: 4px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 13px; color: var(--danger); margin-bottom: 4px;">
                                            âš ï¸ WARNING: THIS ACTION CANNOT BE UNDONE
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            Selected data will be permanently deleted. Your Transactions, Marketing Hub, Team Directory, Tasks, Sales Pipeline, Notes & Documentation, Communications Settings, Strategic Planning, Smart Alerts, and Operational Budgets will be preserved. Make sure to export other data first if you need a backup.
                                        </div>
                                    </div>
                                </div>
                                <button class="btn-secondary" onclick="showResetPlatformConfirmation()" 
                                        style="background: var(--danger); color: white; white-space: nowrap; min-width: 140px; padding: 12px 24px; font-weight: 700;">
                                    Reset Platform
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // PLATFORM RESET FUNCTIONALITY
        function showResetPlatformConfirmation() {
            const modalContent = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">âš ï¸</div>
                        <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 12px; color: var(--danger);">
                            Reset Platform?
                        </h2>
                        <p style="color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
                            This is a permanent action that cannot be undone.
                        </p>
                    </div>
                    
                    <!-- What will be deleted -->
                    <div style="background: rgba(255,107,107,0.1); padding: 24px; border-radius: 16px; border: 2px solid var(--danger); margin-bottom: 24px;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--danger);">
                            âŒ What Will Be Reset/Deleted:
                        </div>
                        <div style="display: grid; gap: 12px; font-size: 14px; color: var(--text-secondary);">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All CRM & Contacts</strong> - Every contact, lead, and customer record</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Calendar Events</strong> - Meetings and appointments</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Marketing Channel Statistics Only</strong> - Spent, leads, conversions reset to 0 (channel setup preserved)</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Vendors</strong> - Vendor relationships and contracts</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Invoices</strong> - Invoice records and billing data</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Divisions</strong> - Business units and organizational structure</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Recent Activity</strong> - Complete activity log history</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Financial Statements Data</strong> - P&L, Cash Flow, and Projections cleared</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--danger); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>All Dashboard Metrics</strong> - MRR, ARR, customers, revenue, etc. all reset to 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- What will be preserved -->
                    <div style="background: rgba(110,231,183,0.1); padding: 24px; border-radius: 16px; border: 2px solid var(--accent-primary); margin-bottom: 24px;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">
                            âœ… What Will Be Preserved:
                        </div>
                        <div style="display: grid; gap: 12px; font-size: 14px; color: var(--text-secondary);">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Your Transactions</strong> - All financial transaction history will remain intact</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Marketing Hub (Complete)</strong> - All campaigns AND channels with budgets preserved</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Team Directory</strong> - All team members and their information</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Task Management</strong> - All tasks and project items</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Sales Pipeline</strong> - All deals and opportunities</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Notes & Documentation</strong> - All your notes and documents</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Communications Settings</strong> - WhatsApp/SMS configuration and message history</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Strategic Planning</strong> - All goals, KPIs, SWOT analysis, business canvas</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Smart Alerts</strong> - All alert configurations and notification settings</span>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 18px; flex-shrink: 0;">â€¢</span>
                                <span><strong>Operational Budgets</strong> - All budget categories and allocations</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Final warning -->
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                        <div style="font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">Before you proceed:</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                            â€¢ Consider exporting your data first (Settings â†’ Export All Data)<br>
                            â€¢ This action is immediate and cannot be reversed<br>
                            â€¢ The platform will reload to a blank state after reset<br>
                            â€¢ You can always add new data after the reset
                        </div>
                    </div>
                    
                    <!-- Confirmation input -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">
                            Type "RESET PLATFORM" to confirm (case-sensitive):
                        </label>
                        <input type="text" id="resetConfirmationInput" 
                               placeholder="RESET PLATFORM"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 2px solid var(--danger); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600;">
                    </div>
                    
                    <!-- Action buttons -->
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeModal()" 
                                style="flex: 1; padding: 14px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='var(--bg-secondary)'"
                                onmouseout="this.style.background='var(--bg-glass)'">
                            Cancel
                        </button>
                        <button onclick="executeResetPlatform()" 
                                style="flex: 1; padding: 14px; background: var(--danger); border: none; 
                                border-radius: 8px; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#ff5252'"
                                onmouseout="this.style.background='var(--danger)'">
                            âš ï¸ Yes, Reset Platform
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Reset Platform', modalContent);
            
            // Focus the confirmation input
            setTimeout(() => {
                const input = document.getElementById('resetConfirmationInput');
                if (input) input.focus();
            }, 100);
        }
        
        function executeResetPlatform() {
            const confirmationInput = document.getElementById('resetConfirmationInput');
            
            if (!confirmationInput || confirmationInput.value !== 'RESET PLATFORM') {
                showToast('Please type "RESET PLATFORM" exactly to confirm', 'error');
                if (confirmationInput) {
                    confirmationInput.style.borderColor = 'var(--danger)';
                    confirmationInput.focus();
                }
                return;
            }
            
            // Show processing state
            showToast('Resetting platform...', 'info');
            
            // Wait a moment for UI feedback
            setTimeout(() => {
                // Preserve critical business sections
                const currentTransactions = appState.data.transactions ? [...appState.data.transactions] : [];
                const currentMarketingChannels = appState.data.marketingChannels ? 
                    appState.data.marketingChannels.map(channel => ({
                        ...channel,
                        spent: 0,
                        leads: 0,
                        conversions: 0,
                        roi: 0,
                        cpl: 0,
                        impressions: 0,
                        clicks: 0,
                        ctr: 0
                    })) : [];
                const currentCampaigns = appState.data.campaigns ? [...appState.data.campaigns] : [];
                const currentTeam = appState.data.team ? [...appState.data.team] : [];
                const currentTasks = appState.data.tasks ? [...appState.data.tasks] : [];
                const currentDeals = appState.data.deals ? [...appState.data.deals] : [];
                const currentNotes = appState.data.notes ? [...appState.data.notes] : [];
                const currentCommunications = appState.data.communications ? 
                    JSON.parse(JSON.stringify(appState.data.communications)) : {
                        whatsapp: { connected: false, phoneNumber: '', apiKey: '', messages: [] },
                        sms: { messages: [] },
                        calls: { history: [] }
                    };
                const currentPipeline = appState.data.pipeline ? 
                    JSON.parse(JSON.stringify(appState.data.pipeline)) : {
                        stages: [
                            { id: 1, name: 'Lead', deals: [] },
                            { id: 2, name: 'Qualified', deals: [] },
                            { id: 3, name: 'Proposal', deals: [] },
                            { id: 4, name: 'Negotiation', deals: [] },
                            { id: 5, name: 'Closed Won', deals: [] }
                        ]
                    };
                const currentStrategicPlanning = appState.data.strategicPlanning ? 
                    JSON.parse(JSON.stringify(appState.data.strategicPlanning)) : {
                        businessUnits: [],
                        documents: [],
                        businessModelCanvas: {
                            keyPartners: '',
                            keyActivities: '',
                            keyResources: '',
                            valuePropositions: '',
                            customerRelationships: '',
                            channels: '',
                            customerSegments: '',
                            costStructure: '',
                            revenueStreams: ''
                        },
                        swotAnalysis: {
                            strengths: [],
                            weaknesses: [],
                            opportunities: [],
                            threats: []
                        },
                        goals: [],
                        kpis: []
                    };
                const currentAlerts = appState.data.alerts ? [...appState.data.alerts] : [];
                const currentBudgets = appState.data.budgets ? 
                    JSON.parse(JSON.stringify(appState.data.budgets)) : null;
                
                // Reset all data to empty state (no mock data) but preserve key sections
                appState.data = {
                    // PRESERVED SECTIONS
                    transactions: currentTransactions,  // PRESERVE transactions
                    marketingChannels: currentMarketingChannels,  // PRESERVE channels with budgets, reset stats
                    campaigns: currentCampaigns,  // PRESERVE campaigns (Marketing Hub)
                    team: currentTeam,  // PRESERVE team directory
                    tasks: currentTasks,  // PRESERVE task management
                    deals: currentDeals,  // PRESERVE sales pipeline (legacy)
                    pipeline: currentPipeline,  // PRESERVE sales pipeline (new structure)
                    notes: currentNotes,  // PRESERVE notes & documentation
                    communications: currentCommunications,  // PRESERVE WhatsApp/SMS/Call settings
                    strategicPlanning: currentStrategicPlanning,  // PRESERVE strategic planning
                    alerts: currentAlerts,  // PRESERVE smart alerts
                    budgets: currentBudgets,  // PRESERVE operational budgets
                    
                    // RESET SECTIONS
                    divisions: [],
                    contacts: [],
                    vendors: [],
                    events: [],
                    invoices: [],
                    recentActivity: [],
                    
                    // RESET METRICS TO 0
                    mrr: { current: 0, growth: 0, target: 0 },
                    subscriptions: { active: 0, growth: 0, churned: 0 },
                    customers: { total: 0, new: 0, churned: 0, churn_rate: 0 },
                    revenue: { monthly: 0, yearly: 0, forecast: 0 },
                    cashflow: { incoming: 0, outgoing: 0, net: 0, runway: 0 },
                    budget: { monthly: 0, spent: 0, remaining: 0 },
                    
                    // RESET FINANCIAL STATEMENTS
                    financialStatements: {
                        profitAndLoss: {
                            revenue: {
                                productSales: 0,
                                serviceSales: 0,
                                otherIncome: 0
                            },
                            costOfGoodsSold: {
                                materials: 0,
                                labor: 0,
                                overhead: 0
                            },
                            operatingExpenses: {
                                salesMarketing: 0,
                                generalAdmin: 0,
                                researchDev: 0,
                                depreciation: 0
                            },
                            otherExpenses: {
                                interestExpense: 0,
                                taxes: 0,
                                other: 0
                            }
                        },
                        cashFlow: {
                            operatingActivities: {
                                netIncome: 0,
                                depreciation: 0,
                                changesInAR: 0,
                                changesInAP: 0,
                                changesInInventory: 0
                            },
                            investingActivities: {
                                equipmentPurchases: 0,
                                investments: 0,
                                assetSales: 0
                            },
                            financingActivities: {
                                loanProceeds: 0,
                                loanRepayments: 0,
                                equityIssuance: 0,
                                dividends: 0
                            }
                        },
                        projections: {
                            nextQuarter: {
                                projectedRevenue: 0,
                                projectedExpenses: 0,
                                projectedProfit: 0,
                                assumptions: ''
                            },
                            nextYear: {
                                projectedRevenue: 0,
                                projectedExpenses: 0,
                                projectedProfit: 0,
                                assumptions: ''
                            },
                            threeYear: {
                                projectedRevenue: 0,
                                projectedExpenses: 0,
                                projectedProfit: 0,
                                assumptions: ''
                            }
                        }
                    }
                };
                
                // Save the reset state
                try {
                    localStorage.setItem('virelyOpsData', JSON.stringify(appState.data));
                    
                    // Log the reset activity
                    addRecentActivity('delete', 'Platform Reset Executed', 
                        `Preserved: Transactions (${currentTransactions.length}), Marketing Hub (${currentCampaigns.length} campaigns, ${currentMarketingChannels.length} channels), Team (${currentTeam.length}), Tasks (${currentTasks.length}), Sales Pipeline & Deals (${currentDeals.length}), Notes & Documentation (${currentNotes.length}), Communications Settings, Operational Budgets. All other data cleared.`, 
                        'info');
                    
                    // Save again after logging the activity
                    localStorage.setItem('virelyOpsData', JSON.stringify(appState.data));
                    
                    closeModal();
                    showToast('âœ… Platform reset complete! Reloading...', 'success');
                    
                    // Reload after a brief moment to show success message
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (e) {
                    console.error('Error during reset:', e);
                    showToast('Error resetting platform. Please try again.', 'error');
                }
            }, 500);
        }

        // FINANCIAL STATEMENTS SAVE FUNCTIONS
        function saveProfitLoss() {
            if (!appState.data.financialStatements) {
                appState.data.financialStatements = {
                    profitAndLoss: {},
                    cashFlow: {},
                    projections: {}
                };
            }
            
            appState.data.financialStatements.profitAndLoss = {
                revenue: {
                    productSales: parseFloat(document.getElementById('pl_productSales').value) || 0,
                    serviceSales: parseFloat(document.getElementById('pl_serviceSales').value) || 0,
                    otherIncome: parseFloat(document.getElementById('pl_otherIncome').value) || 0
                },
                costOfGoodsSold: {
                    materials: parseFloat(document.getElementById('pl_materials').value) || 0,
                    labor: parseFloat(document.getElementById('pl_labor').value) || 0,
                    overhead: parseFloat(document.getElementById('pl_overhead').value) || 0
                },
                operatingExpenses: {
                    salesMarketing: parseFloat(document.getElementById('pl_salesMarketing').value) || 0,
                    generalAdmin: parseFloat(document.getElementById('pl_generalAdmin').value) || 0,
                    researchDev: parseFloat(document.getElementById('pl_researchDev').value) || 0,
                    depreciation: parseFloat(document.getElementById('pl_depreciation').value) || 0
                },
                otherExpenses: {
                    interestExpense: parseFloat(document.getElementById('pl_interestExpense').value) || 0,
                    taxes: parseFloat(document.getElementById('pl_taxes').value) || 0,
                    other: parseFloat(document.getElementById('pl_other').value) || 0
                }
            };
            
            saveData();
            showToast('âœ… Profit & Loss statement saved successfully!', 'success');
            renderCurrentView();
        }
        
        function saveCashFlow() {
            if (!appState.data.financialStatements) {
                appState.data.financialStatements = {
                    profitAndLoss: {},
                    cashFlow: {},
                    projections: {}
                };
            }
            
            appState.data.financialStatements.cashFlow = {
                operatingActivities: {
                    netIncome: parseFloat(document.getElementById('cf_netIncome').value) || 0,
                    depreciation: parseFloat(document.getElementById('cf_depreciation').value) || 0,
                    changesInAR: parseFloat(document.getElementById('cf_changesInAR').value) || 0,
                    changesInAP: parseFloat(document.getElementById('cf_changesInAP').value) || 0,
                    changesInInventory: parseFloat(document.getElementById('cf_changesInInventory').value) || 0
                },
                investingActivities: {
                    equipmentPurchases: parseFloat(document.getElementById('cf_equipmentPurchases').value) || 0,
                    investments: parseFloat(document.getElementById('cf_investments').value) || 0,
                    assetSales: parseFloat(document.getElementById('cf_assetSales').value) || 0
                },
                financingActivities: {
                    loanProceeds: parseFloat(document.getElementById('cf_loanProceeds').value) || 0,
                    loanRepayments: parseFloat(document.getElementById('cf_loanRepayments').value) || 0,
                    equityIssuance: parseFloat(document.getElementById('cf_equityIssuance').value) || 0,
                    dividends: parseFloat(document.getElementById('cf_dividends').value) || 0
                }
            };
            
            saveData();
            showToast('âœ… Cash Flow statement saved successfully!', 'success');
            renderCurrentView();
        }
        
        function saveProjections() {
            if (!appState.data.financialStatements) {
                appState.data.financialStatements = {
                    profitAndLoss: {},
                    cashFlow: {},
                    projections: {}
                };
            }
            
            appState.data.financialStatements.projections = {
                nextQuarter: {
                    projectedRevenue: parseFloat(document.getElementById('proj_q_revenue').value) || 0,
                    projectedExpenses: parseFloat(document.getElementById('proj_q_expenses').value) || 0,
                    projectedProfit: parseFloat(document.getElementById('proj_q_profit').value) || 0,
                    assumptions: document.getElementById('proj_q_assumptions').value || ''
                },
                nextYear: {
                    projectedRevenue: parseFloat(document.getElementById('proj_y_revenue').value) || 0,
                    projectedExpenses: parseFloat(document.getElementById('proj_y_expenses').value) || 0,
                    projectedProfit: parseFloat(document.getElementById('proj_y_profit').value) || 0,
                    assumptions: document.getElementById('proj_y_assumptions').value || ''
                },
                threeYear: {
                    projectedRevenue: parseFloat(document.getElementById('proj_3y_revenue').value) || 0,
                    projectedExpenses: parseFloat(document.getElementById('proj_3y_expenses').value) || 0,
                    projectedProfit: parseFloat(document.getElementById('proj_3y_profit').value) || 0,
                    assumptions: document.getElementById('proj_3y_assumptions').value || ''
                }
            };
            
            saveData();
            showToast('âœ… Financial projections saved successfully!', 'success');
            renderCurrentView();
        }

        // DRILL-DOWN MODAL FUNCTIONS - COMPREHENSIVE FINANCIAL INSIGHTS
        
        function showMRRDrillDown() {
            const mrr = appState.data.mrr;
            const growth = mrr.growth;
            const lastMonth = mrr.current / (1 + growth/100);
            const monthlyGrowth = mrr.current - lastMonth;
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ’°</div>
                        <div style="font-weight: 900; font-size: 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                            $${(mrr.current/1000).toFixed(1)}K
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Monthly Recurring Revenue</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(110,231,183,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-size: 20px;">ðŸ“ˆ</span>
                            <span style="font-weight: 700; color: var(--accent-primary);">+${growth}% Growth</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">LAST MONTH</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--text-primary);">$${(lastMonth/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">MONTHLY GROWTH</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--success);">+$${(monthlyGrowth/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">ANNUAL PROJECTION</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--accent-gold);">$${((mrr.current * 12)/1000000).toFixed(2)}M</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">TARGET MRR</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--accent-tertiary);">$${(mrr.target/1000).toFixed(1)}K</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${((mrr.current/mrr.target)*100).toFixed(0)}% of target</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">ðŸ’¡ Insights</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--success); font-size: 20px;">âœ“</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Strong Growth Trajectory</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">MRR is growing ${growth}% month-over-month, indicating healthy customer acquisition and retention</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 20px;">â†’</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">On Track to Target</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">You're ${((mrr.current/mrr.target)*100).toFixed(0)}% towards your $${(mrr.target/1000).toFixed(1)}K monthly target. Expected to hit target in ${Math.ceil((mrr.target - mrr.current)/(monthlyGrowth))} months</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-gold); font-size: 20px;">âš¡</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Revenue Stability</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Recurring revenue provides predictable cash flow for sustainable growth and operations</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('MRR Deep Dive', modalContent);
        }
        
        function showSubscriptionsDrillDown() {
            const subs = appState.data.subscriptions;
            const lastMonth = Math.round(subs.active / (1 + subs.growth/100));
            const newSubs = subs.active - lastMonth + subs.churned;
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ‘¥</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-primary); margin-bottom: 8px;">
                            ${subs.active}
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Active Subscriptions</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(110,231,183,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--accent-primary);">+${subs.growth}% Growth</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">NEW THIS MONTH</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--success);">+${newSubs}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CHURNED</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--danger);">-${subs.churned}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">NET GROWTH</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--accent-primary);">+${subs.active - lastMonth}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Subscription Breakdown</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Starter Plan</span>
                                    <span style="font-weight: 600;">${Math.round(subs.active * 0.45)} subscriptions</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 45%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Growth Plan</span>
                                    <span style="font-weight: 600;">${Math.round(subs.active * 0.35)} subscriptions</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 35%; height: 100%; background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary));"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Enterprise Plan</span>
                                    <span style="font-weight: 600;">${Math.round(subs.active * 0.20)} subscriptions</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 20%; height: 100%; background: linear-gradient(90deg, var(--accent-gold), var(--accent-secondary));"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">ðŸ’¡ Key Metrics</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">RETENTION RATE</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--success);">${(((subs.active - newSubs + subs.churned)/(subs.active - newSubs + subs.churned + subs.churned))*100).toFixed(1)}%</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">GROWTH RATE</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-primary);">+${subs.growth}%</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">AVG REVENUE PER SUB</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-gold);">$${(appState.data.mrr.current / subs.active).toFixed(0)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">PROJECTED EOY</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-tertiary);">${Math.round(subs.active * Math.pow(1 + subs.growth/100, 12))}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Subscription Analytics', modalContent);
        }
        
        function showCustomersDrillDown() {
            const customers = appState.data.customers;
            const segments = {
                new: customers.new,
                active: customers.total - customers.new - customers.churned,
                at_risk: Math.round(customers.total * 0.08),
                churned: customers.churned
            };
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ“Š</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-primary); margin-bottom: 8px;">
                            ${customers.total.toLocaleString()}
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Total Customer Base</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), transparent); padding: 16px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 28px; margin-bottom: 8px;">ðŸŒŸ</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--success); margin-bottom: 4px;">${segments.new}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">NEW</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(124,92,255,0.1), transparent); padding: 16px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ’š</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-primary); margin-bottom: 4px;">${segments.active}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">ACTIVE</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,182,107,0.1), transparent); padding: 16px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 28px; margin-bottom: 8px;">âš ï¸</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--warning); margin-bottom: 4px;">${segments.at_risk}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">AT RISK</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,107,107,0.1), transparent); padding: 16px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center;">
                            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ“‰</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--danger); margin-bottom: 4px;">${segments.churned}</div>
                            <div style="color: var(--text-muted); font-size: 11px;">CHURNED</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Customer Lifecycle Distribution</div>
                        <div style="display: flex; height: 40px; border-radius: 8px; overflow: hidden;">
                            <div style="flex: ${segments.new}; background: var(--success); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                                ${((segments.new/customers.total)*100).toFixed(0)}%
                            </div>
                            <div style="flex: ${segments.active}; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                                ${((segments.active/customers.total)*100).toFixed(0)}%
                            </div>
                            <div style="flex: ${segments.at_risk}; background: var(--warning); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                                ${((segments.at_risk/customers.total)*100).toFixed(0)}%
                            </div>
                            <div style="flex: ${segments.churned}; background: var(--danger); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px;">
                                ${((segments.churned/customers.total)*100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CUSTOMER ACQUISITION COST</div>
                            <div style="font-weight: 700; font-size: 32px; color: var(--accent-secondary);">$847</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Per new customer</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CUSTOMER LIFETIME VALUE</div>
                            <div style="font-weight: 700; font-size: 32px; color: var(--accent-gold);">$2,714</div>
                            <div style="font-size: 12px; color: var(--success); margin-top: 4px;">3.2x CAC ratio</div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Customer Base Analysis', modalContent);
        }
        
        function showChurnDrillDown() {
            const customers = appState.data.customers;
            const churnRate = customers.churn_rate;
            const churned = customers.churned;
            const churnedRevenue = churned * (appState.data.mrr.current / appState.data.subscriptions.active);
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,182,107,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ“‰</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--danger); margin-bottom: 8px;">
                            ${churnRate}%
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Monthly Churn Rate</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(255,107,107,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--danger);">${churned} customers lost</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">LOST MRR</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--danger);">-$${(churnedRevenue/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">ANNUAL IMPACT</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--warning);">-$${((churnedRevenue * 12)/1000).toFixed(1)}K</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Churn Reasons</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Price concerns</span>
                                    <span style="font-weight: 600;">35%</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 35%; height: 100%; background: var(--danger);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Product fit issues</span>
                                    <span style="font-weight: 600;">28%</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 28%; height: 100%; background: var(--warning);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Support issues</span>
                                    <span style="font-weight: 600;">20%</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 20%; height: 100%; background: var(--accent-secondary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Other reasons</span>
                                    <span style="font-weight: 600;">17%</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 17%; height: 100%; background: var(--text-muted);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--warning);">âš¡ Improvement Actions</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--success); font-size: 20px;">1</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Address pricing concerns</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Consider value-based pricing tier adjustments or grandfathering loyal customers</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-primary); font-size: 20px;">2</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Enhance product-market fit</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Conduct customer interviews to better understand use cases and pain points</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-gold); font-size: 20px;">3</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Improve customer success</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Implement proactive outreach program for at-risk customers and enhance support response times</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 16px; background: rgba(110,231,183,0.1); border-radius: 12px; border: 1px solid rgba(110,231,183,0.2);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">TARGET CHURN RATE</div>
                        <div style="font-weight: 700; font-size: 24px; color: var(--success);">< 2%</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Industry best practice for SaaS</div>
                    </div>
                </div>
            `;
            showModal('Churn Analysis & Mitigation', modalContent);
        }
        
        function showRevenueDrillDown() {
            const revenue = appState.data.revenue;
            const monthlyAvg = revenue.yearly / 12;
            const forecastGrowth = ((revenue.forecast - revenue.yearly) / revenue.yearly * 100).toFixed(1);
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ’µ</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-gold); margin-bottom: 8px;">
                            $${(revenue.yearly/1000000).toFixed(2)}M
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Annual Revenue</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(251,191,36,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--accent-gold);">Projected: $${(revenue.forecast/1000000).toFixed(2)}M</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">MONTHLY AVG</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--text-primary);">$${(monthlyAvg/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">YOY GROWTH</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--success);">+${forecastGrowth}%</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">FORECAST</div>
                            <div style="font-weight: 700; font-size: 24px; color: var(--accent-gold);">$${(revenue.forecast/1000000).toFixed(2)}M</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Revenue Streams</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Subscription Revenue (MRR)</span>
                                    <span style="font-weight: 600;">$${((appState.data.mrr.current * 12)/1000000).toFixed(2)}M (85%)</span>
                                </div>
                                <div style="height: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; overflow: hidden;">
                                    <div style="width: 85%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Setup & Onboarding Fees</span>
                                    <span style="font-weight: 600;">$${((revenue.yearly * 0.10)/1000000).toFixed(2)}M (10%)</span>
                                </div>
                                <div style="height: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; overflow: hidden;">
                                    <div style="width: 10%; height: 100%; background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary));"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Professional Services</span>
                                    <span style="font-weight: 600;">$${((revenue.yearly * 0.05)/1000000).toFixed(2)}M (5%)</span>
                                </div>
                                <div style="height: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; overflow: hidden;">
                                    <div style="width: 5%; height: 100%; background: linear-gradient(90deg, var(--accent-gold), var(--accent-secondary));"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">QUARTERLY BREAKDOWN</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 10px; color: var(--text-muted);">Q1</div>
                                    <div style="font-weight: 700; color: var(--text-primary);">$${((revenue.yearly * 0.23)/1000000).toFixed(2)}M</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 10px; color: var(--text-muted);">Q2</div>
                                    <div style="font-weight: 700; color: var(--text-primary);">$${((revenue.yearly * 0.24)/1000000).toFixed(2)}M</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 10px; color: var(--text-muted);">Q3</div>
                                    <div style="font-weight: 700; color: var(--text-primary);">$${((revenue.yearly * 0.26)/1000000).toFixed(2)}M</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 10px; color: var(--text-muted);">Q4</div>
                                    <div style="font-weight: 700; color: var(--success);">$${((revenue.yearly * 0.27)/1000000).toFixed(2)}M</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">TOP PERFORMING PRODUCTS</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px;">Dealsby.io</span>
                                    <span style="font-weight: 700; color: var(--accent-primary);">$${(appState.data.divisions[0].revenue/1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px;">Appointments</span>
                                    <span style="font-weight: 700; color: var(--accent-tertiary);">$${(appState.data.divisions[1].revenue/1000).toFixed(0)}K</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px;">Reservations</span>
                                    <span style="font-weight: 700; color: var(--accent-gold);">$${(appState.data.divisions[2].revenue/1000).toFixed(0)}K</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Annual Revenue Deep Dive', modalContent);
        }
        
        function showCashflowDrillDown() {
            const cf = appState.data.cashflow;
            const burnRate = cf.outgoing;
            const runway = cf.runway;
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(96,165,250,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ”„</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-tertiary); margin-bottom: 8px;">
                            $${(cf.net/1000).toFixed(1)}K
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Monthly Net Cashflow</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(96,165,250,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--accent-tertiary);">${runway} months runway</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), transparent); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CASH IN</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--success);">+$${(cf.incoming/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,107,107,0.1), transparent); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">CASH OUT</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--danger);">-$${(cf.outgoing/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(96,165,250,0.1), transparent); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">NET CASH</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--accent-tertiary);">+$${(cf.net/1000).toFixed(1)}K</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Cash Flow Breakdown</div>
                        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">INCOMING</div>
                                    <div style="font-weight: 700; font-size: 24px; color: var(--success);">$${(cf.incoming/1000).toFixed(1)}K</div>
                                </div>
                                <div style="background: rgba(110,231,183,0.1); border: 2px solid var(--success); border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Subscriptions</span>
                                            <strong>$${(cf.incoming * 0.85/1000).toFixed(1)}K</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Setup Fees</span>
                                            <strong>$${(cf.incoming * 0.10/1000).toFixed(1)}K</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Other</span>
                                            <strong>$${(cf.incoming * 0.05/1000).toFixed(1)}K</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 32px; color: var(--text-muted);">â†’</div>
                            <div style="flex: 1;">
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">OUTGOING</div>
                                    <div style="font-weight: 700; font-size: 24px; color: var(--danger);">$${(cf.outgoing/1000).toFixed(1)}K</div>
                                </div>
                                <div style="background: rgba(255,107,107,0.1); border: 2px solid var(--danger); border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Payroll</span>
                                            <strong>$${(cf.outgoing * 0.50/1000).toFixed(1)}K</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Infrastructure</span>
                                            <strong>$${(cf.outgoing * 0.15/1000).toFixed(1)}K</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Marketing</span>
                                            <strong>$${(cf.outgoing * 0.20/1000).toFixed(1)}K</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Other</span>
                                            <strong>$${(cf.outgoing * 0.15/1000).toFixed(1)}K</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-tertiary);">ðŸ’¡ Financial Health Indicators</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">RUNWAY</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--success);">${runway} months</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Healthy (>12 months)</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">BURN RATE</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--danger);">$${(burnRate/1000).toFixed(1)}K/mo</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Monthly spending</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">CASH EFFICIENCY</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-primary);">${((cf.net/cf.incoming)*100).toFixed(0)}%</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Net margin</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">MONTHLY SAVINGS</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-gold);">$${(cf.net/1000).toFixed(1)}K</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Building reserves</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Cashflow Analysis', modalContent);
        }
        
        function showBudgetDrillDown() {
            const budget = appState.data.budget;
            const utilizationRate = ((budget.spent / budget.monthly) * 100).toFixed(1);
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ’³</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-gold); margin-bottom: 8px;">
                            $${(budget.remaining/1000).toFixed(1)}K
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Budget Remaining</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(251,191,36,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--accent-gold);">${utilizationRate}% utilized</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">MONTHLY BUDGET</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--text-primary);">$${(budget.monthly/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">SPENT</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--warning);">$${(budget.spent/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">REMAINING</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--success);">$${(budget.remaining/1000).toFixed(1)}K</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 12px;">Budget Utilization</div>
                        <div style="height: 32px; background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; position: relative;">
                            <div style="width: ${utilizationRate}%; height: 100%; background: linear-gradient(90deg, var(--accent-gold), var(--warning)); display: flex; align-items: center; justify-content: center;">
                                <span style="font-weight: 700; font-size: 14px; color: white; position: relative; z-index: 1;">${utilizationRate}%</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                            <span>$0</span>
                            <span>$${(budget.monthly/1000).toFixed(1)}K</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 16px;">Spending by Category</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Operations & Infrastructure</span>
                                    <span style="font-weight: 600;">$${(budget.spent * 0.30/1000).toFixed(1)}K (30%)</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 30%; height: 100%; background: var(--accent-primary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Marketing & Sales</span>
                                    <span style="font-weight: 600;">$${(budget.spent * 0.28/1000).toFixed(1)}K (28%)</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 28%; height: 100%; background: var(--accent-secondary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Product Development</span>
                                    <span style="font-weight: 600;">$${(budget.spent * 0.22/1000).toFixed(1)}K (22%)</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 22%; height: 100%; background: var(--accent-tertiary);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Administrative</span>
                                    <span style="font-weight: 600;">$${(budget.spent * 0.20/1000).toFixed(1)}K (20%)</span>
                                </div>
                                <div style="height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 20%; height: 100%; background: var(--accent-gold);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-gold);">ðŸ“Š Budget Performance</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">DAYS REMAINING</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--accent-primary);">15 days</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Until month end</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">DAILY BURN RATE</div>
                                <div style="font-weight: 700; font-size: 20px; color: var(--warning);">$${((budget.spent/15)/1000).toFixed(1)}K/day</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Average daily</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">PROJECTED SPEND</div>
                                <div style="font-weight: 700; font-size: 20px; color: ${((budget.spent * 2) > budget.monthly) ? 'var(--danger)' : 'var(--success)'};">$${((budget.spent * 2)/1000).toFixed(1)}K</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">By month end</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">BUDGET HEALTH</div>
                                <div style="font-weight: 700; font-size: 20px; color: ${parseFloat(utilizationRate) < 90 ? 'var(--success)' : 'var(--warning)'};">
                                    ${parseFloat(utilizationRate) < 90 ? 'Healthy' : 'Monitor'}
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Status indicator</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Budget Analysis', modalContent);
        }
        
        function showARRDrillDown() {
            const arr = appState.data.mrr.current * 12;
            const growth = appState.data.mrr.growth;
            
            const modalContent = `
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(124,92,255,0.1)); border-radius: 16px;">
                        <div style="font-size: 56px; margin-bottom: 12px;">ðŸ“Š</div>
                        <div style="font-weight: 900; font-size: 48px; color: var(--accent-primary); margin-bottom: 8px;">
                            $${(arr/1000000).toFixed(2)}M
                        </div>
                        <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 16px;">Annual Recurring Revenue</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(110,231,183,0.2); padding: 8px 16px; border-radius: 20px;">
                            <span style="font-weight: 700; color: var(--accent-primary);">+${growth}% MoM</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 20px;">ARR Growth Projection</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            ${[1,2,3,4].map(q => {
                                const projection = arr * Math.pow(1 + growth/100, q * 3);
                                const percentChange = q === 1 ? 'Current' : '+' + (((projection - arr)/arr) * 100).toFixed(0) + '%';
                                return '<div style="background: rgba(110,231,183,0.1); padding: 16px; border-radius: 8px; text-align: center;">' +
                                    '<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Q' + q + ' ' + new Date().getFullYear() + '</div>' +
                                    '<div style="font-weight: 700; font-size: 20px; color: var(--accent-primary);">$' + (projection/1000000).toFixed(2) + 'M</div>' +
                                    '<div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">' + percentChange + '</div>' +
                                    '</div>';
                            }).join('')}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">MRR (Monthly)</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--text-primary);">$${(appState.data.mrr.current/1000).toFixed(1)}K</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">ARR (Annual)</div>
                            <div style="font-weight: 700; font-size: 28px; color: var(--accent-primary);">$${(arr/1000000).toFixed(2)}M</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(20,27,46,0.8), rgba(10,14,26,0.6)); padding: 24px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 16px; color: var(--accent-primary);">ðŸ’¡ ARR Insights</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--success); font-size: 20px;">âœ“</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Strong Momentum</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">With ${growth}% MoM growth, you're on track to reach $${((arr * Math.pow(1 + growth/100, 12))/1000000).toFixed(2)}M ARR in 12 months</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <span style="color: var(--accent-gold); font-size: 20px;">ðŸ“ˆ</span>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Revenue Quality</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">100% of revenue is recurring, providing predictable cash flow and strong business foundation</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('ARR Projection & Analysis', modalContent);
        }
        
        function showLTVCACDrillDown() {
            const avgLTV = appState.data.customers.reduce((sum, c) => sum + c.ltv, 0) / appState.data.customers.length;
            const estimatedCAC = 45000; // $450 in cents
            const ratio = avgLTV / estimatedCAC;
            const paybackMonths = 8.5;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average LTV</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(avgLTV/100).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Customer lifetime value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average CAC</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(estimatedCAC/100).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Customer acquisition cost</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">LTV:CAC Ratio</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${ratio.toFixed(1)}:1</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Excellent unit economics</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Payback Period</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${paybackMonths}mo</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Time to recover CAC</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">LTV by Customer Segment</h3>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(appState.data.customers.reduce((acc, c) => {
                            if (!acc[c.plan]) acc[c.plan] = { count: 0, ltv: 0 };
                            acc[c.plan].count++;
                            acc[c.plan].ltv += c.ltv;
                            return acc;
                        }, {})).map(([plan, data]) => {
                            const avgPlanLTV = data.ltv / data.count;
                            const planCAC = estimatedCAC * (plan === 'Enterprise' ? 1.5 : plan === 'Pro' ? 1.2 : 0.8);
                            const planRatio = avgPlanLTV / planCAC;
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${plan} Plan</span>
                                        <span class="badge badge-success">${planRatio.toFixed(1)}:1</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 13px;">
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">Avg LTV</div>
                                            <div style="font-weight: 600;">$${(avgPlanLTV/100).toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">Avg CAC</div>
                                            <div style="font-weight: 600;">$${(planCAC/100).toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">Customers</div>
                                            <div style="font-weight: 600;">${data.count}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div style="margin-top: 32px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px;">ðŸ“Š BENCHMARK COMPARISON</div>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Your Ratio</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Current performance</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--success);">${ratio.toFixed(1)}:1</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Industry Average</div>
                                <div style="font-size: 12px; color: var(--text-muted);">SaaS benchmark</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--text-secondary);">3.0:1</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Healthy Target</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Recommended minimum</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-tertiary);">3.5:1</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ’Ž ANALYSIS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your LTV:CAC ratio of ${ratio.toFixed(1)}:1 is excellent and above industry standards. This indicates strong unit economics and efficient customer acquisition. Enterprise customers show the best ratio, suggesting you should focus marketing efforts on this segment. With a payback period of only ${paybackMonths} months, you're recovering acquisition costs quickly.
                    </div>
                </div>
            `;
            showModal('LTV:CAC Ratio Analysis', modalContent);
        }
        
        function showPaybackDrillDown() {
            const avgMRR = appState.data.customers.filter(c => c.status === 'Active').reduce((sum, c) => sum + c.mrr, 0) / appState.data.customers.filter(c => c.status === 'Active').length;
            const estimatedCAC = 45000; // $450 in cents
            const paybackMonths = (estimatedCAC / avgMRR).toFixed(1);
            const industryAvg = 12;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">CAC Payback Period</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${paybackMonths}mo</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Months to recover CAC</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Industry Average</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${industryAvg}mo</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">SaaS benchmark</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Performance vs Avg</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${((industryAvg - paybackMonths) / industryAvg * 100).toFixed(0)}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Better than average</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Monthly Profit</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${((avgMRR * 0.78)/100).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">After payback period</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Payback by Customer Segment</h3>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(appState.data.customers.reduce((acc, c) => {
                            if (c.status !== 'Active') return acc;
                            if (!acc[c.plan]) acc[c.plan] = { count: 0, mrr: 0 };
                            acc[c.plan].count++;
                            acc[c.plan].mrr += c.mrr;
                            return acc;
                        }, {})).map(([plan, data]) => {
                            const avgPlanMRR = data.mrr / data.count;
                            const planCAC = estimatedCAC * (plan === 'Enterprise' ? 1.5 : plan === 'Pro' ? 1.2 : 0.8);
                            const planPayback = (planCAC / avgPlanMRR).toFixed(1);
                            const isHealthy = planPayback < 12;
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${plan} Plan</span>
                                        <span class="badge badge-${isHealthy ? 'success' : 'warning'}">${planPayback} months</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 13px;">
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">Avg MRR</div>
                                            <div style="font-weight: 600;">$${(avgPlanMRR/100).toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">CAC</div>
                                            <div style="font-weight: 600;">$${(planCAC/100).toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted); margin-bottom: 4px;">Customers</div>
                                            <div style="font-weight: 600;">${data.count}</div>
                                        </div>
                                    </div>
                                    <div class="progress-bar" style="margin-top: 12px;">
                                        <div class="progress-fill" style="width: ${Math.min(planPayback / 18 * 100, 100)}%; background: linear-gradient(90deg, var(--success), ${isHealthy ? 'var(--accent-primary)' : 'var(--warning)'});"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h3 style="margin-bottom: 20px;">Cash Flow Impact</h3>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Initial Investment (CAC)</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--danger);">-$${(estimatedCAC/100).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Monthly Revenue (Avg)</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+$${(avgMRR/100).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Break-even Month</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--accent-tertiary);">Month ${paybackMonths}</span>
                        </div>
                        <div style="height: 1px; background: var(--glass-border); margin: 8px 0;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Cumulative Profit (12mo)</span>
                            <span style="font-size: 20px; font-weight: 800; color: var(--success);">
                                +$${((avgMRR * 12 - estimatedCAC)/100).toFixed(2)}
                            </span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">â±ï¸ KEY INSIGHT</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your CAC payback period of ${paybackMonths} months is ${(((industryAvg - paybackMonths) / industryAvg) * 100).toFixed(0)}% faster than the ${industryAvg}-month industry average. This efficient capital recovery enables aggressive growth reinvestment. Enterprise customers have the fastest payback, making them your most capital-efficient segment.
                    </div>
                </div>
            `;
            showModal('CAC Payback Period Analysis', modalContent);
        }
        
        function showGrossMarginDrillDown() {
            const revenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const cogs = Math.abs(appState.data.transactions.filter(t => t.category === 'Infrastructure' || t.category === 'Processing').reduce((sum, t) => sum + t.amount, 0));
            const grossProfit = revenue - cogs;
            const grossMargin = (grossProfit / revenue * 100).toFixed(1);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Gross Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${grossMargin}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Revenue after COGS</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Gross Profit</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(grossProfit/100).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total gross profit</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">COGS</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(cogs/100).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Cost of goods sold</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Industry Benchmark</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">75%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">SaaS average margin</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h3 style="margin-bottom: 20px;">Margin Breakdown</h3>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">Total Revenue</span>
                                <span style="font-weight: 700;">$${(revenue/100).toFixed(2)}</span>
                            </div>
                            <div class="progress-bar" style="height: 12px;">
                                <div style="width: 100%; height: 100%; background: linear-gradient(90deg, var(--success), var(--accent-primary)); border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">Cost of Goods Sold (${((cogs/revenue) * 100).toFixed(1)}%)</span>
                                <span style="font-weight: 700; color: var(--danger);">-$${(cogs/100).toFixed(2)}</span>
                            </div>
                            <div class="progress-bar" style="height: 12px;">
                                <div style="width: ${(cogs/revenue) * 100}%; height: 100%; background: linear-gradient(90deg, var(--danger), var(--warning)); border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="height: 1px; background: var(--glass-border);"></div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600;">Gross Profit (${grossMargin}%)</span>
                                <span style="font-size: 20px; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    $${(grossProfit/100).toFixed(2)}
                                </span>
                            </div>
                            <div class="progress-bar" style="height: 12px;">
                                <div style="width: ${grossMargin}%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Cost Structure Analysis</h3>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(appState.data.transactions.filter(t => t.category === 'Infrastructure' || t.category === 'Processing').reduce((acc, t) => {
                            acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
                            return acc;
                        }, {})).map(([category, amount]) => {
                            const percentage = (amount / cogs * 100).toFixed(1);
                            const perCustomer = amount / appState.data.customers.filter(c => c.status === 'Active').length;
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${category}</span>
                                        <span style="font-weight: 700; color: var(--danger);">$${(amount/100).toFixed(2)} (${percentage}%)</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        Per customer: $${(perCustomer/100).toFixed(2)}
                                    </div>
                                    <div class="progress-bar">
                                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--danger), var(--warning)); border-radius: 4px;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div style="margin-top: 32px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px;">ðŸ“Š BENCHMARK COMPARISON</div>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Your Gross Margin</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Current performance</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--success);">${grossMargin}%</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Industry Average</div>
                                <div style="font-size: 12px; color: var(--text-muted);">SaaS benchmark</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--text-secondary);">75%</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Best-in-Class</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Top quartile SaaS</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-primary);">85%</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ“Š ANALYSIS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your gross margin of ${grossMargin}% is ${parseFloat(grossMargin) > 75 ? 'above' : 'below'} the SaaS industry average of 75%. As you scale, negotiate volume discounts and consider reserved instances to improve margins by 5-8 percentage points. Focus on optimizing infrastructure costs which represent the largest COGS component.
                    </div>
                </div>
            `;
            showModal('Gross Margin Deep Dive', modalContent);
        }

        // ADVANCED ANALYTICS DRILL-DOWNS
        function showRevenueGrowthDrillDown() {
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Current Growth Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">24.5%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Month-over-month growth</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Acceleration</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+3.2%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Growth momentum increase</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">YoY Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">127%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year-over-year comparison</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Run Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$4.2M</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Annual run rate projection</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h3 style="margin-bottom: 20px;">Growth Drivers</h3>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">New Customer Acquisition</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+42%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Expansion Revenue</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+31%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Price Optimization</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+15%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Product Mix</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+12%</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ“ˆ GROWTH ANALYSIS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your revenue growth rate of 24.5% is exceptional, with acceleration of 3.2% indicating strengthening momentum. New customer acquisition is the primary driver at 42%, suggesting effective go-to-market strategies. Continue investing in acquisition channels while focusing on expansion revenue to maximize growth efficiency.
                    </div>
                </div>
            `;
            showModal('Revenue Growth Rate Analysis', modalContent);
        }

        function showCLVDrillDown() {
            const totalContacts = appState.data.contacts.length;
            const avgContactValue = appState.data.contacts.reduce((sum, c) => sum + c.value, 0) / totalContacts;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average CLV</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgContactValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Customer lifetime value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Customer Life</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">38mo</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Expected lifetime</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(avgContactValue / 38).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Average per month</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">CLV Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+18.3%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">From last month</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">CLV by Customer Segment</h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Growth Suite</span>
                                <span style="font-weight: 700; color: var(--success);">$${(avgContactValue * 2.5).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 100%;"></div></div>
                            <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Avg lifetime: 48 months</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Growth</span>
                                <span style="font-weight: 700; color: var(--accent-primary);">$${avgContactValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 65%;"></div></div>
                            <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Avg lifetime: 38 months</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Starter</span>
                                <span style="font-weight: 700; color: var(--accent-tertiary);">$${(avgContactValue * 0.4).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 25%; background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-secondary));"></div></div>
                            <div style="margin-top: 8px; font-size: 13px; color: var(--text-muted);">Avg lifetime: 24 months</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ’Ž CLV INSIGHTS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your average customer lifetime value of $${avgContactValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})} is growing at 18.3% month-over-month. Growth Suite customers show exceptional lifetime value at 2.5x the average. Focus on upgrading Growth customers to Growth Suite tier and improving Starter tier retention to maximize overall CLV.
                    </div>
                </div>
            `;
            showModal('Customer Lifetime Value Analysis', modalContent);
        }

        function showProfitMarginDrillDown() {
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = ((netProfit / totalRevenue) * 100).toFixed(1);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Profit Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${profitMargin}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Net profit margin</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Gross Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">78%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Before operating expenses</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Operating Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">42%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Operating profit margin</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">EBITDA Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">45%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Pre-tax earnings margin</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h3 style="margin-bottom: 20px;">Profitability Waterfall</h3>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Total Revenue</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">$${totalRevenue.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">- Cost of Goods Sold (22%)</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--danger);">-$${(totalRevenue * 0.22).toLocaleString()}</span>
                        </div>
                        <div style="height: 1px; background: var(--glass-border);"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">= Gross Profit (78%)</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">$${(totalRevenue * 0.78).toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">- Operating Expenses (36%)</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--danger);">-$${totalExpenses.toLocaleString()}</span>
                        </div>
                        <div style="height: 1px; background: var(--glass-border);"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">= Net Profit (${profitMargin}%)</span>
                            <span style="font-size: 24px; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                $${netProfit.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ’° MARGIN ANALYSIS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your net profit margin of ${profitMargin}% is exceptional for a SaaS business at this stage. High gross margin (78%) combined with disciplined operating expense management creates strong unit economics. Focus on maintaining gross margin while achieving operating leverage as you scale revenue.
                    </div>
                </div>
            `;
            showModal('Profit Margin Deep Dive', modalContent);
        }

        function showCACDrillDown() {
            const totalMarketingSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const totalMarketingLeads = appState.data.campaigns.reduce((sum, c) => sum + c.leads, 0);
            const avgCostPerLead = (totalMarketingSpend / totalMarketingLeads).toFixed(2);
            const conversionRate = 0.28; // 28% conversion rate
            const estimatedCAC = (avgCostPerLead / conversionRate).toFixed(2);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Customer Acquisition Cost</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgCostPerLead}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Average CAC</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Blended CAC</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${estimatedCAC}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Including all channels</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">CAC Trend</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success); margin-bottom: 4px;">-12%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Decreasing efficiency</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Payback Period</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">8.5mo</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Time to recover CAC</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">CAC by Marketing Channel</h3>
                    <div style="display: grid; gap: 12px;">
                        ${appState.data.campaigns.map(campaign => {
                            const channelCAC = (campaign.spent / campaign.leads / conversionRate).toFixed(2);
                            const channelCPL = (campaign.spent / campaign.leads).toFixed(2);
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${campaign.channel}</span>
                                        <span style="font-weight: 700; color: var(--accent-primary);">$${channelCAC} CAC</span>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                                        CPL: $${channelCPL} | Leads: ${campaign.leads} | Conv Rate: ${(conversionRate * 100).toFixed(0)}%
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min((parseFloat(channelCAC) / parseFloat(estimatedCAC)) * 100, 100)}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸŽ¯ CAC INSIGHTS</div>
                    <div style="font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        Your customer acquisition cost of $${avgCostPerLead} is efficient and trending downward (-12%). With an 8.5-month payback period, you're recovering acquisition costs quickly. Continue optimizing channel mix, with focus on highest-performing channels showing lowest CAC while maintaining quality lead generation.
                    </div>
                </div>
            `;
            showModal('Customer Acquisition Cost Analysis', modalContent);
        }

        // NEW ANALYTICS DRILL-DOWN FUNCTIONS
        function showTotalRevenueDrillDown() {
            const transactions = appState.data.transactions.filter(t => t.amount > 0);
            const totalRevenue = transactions.reduce((sum, t) => sum + t.amount, 0);
            const monthlyAvg = totalRevenue / 12;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Revenue</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalRevenue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year to date</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Average</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${monthlyAvg.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per month</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Growth Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success); margin-bottom: 4px;">+24.5%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year over year</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Revenue Streams</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">${transactions.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Active transactions</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">Top Revenue Sources</h3>
                    <div style="display: grid; gap: 12px;">
                        ${transactions.slice(0, 5).map(t => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">${t.description}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${t.category} â€¢ ${t.date}</div>
                                </div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--success);">+$${t.amount.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Total Revenue Analysis', modalContent);
        }

        function showTotalExpensesDrillDown() {
            const transactions = appState.data.transactions.filter(t => t.amount < 0);
            const totalExpenses = Math.abs(transactions.reduce((sum, t) => sum + t.amount, 0));
            const monthlyAvg = totalExpenses / 12;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Expenses</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalExpenses.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year to date</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Average</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${monthlyAvg.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per month</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Expense Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+8.2%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year over year</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Expense Items</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${transactions.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total expenses</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Top Expense Categories</h3>
                    <div style="display: grid; gap: 12px;">
                        ${transactions.slice(0, 5).map(t => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">${t.description}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${t.category} â€¢ ${t.date}</div>
                                </div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--danger);">-$${Math.abs(t.amount).toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Total Expenses Analysis', modalContent);
        }

        function showNetProfitDrillDown() {
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = ((netProfit / totalRevenue) * 100).toFixed(1);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Net Profit</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${netProfit.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Revenue minus expenses</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Profit Margin</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${profitMargin}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Net margin ratio</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Profit</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(netProfit / 12).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Average per month</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Profit Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+42.3%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Year over year</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px; padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h3 style="margin-bottom: 20px;">Profit Breakdown</h3>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Total Revenue</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--success);">+$${totalRevenue.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-secondary);">Total Expenses</span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--danger);">-$${totalExpenses.toLocaleString()}</span>
                        </div>
                        <div style="height: 1px; background: var(--glass-border); margin: 8px 0;"></div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Net Profit</span>
                            <span style="font-size: 24px; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                $${netProfit.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            showModal('Net Profit Analysis', modalContent);
        }

        function showTotalPipelineDrillDown() {
            const totalDealValue = appState.data.deals.reduce((sum, d) => sum + d.value, 0);
            const deals = appState.data.deals;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Pipeline</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalDealValue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Combined deal value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Deal Count</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${deals.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Active opportunities</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Pipeline Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+18.5%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">vs last quarter</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Deal Size</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(totalDealValue / deals.length).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per opportunity</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Top Deals in Pipeline</h3>
                    <div style="display: grid; gap: 12px;">
                        ${deals.sort((a, b) => b.value - a.value).slice(0, 5).map(d => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">${d.name}</span>
                                    <span style="font-weight: 700; font-size: 18px; color: var(--accent-primary);">$${d.value.toLocaleString()}</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    Stage: ${d.stage} â€¢ Probability: ${d.probability}%
                                </div>
                                <div class="progress-bar" style="margin-top: 8px;">
                                    <div class="progress-fill" style="width: ${d.probability}%;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Total Pipeline Analysis', modalContent);
        }

        function showWeightedPipelineDrillDown() {
            const weightedPipeline = appState.data.deals.reduce((sum, d) => sum + (d.value * d.probability / 100), 0);
            const totalPipeline = appState.data.deals.reduce((sum, d) => sum + d.value, 0);
            const weightedPercentage = ((weightedPipeline / totalPipeline) * 100).toFixed(1);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Weighted Pipeline</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${weightedPipeline.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Probability-adjusted</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Conversion Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${weightedPercentage}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Of total pipeline</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Expected Close</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">Q1 2024</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Most deals closing</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Confidence Level</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">High</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Strong indicators</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Pipeline by Probability</h3>
                    <div style="display: grid; gap: 12px;">
                        ${['75-100%', '50-74%', '25-49%', '0-24%'].map((range, idx) => {
                            const [min, max] = range.split('-').map(s => parseInt(s));
                            const dealsInRange = appState.data.deals.filter(d => d.probability >= min && d.probability <= max);
                            const valueInRange = dealsInRange.reduce((sum, d) => sum + d.value, 0);
                            const colors = ['var(--success)', 'var(--accent-primary)', 'var(--warning)', 'var(--danger)'];
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${range} Probability</span>
                                        <span style="font-weight: 700; color: ${colors[idx]};">$${valueInRange.toLocaleString()}</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${dealsInRange.length} deals</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(valueInRange / totalPipeline) * 100}%; background: ${colors[idx]};"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            showModal('Weighted Pipeline Analysis', modalContent);
        }

        function showAvgDealSizeDrillDown() {
            const totalDealValue = appState.data.deals.reduce((sum, d) => sum + d.value, 0);
            const avgDealSize = totalDealValue / appState.data.deals.length;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average Deal Size</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgDealSize.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per opportunity</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Median Deal</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(avgDealSize * 0.85).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Midpoint value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Largest Deal</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${Math.max(...appState.data.deals.map(d => d.value)).toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Highest value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Size Trend</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+12.4%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">YoY growth</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Deal Size Distribution</h3>
                    <div style="display: grid; gap: 12px;">
                        ${['$50K+', '$25K-$50K', '$10K-$25K', 'Under $10K'].map((range, idx) => {
                            const ranges = [[50000, 1000000], [25000, 50000], [10000, 25000], [0, 10000]];
                            const [min, max] = ranges[idx];
                            const dealsInRange = appState.data.deals.filter(d => d.value >= min && d.value < max);
                            const count = dealsInRange.length;
                            const percentage = ((count / appState.data.deals.length) * 100).toFixed(0);
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${range}</span>
                                        <span style="font-weight: 700; color: var(--accent-primary);">${count} deals (${percentage}%)</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            showModal('Average Deal Size Analysis', modalContent);
        }

        function showWinProbabilityDrillDown() {
            const avgProbability = appState.data.deals.reduce((sum, d) => sum + d.probability, 0) / appState.data.deals.length;
            const highProbDeals = appState.data.deals.filter(d => d.probability >= 75).length;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Win Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${avgProbability.toFixed(0)}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Across all deals</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">High Confidence</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${highProbDeals}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Deals above 75%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Historical Win Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">68%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Closed won rate</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Velocity</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">42 days</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Avg sales cycle</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Win Probability by Stage</h3>
                    <div style="display: grid; gap: 12px;">
                        ${['Proposal', 'Negotiation', 'Discovery', 'Qualification'].map((stage, idx) => {
                            const stageProbs = [85, 65, 45, 25];
                            const dealsInStage = appState.data.deals.filter(d => d.stage === stage).length;
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="font-weight: 600;">${stage}</span>
                                        <span style="font-weight: 700; color: var(--success);">${stageProbs[idx]}%</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${dealsInStage} deals in this stage</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${stageProbs[idx]}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            showModal('Win Probability Analysis', modalContent);
        }

        function showTotalContactsDrillDown() {
            const totalContacts = appState.data.contacts.length;
            const customers = appState.data.contacts.filter(c => c.status === 'Customer').length;
            const leads = appState.data.contacts.filter(c => c.status === 'Lead').length;
            const prospects = appState.data.contacts.filter(c => c.status === 'Prospect').length;
            const growthRate = 16.2;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Contacts</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${totalContacts}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">In database</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Customers</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success); margin-bottom: 4px;">${customers}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Active accounts</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Leads</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">${leads}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Qualified prospects</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Growth Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+${growthRate}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Database expansion</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">Contact Status Breakdown</h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Customers</span>
                                <span style="font-weight: 700; color: var(--success);">${customers} (${((customers/totalContacts)*100).toFixed(0)}%)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(customers/totalContacts)*100}%;"></div>
                            </div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Leads</span>
                                <span style="font-weight: 700; color: var(--accent-tertiary);">${leads} (${((leads/totalContacts)*100).toFixed(0)}%)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(leads/totalContacts)*100}%; background: var(--accent-tertiary);"></div>
                            </div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Prospects</span>
                                <span style="font-weight: 700; color: var(--warning);">${prospects} (${((prospects/totalContacts)*100).toFixed(0)}%)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(prospects/totalContacts)*100}%; background: var(--warning);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showModal('Total Contacts Analysis', modalContent);
        }

        function showCustomerMetricsDrillDown() {
            const customers = appState.data.contacts.filter(c => c.status === 'Customer');
            const totalValue = customers.reduce((sum, c) => sum + c.value, 0);
            const avgValue = totalValue / customers.length;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Customers</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${customers.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Active accounts</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalValue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Combined customer value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Customer Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per customer</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Retention Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">94.2%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Customer retention</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Top Customers by Value</h3>
                    <div style="display: grid; gap: 12px;">
                        ${customers.sort((a, b) => b.value - a.value).slice(0, 5).map(c => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">${c.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${c.email}</div>
                                </div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--success);">$${c.value.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Customer Metrics Analysis', modalContent);
        }

        function showLeadMetricsDrillDown() {
            const leads = appState.data.contacts.filter(c => c.status === 'Lead');
            const totalValue = leads.reduce((sum, c) => sum + c.value, 0);
            const avgValue = totalValue / leads.length;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Leads</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${leads.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Qualified prospects</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Potential Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalValue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Combined lead value</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Lead Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per lead</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Qualification Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">72%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Lead quality score</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Top Leads by Potential Value</h3>
                    <div style="display: grid; gap: 12px;">
                        ${leads.sort((a, b) => b.value - a.value).slice(0, 5).map(c => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">${c.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${c.email}</div>
                                </div>
                                <div style="font-weight: 700; font-size: 18px; color: var(--accent-tertiary);">$${c.value.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Lead Metrics Analysis', modalContent);
        }

        function showConversionRateDrillDown() {
            const totalContacts = appState.data.contacts.length;
            const customers = appState.data.contacts.filter(c => c.status === 'Customer').length;
            const conversionRate = ((customers / totalContacts) * 100).toFixed(1);
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Conversion Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${conversionRate}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Lead to customer</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Converted</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${customers}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total customers</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Time to Convert</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">28 days</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Lead to customer</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Improvement</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+8.3%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">vs last quarter</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Conversion Funnel</h3>
                    <div style="display: grid; gap: 12px;">
                        ${[
                            {stage: 'Total Contacts', count: totalContacts, percent: 100},
                            {stage: 'Qualified Leads', count: Math.floor(totalContacts * 0.6), percent: 60},
                            {stage: 'Opportunities', count: Math.floor(totalContacts * 0.35), percent: 35},
                            {stage: 'Customers', count: customers, percent: parseFloat(conversionRate)}
                        ].map(item => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-weight: 600;">${item.stage}</span>
                                    <span style="font-weight: 700; color: var(--accent-primary);">${item.count} (${item.percent.toFixed(0)}%)</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${item.percent}%;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Conversion Rate Analysis', modalContent);
        }

        function showMarketingSpendDrillDown() {
            const totalSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const campaigns = appState.data.campaigns;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Marketing Spend</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalSpend.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">All campaigns</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Active Campaigns</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${campaigns.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Running campaigns</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Spend/Campaign</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${(totalSpend/campaigns.length).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per campaign</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Budget Utilization</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">87%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Of allocated budget</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Spend by Campaign</h3>
                    <div style="display: grid; gap: 12px;">
                        ${campaigns.sort((a, b) => b.spent - a.spent).map(c => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">${c.channel}</span>
                                    <span style="font-weight: 700; color: var(--accent-secondary);">$${c.spent.toLocaleString()}</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                    ${c.leads} leads â€¢ $${(c.spent/c.leads).toFixed(2)} CPL
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(c.spent/totalSpend)*100}%;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Marketing Spend Analysis', modalContent);
        }

        function showLeadsGeneratedDrillDown() {
            const totalLeads = appState.data.campaigns.reduce((sum, c) => sum + c.leads, 0);
            const campaigns = appState.data.campaigns;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Leads</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${totalLeads}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">From all campaigns</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Leads/Campaign</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${Math.floor(totalLeads/campaigns.length)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per campaign</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Growth</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">+22.4%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Lead generation</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Quality Score</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">8.2/10</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Lead quality rating</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Leads by Campaign</h3>
                    <div style="display: grid; gap: 12px;">
                        ${campaigns.sort((a, b) => b.leads - a.leads).map(c => `
                            <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">${c.channel}</span>
                                    <span style="font-weight: 700; color: var(--accent-tertiary);">${c.leads} leads</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                    $${c.spent.toLocaleString()} spend â€¢ $${(c.spent/c.leads).toFixed(2)} CPL
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(c.leads/totalLeads)*100}%; background: var(--accent-tertiary);"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            showModal('Leads Generated Analysis', modalContent);
        }

        function showCostPerLeadDrillDown() {
            const totalSpend = appState.data.campaigns.reduce((sum, c) => sum + c.spent, 0);
            const totalLeads = appState.data.campaigns.reduce((sum, c) => sum + c.leads, 0);
            const avgCPL = (totalSpend / totalLeads).toFixed(2);
            const campaigns = appState.data.campaigns;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Avg Cost Per Lead</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${avgCPL}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Across all campaigns</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Lowest CPL</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${Math.min(...campaigns.map(c => c.spent/c.leads)).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Best performing</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Highest CPL</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${Math.max(...campaigns.map(c => c.spent/c.leads)).toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Needs optimization</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">CPL Trend</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">-14.2%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Improving efficiency</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">CPL by Campaign</h3>
                    <div style="display: grid; gap: 12px;">
                        ${campaigns.sort((a, b) => (a.spent/a.leads) - (b.spent/b.leads)).map(c => {
                            const cpl = (c.spent/c.leads).toFixed(2);
                            const efficiency = parseFloat(cpl) < parseFloat(avgCPL) ? 'High' : 'Medium';
                            const color = parseFloat(cpl) < parseFloat(avgCPL) ? 'var(--success)' : 'var(--warning)';
                            return `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${c.channel}</span>
                                        <span style="font-weight: 700; color: ${color};">$${cpl} CPL</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                        ${c.leads} leads â€¢ $${c.spent.toLocaleString()} spend â€¢ ${efficiency} Efficiency
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min((parseFloat(cpl)/parseFloat(avgCPL))*50, 100)}%; background: ${color};"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            showModal('Cost Per Lead Analysis', modalContent);
        }

        // SUMMARY TILE DRILL-DOWN FUNCTIONS
        function showNewCustomersDrillDown() {
            const customers = appState.data.contacts.filter(c => c.status === 'Customer');
            const newCustomers = customers.slice(-5); // Last 5 customers
            const avgValue = customers.length > 0 ? customers.reduce((sum, c) => sum + c.value, 0) / customers.length : 0;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Customers</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${customers.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Active accounts</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">New This Month</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${newCustomers.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Recent additions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Growth Rate</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success); margin-bottom: 4px;">+12.4%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Month over month</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">$${avgValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per customer</div>
                        </div>
                    </div>
                </div>
                
                ${newCustomers.length > 0 ? `
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">Recent New Customers</h3>
                    <div style="display: grid; gap: 12px;">
                        ${newCustomers.reverse().map(c => `
                            <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--accent-primary); transition: all 0.3s ease;"
                                 onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                                 onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 6px;">${c.name}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">${c.email}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${c.phone || 'No phone'}</div>
                                    </div>
                                    <div style="font-weight: 800; font-size: 24px; color: var(--success);">$${c.value.toLocaleString()}</div>
                                </div>
                                <div style="padding-top: 12px; border-top: 1px solid var(--glass-border);">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">COMPANY:</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${c.company || 'N/A'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div style="text-align: center; padding: 40px; background: var(--bg-glass); border-radius: 12px; border: 1px dashed var(--glass-border);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ‘¥</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No New Customers</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Start adding customers to see them here.</div>
                </div>
                `}
            `;
            showModal('New Customers', modalContent);
        }

        function showInvoicesDueDrillDown() {
            const pendingInvoices = appState.data.invoices.filter(i => i.status === 'Pending' || i.status === 'pending');
            const totalDue = pendingInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const overdueInvoices = pendingInvoices.filter(i => new Date(i.dueDate || i.due_date) < new Date()).length;
            const avgInvoice = pendingInvoices.length > 0 ? totalDue / pendingInvoices.length : 0;
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Pending</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${pendingInvoices.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Awaiting payment</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Due</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalDue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Outstanding balance</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Overdue</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--danger); margin-bottom: 4px;">${overdueInvoices}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Past due date</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Average</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">$${avgInvoice.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Per invoice</div>
                        </div>
                    </div>
                </div>
                
                ${pendingInvoices.length > 0 ? `
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">Pending Invoices</h3>
                    <div style="display: grid; gap: 12px;">
                        ${pendingInvoices.sort((a, b) => new Date(a.dueDate || a.due_date) - new Date(b.dueDate || b.due_date)).map(inv => {
                            const dueDate = inv.dueDate || inv.due_date;
                            const isOverdue = new Date(dueDate) < new Date();
                            const daysUntilDue = Math.ceil((new Date(dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                            return `
                                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid ${isOverdue ? 'var(--danger)' : 'var(--accent-primary)'}; transition: all 0.3s ease;"
                                     onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                                     onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 6px;">${inv.customer}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Invoice #${inv.number}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                Issued: ${inv.issued} â€¢ Due: ${dueDate}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 800; font-size: 24px; color: ${isOverdue ? 'var(--danger)' : 'var(--accent-primary)'};">
                                                $${inv.amount.toLocaleString()}
                                            </div>
                                            ${isOverdue ? 
                                                `<div style="font-size: 11px; color: var(--danger); font-weight: 600; margin-top: 4px;">âš ï¸ ${Math.abs(daysUntilDue)} DAYS OVERDUE</div>` : 
                                                `<div style="font-size: 11px; color: var(--success); font-weight: 600; margin-top: 4px;">âœ“ Due in ${daysUntilDue} days</div>`
                                            }
                                        </div>
                                    </div>
                                    ${inv.items && inv.items.length > 0 ? `
                                        <div style="padding-top: 12px; border-top: 1px solid var(--glass-border);">
                                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">ITEMS:</div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">${inv.items.join(', ')}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : `
                <div style="text-align: center; padding: 40px; background: var(--bg-glass); border-radius: 12px; border: 1px dashed var(--glass-border);">
                    <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">All Caught Up!</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">No pending invoices at the moment.</div>
                </div>
                `}
            `;
            showModal('Invoices Due', modalContent);
        }

        function showRecurringPatternsDrillDown() {
            const patterns = detectRecurringPatterns();
            const totalOccurrences = patterns.reduce((sum, p) => sum + p.count, 0);
            const monthlyImpact = Math.abs(patterns.reduce((sum, p) => sum + (p.amount * p.count), 0));
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Patterns</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${patterns.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Recurring transactions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Confidence</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success); margin-bottom: 4px;">High</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">AI detection accuracy</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Occurrences</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 4px;">${totalOccurrences}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Repeated transactions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Monthly Impact</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--warning); margin-bottom: 4px;">$${monthlyImpact.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Estimated value</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 20px;">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ”„ SMART DETECTION</div>
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        AI has detected ${patterns.length} recurring transaction patterns in your data. These patterns can help you forecast expenses and automate accounting processes.
                    </div>
                </div>
                
                <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700; color: var(--text-primary);">Detected Recurring Patterns</h3>
                <div style="display: grid; gap: 12px;">
                    ${patterns.map(p => `
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid ${p.amount > 0 ? 'var(--success)' : 'var(--danger)'}; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                             onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 6px;">${p.description}</div>
                                    <div style="font-size: 13px; color: var(--text-muted);">${p.category}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 800; font-size: 24px; color: ${p.amount > 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${p.amount > 0 ? '+' : ''}$${Math.abs(p.amount).toLocaleString()}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${p.count} occurrences</div>
                                </div>
                            </div>
                            <div style="padding: 12px; background: rgba(110,231,183,0.1); border-radius: 8px; margin-top: 12px;">
                                <div style="font-size: 12px; color: var(--accent-primary);">
                                    ðŸ’¡ Suggested: Set up auto-categorization for this pattern
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            showModal('Recurring Transaction Patterns', modalContent);
        }

        function showRecentActivityDrillDown() {
            // Initialize recentActivity if it doesn't exist
            if (!appState.data.recentActivity) {
                appState.data.recentActivity = [];
            }
            
            const recentActivity = appState.data.recentActivity.slice(0, 25);
            
            const modalContent = `
                <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(110,231,183,0.05), rgba(124,92,255,0.05)); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">ðŸ“ ACTIVITY FEED</div>
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        Real-time tracking of all platform activities. Automatically updated when you create, edit, or delete any data.
                    </div>
                </div>
                ${recentActivity.length > 0 ? `
                <div style="display: grid; gap: 12px;">
                    ${recentActivity.map(activity => `
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border); display: flex; gap: 12px; align-items: start; transition: all 0.3s ease;"
                             onmouseover="this.style.transform='translateX(4px)'; this.style.borderColor='var(--accent-primary)'"
                             onmouseout="this.style.transform=''; this.style.borderColor='var(--glass-border)'">
                            <div style="font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); border-radius: 8px; flex-shrink: 0;">
                                ${activity.icon}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">${activity.type}</div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">${activity.description}</div>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap;">${activity.time}</div>
                                </div>
                                ${activity.details ? `<div style="font-size: 12px; color: var(--text-secondary);">${activity.details}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : `
                <div style="text-align: center; padding: 40px; background: var(--bg-glass); border-radius: 12px; border: 1px dashed var(--glass-border);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“­</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Recent Activity</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Activities will appear here as you work with the platform.</div>
                </div>
                `}
            `;
            showModal('Recent Activity', modalContent);
        }

        function showFinancialSummaryDrillDown() {
            const totalRevenue = appState.data.transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(appState.data.transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0));
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = ((netProfit / totalRevenue) * 100).toFixed(1);
            
            // Category breakdown
            const revenueByCategory = {};
            const expensesByCategory = {};
            
            appState.data.transactions.forEach(t => {
                if (t.amount > 0) {
                    revenueByCategory[t.category] = (revenueByCategory[t.category] || 0) + t.amount;
                } else {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + Math.abs(t.amount);
                }
            });
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Revenue</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalRevenue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">All income</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Expenses</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${totalExpenses.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">All costs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Net Profit</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${profitMargin}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Net margin</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 32px;">
                    <div>
                        <h3 style="margin-bottom: 16px; color: var(--success);">ðŸ’° Revenue by Category</h3>
                        <div style="display: grid; gap: 12px;">
                            ${Object.entries(revenueByCategory).sort((a, b) => b[1] - a[1]).map(([category, amount]) => `
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${category}</span>
                                        <span style="font-weight: 700; color: var(--success);">$${amount.toLocaleString()}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(amount/totalRevenue)*100}%; background: var(--success);"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 16px; color: var(--danger);">ðŸ’¸ Expenses by Category</h3>
                        <div style="display: grid; gap: 12px;">
                            ${Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]).map(([category, amount]) => `
                                <div style="padding: 12px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${category}</span>
                                        <span style="font-weight: 700; color: var(--danger);">$${amount.toLocaleString()}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(amount/totalExpenses)*100}%; background: var(--danger);"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            showModal('Financial Summary', modalContent);
        }

        function showBudgetSummaryDrillDown() {
            if (!appState.data.budgets) {
                initializeBudgets();
            }
            
            const budgets = appState.data.budgets;
            
            const calculateCategoryTotals = (categoryItems) => {
                const allocated = categoryItems.reduce((sum, item) => sum + (item.allocated || 0), 0);
                const spent = categoryItems.reduce((sum, item) => sum + (item.spent || 0), 0);
                const remaining = allocated - spent;
                const percentage = allocated > 0 ? (spent / allocated * 100) : 0;
                return { allocated, spent, remaining, percentage };
            };
            
            const operationalTotals = calculateCategoryTotals(budgets.operational);
            const marketingTotals = calculateCategoryTotals(budgets.marketing);
            const sgaTotals = calculateCategoryTotals(budgets.sga);
            
            const grandTotal = {
                allocated: operationalTotals.allocated + marketingTotals.allocated + sgaTotals.allocated,
                spent: operationalTotals.spent + marketingTotals.spent + sgaTotals.spent,
                remaining: operationalTotals.remaining + marketingTotals.remaining + sgaTotals.remaining
            };
            grandTotal.percentage = grandTotal.allocated > 0 ? (grandTotal.spent / grandTotal.allocated * 100) : 0;
            
            const getStatusColor = (percentage) => {
                if (percentage >= 90) return 'var(--danger)';
                if (percentage >= 75) return 'var(--warning)';
                return 'var(--success)';
            };
            
            const getStatusIcon = (percentage) => {
                if (percentage >= 90) return 'ðŸ”´';
                if (percentage >= 75) return 'ðŸŸ¡';
                return 'ðŸŸ¢';
            };
            
            const marketingHubSpent = (appState.data.marketingChannels || []).reduce((sum, channel) => sum + (channel.spent || 0), 0);
            const campaignSpent = (appState.data.campaigns || []).reduce((sum, campaign) => sum + (campaign.spent || 0), 0);
            const totalMarketingSpent = marketingHubSpent + campaignSpent;
            
            const transactionExpenses = Math.abs((appState.data.transactions || [])
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0));
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Allocated</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">$${grandTotal.allocated.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Budget allocated</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Spent</div>
                            <div style="font-size: 32px; font-weight: 800; color: ${getStatusColor(grandTotal.percentage)}; margin-bottom: 4px;">$${grandTotal.spent.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${grandTotal.percentage.toFixed(1)}% utilized</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Remaining</div>
                            <div style="font-size: 32px; font-weight: 800; color: ${grandTotal.remaining > 0 ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 4px;">$${grandTotal.remaining.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Available budget</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Status</div>
                            <div style="font-size: 32px; font-weight: 800; color: ${getStatusColor(grandTotal.percentage)}; margin-bottom: 4px;">${getStatusIcon(grandTotal.percentage)} ${grandTotal.percentage.toFixed(1)}%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Budget health</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 32px;">
                    <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 700; font-size: 16px;">ðŸ’» Operational</span>
                            <span style="font-size: 20px;">${getStatusIcon(operationalTotals.percentage)}</span>
                        </div>
                        <div style="font-size: 24px; font-weight: 800; color: ${getStatusColor(operationalTotals.percentage)}; margin-bottom: 4px;">${operationalTotals.percentage.toFixed(1)}%</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">$${operationalTotals.remaining.toLocaleString()} remaining</div>
                        <div class="progress-bar" style="margin-top: 12px;">
                            <div class="progress-fill" style="width: ${Math.min(operationalTotals.percentage, 100)}%; background: ${getStatusColor(operationalTotals.percentage)};"></div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 700; font-size: 16px;">ðŸ“¢ Marketing</span>
                            <span style="font-size: 20px;">${getStatusIcon(marketingTotals.percentage)}</span>
                        </div>
                        <div style="font-size: 24px; font-weight: 800; color: ${getStatusColor(marketingTotals.percentage)}; margin-bottom: 4px;">${marketingTotals.percentage.toFixed(1)}%</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">$${marketingTotals.remaining.toLocaleString()} remaining</div>
                        <div class="progress-bar" style="margin-top: 12px;">
                            <div class="progress-fill" style="width: ${Math.min(marketingTotals.percentage, 100)}%; background: ${getStatusColor(marketingTotals.percentage)};"></div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 700; font-size: 16px;">ðŸ¢ SG&A</span>
                            <span style="font-size: 20px;">${getStatusIcon(sgaTotals.percentage)}</span>
                        </div>
                        <div style="font-size: 24px; font-weight: 800; color: ${getStatusColor(sgaTotals.percentage)}; margin-bottom: 4px;">${sgaTotals.percentage.toFixed(1)}%</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">$${sgaTotals.remaining.toLocaleString()} remaining</div>
                        <div class="progress-bar" style="margin-top: 12px;">
                            <div class="progress-fill" style="width: ${Math.min(sgaTotals.percentage, 100)}%; background: ${getStatusColor(sgaTotals.percentage)};"></div>
                        </div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 24px; border-radius: 16px; border: 1px solid var(--accent-primary); margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent-primary); display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">ðŸ“Š</span>
                        Budget vs Actual Expenses
                    </h3>
                    
                    <div style="display: grid; gap: 16px;">
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Marketing Hub Expenses</span>
                                <span style="font-weight: 700; color: var(--accent-primary);">$${totalMarketingSpent.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                Campaigns + Channels: $${campaignSpent.toLocaleString()} + $${marketingHubSpent.toLocaleString()}
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                Budget Allocated: $${marketingTotals.allocated.toLocaleString()} 
                                ${totalMarketingSpent > marketingTotals.allocated ? 
                                    '<span style="color: var(--danger); font-weight: 700;">âš ï¸ Over budget by $' + (totalMarketingSpent - marketingTotals.allocated).toLocaleString() + '</span>' : 
                                    '<span style="color: var(--success);">âœ“ Within budget</span>'}
                            </div>
                        </div>
                        
                        <div style="padding: 16px; background: var(--bg-glass); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: 600;">Transaction Expenses</span>
                                <span style="font-weight: 700; color: var(--accent-primary);">$${transactionExpenses.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                All expense transactions from ledger
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                Total Budget: $${grandTotal.allocated.toLocaleString()}
                                ${transactionExpenses > grandTotal.allocated ? 
                                    '<span style="color: var(--danger); font-weight: 700;">âš ï¸ Over budget by $' + (transactionExpenses - grandTotal.allocated).toLocaleString() + '</span>' : 
                                    '<span style="color: var(--success);">âœ“ Within budget</span>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 20px;">
                    <button onclick="closeModal(); switchSection('budgets');" class="btn btn-primary" style="padding: 14px 32px; font-size: 16px;">
                        ðŸ’¼ View Full Budget Details
                    </button>
                </div>
            `;
            showModal('ðŸ’° Operational Budgets Overview', modalContent);
        }

        function showUpcomingEventsDrillDown() {
            const today = new Date();
            const upcomingEvents = appState.data.events.filter(e => {
                const eventDate = new Date(e.date);
                return eventDate >= today;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const thisWeek = upcomingEvents.filter(e => {
                const eventDate = new Date(e.date);
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil <= 7;
            });
            
            const nextWeek = upcomingEvents.filter(e => {
                const eventDate = new Date(e.date);
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                return daysUntil > 7 && daysUntil <= 14;
            });
            
            const modalContent = `
                <div style="background: var(--bg-glass); padding: 24px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">This Week</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${thisWeek.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Next 7 days</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Next Week</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${nextWeek.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Days 8-14</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Total Upcoming</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${upcomingEvents.length}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">All scheduled</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Types</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary); margin-bottom: 4px;">${new Set(upcomingEvents.map(e => e.type)).size}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Event categories</div>
                        </div>
                    </div>
                </div>
                
                ${thisWeek.length > 0 ? `
                    <div style="margin-top: 32px;">
                        <h3 style="margin-bottom: 16px;">ðŸ“… This Week</h3>
                        <div style="display: grid; gap: 12px;">
                            ${thisWeek.map(e => {
                                const eventDate = new Date(e.date);
                                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                                return `
                                    <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">${e.title}</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                                                    ðŸ“… ${e.date} â€¢ â° ${e.time}
                                                </div>
                                                ${e.location ? `<div style="font-size: 12px; color: var(--text-secondary);">ðŸ“ ${e.location}</div>` : ''}
                                            </div>
                                            <span class="badge badge-${daysUntil === 0 ? 'danger' : daysUntil <= 2 ? 'warning' : 'success'}">
                                                ${daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : `In ${daysUntil} days`}
                                            </span>
                                        </div>
                                        ${e.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">${e.description}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${nextWeek.length > 0 ? `
                    <div style="margin-top: 24px;">
                        <h3 style="margin-bottom: 16px;">ðŸ“† Next Week</h3>
                        <div style="display: grid; gap: 12px;">
                            ${nextWeek.slice(0, 5).map(e => `
                                <div style="padding: 16px; background: var(--bg-glass); border-radius: 8px; border: 1px solid var(--glass-border);">
                                    <div style="font-weight: 600; margin-bottom: 4px;">${e.title}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">
                                        ðŸ“… ${e.date} â€¢ â° ${e.time} ${e.location ? `â€¢ ðŸ“ ${e.location}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            showModal('Upcoming Events', modalContent);
        }

        // TEAM DIRECTORY DRILL-DOWN
        function showTeamMemberDetails(member) {
            const modalContent = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 64px; margin-bottom: 16px;">${member.avatar}</div>
                    <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 8px;">${member.name}</h2>
                    <div style="font-size: 16px; color: var(--accent-primary); font-weight: 600; margin-bottom: 20px;">${member.role}</div>
                </div>
                
                <div style="background: var(--bg-glass); border-radius: 12px; padding: 24px; border: 1px solid var(--glass-border);">
                    <h3 style="font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;">Contact Information</h3>
                    
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; width: 40px; text-align: center;">ðŸ“§</div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 2px;">Email</div>
                                <div style="font-size: 14px; font-weight: 500;">${member.email}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; width: 40px; text-align: center;">ðŸ“±</div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 2px;">Phone</div>
                                <div style="font-size: 14px; font-weight: 500;">${member.phone}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; width: 40px; text-align: center;">ðŸ’¼</div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 2px;">Department</div>
                                <div style="font-size: 14px; font-weight: 500;">${member.department || 'General'}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; width: 40px; text-align: center;">âš¡</div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 2px;">Status</div>
                                <span class="badge badge-success">${member.status}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-primary" onclick="window.location.href='mailto:${member.email}'; closeModal();">
                        ðŸ“§ Send Email
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='tel:${member.phone}'; closeModal();">
                        ðŸ“ž Call
                    </button>
                </div>
            `;
            showModal('Team Member Details', modalContent);
        }

        // UTILITY FUNCTIONS
        
        // INPUT MASKING & VALIDATION UTILITIES
        function formatPhoneNumber(value) {
            // Remove all non-numeric characters
            const phoneNumber = value.replace(/\D/g, '');
            
            // Format as +1 (555) 555-5555
            if (phoneNumber.length === 0) return '';
            if (phoneNumber.length <= 1) return phoneNumber;
            if (phoneNumber.length <= 4) return `(${phoneNumber.slice(1)})`;
            if (phoneNumber.length <= 7) return `(${phoneNumber.slice(1, 4)}) ${phoneNumber.slice(4)}`;
            return `(${phoneNumber.slice(1, 4)}) ${phoneNumber.slice(4, 7)}-${phoneNumber.slice(7, 11)}`;
        }
        
        function validateEmail(email) {
            // RFC 5322 compliant email regex
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return emailRegex.test(email);
        }
        
        
        
        
        function showModal(title, content, maxWidth = '900px') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            const modal = document.getElementById('modal');
            const modalBox = modal.querySelector('.modal');
            if (modalBox) {
                modalBox.style.maxWidth = maxWidth;
            }
            modal.classList.add('active');
            
            // Initialize input masks for any new inputs in the modal
            setTimeout(() => {
                initializeInputMasks();
            }, 0);
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showAddTransaction() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleTransactionSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <input type="text" id="txn_description" required 
                               placeholder="Enter transaction description"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Amount ($)</label>
                            <input type="number" id="txn_amount" required step="0.01"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="txn_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Expense">Expense</option>
                                <option value="Revenue">Revenue</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Sub-Category</label>
                        <select id="txn_category" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Revenue">Revenue</option>
                                <option value="Office Supplies">Office Supplies</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Legal Services">Legal Services</option>
                                <option value="Marketing Tech Stack">Marketing Tech Stack</option>
                                <option value="Contractor Services - Upwork & Fiverr">Contractor Services - Upwork & Fiverr</option>
                                <option value="Mail Postage Expense">Mail Postage Expense</option>
                                <option value="Marketing - Advertising">Marketing - Advertising</option>
                                <option value="Marketing - Promotional">Marketing - Promotional</option>
                                <option value="Memberships">Memberships</option>
                                <option value="Productivity Software">Productivity Software</option>
                                <option value="Office Furniture">Office Furniture</option>
                                <option value="Donation">Donation</option>
                                <option value="Permits & Licenses (Legal, Marketing, etc)">Permits & Licenses (Legal, Marketing, etc)</option>
                                <option value="Professional Services">Professional Services</option>
                                <option value="Accounting Tech Stack">Accounting Tech Stack</option>
                                <option value="Enterprise - Web & App">Enterprise - Web & App</option>
                                <option value="Business Equipment">Business Equipment</option>
                                <option value="Rent & Lease">Rent & Lease</option>
                                <option value="SGA">SGA</option>
                                <option value="Telecommunications">Telecommunications</option>
                                <option value="Co-working Membership">Co-working Membership</option>
                                <option value="Commercial Insurance">Commercial Insurance</option>
                                <option value="Cyber Insurance">Cyber Insurance</option>
                                <option value="General Liability Insurance">General Liability Insurance</option>
                                <option value="One Time Software Purchase">One Time Software Purchase</option>
                                <option value="AI Productivity & Creativity Tools">AI Productivity & Creativity Tools</option>
                                <option value="Team Communications">Team Communications</option>
                                <option value="Business Licenses">Business Licenses</option>
                                <option value="Customer Demo Scheduling API">Customer Demo Scheduling API</option>
                                <option value="Office Equipment">Office Equipment</option>
                                <option value="Professional Liability Insurance">Professional Liability Insurance</option>
                                <option value="Phone Services">Phone Services</option>
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Processing">Processing</option>
                                <option value="Software">Software</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Date</label>
                            <input type="date" id="txn_date" required value="${today}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Vendor (Optional)</label>
                            <input type="text" id="txn_vendor" 
                                   placeholder="Vendor name"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Transaction</button>
                </form>
            `;
            showModal('Add New Transaction', formHTML);
        }

        function handleTransactionSubmit(event) {
            event.preventDefault();
            const txnType = document.getElementById('txn_type').value;
            let amount = parseFloat(document.getElementById('txn_amount').value);
            
            // Make amount negative for expenses
            if ((txnType === 'Expense' || txnType === 'Expenses') && amount > 0) {
                amount = -amount;
            }
            
            const newTransaction = {
                id: Date.now(),
                date: document.getElementById('txn_date').value,
                description: document.getElementById('txn_description').value,
                amount: amount,
                type: txnType,
                category: document.getElementById('txn_category').value,
                vendor: document.getElementById('txn_vendor').value || '',
                recurring: false
            };
            appState.data.transactions.unshift(newTransaction);
            
            // Log activity
            addRecentActivity('transaction', `Added transaction: ${newTransaction.description}`, `${newTransaction.amount > 0 ? '+' : ''}$${Math.abs(newTransaction.amount).toLocaleString()} â€¢ ${newTransaction.category}`, 'info');
            
            saveData();
            closeModal();
            showToast('Transaction added successfully!');
            switchSection('transactions');
        }
        
        function editTransaction(id) {
            const txn = appState.data.transactions.find(t => t.id === id);
            if (!txn) return;
            
            // Determine type and absolute amount
            const txnType = txn.type || (txn.amount > 0 ? 'Revenue' : 'Expense');
            const absAmount = Math.abs(txn.amount);
            
            const formHTML = `
                <form onsubmit="handleTransactionEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <input type="text" id="txn_description" required value="${txn.description.replace(/"/g, '&quot;')}"
                               placeholder="Enter transaction description"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Amount ($)</label>
                            <input type="number" id="txn_amount" required step="0.01" value="${absAmount}"
                                   placeholder="0.00"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="txn_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Expense" ${txnType === 'Expense' || txnType === 'Expenses' ? 'selected' : ''}>Expense</option>
                                <option value="Revenue" ${txnType === 'Revenue' ? 'selected' : ''}>Revenue</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Sub-Category</label>
                        <select id="txn_category" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <option value="Office Supplies" ${txn.category === 'Office Supplies' ? 'selected' : ''}>Office Supplies</option>
                            <option value="Utilities" ${txn.category === 'Utilities' ? 'selected' : ''}>Utilities</option>
                                <option value="Legal Services" ${txn.category === 'Legal Services' ? 'selected' : ''}>Legal Services</option>
                                <option value="Marketing Tech Stack" ${txn.category === 'Marketing Tech Stack' ? 'selected' : ''}>Marketing Tech Stack</option>
                                <option value="Contractor Services - Upwork & Fiverr" ${txn.category === 'Contractor Services - Upwork & Fiverr' ? 'selected' : ''}>Contractor Services - Upwork & Fiverr</option>
                                <option value="Mail Postage Expense" ${txn.category === 'Mail Postage Expense' ? 'selected' : ''}>Mail Postage Expense</option>
                                <option value="Marketing - Advertising" ${txn.category === 'Marketing - Advertising' ? 'selected' : ''}>Marketing - Advertising</option>
                                <option value="Marketing - Promotional" ${txn.category === 'Marketing - Promotional' ? 'selected' : ''}>Marketing - Promotional</option>
                                <option value="Memberships" ${txn.category === 'Memberships' ? 'selected' : ''}>Memberships</option>
                                <option value="Productivity Software" ${txn.category === 'Productivity Software' ? 'selected' : ''}>Productivity Software</option>
                                <option value="Office Furniture" ${txn.category === 'Office Furniture' ? 'selected' : ''}>Office Furniture</option>
                                <option value="Donation" ${txn.category === 'Donation' ? 'selected' : ''}>Donation</option>
                                <option value="Permits & Licenses (Legal, Marketing, etc)" ${txn.category === 'Permits & Licenses (Legal, Marketing, etc)' ? 'selected' : ''}>Permits & Licenses (Legal, Marketing, etc)</option>
                                <option value="Professional Services" ${txn.category === 'Professional Services' ? 'selected' : ''}>Professional Services</option>
                                <option value="Accounting Tech Stack" ${txn.category === 'Accounting Tech Stack' ? 'selected' : ''}>Accounting Tech Stack</option>
                                <option value="Enterprise - Web & App" ${txn.category === 'Enterprise - Web & App' ? 'selected' : ''}>Enterprise - Web & App</option>
                                <option value="Business Equipment" ${txn.category === 'Business Equipment' ? 'selected' : ''}>Business Equipment</option>
                                <option value="Rent & Lease" ${txn.category === 'Rent & Lease' ? 'selected' : ''}>Rent & Lease</option>
                                <option value="SGA" ${txn.category === 'SGA' ? 'selected' : ''}>SGA</option>
                                <option value="Telecommunications" ${txn.category === 'Telecommunications' ? 'selected' : ''}>Telecommunications</option>
                                <option value="Co-working Membership" ${txn.category === 'Co-working Membership' ? 'selected' : ''}>Co-working Membership</option>
                                <option value="Commercial Insurance" ${txn.category === 'Commercial Insurance' ? 'selected' : ''}>Commercial Insurance</option>
                                <option value="Cyber Insurance" ${txn.category === 'Cyber Insurance' ? 'selected' : ''}>Cyber Insurance</option>
                                <option value="General Liability Insurance" ${txn.category === 'General Liability Insurance' ? 'selected' : ''}>General Liability Insurance</option>
                                <option value="One Time Software Purchase" ${txn.category === 'One Time Software Purchase' ? 'selected' : ''}>One Time Software Purchase</option>
                                <option value="AI Productivity & Creativity Tools" ${txn.category === 'AI Productivity & Creativity Tools' ? 'selected' : ''}>AI Productivity & Creativity Tools</option>
                                <option value="Team Communications" ${txn.category === 'Team Communications' ? 'selected' : ''}>Team Communications</option>
                                <option value="Business Licenses" ${txn.category === 'Business Licenses' ? 'selected' : ''}>Business Licenses</option>
                                <option value="Customer Demo Scheduling API" ${txn.category === 'Customer Demo Scheduling API' ? 'selected' : ''}>Customer Demo Scheduling API</option>
                                <option value="Office Equipment" ${txn.category === 'Office Equipment' ? 'selected' : ''}>Office Equipment</option>
                                <option value="Professional Liability Insurance" ${txn.category === 'Professional Liability Insurance' ? 'selected' : ''}>Professional Liability Insurance</option>
                                <option value="Phone Services" ${txn.category === 'Phone Services' ? 'selected' : ''}>Phone Services</option>
                                <option value="Infrastructure" ${txn.category === 'Infrastructure' ? 'selected' : ''}>Infrastructure</option>
                                <option value="Processing" ${txn.category === 'Processing' ? 'selected' : ''}>Processing</option>
                                <option value="Software" ${txn.category === 'Software' ? 'selected' : ''}>Software</option>
                                <option value="Marketing" ${txn.category === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Salary" ${txn.category === 'Salary' ? 'selected' : ''}>Salary</option>
                                <option value="Operations" ${txn.category === 'Operations' ? 'selected' : ''}>Operations</option>
                                <option value="Other" ${txn.category === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Vendor (Optional)</label>
                            <input type="text" id="txn_vendor" value="${txn.vendor || ''}"
                                   placeholder="Vendor name"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Transaction</button>
                </form>
            `;
            showModal('Edit Transaction', formHTML);
        }
        
        function handleTransactionEdit(event, id) {
            event.preventDefault();
            const txn = appState.data.transactions.find(t => t.id === id);
            if (!txn) return;
            
            const txnType = document.getElementById('txn_type').value;
            let amount = parseFloat(document.getElementById('txn_amount').value);
            
            // Make amount negative for expenses
            if ((txnType === 'Expense' || txnType === 'Expenses') && amount > 0) {
                amount = -amount;
            } else if (txnType === 'Revenue' && amount < 0) {
                amount = Math.abs(amount);
            }
            
            txn.date = document.getElementById('txn_date').value;
            txn.description = document.getElementById('txn_description').value;
            txn.amount = amount;
            txn.type = txnType;
            txn.category = document.getElementById('txn_category').value;
            txn.vendor = document.getElementById('txn_vendor').value || '';
            
            // Log activity
            addRecentActivity('transaction', `Updated transaction: ${txn.description}`, `${txn.amount > 0 ? '+' : ''}$${Math.abs(txn.amount).toLocaleString()} â€¢ ${txn.category}`, 'info');
            
            saveData();
            closeModal();
            showToast('Transaction updated successfully!');
            switchSection('transactions');
        }
        
        function deleteTransaction(id) {
            const txn = appState.data.transactions.find(t => t.id === id);
            if (confirm('Delete this transaction?')) {
                // Log activity before deletion
                if (txn) {
                    addRecentActivity('delete', `Deleted transaction: ${txn.description}`, `${txn.amount > 0 ? '+' : ''}$${Math.abs(txn.amount).toLocaleString()}`, 'info');
                }
                appState.data.transactions = appState.data.transactions.filter(t => t.id !== id);
                saveData();
                switchSection('transactions');
                showToast('Transaction deleted');
            }
        }

        // CSV IMPORT FOR TRANSACTIONS
        function showImportTransactionsCSV() {
            const formHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--accent-primary);">
                            ðŸ“‹ CSV File Format
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            Your CSV file should have the following columns:
                        </div>
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; margin-bottom: 12px;">
                            date, description, amount, category
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                            <strong>Example:</strong>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px;">
                            2025-11-01, Monthly Subscription Revenue, 12500, Revenue<br>
                            2025-11-05, Google Ads Spend, -2500, Marketing<br>
                            2025-11-10, AWS Infrastructure, -1250, Infrastructure
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
                            ðŸ’¡ <strong>Tip:</strong> Use negative amounts for expenses, positive for revenue
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 12px; color: var(--text-secondary); font-weight: 500;">
                            Select CSV File
                        </label>
                        <input type="file" id="csvFileInput" accept=".csv" 
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; cursor: pointer;">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="handleCSVImport()" style="flex: 1;">
                            ðŸ“¥ Import Transactions
                        </button>
                        <button class="btn-secondary" onclick="closeModal()" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            showModal('Import Transactions from CSV', formHTML);
        }

        function handleCSVImport() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                let importedCount = 0;
                let errorCount = 0;
                
                // Skip header row if it exists
                const startIndex = lines[0].toLowerCase().includes('date') ? 1 : 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV line (simple parsing, doesn't handle quotes)
                    const parts = line.split(',').map(p => p.trim());
                    
                    if (parts.length >= 4) {
                        try {
                            const transaction = {
                                id: Date.now() + i,
                                date: parts[0],
                                description: parts[1],
                                amount: parseFloat(parts[2]),
                                category: parts[3],
                                vendor: parts[4] || '',
                                recurring: false
                            };
                            
                            // Validate the transaction
                            if (transaction.date && transaction.description && !isNaN(transaction.amount)) {
                                appState.data.transactions.unshift(transaction);
                                importedCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (error) {
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                }
                
                saveData();
                closeModal();
                showToast(`âœ… Imported ${importedCount} transactions${errorCount > 0 ? ` (${errorCount} errors)` : ''}!`);
                switchSection('transactions');
            };
            
            reader.onerror = function() {
                showToast('Error reading CSV file');
            };
            
            reader.readAsText(file);
        }

        // REVENUE DRILLDOWN
        let revenueSortColumn = null;
        let revenueSortAscending = true;

        function drilldownRevenue() {
            const revenues = appState.data.transactions.filter(t => t.amount > 0);
            const totalRevenue = revenues.reduce((sum, t) => sum + t.amount, 0);
            
            renderSortableTransactionTable(
                'Total Revenue Breakdown', 
                revenues, 
                totalRevenue,
                'revenue'
            );
        }

        // EXPENSES DRILLDOWN
        let expenseSortColumn = null;
        let expenseSortAscending = true;

        function drilldownExpenses() {
            const expenses = appState.data.transactions.filter(t => t.amount < 0);
            const totalExpenses = Math.abs(expenses.reduce((sum, t) => sum + t.amount, 0));
            
            renderSortableTransactionTable(
                'Total Expenses Breakdown', 
                expenses, 
                totalExpenses,
                'expense'
            );
        }

        function renderSortableTransactionTable(title, transactions, total, type) {
            const content = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                         border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">TOTAL ${type.toUpperCase()}</div>
                        <div style="font-size: 36px; font-weight: 800; color: ${type === 'revenue' ? 'var(--accent-primary)' : 'var(--danger)'};">
                            $${total.toLocaleString()}
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                            ${transactions.length} transactions
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); border-radius: 12px; overflow: hidden;">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: var(--bg-secondary);">
                                    <tr>
                                        <th onclick="sortTransactionTable('${type}', 'date')" 
                                            style="padding: 12px; text-align: left; cursor: pointer; user-select: none; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                                            DATE â‡…
                                        </th>
                                        <th onclick="sortTransactionTable('${type}', 'description')" 
                                            style="padding: 12px; text-align: left; cursor: pointer; user-select: none; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                                            DESCRIPTION â‡…
                                        </th>
                                        <th onclick="sortTransactionTable('${type}', 'category')" 
                                            style="padding: 12px; text-align: left; cursor: pointer; user-select: none; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                                            CATEGORY â‡…
                                        </th>
                                        <th onclick="sortTransactionTable('${type}', 'amount')" 
                                            style="padding: 12px; text-align: right; cursor: pointer; user-select: none; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                                            AMOUNT â‡…
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="${type}TableBody">
                                    ${renderTransactionRows(transactions, type)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(title, content);
        }

        function renderTransactionRows(transactions, type) {
            return transactions.map(t => `
                <tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 12px; font-size: 13px;">${t.date}</td>
                    <td style="padding: 12px; font-size: 13px; font-weight: 600;">${t.description}</td>
                    <td style="padding: 12px;">
                        <span class="badge badge-info" style="font-size: 11px;">${t.category}</span>
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 14px; color: ${t.amount > 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${t.amount > 0 ? '+' : ''}$${Math.abs(t.amount).toLocaleString()}
                    </td>
                </tr>
            `).join('');
        }

        function sortTransactionTable(type, column) {
            let sortColumn, sortAscending;
            
            if (type === 'revenue') {
                if (revenueSortColumn === column) {
                    revenueSortAscending = !revenueSortAscending;
                } else {
                    revenueSortColumn = column;
                    revenueSortAscending = true;
                }
                sortColumn = revenueSortColumn;
                sortAscending = revenueSortAscending;
            } else {
                if (expenseSortColumn === column) {
                    expenseSortAscending = !expenseSortAscending;
                } else {
                    expenseSortColumn = column;
                    expenseSortAscending = true;
                }
                sortColumn = expenseSortColumn;
                sortAscending = expenseSortAscending;
            }
            
            const transactions = type === 'revenue' 
                ? appState.data.transactions.filter(t => t.amount > 0)
                : appState.data.transactions.filter(t => t.amount < 0);
            
            transactions.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                
                if (sortColumn === 'amount') {
                    valA = Math.abs(valA);
                    valB = Math.abs(valB);
                }
                
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                if (valA < valB) return sortAscending ? -1 : 1;
                if (valA > valB) return sortAscending ? 1 : -1;
                return 0;
            });
            
            const tbody = document.getElementById(`${type}TableBody`);
            if (tbody) {
                tbody.innerHTML = renderTransactionRows(transactions, type);
            }
        }

        // CUSTOMER CRUD
        function showAddCustomer() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleCustomerSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customer Name</label>
                        <input type="text" id="cust_name" required placeholder="Company Name"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                        <input type="email" id="cust_email" required placeholder="contact@company.com"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Plan</label>
                            <select id="cust_plan" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Starter">Starter - $2.99/mo</option>
                                <option value="Growth">Growth - $9.99/mo</option>
                                <option value="Growth Suite">Growth Suite - $24.99/mo</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="cust_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Churned">Churned</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Join Date</label>
                        <input type="date" id="cust_joinDate" required value="${today}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Customer</button>
                </form>
            `;
            showModal('Add New Customer', formHTML);
        }

        function handleCustomerSubmit(event) {
            event.preventDefault();
            const plan = document.getElementById('cust_plan').value;
            const mrrMap = { 'Starter': 299, 'Growth': 999, 'Growth Suite': 2499 };
            const mrr = mrrMap[plan];
            
            const newCustomer = {
                id: Date.now(),
                name: document.getElementById('cust_name').value,
                email: document.getElementById('cust_email').value,
                plan: plan,
                mrr: mrr,
                joinDate: document.getElementById('cust_joinDate').value,
                status: document.getElementById('cust_status').value,
                ltv: mrr * 12
            };
            appState.data.customers.push(newCustomer);
            saveData();
            closeModal();
            showToast('Customer added successfully!');
            switchSection('customers');
        }

        function editCustomer(id) {
            const cust = appState.data.customers.find(c => c.id === id);
            if (!cust) return;

            const formHTML = `
                <form onsubmit="handleCustomerEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customer Name</label>
                        <input type="text" id="cust_name" required value="${cust.name}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                        <input type="email" id="cust_email" required value="${cust.email}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Plan</label>
                            <select id="cust_plan" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Starter" ${cust.plan === 'Starter' ? 'selected' : ''}>Starter - $2.99/mo</option>
                                <option value="Growth" ${cust.plan === 'Growth' ? 'selected' : ''}>Growth - $9.99/mo</option>
                                <option value="Growth Suite" ${cust.plan === 'Growth Suite' ? 'selected' : ''}>Growth Suite - $24.99/mo</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="cust_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active" ${cust.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Churned" ${cust.status === 'Churned' ? 'selected' : ''}>Churned</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Join Date</label>
                        <input type="date" id="cust_joinDate" required value="${cust.joinDate}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Customer</button>
                </form>
            `;
            showModal('Edit Customer', formHTML);
        }

        function handleCustomerEdit(event, id) {
            event.preventDefault();
            const cust = appState.data.customers.find(c => c.id === id);
            if (!cust) return;

            const plan = document.getElementById('cust_plan').value;
            const mrrMap = { 'Starter': 299, 'Growth': 999, 'Growth Suite': 2499 };

            cust.name = document.getElementById('cust_name').value;
            cust.email = document.getElementById('cust_email').value;
            cust.plan = plan;
            cust.mrr = mrrMap[plan];
            cust.status = document.getElementById('cust_status').value;
            cust.joinDate = document.getElementById('cust_joinDate').value;
            cust.ltv = cust.mrr * 12;

            saveData();
            closeModal();
            showToast('Customer updated successfully!');
            switchSection('customers');
        }

        function deleteCustomer(id) {
            if (confirm('Delete this customer?')) {
                appState.data.customers = appState.data.customers.filter(c => c.id !== id);
                saveData();
                switchSection('customers');
                showToast('Customer deleted');
            }
        }

        // CAMPAIGN CRUD


        function editCampaign(id) {
            const camp = appState.data.campaigns.find(c => c.id === id);
            if (!camp) return;

            const formHTML = `
                <form onsubmit="handleCampaignEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Campaign Name</label>
                        <input type="text" id="camp_name" required value="${camp.name}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Channel</label>
                            <select id="camp_channel" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Email" ${camp.channel === 'Email' ? 'selected' : ''}>Email</option>
                                <option value="Social Media" ${camp.channel === 'Social Media' ? 'selected' : ''}>Social Media</option>
                                <option value="Google Ads" ${camp.channel === 'Google Ads' ? 'selected' : ''}>Google Ads</option>
                                <option value="Content" ${camp.channel === 'Content' ? 'selected' : ''}>Content</option>
                                <option value="Referral" ${camp.channel === 'Referral' ? 'selected' : ''}>Referral</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="camp_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active" ${camp.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Paused" ${camp.status === 'Paused' ? 'selected' : ''}>Paused</option>
                                <option value="Completed" ${camp.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Budget ($)</label>
                            <input type="number" id="camp_budget" required value="${camp.budget}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Spent ($)</label>
                            <input type="number" id="camp_spent" required value="${camp.spent}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Leads</label>
                            <input type="number" id="camp_leads" required value="${camp.leads}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Conversions</label>
                            <input type="number" id="camp_conversions" required value="${camp.conversions}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Start Date</label>
                            <input type="date" id="camp_startDate" required value="${camp.startDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">End Date</label>
                            <input type="date" id="camp_endDate" required value="${camp.endDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Campaign</button>
                </form>
            `;
            showModal('Edit Campaign', formHTML);
        }

        function handleCampaignEdit(event, id) {
            event.preventDefault();
            const camp = appState.data.campaigns.find(c => c.id === id);
            if (!camp) return;

            camp.name = document.getElementById('camp_name').value;
            camp.channel = document.getElementById('camp_channel').value;
            camp.budget = parseInt(document.getElementById('camp_budget').value);
            camp.spent = parseInt(document.getElementById('camp_spent').value);
            camp.leads = parseInt(document.getElementById('camp_leads').value);
            camp.conversions = parseInt(document.getElementById('camp_conversions').value);
            camp.status = document.getElementById('camp_status').value;
            camp.startDate = document.getElementById('camp_startDate').value;
            camp.endDate = document.getElementById('camp_endDate').value;

            saveData();
            closeModal();
            showToast('Campaign updated successfully!');
            switchSection('campaigns');
        }

        // TEAM MEMBER CRUD
        function showAddTeamMember() {
            const today = new Date().toISOString().split('T')[0];
            
            const formHTML = `
                <form onsubmit="handleTeamMemberSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Full Name</label>
                        <input type="text" id="team_name" required placeholder="John Doe"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                        <input type="email" id="team_email" required placeholder="john@virely.com"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Role</label>
                            <input type="text" id="team_role" required placeholder="Software Engineer"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Department</label>
                            <select id="team_department" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Engineering">Engineering</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Sales">Sales</option>
                                <option value="Product">Product</option>
                                <option value="Executive">Executive</option>
                                <option value="Operations">Operations</option>
                                <option value="Finance">Finance</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Join Date</label>
                            <input type="date" id="team_joinDate" required value="${today}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="team_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Team Member</button>
                </form>
            `;
            showModal('Add Team Member', formHTML);
        }

        function handleTeamMemberSubmit(event) {
            event.preventDefault();
            const newMember = {
                id: Date.now(),
                name: document.getElementById('team_name').value,
                email: document.getElementById('team_email').value,
                role: document.getElementById('team_role').value,
                department: document.getElementById('team_department').value,
                joinDate: document.getElementById('team_joinDate').value,
                status: document.getElementById('team_status').value
            };
            appState.data.team.push(newMember);
            saveData();
            closeModal();
            showToast('Team member added successfully!');
            switchSection('team');
        }

        function editTeamMember(id) {
            const member = appState.data.team.find(t => t.id === id);
            if (!member) return;

            const formHTML = `
                <form onsubmit="handleTeamMemberEdit(event, ${id})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Full Name</label>
                        <input type="text" id="team_name" required value="${member.name}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                        <input type="email" id="team_email" required value="${member.email}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Role</label>
                            <input type="text" id="team_role" required value="${member.role}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Department</label>
                            <select id="team_department" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Engineering" ${member.department === 'Engineering' ? 'selected' : ''}>Engineering</option>
                                <option value="Marketing" ${member.department === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Sales" ${member.department === 'Sales' ? 'selected' : ''}>Sales</option>
                                <option value="Product" ${member.department === 'Product' ? 'selected' : ''}>Product</option>
                                <option value="Executive" ${member.department === 'Executive' ? 'selected' : ''}>Executive</option>
                                <option value="Operations" ${member.department === 'Operations' ? 'selected' : ''}>Operations</option>
                                <option value="Finance" ${member.department === 'Finance' ? 'selected' : ''}>Finance</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Join Date</label>
                            <input type="date" id="team_joinDate" required value="${member.joinDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="team_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active" ${member.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${member.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Team Member</button>
                </form>
            `;
            showModal('Edit Team Member', formHTML);
        }

        function handleTeamMemberEdit(event, id) {
            event.preventDefault();
            const member = appState.data.team.find(t => t.id === id);
            if (!member) return;

            member.name = document.getElementById('team_name').value;
            member.email = document.getElementById('team_email').value;
            member.role = document.getElementById('team_role').value;
            member.department = document.getElementById('team_department').value;
            member.joinDate = document.getElementById('team_joinDate').value;
            member.status = document.getElementById('team_status').value;

            addRecentActivity('team_updated', `Updated team member: ${member.name} (${member.role})`, 'info');
            saveData();
            closeModal();
            showToast('Team member updated successfully!');
            switchSection('team');
        }

        function deleteTeamMember(id) {
            if (confirm('Delete this team member?')) {
                const member = appState.data.team.find(t => t.id === id);
                const memberName = member ? member.name : 'Unknown';
                appState.data.team = appState.data.team.filter(t => t.id !== id);
                addRecentActivity('team_deleted', `Deleted team member: ${memberName}`, 'danger');
                saveData();
                switchSection('team');
                showToast('Team member deleted');
            }
        }

        function editTeamMemberField(memberId, fieldName, currentValue) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const fieldLabels = {
                email: 'Email',
                phone: 'Phone',
                location: 'Location',
                timezone: 'Time Zone',
                hireDate: 'Hire Date',
                salary: 'Salary',
                status: 'Status',
                yearsExperience: 'Years of Experience',
                previousCompany: 'Previous Company',
                skills: 'Skills (comma-separated)',
                certifications: 'Certifications (one per line)',
                languages: 'Languages (comma-separated)',
                performance: 'Performance Score',
                tasksCompleted: 'Tasks Completed',
                projects: 'Projects (one per line)',
                linkedin: 'LinkedIn Profile',
                github: 'GitHub Profile'
            };
            
            const label = fieldLabels[fieldName] || fieldName;
            
            // Determine input type based on field
            let inputHTML = '';
            if (fieldName === 'certifications' || fieldName === 'projects') {
                inputHTML = `<textarea id="field_value" required style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 120px; resize: vertical;">${currentValue}</textarea>`;
            } else if (fieldName === 'status') {
                inputHTML = `
                    <select id="field_value" required style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        <option value="Active" ${currentValue === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="On Leave" ${currentValue === 'On Leave' ? 'selected' : ''}>On Leave</option>
                        <option value="Remote" ${currentValue === 'Remote' ? 'selected' : ''}>Remote</option>
                        <option value="Contract" ${currentValue === 'Contract' ? 'selected' : ''}>Contract</option>
                        <option value="Part-Time" ${currentValue === 'Part-Time' ? 'selected' : ''}>Part-Time</option>
                    </select>`;
            } else if (fieldName === 'salary' || fieldName === 'performance' || fieldName === 'tasksCompleted' || fieldName === 'yearsExperience') {
                inputHTML = `<input type="number" id="field_value" required value="${currentValue}" style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else if (fieldName === 'hireDate') {
                inputHTML = `<input type="date" id="field_value" required value="${currentValue}" style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else if (fieldName === 'email') {
                inputHTML = `<input type="email" id="field_value" required value="${currentValue}" style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            } else {
                inputHTML = `<input type="text" id="field_value" required value="${currentValue}" style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 14px;">`;
            }
            
            const formHTML = `
                <form onsubmit="handleTeamMemberFieldEdit(event, ${memberId}, '${fieldName}')" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">${label}</label>
                        ${inputHTML}
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 8px;">Update ${label}</button>
                </form>
            `;
            
            showModal(`Edit ${label} - ${member.name}`, formHTML);
        }
        
        function handleTeamMemberFieldEdit(event, memberId, fieldName) {
            event.preventDefault();
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const value = document.getElementById('field_value').value;
            
            // Process value based on field type
            if (fieldName === 'skills' || fieldName === 'languages') {
                member[fieldName] = value.split(',').map(item => item.trim()).filter(item => item);
            } else if (fieldName === 'certifications' || fieldName === 'projects') {
                member[fieldName] = value.split('\n').map(item => item.trim()).filter(item => item);
            } else if (fieldName === 'salary' || fieldName === 'performance' || fieldName === 'tasksCompleted' || fieldName === 'yearsExperience') {
                member[fieldName] = parseFloat(value);
            } else {
                member[fieldName] = value;
            }
            
            addRecentActivity('team_updated', `Updated ${fieldName} for ${member.name}`, 'info');
            saveData();
            closeModal();
            showToast(`${fieldName} updated successfully!`);
            
            // Refresh the profile view
            setTimeout(() => viewTeamMemberProfile(memberId), 100);
        }

        function handleAdd() {
            const sections = {
                transactions: showAddTransaction,
                customers: showAddCustomer,
                campaigns: showAddCampaign,
                team: showAddTeamMember,
                divisions: showAddDivision,
                crm: showAddContact,
                deals: showAddDeal,
                vendors: showAddVendor,
                tasks: showAddTask,
                invoices: showAddInvoice,
                alerts: showAddAlert,
                notes: showAddNote,
                calendar: showAddEvent,
                'strategic-planning': showAddBusinessUnit,
            };
            
            if (sections[appState.currentSection]) {
                sections[appState.currentSection]();
            } else {
                showToast('Add feature not available for this section');
            }
        }

        // DIVISION CRUD


        // CONTACT/CRM CRUD
        function showAddContact() {
            const formHTML = `
                <form onsubmit="handleContactSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">First Name</label>
                            <input type="text" id="contact_firstName" required placeholder="John"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Last Name</label>
                            <input type="text" id="contact_lastName" required placeholder="Doe"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Company</label>
                        <input type="text" id="contact_company" required placeholder="Acme Corp"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email</label>
                            <input type="email" id="contact_email" required placeholder="john@acme.com"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Phone</label>
                            <input type="tel" id="contact_phone" placeholder="+1 555-0100"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="contact_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Lead">Lead</option>
                                <option value="Customer">Customer</option>
                                <option value="Partner">Partner</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="contact_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Contact</button>
                </form>
            `;
            showModal('Add New Contact', formHTML);
        }

        function handleContactSubmit(event) {
            event.preventDefault();
            const newContact = {
                id: Date.now(),
                name: `${document.getElementById('contact_firstName').value} ${document.getElementById('contact_lastName').value}`,
                firstName: document.getElementById('contact_firstName').value,
                lastName: document.getElementById('contact_lastName').value,
                company: document.getElementById('contact_company').value,
                email: document.getElementById('contact_email').value,
                phone: document.getElementById('contact_phone').value || '',
                type: document.getElementById('contact_type').value,
                status: document.getElementById('contact_status').value,
                value: 0,
                source: 'Direct',
                lastContact: new Date().toISOString().split('T')[0],
                created: new Date().toISOString().split('T')[0],
                // Comprehensive profile fields
                title: '',
                address: '',
                website: '',
                linkedin: '',
                twitter: '',
                birthday: '',
                industry: '',
                tags: [],
                notes: '',
                timezone: '',
                preferredContact: 'Email'
            };
            appState.data.contacts.push(newContact);
            
            // Log activity
            addRecentActivity('contact', `Added contact: ${newContact.name}`, `${newContact.company} â€¢ ${newContact.email}`, 'info');
            
            if (saveData()) {
                closeModal();
                showToast('âœ… Contact added successfully!', 'success');
                switchSection('crm');
            } else {
                showToast('âŒ Error saving contact. Please try again.', 'error');
            }
        }



        // DEAL CRUD
        function showAddDeal() {
            const formHTML = `
                <form onsubmit="handleDealSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Deal Name</label>
                        <input type="text" id="deal_name" required placeholder="Enterprise License - Acme Corp"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Company</label>
                        <input type="text" id="deal_company" required placeholder="Acme Corp"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Value ($)</label>
                            <input type="number" id="deal_value" required placeholder="25000"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Probability (%)</label>
                            <input type="number" id="deal_probability" required min="0" max="100" placeholder="75"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Stage</label>
                            <select id="deal_stage" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Prospecting">Prospecting</option>
                                <option value="Qualification">Qualification</option>
                                <option value="Proposal">Proposal</option>
                                <option value="Negotiation">Negotiation</option>
                                <option value="Closed Won">Closed Won</option>
                                <option value="Closed Lost">Closed Lost</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Close Date</label>
                            <input type="date" id="deal_closeDate" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Deal</button>
                </form>
            `;
            showModal('Add New Deal', formHTML);
        }

        function handleDealSubmit(event) {
            event.preventDefault();
            const newDeal = {
                id: Date.now(),
                name: document.getElementById('deal_name').value,
                company: document.getElementById('deal_company').value,
                value: parseInt(document.getElementById('deal_value').value),
                probability: parseInt(document.getElementById('deal_probability').value),
                stage: document.getElementById('deal_stage').value,
                closeDate: document.getElementById('deal_closeDate').value,
                created: new Date().toISOString().split('T')[0]
            };
            appState.data.deals.push(newDeal);
            saveData();
            closeModal();
            showToast('Deal added successfully!');
            switchSection('deals');
        }

        // VENDOR CRUD
        function showAddVendor() {
            const formHTML = `
                <form onsubmit="handleVendorSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Vendor Name</label>
                        <input type="text" id="vendor_name" required placeholder="AWS"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="vendor_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Software">Software</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Payment">Payment Processing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Cost ($)</label>
                            <input type="number" id="vendor_cost" required placeholder="1250"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Contact Email</label>
                            <input type="email" id="vendor_contact" required placeholder="support@vendor.com"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Contract Type</label>
                            <select id="vendor_contract" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Monthly">Monthly</option>
                                <option value="Annual">Annual</option>
                                <option value="Multi-Year">Multi-Year</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Renewal Date</label>
                            <input type="date" id="vendor_renewal" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="vendor_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Vendor</button>
                </form>
            `;
            showModal('Add New Vendor', formHTML);
        }

        function handleVendorSubmit(event) {
            event.preventDefault();
            const newVendor = {
                id: Date.now(),
                name: document.getElementById('vendor_name').value,
                type: document.getElementById('vendor_type').value,
                contact: document.getElementById('vendor_contact').value,
                cost: parseInt(document.getElementById('vendor_cost').value),
                contract: document.getElementById('vendor_contract').value,
                renewal: document.getElementById('vendor_renewal').value,
                status: document.getElementById('vendor_status').value
            };
            appState.data.vendors.push(newVendor);
            saveData();
            closeModal();
            showToast('Vendor added successfully!');
            switchSection('vendors');
        }

        function editVendor(vendorId) {
            const vendor = appState.data.vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            const formHTML = `
                <form onsubmit="handleVendorUpdate(event, ${vendorId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Vendor Name</label>
                        <input type="text" id="vendor_name" value="${vendor.name}" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="vendor_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Infrastructure" ${vendor.type === 'Infrastructure' ? 'selected' : ''}>Infrastructure</option>
                                <option value="Software" ${vendor.type === 'Software' ? 'selected' : ''}>Software</option>
                                <option value="Marketing" ${vendor.type === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Payment" ${vendor.type === 'Payment' || vendor.type === 'Payments' ? 'selected' : ''}>Payment Processing</option>
                                <option value="Other" ${vendor.type === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Monthly Cost ($)</label>
                            <input type="number" id="vendor_cost" value="${vendor.cost}" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Contact Email</label>
                            <input type="email" id="vendor_contact" value="${vendor.contact}" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Contract Type</label>
                            <select id="vendor_contract" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Monthly" ${vendor.contract === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                <option value="Annual" ${vendor.contract === 'Annual' ? 'selected' : ''}>Annual</option>
                                <option value="Multi-Year" ${vendor.contract === 'Multi-Year' ? 'selected' : ''}>Multi-Year</option>
                                <option value="Transaction %" ${vendor.contract === 'Transaction %' ? 'selected' : ''}>Transaction %</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Renewal Date</label>
                            <input type="date" id="vendor_renewal" value="${vendor.renewal}" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="vendor_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active" ${vendor.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${vendor.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Vendor</button>
                </form>
            `;
            showModal('Edit Vendor', formHTML);
        }

        function handleVendorUpdate(event, vendorId) {
            event.preventDefault();
            const vendorIndex = appState.data.vendors.findIndex(v => v.id === vendorId);
            if (vendorIndex !== -1) {
                appState.data.vendors[vendorIndex] = {
                    ...appState.data.vendors[vendorIndex],
                    name: document.getElementById('vendor_name').value,
                    type: document.getElementById('vendor_type').value,
                    contact: document.getElementById('vendor_contact').value,
                    cost: parseInt(document.getElementById('vendor_cost').value),
                    contract: document.getElementById('vendor_contract').value,
                    renewal: document.getElementById('vendor_renewal').value,
                    status: document.getElementById('vendor_status').value
                };
                saveData();
                closeModal();
                showToast('Vendor updated successfully!');
                switchSection('vendors');
            }
        }

        function deleteVendor(vendorId) {
            if (confirm('Are you sure you want to delete this vendor?')) {
                appState.data.vendors = appState.data.vendors.filter(v => v.id !== vendorId);
                saveData();
                showToast('Vendor deleted successfully!');
                switchSection('vendors');
            }
        }

        // TASK CRUD
        function showAddTask() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleTaskSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Task Title</label>
                        <input type="text" id="task_title" required placeholder="Complete Q4 report"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="task_description" placeholder="Task details..."
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 80px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Priority</label>
                            <select id="task_priority" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="task_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Due Date</label>
                            <input type="date" id="task_dueDate" required value="${today}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Task</button>
                </form>
            `;
            showModal('Add New Task', formHTML);
        }

        function handleTaskSubmit(event) {
            event.preventDefault();
            const newTask = {
                id: Date.now(),
                title: document.getElementById('task_title').value,
                description: document.getElementById('task_description').value || '',
                priority: document.getElementById('task_priority').value,
                status: document.getElementById('task_status').value,
                dueDate: document.getElementById('task_dueDate').value,
                created: new Date().toISOString().split('T')[0]
            };
            appState.data.tasks.push(newTask);
            
            // Log activity
            addRecentActivity('task', `Created task: ${newTask.title}`, `${newTask.priority} priority â€¢ Due: ${newTask.dueDate}`, 'info');
            
            saveData();
            closeModal();
            showToast('Task added successfully!');
            switchSection('tasks');
        }

        // INVOICE CRUD
        function showAddInvoice() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleInvoiceSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customer Name</label>
                        <input type="text" id="invoice_customer" required placeholder="Acme Corp"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Amount ($)</label>
                            <input type="number" id="invoice_amount" required placeholder="5000"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="invoice_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Draft">Draft</option>
                                <option value="Sent">Sent</option>
                                <option value="Paid">Paid</option>
                                <option value="Overdue">Overdue</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Issue Date</label>
                            <input type="date" id="invoice_issueDate" required value="${today}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Due Date</label>
                            <input type="date" id="invoice_dueDate" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Create Invoice</button>
                </form>
            `;
            showModal('Create New Invoice', formHTML);
        }

        function handleInvoiceSubmit(event) {
            event.preventDefault();
            const newInvoice = {
                id: Date.now(),
                number: `INV-${Date.now().toString().slice(-6)}`,
                customer: document.getElementById('invoice_customer').value,
                amount: parseInt(document.getElementById('invoice_amount').value),
                status: document.getElementById('invoice_status').value,
                issueDate: document.getElementById('invoice_issueDate').value,
                dueDate: document.getElementById('invoice_dueDate').value
            };
            appState.data.invoices.push(newInvoice);
            saveData();
            closeModal();
            showToast('Invoice created successfully!');
            switchSection('invoices');
        }

        function editInvoice(invoiceId) {
            const invoice = appState.data.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;
            
            const formHTML = `
                <form onsubmit="handleInvoiceUpdate(event, ${invoiceId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Invoice Number</label>
                        <input type="text" id="invoice_number" required value="${invoice.number}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Customer Name</label>
                        <input type="text" id="invoice_customer" required value="${invoice.customer}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Amount ($)</label>
                            <input type="number" id="invoice_amount" required value="${invoice.amount}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="invoice_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Pending" ${invoice.status === 'Pending' || invoice.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="Paid" ${invoice.status === 'Paid' ? 'selected' : ''}>Paid</option>
                                <option value="Overdue" ${invoice.status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Issue Date</label>
                            <input type="date" id="invoice_issueDate" required value="${invoice.issueDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Due Date</label>
                            <input type="date" id="invoice_dueDate" required value="${invoice.dueDate}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Invoice</button>
                </form>
            `;
            showModal('Edit Invoice', formHTML);
        }

        function handleInvoiceUpdate(event, invoiceId) {
            event.preventDefault();
            const invoiceIndex = appState.data.invoices.findIndex(i => i.id === invoiceId);
            if (invoiceIndex !== -1) {
                appState.data.invoices[invoiceIndex] = {
                    ...appState.data.invoices[invoiceIndex],
                    number: document.getElementById('invoice_number').value,
                    customer: document.getElementById('invoice_customer').value,
                    amount: parseInt(document.getElementById('invoice_amount').value),
                    status: document.getElementById('invoice_status').value,
                    issueDate: document.getElementById('invoice_issueDate').value,
                    dueDate: document.getElementById('invoice_dueDate').value
                };
                saveData();
                closeModal();
                showToast('Invoice updated successfully!');
                switchSection('invoices');
            }
        }

        function deleteInvoice(invoiceId) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                appState.data.invoices = appState.data.invoices.filter(i => i.id !== invoiceId);
                saveData();
                showToast('Invoice deleted successfully!');
                switchSection('invoices');
            }
        }

        // ALERT CRUD
        function showAddAlert() {
            const formHTML = `
                <form onsubmit="handleAlertSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Alert Title</label>
                        <input type="text" id="alert_title" required placeholder="Contract Renewal Due"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Message</label>
                        <textarea id="alert_message" required placeholder="Alert details..."
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 80px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="alert_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Revenue">Revenue</option>
                                <option value="Customer">Customer</option>
                                <option value="System">System</option>
                                <option value="Financial">Financial</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Priority</label>
                            <select id="alert_priority" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Create Alert</button>
                </form>
            `;
            showModal('Create New Alert', formHTML);
        }

        function handleAlertSubmit(event) {
            event.preventDefault();
            const newAlert = {
                id: Date.now(),
                title: document.getElementById('alert_title').value,
                message: document.getElementById('alert_message').value,
                type: document.getElementById('alert_type').value,
                priority: document.getElementById('alert_priority').value,
                enabled: true,
                read: false,
                date: new Date().toLocaleDateString(),
                status: 'Active',
                created: new Date().toISOString()
            };
            appState.data.alerts.push(newAlert);
            saveData();
            closeModal();
            showToast('Alert created successfully!');
            switchSection('alerts');
        }

        function editAlert(alertId) {
            const alert = appState.data.alerts.find(a => a.id === alertId);
            if (!alert) return;
            
            const formHTML = `
                <form onsubmit="handleAlertUpdate(event, ${alertId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Alert Title</label>
                        <input type="text" id="alert_title" required value="${alert.title}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Message</label>
                        <textarea id="alert_message" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 100px;">${alert.message}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="alert_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="info" ${alert.type === 'info' ? 'selected' : ''}>Info</option>
                                <option value="success" ${alert.type === 'success' ? 'selected' : ''}>Success</option>
                                <option value="warning" ${alert.type === 'warning' ? 'selected' : ''}>Warning</option>
                                <option value="danger" ${alert.type === 'danger' ? 'selected' : ''}>Danger</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Priority</label>
                            <select id="alert_priority" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Low" ${alert.priority === 'Low' ? 'selected' : ''}>Low</option>
                                <option value="Medium" ${alert.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="High" ${alert.priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Critical" ${alert.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Alert</button>
                </form>
            `;
            showModal('Edit Alert', formHTML);
        }

        function handleAlertUpdate(event, alertId) {
            event.preventDefault();
            const alertIndex = appState.data.alerts.findIndex(a => a.id === alertId);
            if (alertIndex !== -1) {
                appState.data.alerts[alertIndex] = {
                    ...appState.data.alerts[alertIndex],
                    title: document.getElementById('alert_title').value,
                    message: document.getElementById('alert_message').value,
                    type: document.getElementById('alert_type').value,
                    priority: document.getElementById('alert_priority').value
                };
                saveData();
                closeModal();
                showToast('Alert updated successfully!');
                switchSection('alerts');
            }
        }

        function deleteAlert(alertId) {
            if (confirm('Are you sure you want to delete this alert?')) {
                appState.data.alerts = appState.data.alerts.filter(a => a.id !== alertId);
                saveData();
                showToast('Alert deleted successfully!');
                switchSection('alerts');
            }
        }

        // NOTE CRUD
        function showAddNote() {
            const formHTML = `
                <form onsubmit="handleNoteSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Note Title</label>
                        <input type="text" id="note_title" required placeholder="Meeting Notes - Q4 Planning"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Content</label>
                        <textarea id="note_content" required placeholder="Note content..."
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 120px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Category</label>
                            <select id="note_category" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Meeting">Meeting</option>
                                <option value="Idea">Idea</option>
                                <option value="Strategy">Strategy</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Tags</label>
                            <input type="text" id="note_tags" placeholder="q4, planning, strategy"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Save Note</button>
                </form>
            `;
            showModal('Create New Note', formHTML);
        }

        function handleNoteSubmit(event) {
            event.preventDefault();
            const newNote = {
                id: Date.now(),
                title: document.getElementById('note_title').value,
                content: document.getElementById('note_content').value,
                category: document.getElementById('note_category').value,
                tags: document.getElementById('note_tags').value.split(',').map(t => t.trim()).filter(t => t),
                created: new Date().toISOString(),
                updated: new Date().toISOString()
            };
            appState.data.notes.push(newNote);
            saveData();
            closeModal();
            showToast('Note saved successfully!');
            switchSection('notes');
        }

        // EVENT/CALENDAR CRUD
        function showAddEvent() {
            const today = new Date().toISOString().split('T')[0];
            const formHTML = `
                <form onsubmit="handleEventSubmit(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Event Title</label>
                        <input type="text" id="event_title" required placeholder="Team Meeting"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="event_description" placeholder="Event details..."
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 80px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Date</label>
                            <input type="date" id="event_date" required value="${today}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Time</label>
                            <input type="time" id="event_time" required
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                            <select id="event_type" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Meeting">Meeting</option>
                                <option value="Call">Call</option>
                                <option value="Deadline">Deadline</option>
                                <option value="Review">Review</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Location</label>
                            <input type="text" id="event_location" placeholder="Conference Room A"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Add Event</button>
                </form>
            `;
            showModal('Add Calendar Event', formHTML);
        }

        function handleEventSubmit(event) {
            event.preventDefault();
            const newEvent = {
                id: Date.now(),
                title: document.getElementById('event_title').value,
                description: document.getElementById('event_description').value || '',
                date: document.getElementById('event_date').value,
                time: document.getElementById('event_time').value,
                type: document.getElementById('event_type').value,
                location: document.getElementById('event_location').value || '',
                created: new Date().toISOString()
            };
            appState.data.events.push(newEvent);
            
            // Log activity
            addRecentActivity('event', `Created event: ${newEvent.title}`, `${newEvent.date} at ${newEvent.time} â€¢ ${newEvent.location || 'No location'}`, 'info');
            
            saveData();
            closeModal();
            showToast('Event added successfully!');
            switchSection('calendar');
        }

        function filterTable(query, tableId) {
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function exportData() {
            showToast('Exporting data...', 'info');
            setTimeout(() => {
                const dataStr = JSON.stringify(appState.data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `virely-ops-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showToast('âœ… Data exported successfully!', 'success');
            }, 500);
        }

        // ADVANCED SETTINGS FUNCTIONS
        
        // API KEY MANAGEMENT
        function manageAPIKeys() {
            const apiKeys = appState.data.apiKeys || [];
            
            const apiKeysHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">API Keys</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Manage your API keys for integrations</div>
                        </div>
                        <button class="btn-primary" onclick="addAPIKey()" style="padding: 8px 16px; font-size: 14px;">
                            âž• Generate New Key
                        </button>
                    </div>
                    
                    ${apiKeys.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${apiKeys.map((key, index) => `
                                <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">${key.name}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${key.description || 'No description'}</div>
                                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; display: flex; align-items: center; gap: 12px;">
                                                <code style="flex: 1; color: var(--accent-primary); overflow-x: auto;">${key.key}</code>
                                                <button onclick="copyAPIKey('${key.key}')" class="btn-secondary" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">
                                                    ðŸ“‹ Copy
                                                </button>
                                            </div>
                                        </div>
                                        <button onclick="deleteAPIKey(${index})" class="btn-secondary" style="margin-left: 12px; padding: 8px 12px; background: var(--danger); color: white;">
                                            ðŸ—‘ï¸
                                        </button>
                                    </div>
                                    <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-muted);">
                                        <span>Created: ${key.created}</span>
                                        <span>Last Used: ${key.lastUsed || 'Never'}</span>
                                        <span class="badge ${key.status === 'Active' ? 'success' : 'danger'}" style="padding: 4px 8px; font-size: 11px;">${key.status}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-glass); border-radius: 12px; border: 1px dashed var(--glass-border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ”‘</div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">No API Keys Yet</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">Generate your first API key to start integrating with external services</div>
                            <button class="btn-primary" onclick="addAPIKey()">
                                Generate API Key
                            </button>
                        </div>
                    `}
                    
                    <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px;">ðŸ’¡ API Key Best Practices</div>
                        <ul style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                            <li>Never share your API keys publicly</li>
                            <li>Rotate keys regularly for security</li>
                            <li>Use different keys for different environments</li>
                            <li>Revoke unused keys immediately</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('API Key Management', apiKeysHTML, '800px');
        }
        
        function addAPIKey() {
            const formHTML = `
                <form onsubmit="handleAddAPIKey(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Key Name</label>
                        <input type="text" id="api_key_name" class="form-input" placeholder="Production API Key" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Description (Optional)</label>
                        <textarea id="api_key_description" class="form-textarea" rows="3" placeholder="Describe what this key will be used for..."></textarea>
                    </div>
                    <div style="background: rgba(110,231,183,0.1); padding: 16px; border-radius: 8px; border: 1px solid var(--accent-primary);">
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: var(--accent-primary);">ðŸ”’ Security Notice</div>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            This key will only be shown once. Make sure to copy and store it securely.
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal(); manageAPIKeys()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2;">Generate API Key</button>
                    </div>
                </form>
            `;
            showModal('Generate New API Key', formHTML);
        }
        
        function handleAddAPIKey(event) {
            event.preventDefault();
            
            // Generate a secure random API key
            const apiKey = 'vrl_' + Array.from({length: 32}, () => 
                '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 62)]
            ).join('');
            
            const newKey = {
                id: Date.now(),
                name: document.getElementById('api_key_name').value,
                description: document.getElementById('api_key_description').value,
                key: apiKey,
                created: new Date().toISOString().split('T')[0],
                lastUsed: null,
                status: 'Active'
            };
            
            if (!appState.data.apiKeys) {
                appState.data.apiKeys = [];
            }
            appState.data.apiKeys.push(newKey);
            
            if (saveData()) {
                closeModal();
                showToast('âœ… API key generated successfully!', 'success');
                
                // Show the new key once
                setTimeout(() => {
                    const keyDisplayHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸŽ‰</div>
                            <div style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">API Key Generated!</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">
                                Copy this key now. You won't be able to see it again.
                            </div>
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <div style="font-family: 'Courier New', monospace; font-size: 16px; color: var(--accent-primary); word-break: break-all; margin-bottom: 12px;">
                                    ${apiKey}
                                </div>
                                <button onclick="copyAPIKey('${apiKey}')" class="btn-primary" style="width: 100%;">
                                    ðŸ“‹ Copy to Clipboard
                                </button>
                            </div>
                            <button onclick="closeModal(); manageAPIKeys()" class="btn-secondary" style="width: 100%;">
                                Done
                            </button>
                        </div>
                    `;
                    showModal('Your New API Key', keyDisplayHTML);
                }, 500);
            }
        }
        
        function copyAPIKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                showToast('âœ… API key copied to clipboard!', 'success');
            }).catch(() => {
                showToast('âŒ Failed to copy API key', 'error');
            });
        }
        
        function deleteAPIKey(index) {
            if (confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
                appState.data.apiKeys.splice(index, 1);
                if (saveData()) {
                    showToast('âœ… API key deleted', 'success');
                    manageAPIKeys();
                }
            }
        }
        
        // WEBHOOK MANAGEMENT
        function manageWebhooks() {
            const webhooks = appState.data.webhooks || [];
            
            const webhooksHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">Webhooks</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Configure webhook endpoints for real-time event notifications</div>
                        </div>
                        <button class="btn-primary" onclick="addWebhook()" style="padding: 8px 16px; font-size: 14px;">
                            âž• Add Webhook
                        </button>
                    </div>
                    
                    ${webhooks.length > 0 ? `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${webhooks.map((webhook, index) => `
                                <div style="background: var(--bg-glass); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">${webhook.name}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${webhook.description || 'No description'}</div>
                                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 12px;">
                                                <div style="color: var(--text-muted); margin-bottom: 4px;">Endpoint:</div>
                                                <code style="color: var(--accent-tertiary);">${webhook.url}</code>
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                ${webhook.events.map(event => `
                                                    <span class="badge info" style="font-size: 11px; padding: 4px 8px;">${event}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                                            <button onclick="editWebhook(${index})" class="btn-secondary" style="padding: 8px 12px;">
                                                âœï¸
                                            </button>
                                            <button onclick="deleteWebhook(${index})" class="btn-secondary" style="padding: 8px 12px; background: var(--danger); color: white;">
                                                ðŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-muted);">
                                        <span>Created: ${webhook.created}</span>
                                        <span>Last Triggered: ${webhook.lastTriggered || 'Never'}</span>
                                        <span class="badge ${webhook.status === 'Active' ? 'success' : 'danger'}" style="padding: 4px 8px; font-size: 11px;">${webhook.status}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 60px 20px; background: var(--bg-glass); border-radius: 12px; border: 1px dashed var(--glass-border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ””</div>
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">No Webhooks Configured</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">Set up webhooks to receive real-time notifications when events occur</div>
                            <button class="btn-primary" onclick="addWebhook()">
                                Add Webhook
                            </button>
                        </div>
                    `}
                    
                    <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(124,92,255,0.1)); border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 14px;">ðŸ“¡ Available Events</div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                            <strong>Transaction Events:</strong> transaction.created, transaction.updated<br>
                            <strong>Contact Events:</strong> contact.created, contact.updated, contact.deleted<br>
                            <strong>Deal Events:</strong> deal.created, deal.updated, deal.won, deal.lost<br>
                            <strong>Invoice Events:</strong> invoice.created, invoice.paid, invoice.overdue
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Webhook Management', webhooksHTML, '800px');
        }
        
        function addWebhook() {
            const formHTML = `
                <form onsubmit="handleAddWebhook(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Webhook Name</label>
                        <input type="text" id="webhook_name" class="form-input" placeholder="Slack Notifications" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Endpoint URL</label>
                        <input type="url" id="webhook_url" class="form-input" placeholder="https://your-domain.com/webhook" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Description (Optional)</label>
                        <textarea id="webhook_description" class="form-textarea" rows="2" placeholder="Describe what this webhook is for..."></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 12px; color: var(--text-secondary); font-weight: 600;">Select Events to Subscribe</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 200px; overflow-y: auto; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            ${['transaction.created', 'transaction.updated', 'contact.created', 'contact.updated', 'contact.deleted', 'deal.created', 'deal.updated', 'deal.won', 'deal.lost', 'invoice.created', 'invoice.paid', 'invoice.overdue'].map(event => `
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px;">
                                    <input type="checkbox" name="webhook_events" value="${event}" style="width: 16px; height: 16px;">
                                    <span style="font-size: 13px;">${event}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal(); manageWebhooks()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2;">Create Webhook</button>
                    </div>
                </form>
            `;
            showModal('Add New Webhook', formHTML);
        }
        
        function handleAddWebhook(event) {
            event.preventDefault();
            
            const selectedEvents = Array.from(document.querySelectorAll('input[name="webhook_events"]:checked'))
                .map(cb => cb.value);
            
            if (selectedEvents.length === 0) {
                showToast('âŒ Please select at least one event', 'error');
                return;
            }
            
            const newWebhook = {
                id: Date.now(),
                name: document.getElementById('webhook_name').value,
                url: document.getElementById('webhook_url').value,
                description: document.getElementById('webhook_description').value,
                events: selectedEvents,
                created: new Date().toISOString().split('T')[0],
                lastTriggered: null,
                status: 'Active'
            };
            
            if (!appState.data.webhooks) {
                appState.data.webhooks = [];
            }
            appState.data.webhooks.push(newWebhook);
            
            if (saveData()) {
                closeModal();
                showToast('âœ… Webhook created successfully!', 'success');
                setTimeout(() => manageWebhooks(), 500);
            }
        }
        
        function editWebhook(index) {
            const webhook = appState.data.webhooks[index];
            
            const formHTML = `
                <form onsubmit="handleEditWebhook(event, ${index})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Webhook Name</label>
                        <input type="text" id="webhook_name" class="form-input" value="${webhook.name}" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Endpoint URL</label>
                        <input type="url" id="webhook_url" class="form-input" value="${webhook.url}" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Description</label>
                        <textarea id="webhook_description" class="form-textarea" rows="2">${webhook.description || ''}</textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 12px; color: var(--text-secondary); font-weight: 600;">Select Events to Subscribe</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 200px; overflow-y: auto; padding: 12px; background: var(--bg-glass); border-radius: 8px;">
                            ${['transaction.created', 'transaction.updated', 'contact.created', 'contact.updated', 'contact.deleted', 'deal.created', 'deal.updated', 'deal.won', 'deal.lost', 'invoice.created', 'invoice.paid', 'invoice.overdue'].map(event => `
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px;">
                                    <input type="checkbox" name="webhook_events" value="${event}" ${webhook.events.includes(event) ? 'checked' : ''} style="width: 16px; height: 16px;">
                                    <span style="font-size: 13px;">${event}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal(); manageWebhooks()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2;">Update Webhook</button>
                    </div>
                </form>
            `;
            showModal('Edit Webhook', formHTML);
        }
        
        function handleEditWebhook(event, index) {
            event.preventDefault();
            
            const selectedEvents = Array.from(document.querySelectorAll('input[name="webhook_events"]:checked'))
                .map(cb => cb.value);
            
            if (selectedEvents.length === 0) {
                showToast('âŒ Please select at least one event', 'error');
                return;
            }
            
            appState.data.webhooks[index] = {
                ...appState.data.webhooks[index],
                name: document.getElementById('webhook_name').value,
                url: document.getElementById('webhook_url').value,
                description: document.getElementById('webhook_description').value,
                events: selectedEvents
            };
            
            if (saveData()) {
                closeModal();
                showToast('âœ… Webhook updated successfully!', 'success');
                setTimeout(() => manageWebhooks(), 500);
            }
        }
        
        function deleteWebhook(index) {
            if (confirm('Are you sure you want to delete this webhook?')) {
                appState.data.webhooks.splice(index, 1);
                if (saveData()) {
                    showToast('âœ… Webhook deleted', 'success');
                    manageWebhooks();
                }
            }
        }
        
        // DEVELOPER MODE
        function toggleDeveloperMode(enabled) {
            appState.data.developerMode = enabled;
            
            if (saveData()) {
                showToast(enabled ? 'ðŸ”§ Developer mode enabled' : 'ðŸ”§ Developer mode disabled', 'success');
                
                // Update the status text
                const statusSpan = document.getElementById('devModeStatus');
                if (statusSpan) {
                    statusSpan.textContent = enabled ? 'Enabled' : 'Disabled';
                    statusSpan.style.color = enabled ? 'var(--success)' : 'var(--text-muted)';
                }
                
                // Show developer features info
                if (enabled) {
                    setTimeout(() => {
                        const devFeaturesHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">ðŸ”§</div>
                                <div style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">Developer Mode Enabled</div>
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">
                                    Advanced features are now available
                                </div>
                                <div style="text-align: left; background: var(--bg-glass); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                    <div style="font-weight: 700; margin-bottom: 12px;">ðŸš€ Available Features:</div>
                                    <ul style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                                        <li>Access to browser console logs</li>
                                        <li>Debug mode for API calls</li>
                                        <li>View raw data structures</li>
                                        <li>Export/import in developer formats</li>
                                        <li>Advanced testing tools</li>
                                    </ul>
                                </div>
                                <button onclick="closeModal()" class="btn-primary" style="width: 100%;">
                                    Got It
                                </button>
                            </div>
                        `;
                        showModal('Developer Mode', devFeaturesHTML);
                    }, 1000);
                }
            }
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            
            // Create icon based on type
            let icon;
            switch(type) {
                case 'warning':
                    icon = 'âš ï¸';
                    break;
                case 'error':
                    icon = 'âŒ';
                    break;
                case 'info':
                    icon = 'â„¹ï¸';
                    break;
                default: // success
                    icon = 'âœ…';
            }
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            // Define colors based on type
            let bgColor, borderColor, shadowColor;
            switch(type) {
                case 'warning':
                    bgColor = 'linear-gradient(135deg, rgba(255,183,107,0.95), rgba(251,191,36,0.95))';
                    borderColor = 'rgba(251,191,36,0.5)';
                    shadowColor = 'rgba(251,191,36,0.4)';
                    break;
                case 'error':
                    bgColor = 'linear-gradient(135deg, rgba(255,107,107,0.95), rgba(255,68,68,0.95))';
                    borderColor = 'rgba(255,107,107,0.5)';
                    shadowColor = 'rgba(255,107,107,0.4)';
                    break;
                case 'info':
                    bgColor = 'linear-gradient(135deg, rgba(96,165,250,0.95), rgba(124,92,255,0.95))';
                    borderColor = 'rgba(96,165,250,0.5)';
                    shadowColor = 'rgba(96,165,250,0.4)';
                    break;
                default: // success
                    bgColor = 'linear-gradient(135deg, rgba(110,231,183,0.95), rgba(124,92,255,0.95))';
                    borderColor = 'rgba(110,231,183,0.5)';
                    shadowColor = 'rgba(110,231,183,0.4)';
            }
            
            toast.style.cssText = `
                position: fixed; 
                bottom: 32px; 
                right: 32px; 
                background: ${bgColor}; 
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                color: #ffffff; 
                padding: 16px 24px; 
                border-radius: 16px; 
                border: 1px solid ${borderColor};
                font-weight: 600; 
                font-size: 14px;
                z-index: 10000; 
                box-shadow: 0 8px 32px ${shadowColor}, 0 0 0 1px rgba(255,255,255,0.1); 
                animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
                max-width: 420px; 
                line-height: 1.5;
                cursor: pointer;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            `;
            
            // Add hover effect
            toast.addEventListener('mouseenter', () => {
                toast.style.transform = 'translateY(-4px)';
                toast.style.boxShadow = `0 12px 48px ${shadowColor}, 0 0 0 1px rgba(255,255,255,0.2)`;
            });
            
            toast.addEventListener('mouseleave', () => {
                toast.style.transform = '';
                toast.style.boxShadow = `0 8px 32px ${shadowColor}, 0 0 0 1px rgba(255,255,255,0.1)`;
            });
            
            // Click to dismiss
            toast.addEventListener('click', () => {
                toast.style.animation = 'toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => toast.remove(), 300);
            });
            
            document.body.appendChild(toast);
            
            // Add animation styles if not already present
            if (!document.getElementById('toast-animations')) {
                const style = document.createElement('style');
                style.id = 'toast-animations';
                style.textContent = `
                    @keyframes toastSlideIn {
                        from {
                            transform: translateX(120%) translateY(0);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0) translateY(0);
                            opacity: 1;
                        }
                    }
                    @keyframes toastSlideOut {
                        from {
                            transform: translateX(0) translateY(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(120%) translateY(0);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Auto dismiss
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Click outside modal to close
            const modal = document.getElementById('modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeModal();
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
                    closeModal();
                }
            });
        }

        // ENHANCED FUNCTIONS FOR NEW FEATURES

        // Enhanced renderDeals with drag-and-drop Deal Pipeline
        function renderDealsEnhanced(container) {
            const stages = ['Prospect', 'Qualification', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];
            
            container.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <h2>Sales Pipeline</h2>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showAddDeal()">âž• Add Deal</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Drag & Drop Deal Pipeline</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;">
                        ${stages.map(stage => `
                            <div class="pipeline-column" data-stage="${stage}" 
                                 style="background: var(--bg-glass); border: 2px dashed var(--glass-border); border-radius: 12px; padding: 16px; min-height: 400px;"
                                 ondrop="dropDeal(event)" ondragover="allowDrop(event)">
                                <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 1px;">
                                    ${stage}
                                </div>
                                <div class="deals-container" id="deals-${stage.replace(/\\s+/g, '-')}">
                                    ${appState.data.deals.filter(d => d.stage === stage).map(deal => `
                                        <div class="deal-card" draggable="true" ondragstart="dragDeal(event)" data-deal-id="${deal.id}"
                                             style="background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: move;">
                                            <div style="font-weight: 600; margin-bottom: 6px;">${deal.name}</div>
                                            <div style="font-size: 18px; font-weight: 800; color: var(--accent-primary); margin-bottom: 6px;">
                                                $${deal.value.toLocaleString()}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                                                ${deal.contact} â€¢ ${deal.probability}% probability
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-muted);">
                                                Close: ${deal.closeDate}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        let draggedDealId = null;

        function dragDeal(event) {
            draggedDealId = parseInt(event.target.getAttribute('data-deal-id'));
            event.dataTransfer.effectAllowed = 'move';
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropDeal(event) {
            event.preventDefault();
            const column = event.target.closest('.pipeline-column');
            if (column && draggedDealId) {
                const newStage = column.getAttribute('data-stage');
                const deal = appState.data.deals.find(d => d.id === draggedDealId);
                if (deal) {
                    deal.stage = newStage;
                    saveData();
                    showToast(`Deal moved to ${newStage}`);
                    switchSection('deals');
                }
            }
        }

        // Enhanced renderMarketing with Marketing Channels section
        function renderMarketingEnhanced(container) {
            const totalBudget = appState.data.marketingChannels.reduce((sum, c) => sum + c.budget, 0);
            const totalSpent = appState.data.marketingChannels.filter(c => c.enabled).reduce((sum, c) => sum + c.spent, 0);
            const totalLeads = appState.data.marketingChannels.filter(c => c.enabled).reduce((sum, c) => sum + c.leads, 0);
            const totalConversions = appState.data.marketingChannels.filter(c => c.enabled).reduce((sum, c) => sum + c.conversions, 0);
            const activeChannels = appState.data.marketingChannels.filter(c => c.enabled).length;
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownMarketingBudget()" 
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)';"
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-label">Total Marketing Budget</div>
                        <div class="stat-value">$${totalBudget.toLocaleString()}</div>
                        <div class="stat-change">${((totalSpent / totalBudget) * 100).toFixed(1)}% spent</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Click for budget breakdown</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownMarketingLeads()"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)';"
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div class="stat-icon">ðŸ“Š</div>
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value">${totalLeads}</div>
                        <div class="stat-change positive">${totalConversions} conversions</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Click for lead details</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownConversionRate()"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)';"
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div class="stat-icon">ðŸŽ¯</div>
                        <div class="stat-label">Conversion Rate</div>
                        <div class="stat-value">${totalLeads > 0 ? ((totalConversions / totalLeads) * 100).toFixed(1) : 0}%</div>
                        <div class="stat-change positive">Across all channels</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Click for conversion analysis</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="drilldownActiveChannels()"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)';"
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div class="stat-icon">ðŸ’¡</div>
                        <div class="stat-label">Active Channels</div>
                        <div class="stat-value">${activeChannels}/${appState.data.marketingChannels.length}</div>
                        <div class="stat-change">Platforms monitored</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Click for channel overview</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Marketing Channels with Budgets</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        ${appState.data.marketingChannels.map(channel => {
                            const spentPercent = ((channel.spent / channel.budget) * 100).toFixed(0);
                            const remaining = channel.budget - channel.spent;
                            const isDisabled = !channel.enabled;
                            return `
                            <div style="background: var(--bg-glass); border: 1px solid ${isDisabled ? 'var(--danger)' : 'var(--glass-border)'}; border-radius: 12px; padding: 20px; ${isDisabled ? 'opacity: 0.6;' : 'cursor: pointer;'} transition: all 0.3s ease; position: relative;"
                                 ${!isDisabled ? `onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 0 32px rgba(110,231,183,0.3)';"` : ''}
                                 ${!isDisabled ? `onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"` : ''}
                                 ${!isDisabled ? `onclick="drilldownMarketingChannel(${channel.id})"` : ''}>
                                
                                ${isDisabled ? `<div style="position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">DISABLED</div>` : ''}
                                
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                    <div>
                                        <div style="font-size: 32px; margin-bottom: 8px;">${channel.icon}</div>
                                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;">${channel.name}</div>
                                        <span class="badge badge-${channel.status === 'Active' ? 'success' : 'warning'}">${channel.status}</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                                        <button onclick="event.stopPropagation(); toggleMarketingChannel(${channel.id})" 
                                                style="padding: 6px 14px; background: ${isDisabled ? 'var(--success)' : 'var(--danger)'}; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                            ${isDisabled ? 'Enable' : 'Disable'}
                                        </button>
                                        ${!isDisabled && channel.loginUrl ? `<a href="${channel.loginUrl}" target="_blank" onclick="event.stopPropagation();" 
                                                style="padding: 6px 14px; background: var(--accent-tertiary); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; transition: all 0.3s;">
                                            ðŸ”— Login
                                        </a>` : ''}
                                    </div>
                                </div>
                                
                                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 12px; color: var(--text-muted);">Budget</span>
                                        <span style="font-weight: 600;">$${channel.budget.toLocaleString()}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 12px; color: var(--text-muted);">Spent</span>
                                        <span style="font-weight: 600; color: var(--accent-tertiary);">$${channel.spent.toLocaleString()}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 12px; color: var(--text-muted);">Remaining</span>
                                        <span style="font-weight: 600; color: var(--accent-primary);">$${remaining.toLocaleString()}</span>
                                    </div>
                                    <div style="width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin-top: 12px; overflow: hidden;">
                                        <div style="width: ${spentPercent}%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px; text-align: center;">
                                        ${spentPercent}% utilized
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--accent-tertiary);">${channel.leads}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Leads</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--accent-gold);">${channel.conversions}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">Conversions</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--success);">${channel.roi}x</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">ROI</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); font-size: 12px; color: var(--text-secondary);">
                                    Cost per lead: <span style="font-weight: 600; color: var(--accent-primary);">$${channel.cpl}</span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Channel Performance Comparison</div>
                    <div style="margin-top: 20px;">
                        <canvas id="channelPerformanceChart"></canvas>
                    </div>
                </div>
                
                <!-- Marketing Campaigns Section -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="card-title" style="margin-bottom: 0;">Marketing Campaigns</div>
                        <button class="btn-primary" onclick="showAddCampaign()" 
                                style="padding: 10px 20px; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;
                                       background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); 
                                       border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
                                       box-shadow: 0 4px 16px rgba(110,231,183,0.3);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(110,231,183,0.5)';"
                                onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px rgba(110,231,183,0.3)';">
                            <span style="font-size: 18px;">ðŸ“¢</span>
                            <span>Add Campaign</span>
                        </button>
                    </div>
                    ${!appState.data.campaigns || appState.data.campaigns.length === 0 ? `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 64px; margin-bottom: 20px;">ðŸ“¢</div>
                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 12px;">No Campaigns Yet</div>
                            <div style="font-size: 14px; margin-bottom: 24px;">Create your first marketing campaign to track performance across channels</div>
                            <button class="btn-primary" onclick="showAddCampaign()">Create First Campaign</button>
                        </div>
                    ` : `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                            ${appState.data.campaigns.map(campaign => {
                                const progressPercent = campaign.targetLeads > 0 ? ((campaign.leads / campaign.targetLeads) * 100).toFixed(0) : 0;
                                const budgetPercent = campaign.budget > 0 ? ((campaign.spent / campaign.budget) * 100).toFixed(0) : 0;
                                const statusColor = campaign.status === 'Active' ? 'var(--success)' : 
                                                  campaign.status === 'Completed' ? 'var(--accent-tertiary)' : 
                                                  campaign.status === 'Planning' ? 'var(--accent-gold)' : 'var(--text-muted)';
                                return `
                                <div style="background: var(--bg-glass); border: 1px solid ${campaign.status === 'Paused' ? 'var(--warning)' : 'var(--glass-border)'}; border-radius: 12px; 
                                            padding: 20px; transition: all 0.3s ease; cursor: pointer; position: relative;
                                            ${campaign.status === 'Paused' ? 'opacity: 0.8;' : ''}"
                                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 32px rgba(110,231,183,0.2)'; this.style.borderColor='var(--accent-primary)'"
                                     onmouseout="this.style.transform=''; this.style.boxShadow=''; this.style.borderColor='${campaign.status === 'Paused' ? 'var(--warning)' : 'var(--glass-border)'}'"
                                     onclick="viewCampaignDetails(${campaign.id})">
                                    
                                    ${campaign.status === 'Paused' ? `<div style="position: absolute; top: 10px; right: 10px; background: var(--warning); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700;">â¸ï¸ PAUSED</div>` : ''}
                                    ${campaign.status === 'Completed' ? `<div style="position: absolute; top: 10px; right: 10px; background: var(--accent-tertiary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700;">âœ“ COMPLETED</div>` : ''}
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 6px; color: var(--text-primary);">${campaign.name}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${campaign.type}</div>
                                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                                <span class="badge" style="background: ${statusColor}; font-size: 11px;">${campaign.status}</span>
                                                ${campaign.channelNames ? campaign.channelNames.slice(0, 2).map(name => 
                                                    `<span class="badge badge-info" style="font-size: 10px;">${name}</span>`
                                                ).join('') : ''}
                                                ${campaign.channelNames && campaign.channelNames.length > 2 ? 
                                                    `<span class="badge badge-secondary" style="font-size: 10px;">+${campaign.channelNames.length - 2} more</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 14px; margin-bottom: 14px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Budget</div>
                                                <div style="font-size: 16px; font-weight: 700; color: var(--accent-primary);">$${campaign.budget.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Spent</div>
                                                <div style="font-size: 16px; font-weight: 700; color: var(--accent-secondary);">$${campaign.spent.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                                            <div style="width: ${budgetPercent}%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: center;">${budgetPercent}% utilized</div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px;">
                                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-size: 18px; font-weight: 700; color: var(--accent-tertiary);">${campaign.leads}</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">Leads</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-size: 18px; font-weight: 700; color: var(--success);">${campaign.conversions}</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">Conversions</div>
                                        </div>
                                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-size: 18px; font-weight: 700; color: ${campaign.roi > 1 ? 'var(--success)' : 'var(--danger)'};">${campaign.roi}x</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">ROI</div>
                                        </div>
                                    </div>
                                    
                                    <div style="padding-top: 12px; border-top: 1px solid var(--glass-border);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                            <span style="font-size: 11px; color: var(--text-muted);">Progress to Target</span>
                                            <span style="font-size: 11px; font-weight: 600; color: ${progressPercent >= 100 ? 'var(--success)' : 'var(--text-primary)'};">${progressPercent}%</span>
                                        </div>
                                        <div style="width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                            <div style="width: ${Math.min(progressPercent, 100)}%; height: 100%; background: ${progressPercent >= 100 ? 'var(--success)' : 'linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary))'};"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between;">
                                        <span>ðŸ“… ${campaign.startDate}</span>
                                        <span>â†’</span>
                                        <span>ðŸ“… ${campaign.endDate}</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            `;

            // Render channel performance chart
            setTimeout(() => {
                const ctx = document.getElementById('channelPerformanceChart');
                if (ctx) {
                    const enabledChannels = appState.data.marketingChannels.filter(c => c.enabled);
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: enabledChannels.map(c => c.name),
                            datasets: [{
                                label: 'Leads',
                                data: enabledChannels.map(c => c.leads),
                                backgroundColor: 'rgba(110, 231, 183, 0.8)'
                            }, {
                                label: 'Conversions',
                                data: enabledChannels.map(c => c.conversions),
                                backgroundColor: 'rgba(251, 191, 36, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: true, labels: { color: '#94a3b8' } } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Marketing Stat Card Drill-down Functions
        function drilldownMarketingBudget() {
            const channels = appState.data.marketingChannels;
            const totalBudget = channels.reduce((sum, c) => sum + c.budget, 0);
            const totalSpent = channels.reduce((sum, c) => sum + c.spent, 0);
            const totalRemaining = totalBudget - totalSpent;
            
            const content = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(110,231,183,0.2), rgba(124,92,255,0.2)); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ’°</div>
                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Marketing Budget Breakdown</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Complete budget allocation across all channels</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(110,231,183,0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--accent-primary);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Total Budget</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-primary);">$${totalBudget.toLocaleString()}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(124,92,255,0.1), rgba(124,92,255,0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--accent-secondary);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Total Spent</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--accent-secondary);">$${totalSpent.toLocaleString()}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${((totalSpent / totalBudget) * 100).toFixed(1)}% utilized</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(74,222,128,0.1), rgba(74,222,128,0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--success);">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Remaining</div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--success);">$${totalRemaining.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 16px; color: var(--accent-primary);">Channel Budget Allocation</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${channels.map(channel => {
                                const percent = ((channel.budget / totalBudget) * 100).toFixed(1);
                                const spentPercent = ((channel.spent / channel.budget) * 100).toFixed(0);
                                const remaining = channel.budget - channel.spent;
                                return `
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; ${!channel.enabled ? 'opacity: 0.5;' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="font-size: 24px;">${channel.icon}</span>
                                            <div>
                                                <div style="font-weight: 600; font-size: 16px;">${channel.name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">${percent}% of total budget</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 700; font-size: 18px; color: var(--accent-primary);">$${channel.budget.toLocaleString()}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">$${channel.spent.toLocaleString()} spent â€¢ $${remaining.toLocaleString()} left</div>
                                        </div>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${spentPercent}%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                    </div>
                                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: center;">${spentPercent}% budget utilized</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <button class="btn-secondary" onclick="closeModal()" style="padding: 14px; font-size: 16px;">Close</button>
                </div>
            `;
            
            showModal('Marketing Budget Analysis', content);
        }
        
        function drilldownMarketingLeads() {
            const channels = appState.data.marketingChannels.filter(c => c.enabled);
            const totalLeads = channels.reduce((sum, c) => sum + c.leads, 0);
            const totalConversions = channels.reduce((sum, c) => sum + c.conversions, 0);
            const totalSpent = channels.reduce((sum, c) => sum + c.spent, 0);
            const avgCostPerLead = totalLeads > 0 ? (totalSpent / totalLeads).toFixed(2) : 0;
            
            // Sort channels by lead volume
            const sortedByLeads = [...channels].sort((a, b) => b.leads - a.leads);
            
            const content = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(110,231,183,0.2)); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“Š</div>
                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Lead Generation Analysis</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Comprehensive lead performance across all channels</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Total Leads</div>
                            <div style="font-size: 28px; font-weight: 800; color: var(--accent-tertiary);">${totalLeads}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Conversions</div>
                            <div style="font-size: 28px; font-weight: 800; color: var(--success);">${totalConversions}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Avg CPL</div>
                            <div style="font-size: 28px; font-weight: 800; color: var(--accent-primary);">$${avgCostPerLead}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Active Channels</div>
                            <div style="font-size: 28px; font-weight: 800; color: var(--accent-secondary);">${channels.length}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 16px; color: var(--accent-primary);">Lead Volume by Channel</div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${sortedByLeads.map((channel, index) => {
                                const leadPercent = ((channel.leads / totalLeads) * 100).toFixed(1);
                                const convRate = channel.leads > 0 ? ((channel.conversions / channel.leads) * 100).toFixed(1) : 0;
                                const cpl = channel.leads > 0 ? (channel.spent / channel.leads).toFixed(2) : 0;
                                return `
                                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; cursor: pointer;"
                                     onclick="drilldownMarketingChannel(${channel.id})">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 20px;">${channel.icon}</span>
                                            <div>
                                                <div style="font-weight: 600;">${channel.name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">Rank #${index + 1} â€¢ ${leadPercent}% of total</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 20px; font-weight: 700; color: var(--accent-tertiary);">${channel.leads} leads</div>
                                            <div style="font-size: 11px; color: var(--success);">${channel.conversions} conversions (${convRate}%)</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: var(--text-secondary);">
                                        <div>Cost per Lead: <span style="font-weight: 600; color: var(--accent-primary);">$${cpl}</span></div>
                                        <div>ROI: <span style="font-weight: 600; color: var(--success);">${channel.roi}x</span></div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <button class="btn-secondary" onclick="closeModal()" style="padding: 14px; font-size: 16px;">Close</button>
                </div>
            `;
            
            showModal('Lead Generation Dashboard', content);
        }
        
        function drilldownConversionRate() {
            const channels = appState.data.marketingChannels.filter(c => c.enabled);
            const totalLeads = channels.reduce((sum, c) => sum + c.leads, 0);
            const totalConversions = channels.reduce((sum, c) => sum + c.conversions, 0);
            const overallConvRate = totalLeads > 0 ? ((totalConversions / totalLeads) * 100).toFixed(1) : 0;
            
            // Sort by conversion rate
            const sortedByConvRate = [...channels].sort((a, b) => {
                const rateA = a.leads > 0 ? (a.conversions / a.leads) : 0;
                const rateB = b.leads > 0 ? (b.conversions / b.leads) : 0;
                return rateB - rateA;
            });
            
            const content = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(110,231,183,0.2)); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸŽ¯</div>
                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Conversion Rate Analysis</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Lead-to-customer conversion performance</div>
                    </div>
                    
                    <div style="text-align: center; padding: 32px; background: var(--bg-glass); border-radius: 12px; border: 2px solid var(--success);">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase;">Overall Conversion Rate</div>
                        <div style="font-size: 56px; font-weight: 900; color: var(--success); margin-bottom: 8px;">${overallConvRate}%</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${totalConversions} conversions from ${totalLeads} leads</div>
                    </div>
                    
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 16px; color: var(--accent-primary);">Conversion Rate by Channel</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${sortedByConvRate.map((channel, index) => {
                                const convRate = channel.leads > 0 ? ((channel.conversions / channel.leads) * 100).toFixed(1) : 0;
                                const costPerConv = channel.conversions > 0 ? (channel.spent / channel.conversions).toFixed(2) : 0;
                                const performance = convRate >= 5 ? 'Excellent' : convRate >= 3 ? 'Good' : convRate >= 1 ? 'Average' : 'Needs Improvement';
                                const performanceColor = convRate >= 5 ? 'var(--success)' : convRate >= 3 ? 'var(--accent-primary)' : convRate >= 1 ? 'var(--warning)' : 'var(--danger)';
                                return `
                                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; border-left: 4px solid ${performanceColor}; cursor: pointer;"
                                     onclick="drilldownMarketingChannel(${channel.id})">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="font-size: 24px;">${channel.icon}</span>
                                            <div>
                                                <div style="font-weight: 600; font-size: 16px;">${channel.name}</div>
                                                <div style="font-size: 11px; color: var(--text-muted);">Rank #${index + 1}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 32px; font-weight: 800; color: ${performanceColor};">${convRate}%</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">${performance}</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 10px; border-top: 1px solid var(--glass-border); font-size: 11px;">
                                        <div>
                                            <div style="color: var(--text-muted);">Leads</div>
                                            <div style="font-weight: 600; color: var(--accent-tertiary);">${channel.leads}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted);">Conversions</div>
                                            <div style="font-weight: 600; color: var(--success);">${channel.conversions}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-muted);">Cost/Conv</div>
                                            <div style="font-weight: 600; color: var(--accent-secondary);">$${costPerConv}</div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 16px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 700; margin-bottom: 8px;">ðŸ’¡ Optimization Tips</div>
                        <ul style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                            <li>Channels with >5% conversion rate are performing excellently</li>
                            <li>Focus budget on high-converting channels</li>
                            <li>Review targeting and creative for channels <2%</li>
                            <li>Test different audiences on underperforming channels</li>
                        </ul>
                    </div>
                    
                    <button class="btn-secondary" onclick="closeModal()" style="padding: 14px; font-size: 16px;">Close</button>
                </div>
            `;
            
            showModal('Conversion Rate Dashboard', content);
        }
        
        function drilldownActiveChannels() {
            const allChannels = appState.data.marketingChannels;
            const activeChannels = allChannels.filter(c => c.enabled);
            const inactiveChannels = allChannels.filter(c => !c.enabled);
            
            const content = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(124,92,255,0.2), rgba(110,231,183,0.2)); border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ðŸ’¡</div>
                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Marketing Channels Overview</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Complete status of all marketing channels</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: linear-gradient(135deg, rgba(74,222,128,0.1), rgba(74,222,128,0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--success); text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Active Channels</div>
                            <div style="font-size: 48px; font-weight: 900; color: var(--success);">${activeChannels.length}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,107,107,0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--danger); text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Inactive Channels</div>
                            <div style="font-size: 48px; font-weight: 900; color: var(--danger);">${inactiveChannels.length}</div>
                        </div>
                    </div>
                    
                    ${activeChannels.length > 0 ? `
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--success);">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 16px; color: var(--success);">âœ… Active Channels</div>
                        <div style="display: grid; gap: 10px;">
                            ${activeChannels.map(channel => `
                                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                                     onclick="drilldownMarketingChannel(${channel.id})">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 28px;">${channel.icon}</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">${channel.name}</div>
                                            <div style="font-size: 11px; color: var(--text-muted);">
                                                ${channel.leads} leads â€¢ ${channel.conversions} conversions â€¢ ${channel.roi}x ROI
                                            </div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 700; color: var(--accent-primary);">$${channel.spent.toLocaleString()}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">of $${channel.budget.toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${inactiveChannels.length > 0 ? `
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--danger);">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 16px; color: var(--danger);">â¸ï¸ Inactive Channels</div>
                        <div style="display: grid; gap: 10px;">
                            ${inactiveChannels.map(channel => `
                                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 8px; opacity: 0.6; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 28px;">${channel.icon}</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">${channel.name}</div>
                                            <div style="font-size: 11px; color: var(--danger);">Currently disabled</div>
                                        </div>
                                    </div>
                                    <button onclick="event.stopPropagation(); toggleMarketingChannel(${channel.id}); closeModal(); setTimeout(() => drilldownActiveChannels(), 500);" 
                                            class="btn-primary" style="padding: 8px 16px; font-size: 12px;">
                                        Enable
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <button class="btn-secondary" onclick="closeModal()" style="padding: 14px; font-size: 16px;">Close</button>
                </div>
            `;
            
            showModal('Marketing Channels Status', content);
        }

        // Toggle marketing channel enable/disable
        function toggleMarketingChannel(channelId) {
            const channel = appState.data.marketingChannels.find(c => c.id === channelId);
            if (!channel) return;
            
            channel.enabled = !channel.enabled;
            
            if (!channel.enabled) {
                showToast(`âš ï¸ ${channel.name} has been disabled. Budget: $${channel.budget.toLocaleString()} | Current Spending: $${channel.spent.toLocaleString()}`, 'warning');
            } else {
                showToast(`âœ… ${channel.name} has been enabled and is now active!`, 'success');
            }
            
            saveData();
            switchSection('marketing');
        }
        
        // Delete marketing channel with smart cascade logic
        function deleteMarketingChannel(channelId) {
            const channel = appState.data.marketingChannels.find(c => c.id === channelId);
            if (!channel) return;
            
            // Check if channel is used in any campaigns
            const campaignsUsingChannel = appState.data.campaigns.filter(campaign => 
                campaign.channels && campaign.channels.includes(channelId)
            );
            
            // Build smart warning message
            let warningMsg = `âš ï¸ DELETE MARKETING CHANNEL: ${channel.icon} ${channel.name}\n\n`;
            warningMsg += `This will permanently delete:\n`;
            warningMsg += `â€¢ Budget allocation: $${channel.budget.toLocaleString()}\n`;
            warningMsg += `â€¢ Spent amount: $${channel.spent.toLocaleString()}\n`;
            warningMsg += `â€¢ ${channel.leads} leads tracked\n`;
            warningMsg += `â€¢ ${channel.conversions} conversions tracked\n`;
            warningMsg += `â€¢ All channel performance history\n\n`;
            
            // Warn about cascade effects
            if (campaignsUsingChannel.length > 0) {
                warningMsg += `ðŸ”— CASCADE EFFECT WARNING:\n`;
                warningMsg += `This channel is currently used in ${campaignsUsingChannel.length} campaign(s):\n`;
                campaignsUsingChannel.forEach(c => {
                    warningMsg += `  â€¢ ${c.name} (${c.status})\n`;
                });
                warningMsg += `\nDeleting this channel will remove it from all campaigns.\n`;
            }
            
            // Extra warning for active channels
            if (channel.enabled) {
                warningMsg += `\nâš ï¸ WARNING: This channel is currently ACTIVE!\n`;
            }
            
            // Check if it's a custom channel
            if (channel.custom) {
                warningMsg += `\nðŸ’¡ This is a custom channel you created.\n`;
            }
            
            warningMsg += `\nThis action CANNOT be undone.\n\nAre you absolutely sure you want to delete this channel?`;
            
            if (confirm(warningMsg)) {
                // Remove channel from all campaigns that use it
                if (campaignsUsingChannel.length > 0) {
                    campaignsUsingChannel.forEach(campaign => {
                        campaign.channels = campaign.channels.filter(id => id !== channelId);
                        // Update campaign channel names
                        if (campaign.channelNames) {
                            campaign.channelNames = campaign.channelNames.filter(name => name !== channel.name);
                        }
                    });
                }
                
                // Delete the channel
                const index = appState.data.marketingChannels.findIndex(c => c.id === channelId);
                if (index !== -1) {
                    appState.data.marketingChannels.splice(index, 1);
                    
                    // Log deletion with details
                    addRecentActivity('delete', `Marketing Channel Deleted: ${channel.name}`, 
                        `Budget: $${channel.budget.toLocaleString()} | Spent: $${channel.spent.toLocaleString()} | ${channel.leads} leads | Removed from ${campaignsUsingChannel.length} campaign(s)`, 
                        'warning');
                    
                    if (saveData()) {
                        closeModal();
                        showToast(`âœ… Channel "${channel.name}" has been permanently deleted${campaignsUsingChannel.length > 0 ? ` and removed from ${campaignsUsingChannel.length} campaign(s)` : ''}`, 'success');
                        switchSection('marketing');
                    }
                }
            }
        }
        
        // Add new marketing channel
        function showAddMarketingChannel() {
            const formHTML = `
                <form onsubmit="handleAddMarketingChannel(event)" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Channel Name</label>
                        <input type="text" id="channel_name" required placeholder="YouTube Ads"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Channel Icon *</label>
                        <select id="channel_icon" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                       border-radius: 8px; color: var(--text-primary); font-size: 20px; text-align: center; cursor: pointer;"
                                onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 4px rgba(110,231,183,0.15)';"
                                onblur="this.style.borderColor='var(--glass-border)'; this.style.boxShadow='none';">
                            <option value="">Select Icon...</option>
                            <optgroup label="ðŸ“± Digital Marketing">
                                <option value="ðŸ“±">ðŸ“± Mobile</option>
                                <option value="ðŸ’»">ðŸ’» Desktop</option>
                                <option value="ðŸ“§">ðŸ“§ Email</option>
                                <option value="ðŸ’¬">ðŸ’¬ Messaging</option>
                                <option value="ðŸ“²">ðŸ“² SMS</option>
                                <option value="ðŸŒ">ðŸŒ Web</option>
                                <option value="ðŸ”">ðŸ” SEO/Search</option>
                                <option value="ðŸ“Š">ðŸ“Š Analytics</option>
                            </optgroup>
                            <optgroup label="ðŸ“¢ Social Media">
                                <option value="ðŸ‘¥">ðŸ‘¥ Social Networks</option>
                                <option value="ðŸ“·">ðŸ“· Instagram</option>
                                <option value="ðŸ¦">ðŸ¦ Twitter</option>
                                <option value="ðŸ’¼">ðŸ’¼ LinkedIn</option>
                                <option value="ðŸ“˜">ðŸ“˜ Facebook</option>
                                <option value="ðŸŽµ">ðŸŽµ TikTok</option>
                                <option value="ðŸ“¹">ðŸ“¹ YouTube</option>
                                <option value="ðŸ“¸">ðŸ“¸ Stories</option>
                                <option value="ðŸ’­">ðŸ’­ Forums</option>
                            </optgroup>
                            <optgroup label="ðŸŽ™ï¸ Content & Media">
                                <option value="ðŸŽ™ï¸">ðŸŽ™ï¸ Podcast</option>
                                <option value="ðŸŽ¬">ðŸŽ¬ Video</option>
                                <option value="ðŸ“º">ðŸ“º Streaming/TV</option>
                                <option value="ðŸ“»">ðŸ“» Radio</option>
                                <option value="ðŸ“°">ðŸ“° News/Press</option>
                                <option value="ðŸ“">ðŸ“ Blog</option>
                                <option value="ðŸ“–">ðŸ“– Publications</option>
                                <option value="ðŸŽ¨">ðŸŽ¨ Creative</option>
                            </optgroup>
                            <optgroup label="ðŸ’° Paid Advertising">
                                <option value="ðŸ’°">ðŸ’° Paid Ads</option>
                                <option value="ðŸŽ¯">ðŸŽ¯ Display Ads</option>
                                <option value="ðŸ”—">ðŸ”— Sponsored Links</option>
                                <option value="ðŸ“£">ðŸ“£ Programmatic</option>
                                <option value="ðŸŽª">ðŸŽª Banner Ads</option>
                                <option value="ðŸ›ï¸">ðŸ›ï¸ Shopping Ads</option>
                                <option value="ðŸ’³">ðŸ’³ Retargeting</option>
                            </optgroup>
                            <optgroup label="ðŸ¤ Partnerships & Affiliates">
                                <option value="ðŸ¤">ðŸ¤ Partnerships</option>
                                <option value="ðŸ‘¤">ðŸ‘¤ Influencers</option>
                                <option value="â­">â­ Brand Ambassadors</option>
                                <option value="ðŸ”„">ðŸ”„ Affiliate Network</option>
                                <option value="ðŸ¤²">ðŸ¤² Referral Program</option>
                                <option value="ðŸŽ">ðŸŽ Gift/Giveaway</option>
                            </optgroup>
                            <optgroup label="ðŸ¢ Events & Offline">
                                <option value="ðŸ¢">ðŸ¢ Trade Shows</option>
                                <option value="ðŸŽª">ðŸŽª Events</option>
                                <option value="ðŸŽ¤">ðŸŽ¤ Conference</option>
                                <option value="ðŸŽ«">ðŸŽ« Sponsorship</option>
                                <option value="ðŸª">ðŸª Retail</option>
                                <option value="ðŸšª">ðŸšª Door-to-Door</option>
                                <option value="ðŸ“®">ðŸ“® Direct Mail</option>
                                <option value="ðŸ—ºï¸">ðŸ—ºï¸ Outdoor/Billboard</option>
                            </optgroup>
                            <optgroup label="ðŸŽ® Emerging Channels">
                                <option value="ðŸŽ®">ðŸŽ® Gaming</option>
                                <option value="ðŸ•¹ï¸">ðŸ•¹ï¸ Esports</option>
                                <option value="ðŸ¥½">ðŸ¥½ VR/AR</option>
                                <option value="ðŸ¤–">ðŸ¤– Chatbots</option>
                                <option value="ðŸ”Š">ðŸ”Š Voice/Alexa</option>
                                <option value="ðŸ’Ž">ðŸ’Ž NFT/Web3</option>
                                <option value="ðŸŒŒ">ðŸŒŒ Metaverse</option>
                            </optgroup>
                            <optgroup label="ðŸ“ž Direct Communication">
                                <option value="ðŸ“ž">ðŸ“ž Phone</option>
                                <option value="â˜Žï¸">â˜Žï¸ Telemarketing</option>
                                <option value="ðŸ’Œ">ðŸ’Œ Direct Message</option>
                                <option value="âœ‰ï¸">âœ‰ï¸ Newsletter</option>
                                <option value="ðŸ“¨">ðŸ“¨ Drip Campaign</option>
                                <option value="ðŸ“¬">ðŸ“¬ Postal Mail</option>
                            </optgroup>
                            <optgroup label="ðŸŽ“ Educational & Content">
                                <option value="ðŸŽ“">ðŸŽ“ Webinars</option>
                                <option value="ðŸ“š">ðŸ“š E-books</option>
                                <option value="ðŸ“„">ðŸ“„ Whitepapers</option>
                                <option value="ðŸŽ¯">ðŸŽ¯ Case Studies</option>
                                <option value="ðŸ’¡">ðŸ’¡ Workshops</option>
                                <option value="ðŸŽ¬">ðŸŽ¬ Demos</option>
                            </optgroup>
                            <optgroup label="âš¡ Other">
                                <option value="âš¡">âš¡ Other</option>
                                <option value="ðŸŒŸ">ðŸŒŸ Special</option>
                                <option value="ðŸš€">ðŸš€ Launch</option>
                                <option value="ðŸ”¥">ðŸ”¥ Trending</option>
                                <option value="âœ¨">âœ¨ Premium</option>
                                <option value="ðŸŽ‰">ðŸŽ‰ Promotion</option>
                                <option value="ðŸ†">ðŸ† Awards</option>
                                <option value="ðŸ’«">ðŸ’« Viral</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Initial Budget ($)</label>
                            <input type="number" id="channel_budget" required step="100" min="0" value="5000"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Status</label>
                            <select id="channel_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="Active">Active</option>
                                <option value="Planning">Planning</option>
                                <option value="Paused">Paused</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Login/Dashboard URL (Optional)</label>
                        <input type="url" id="channel_url" placeholder="https://ads.example.com"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            Link to the platform's ad dashboard for quick access
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                                padding: 16px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">ðŸ“Š Initial Metrics (Optional)</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">Current Spend</label>
                                <input type="number" id="channel_spent" step="10" min="0" value="0"
                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--glass-border); 
                                       border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">Leads Generated</label>
                                <input type="number" id="channel_leads" min="0" value="0"
                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--glass-border); 
                                       border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">Conversions</label>
                                <input type="number" id="channel_conversions" min="0" value="0"
                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--glass-border); 
                                       border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">ROI Multiplier</label>
                                <input type="number" id="channel_roi" step="0.1" min="0" value="2.0"
                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--glass-border); 
                                       border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="margin-top: 8px; padding: 14px; font-size: 16px;">
                        âž• Add Marketing Channel
                    </button>
                </form>
            `;
            showModal('Add New Marketing Channel', formHTML);
        }
        
        function handleAddMarketingChannel(event) {
            event.preventDefault();
            
            const name = document.getElementById('channel_name').value;
            const budget = parseFloat(document.getElementById('channel_budget').value);
            const spent = parseFloat(document.getElementById('channel_spent').value || 0);
            const leads = parseInt(document.getElementById('channel_leads').value || 0);
            const conversions = parseInt(document.getElementById('channel_conversions').value || 0);
            const roi = parseFloat(document.getElementById('channel_roi').value);
            
            const newChannel = {
                id: Math.max(...appState.data.marketingChannels.map(c => c.id), 0) + 1,
                name: name,
                icon: document.getElementById('channel_icon').value || 'ðŸ“±',
                budget: budget,
                spent: spent,
                leads: leads,
                conversions: conversions,
                roi: roi,
                cpl: leads > 0 ? (spent / leads).toFixed(2) : 0,
                status: document.getElementById('channel_status').value,
                enabled: true,
                loginUrl: document.getElementById('channel_url').value || '',
                impressions: 0,
                clicks: 0,
                ctr: 0
            };
            
            appState.data.marketingChannels.push(newChannel);
            
            // Log activity
            addRecentActivity('create', `New Marketing Channel Added: ${newChannel.name}`, 
                `Budget: $${budget.toLocaleString()} â€¢ Status: ${newChannel.status}`, 'info');
            
            if (saveData()) {
                closeModal();
                showToast(`âœ… ${newChannel.name} added successfully!`, 'success');
                switchSection('marketing');
            }
        }

        function drilldownMarketingChannel(channelId) {
            const channel = appState.data.marketingChannels.find(c => c.id === channelId);
            if (!channel) return;
            
            const conversionRate = ((channel.conversions / channel.leads) * 100).toFixed(1);
            const costPerConversion = (channel.spent / channel.conversions).toFixed(2);
            const ctr = channel.ctr || ((channel.clicks / channel.impressions) * 100).toFixed(2);
            
            const content = `
                <div style="display: grid; gap: 20px;">
                    <!-- Header Section -->
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); padding: 24px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">${channel.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">${channel.name}</div>
                        <span class="badge badge-${channel.status === 'Active' ? 'success' : 'warning'}" style="font-size: 14px;">${channel.status}</span>
                        ${channel.loginUrl ? `<div style="margin-top: 16px;"><a href="${channel.loginUrl}" target="_blank" 
                            style="display: inline-block; padding: 12px 24px; background: var(--accent-primary); color: var(--bg-primary); border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s;">
                            ðŸ”— Open ${channel.name} Dashboard
                        </a></div>` : ''}
                    </div>
                    
                    <!-- Main Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">BUDGET</div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-primary);" contenteditable="true" 
                                 onblur="updateChannelField(${channelId}, 'budget', this.textContent.replace('$', '').replace(',', ''))" 
                                 style="cursor: text;">$${channel.budget.toLocaleString()}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">SPENT</div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--accent-tertiary);" contenteditable="true" 
                                 onblur="updateChannelField(${channelId}, 'spent', this.textContent.replace('$', '').replace(',', ''))" 
                                 style="cursor: text;">$${channel.spent.toLocaleString()}</div>
                        </div>
                        <div style="background: var(--bg-glass); padding: 16px; border-radius: 10px; border: 1px solid var(--glass-border);">
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">REMAINING</div>
                            <div style="font-size: 24px; font-weight: 800; color: var(--success);">$${(channel.budget - channel.spent).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--accent-primary);">ðŸ“Š Performance Metrics (Click to Edit)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Impressions</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--text-primary);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'impressions', this.textContent.replace(',', ''))" 
                                     style="cursor: text;">${channel.impressions?.toLocaleString() || '0'}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Clicks</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--text-primary);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'clicks', this.textContent.replace(',', ''))" 
                                     style="cursor: text;">${channel.clicks?.toLocaleString() || '0'}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">CTR</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--accent-tertiary);">${ctr}%</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Leads</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--accent-primary);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'leads', this.textContent)" 
                                     style="cursor: text;">${channel.leads}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Conversions</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--accent-gold);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'conversions', this.textContent)" 
                                     style="cursor: text;">${channel.conversions}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Conversion Rate</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--success);">${conversionRate}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ROI & Cost Analysis -->
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--accent-primary);">ðŸ’° ROI & Cost Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">ROI</div>
                                <div style="font-size: 28px; font-weight: 800; color: var(--success);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'roi', this.textContent.replace('x', ''))" 
                                     style="cursor: text;">${channel.roi}x</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Cost per Lead</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--accent-primary);" contenteditable="true" 
                                     onblur="updateChannelField(${channelId}, 'cpl', this.textContent.replace('$', ''))" 
                                     style="cursor: text;">$${channel.cpl}</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Cost per Conversion</div>
                                <div style="font-size: 22px; font-weight: 700; color: var(--warning);">$${costPerConversion}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <button onclick="closeModal()" class="btn-secondary" style="padding: 14px; font-size: 14px; font-weight: 600;">
                            Close
                        </button>
                        <button onclick="toggleMarketingChannel(${channelId}); closeModal(); setTimeout(() => drilldownMarketingChannel(${channelId}), 500);" 
                                class="btn-secondary" style="padding: 14px; font-size: 14px; font-weight: 600; background: ${channel.enabled ? 'var(--warning)' : 'var(--success)'};">
                            ${channel.enabled ? 'â¸ï¸ Disable' : 'â–¶ï¸ Enable'}
                        </button>
                        <button onclick="saveChannelChanges(${channelId})" class="btn-primary" style="padding: 14px; font-size: 14px; font-weight: 600;">
                            ðŸ’¾ Save
                        </button>
                        <button onclick="deleteMarketingChannel(${channelId})" class="btn-secondary" style="padding: 14px; font-size: 14px; font-weight: 600; background: var(--danger);">
                            ðŸ—‘ï¸ Delete
                        </button>
                    </div>
                </div>
            `;
            
            showModal(`${channel.name} - Comprehensive Analytics`, content, '800px');
        }

        // Update individual channel fields
        function updateChannelField(channelId, field, value) {
            const channel = appState.data.marketingChannels.find(c => c.id === channelId);
            if (!channel) return;
            
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                channel[field] = numValue;
                // Recalculate dependent values
                if (field === 'impressions' || field === 'clicks') {
                    channel.ctr = ((channel.clicks / channel.impressions) * 100).toFixed(2);
                }
            }
        }

        // Save all channel changes
        function saveChannelChanges(channelId) {
            saveData();
            closeModal();
            showToast('âœ… Channel analytics updated successfully!', 'success');
            switchSection('marketing');
        }

        // Enhanced Vendor Management with drilldown
        function drilldownVendor(vendorId) {
            const vendor = appState.data.vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            const content = `
                <div style="display: grid; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">${vendor.name}</div>
                        
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Type:</span>
                                <span class="badge badge-info">${vendor.type}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Contact:</span>
                                <span style="color: var(--accent-primary);">${vendor.contact}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Cost:</span>
                                <span style="color: var(--accent-gold); font-size: 18px;">$${vendor.cost.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Contract:</span>
                                <span>${vendor.contract}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Renewal Date:</span>
                                <span style="color: var(--warning);">${vendor.renewal}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="font-weight: 600;">Status:</span>
                                <span class="badge badge-success">${vendor.status}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                            <button class="btn-primary" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`Vendor Details - ${vendor.name}`, content);
        }

        // Enhanced Alerts with enable/disable
        function toggleAlert(alertId) {
            const alert = appState.data.alerts.find(a => a.id === alertId);
            if (alert) {
                alert.enabled = !alert.enabled;
                saveData();
                showToast(alert.enabled ? 'Alert enabled' : 'Alert disabled');
                switchSection('alerts');
            }
        }

        // Enhanced Notes with editing
        function editNote(noteId) {
            const note = appState.data.notes.find(n => n.id === noteId);
            if (!note) return;
            
            const formHTML = `
                <form onsubmit="handleNoteEdit(event, ${noteId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Title</label>
                        <input type="text" id="edit_note_title" required value="${note.title}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Content</label>
                        <textarea id="edit_note_content" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 150px;">${note.content}</textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Category</label>
                        <select id="edit_note_category" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <option value="Meeting" ${note.category === 'Meeting' ? 'selected' : ''}>Meeting</option>
                            <option value="Idea" ${note.category === 'Idea' ? 'selected' : ''}>Idea</option>
                            <option value="Strategy" ${note.category === 'Strategy' ? 'selected' : ''}>Strategy</option>
                            <option value="General" ${note.category === 'General' ? 'selected' : ''}>General</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Note</button>
                </form>
            `;
            showModal('Edit Note', formHTML);
        }

        function handleNoteEdit(event, noteId) {
            event.preventDefault();
            const note = appState.data.notes.find(n => n.id === noteId);
            if (note) {
                note.title = document.getElementById('edit_note_title').value;
                note.content = document.getElementById('edit_note_content').value;
                note.category = document.getElementById('edit_note_category').value;
                note.updated = new Date().toISOString();
                saveData();
                closeModal();
                showToast('Note updated successfully!');
                switchSection('notes');
            }
        }

        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                appState.data.notes = appState.data.notes.filter(n => n.id !== noteId);
                saveData();
                showToast('Note deleted successfully!');
                switchSection('notes');
            }
        }

        // Enhanced Events with editing
        function editEvent(eventId) {
            const event = appState.data.events.find(e => e.id === eventId);
            if (!event) return;
            
            const formHTML = `
                <form onsubmit="handleEventEdit(event, ${eventId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Event Title</label>
                        <input type="text" id="edit_event_title" required value="${event.title}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Date</label>
                            <input type="date" id="edit_event_date" required value="${event.date}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Time</label>
                            <input type="time" id="edit_event_time" required value="${event.time}"
                                   style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Type</label>
                        <select id="edit_event_type" required
                                style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                            <option value="Meeting" ${event.type === 'Meeting' ? 'selected' : ''}>Meeting</option>
                            <option value="Call" ${event.type === 'Call' ? 'selected' : ''}>Call</option>
                            <option value="Deadline" ${event.type === 'Deadline' ? 'selected' : ''}>Deadline</option>
                            <option value="Review" ${event.type === 'Review' ? 'selected' : ''}>Review</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Location</label>
                        <input type="text" id="edit_event_location" value="${event.location || ''}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Event</button>
                </form>
            `;
            showModal('Edit Event', formHTML);
        }

        function handleEventEdit(e, eventId) {
            e.preventDefault();
            const event = appState.data.events.find(ev => ev.id === eventId);
            if (event) {
                event.title = document.getElementById('edit_event_title').value;
                event.date = document.getElementById('edit_event_date').value;
                event.time = document.getElementById('edit_event_time').value;
                event.type = document.getElementById('edit_event_type').value;
                event.location = document.getElementById('edit_event_location').value;
                
                // Log activity
                addRecentActivity('event', `Updated event: ${event.title}`, `${event.date} at ${event.time} â€¢ ${event.location || 'No location'}`, 'info');
                
                saveData();
                closeModal();
                showToast('Event updated successfully!');
                switchSection('calendar');
            }
        }

        // Enhanced Task Management with editable tiles
        function editTask(taskId) {
            const task = appState.data.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const formHTML = `
                <form onsubmit="handleTaskEdit(event, ${taskId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Task Title</label>
                        <input type="text" id="edit_task_title" required value="${task.title}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Description</label>
                        <textarea id="edit_task_description" 
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px; min-height: 100px;">${task.description}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Status</label>
                            <select id="edit_task_status" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="To Do" ${task.status === 'To Do' ? 'selected' : ''}>To Do</option>
                                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Priority</label>
                            <select id="edit_task_priority" required
                                    style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                    border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                                <option value="High" ${task.priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Medium" ${task.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Low" ${task.priority === 'Low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Due Date</label>
                        <input type="date" id="edit_task_dueDate" required value="${task.dueDate}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Progress (%)</label>
                        <input type="number" id="edit_task_progress" required min="0" max="100" value="${task.progress}"
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 16px;">Update Task</button>
                </form>
            `;
            showModal('Edit Task', formHTML);
        }

        function handleTaskEdit(e, taskId) {
            e.preventDefault();
            const task = appState.data.tasks.find(t => t.id === taskId);
            if (task) {
                task.title = document.getElementById('edit_task_title').value;
                task.description = document.getElementById('edit_task_description').value;
                task.status = document.getElementById('edit_task_status').value;
                task.priority = document.getElementById('edit_task_priority').value;
                task.dueDate = document.getElementById('edit_task_dueDate').value;
                task.progress = parseInt(document.getElementById('edit_task_progress').value);
                saveData();
                closeModal();
                showToast('Task updated successfully!');
                switchSection('tasks');
            }
        }

        function deleteTask(taskId) {
            const task = appState.data.tasks.find(t => t.id === taskId);
            if (confirm('Are you sure you want to delete this task?')) {
                // Log activity before deletion
                if (task) {
                    addRecentActivity('delete', `Deleted task: ${task.title}`, `${task.priority} priority â€¢ ${task.status}`, 'info');
                }
                appState.data.tasks = appState.data.tasks.filter(t => t.id !== taskId);
                saveData();
                showToast('Task deleted successfully!');
                switchSection('tasks');
            }
        }

        function drilldownTask(taskId) {
            const task = appState.data.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const content = `
                <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">${task.title}</div>
                    <div style="color: var(--text-secondary); margin-bottom: 20px;">${task.description}</div>
                    
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-weight: 600;">Status:</span>
                            <span class="badge badge-info">${task.status}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-weight: 600;">Priority:</span>
                            <span class="badge badge-${task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'success'}">${task.priority}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-weight: 600;">Assignee:</span>
                            <span>${task.assignee}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-weight: 600;">Due Date:</span>
                            <span style="color: var(--warning);">${task.dueDate}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-weight: 600;">Progress:</span>
                            <span style="color: var(--accent-primary); font-weight: 700;">${task.progress}%</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border); display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="editTask(${task.id})">Edit Task</button>
                        <button class="btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            showModal(`Task Details - ${task.title}`, content);
        }

        // Enhanced Team with comprehensive details
        function viewTeamMemberDetails(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const reportsToMember = member.reportsTo ? appState.data.team.find(m => m.id === member.reportsTo) : null;
            
            const content = `
                <div style="display: grid; gap: 20px;">
                    <div style="background: var(--bg-glass); padding: 24px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 12px;">${member.avatar}</div>
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${member.name}</div>
                        <div style="font-size: 18px; color: var(--accent-primary); margin-bottom: 4px;">${member.role}</div>
                        <div style="font-size: 14px; color: var(--text-muted);">${member.department}</div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Contact Information</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Email:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--accent-tertiary);">${member.email}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'email', '${member.email}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Phone:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.phone}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'phone', '${member.phone}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Location:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.location}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'location', '${member.location}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Timezone:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.timezone}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'timezone', '${member.timezone}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Employment Details</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Hire Date:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.hireDate}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'hireDate', '${member.hireDate}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Salary:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--accent-gold); font-weight: 700;">$${member.salary.toLocaleString()}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'salary', ${member.salary})" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Reports To:</span>
                                <span>${reportsToMember ? reportsToMember.name : 'Board of Directors'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Status:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="badge badge-success">${member.status}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'status', '${member.status}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Years of Experience:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.yearsExperience} years</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'yearsExperience', ${member.yearsExperience})" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Previous Company:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>${member.previousCompany}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'previousCompany', '${member.previousCompany}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Skills & Certifications</div>
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Skills:</div>
                                <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'skills', '${member.skills.join(', ')}')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                            </div>
                            <div style="display: flex; flex-wrap: gap; gap: 8px;">
                                ${member.skills.map(skill => `<span class="badge badge-info">${skill}</span>`).join('')}
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Certifications:</div>
                                <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'certifications', '${member.certifications.join('\n')}')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                            </div>
                            ${member.certifications.map(cert => `<div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">â€¢ ${cert}</div>`).join('')}
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Languages:</div>
                                <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'languages', '${member.languages.join(', ')}')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${member.languages.map(lang => `<span class="badge badge-warning">${lang}</span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Performance & Projects</div>
                        <div style="display: grid; gap: 10px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Performance Score:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--success); font-size: 20px; font-weight: 700;">${member.performance}%</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'performance', ${member.performance})" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">Tasks Completed:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--accent-primary); font-weight: 700;">${member.tasksCompleted}</span>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'tasksCompleted', ${member.tasksCompleted})" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Current Projects:</div>
                                <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'projects', '${member.projects.join('\n')}')" style="padding: 4px 12px; font-size: 12px;">âœï¸ Edit</button>
                            </div>
                            ${member.projects.map(project => `<div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">â€¢ ${project}</div>`).join('')}
                        </div>
                    </div>

                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--accent-primary);">Social Links</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">LinkedIn:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${member.linkedin ? `<a href="https://${member.linkedin}" target="_blank" style="color: var(--accent-tertiary); text-decoration: none;">View Profile â†’</a>` : '<span style="color: var(--text-muted);">Not set</span>'}
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'linkedin', '${member.linkedin || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-weight: 600;">GitHub:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${member.github ? `<a href="https://${member.github}" target="_blank" style="color: var(--accent-tertiary); text-decoration: none;">View Profile â†’</a>` : '<span style="color: var(--text-muted);">Not set</span>'}
                                    <button class="btn-secondary" onclick="event.stopPropagation(); editTeamMemberField(${memberId}, 'github', '${member.github || ''}')" style="padding: 2px 8px; font-size: 11px;">âœï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 20px; border-top: 1px solid var(--glass-border);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <button class="btn-secondary" onclick="closeModal(); sendEmailToTeamMember(${memberId});" style="background: var(--accent-tertiary);">
                                ðŸ“§ Send Email
                            </button>
                            <button class="btn-secondary" onclick="closeModal(); showTeamCommunicationChoice(${memberId});" style="background: var(--accent-secondary);">
                                ðŸ“ž Contact
                            </button>
                            <button class="btn-primary" onclick="closeModal(); setTimeout(() => editTeamMember(${memberId}), 100);">
                                âœï¸ Edit Profile
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-secondary" onclick="deleteTeamMemberFromProfile(${memberId})" style="flex: 1; background: var(--danger);">ðŸ—‘ï¸ Delete Profile</button>
                            <button class="btn-secondary" onclick="closeModal()" style="flex: 1;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`Team Member Profile - ${member.name}`, content);
        }

        function deleteTeamMemberFromProfile(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const confirmMessage = `Are you sure you want to delete ${member.name}'s profile?\n\nThis will permanently remove:\n- All personal information\n- Employment records\n- Performance data\n- Project assignments\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                const memberName = member.name;
                const memberRole = member.role;
                
                // Remove the team member
                appState.data.team = appState.data.team.filter(m => m.id !== memberId);
                
                // Add to recent activity
                addRecentActivity('team_deleted', `Deleted team member: ${memberName} (${memberRole})`, 'danger');
                
                saveData();
                closeModal();
                showToast(`ðŸ—‘ï¸ ${memberName}'s profile has been permanently deleted`, 'error');
                switchSection('team');
            }
        }

        // SEND EMAIL TO TEAM MEMBER
        function sendEmailToTeamMember(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            appState.currentEmailTeamMember = member;
            
            const emailFormHTML = `
                <form onsubmit="handleSendEmailToTeamMember(event, ${memberId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="font-size: 32px;">${member.avatar || 'ðŸ‘¤'}</div>
                            <div>
                                <div style="font-weight: 700;">${member.name}</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">${member.role} â€¢ ${member.department}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--accent-tertiary);">
                            <span>ðŸ“§</span>
                            <span style="font-weight: 600;">${member.email}</span>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">From:</label>
                        <input type="email" id="email_from_team" value="admin@virely.com" required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Subject:</label>
                        <input type="text" id="email_subject_team" placeholder="Email subject..." required
                               style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                               border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Message:</label>
                        <textarea id="email_message_team" rows="8" placeholder="Type your message..." required
                                  style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(110,231,183,0.1), rgba(124,92,255,0.1)); 
                                padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">QUICK TEMPLATES:</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn-secondary" onclick="applyTeamEmailTemplate('meeting')" 
                                    style="padding: 6px 12px; font-size: 12px;">Team Meeting</button>
                            <button type="button" class="btn-secondary" onclick="applyTeamEmailTemplate('update')" 
                                    style="padding: 6px 12px; font-size: 12px;">Project Update</button>
                            <button type="button" class="btn-secondary" onclick="applyTeamEmailTemplate('recognition')" 
                                    style="padding: 6px 12px; font-size: 12px;">Recognition</button>
                            <button type="button" class="btn-secondary" onclick="applyTeamEmailTemplate('feedback')" 
                                    style="padding: 6px 12px; font-size: 12px;">Feedback Request</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2; background: var(--accent-tertiary);">
                            ðŸ“§ Send Email
                        </button>
                    </div>
                </form>
            `;
            
            showModal('Send Email to Team Member', emailFormHTML);
        }

        function applyTeamEmailTemplate(template) {
            const member = appState.currentEmailTeamMember;
            const firstName = member ? member.name.split(' ')[0] : 'there';
            const templates = {
                meeting: {
                    subject: `Team Meeting - ${new Date().toLocaleDateString()}`,
                    message: `Hi ${firstName},\n\nI'd like to schedule a team meeting to discuss:\n\nâ€¢ [Topic 1]\nâ€¢ [Topic 2]\nâ€¢ [Topic 3]\n\nProposed time: [Date/Time]\nLocation: [Meeting Room/Video Link]\n\nPlease let me know if this works for you.\n\nBest regards,\n[Your Name]`
                },
                update: {
                    subject: `Project Update Request`,
                    message: `Hi ${firstName},\n\nCould you please provide an update on the following:\n\nâ€¢ Current project status\nâ€¢ Any blockers or challenges\nâ€¢ Next steps and timeline\n\nThis will help us stay aligned on our goals.\n\nThank you,\n[Your Name]`
                },
                recognition: {
                    subject: `Great Work! ðŸŒŸ`,
                    message: `Hi ${firstName},\n\nI wanted to take a moment to recognize your excellent work on [specific achievement]. Your dedication and effort have made a significant impact on the team.\n\n${member ? member.projects && member.projects.length > 0 ? `Your contributions to ${member.projects[0]} have been outstanding.` : 'Keep up the great work!' : 'Keep up the great work!'}\n\nThank you for your continued excellence!\n\nBest regards,\n[Your Name]`
                },
                feedback: {
                    subject: `Request for Feedback`,
                    message: `Hi ${firstName},\n\nI'd appreciate your feedback on [specific topic/project]. Your insights and perspective would be valuable.\n\nCould you share your thoughts on:\nâ€¢ [Question 1]\nâ€¢ [Question 2]\nâ€¢ [Question 3]\n\nFeel free to schedule a time to discuss if that would be easier.\n\nThank you,\n[Your Name]`
                }
            };
            
            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('email_subject_team').value = selectedTemplate.subject;
                document.getElementById('email_message_team').value = selectedTemplate.message;
            }
        }

        function handleSendEmailToTeamMember(event, memberId) {
            event.preventDefault();
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const emailData = {
                from: document.getElementById('email_from_team').value,
                to: member.email,
                subject: document.getElementById('email_subject_team').value,
                message: document.getElementById('email_message_team').value,
                memberName: member.name,
                memberRole: member.role,
                timestamp: new Date().toISOString()
            };
            
            // Log the email send activity
            addRecentActivity('email', `Email Sent to Team Member`, `Sent email to ${member.name} (${member.role}) - Subject: "${emailData.subject}"`, 'info');
            
            saveData();
            closeModal();
            showToast(`âœ… Email sent to ${member.name}!`, 'success');
            
            // Show confirmation with details
            setTimeout(() => {
                showToast(`ðŸ“§ Check your email client to complete sending`, 'info');
            }, 2000);
        }

        // TEAM COMMUNICATION CHOICE (Call or SMS)
        function showTeamCommunicationChoice(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;

            const choiceHTML = `
                <div style="text-align: center;">
                    <div style="background: var(--bg-glass); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">${member.avatar || 'ðŸ‘¤'}</div>
                        <div style="font-weight: 700; font-size: 20px; margin-bottom: 8px;">${member.name}</div>
                        <div style="color: var(--accent-primary); margin-bottom: 4px; font-size: 16px;">${member.role}</div>
                        <div style="color: var(--text-secondary); margin-bottom: 12px;">${member.department}</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px;">
                            <span style="font-size: 20px;">ðŸ“±</span>
                            <span style="font-weight: 600; color: var(--accent-primary); font-size: 18px;">${member.phone}</span>
                        </div>
                    </div>

                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                        How would you like to contact ${member.name.split(' ')[0]}?
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <button class="btn-primary" onclick="closeModal(); callTeamMember(${memberId});" 
                                style="padding: 20px; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 32px;">ðŸ“ž</span>
                            <span>Call</span>
                        </button>
                        <button class="btn-secondary" onclick="closeModal(); sendSMSToTeamMember(${memberId});" 
                                style="padding: 20px; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--accent-secondary);">
                            <span style="font-size: 32px;">ðŸ’¬</span>
                            <span>Send SMS</span>
                        </button>
                    </div>

                    <button class="btn-secondary" onclick="closeModal();" style="margin-top: 16px; width: 100%;">
                        Cancel
                    </button>
                </div>
            `;

            showModal('Contact Team Member', choiceHTML);
        }

        // CALL TEAM MEMBER
        function callTeamMember(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;

            // Log the call activity
            addRecentActivity('phone', `Call Initiated to Team`, `Called ${member.name} (${member.role}) at ${member.phone}`, 'info');
            
            saveData();
            
            // Attempt to initiate phone call (works on mobile devices)
            window.location.href = `tel:${member.phone}`;
            
            // Show confirmation
            showToast(`ðŸ“ž Calling ${member.name}...`, 'success');
        }

        // SEND SMS TO TEAM MEMBER
        function sendSMSToTeamMember(memberId) {
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            appState.currentSMSTeamMember = member;
            
            const smsFormHTML = `
                <form onsubmit="handleSendSMSToTeamMember(event, ${memberId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="background: var(--bg-glass); padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="font-size: 32px;">${member.avatar || 'ðŸ‘¤'}</div>
                            <div>
                                <div style="font-weight: 700;">${member.name}</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">${member.role} â€¢ ${member.department}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--accent-secondary);">
                            <span>ðŸ“±</span>
                            <span style="font-weight: 600;">${member.phone}</span>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">
                            Message: <span style="font-size: 12px; color: var(--text-muted);" id="sms_char_count_team">0/160 characters</span>
                        </label>
                        <textarea id="sms_message_team" rows="5" placeholder="Type your SMS message..." required
                                  maxlength="160" oninput="updateSMSCharCountTeam()"
                                  style="width: 100%; padding: 12px; background: var(--bg-glass); border: 1px solid var(--glass-border); 
                                  border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            ðŸ’¡ Keep messages under 160 characters for single SMS
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(124,92,255,0.1), rgba(110,231,183,0.1)); 
                                padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">QUICK TEMPLATES:</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn-secondary" onclick="applySMSTeamTemplate('meeting')" 
                                    style="padding: 6px 12px; font-size: 12px;">Meeting Reminder</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTeamTemplate('urgent')" 
                                    style="padding: 6px 12px; font-size: 12px;">Urgent Request</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTeamTemplate('update')" 
                                    style="padding: 6px 12px; font-size: 12px;">Quick Update</button>
                            <button type="button" class="btn-secondary" onclick="applySMSTeamTemplate('thanks')" 
                                    style="padding: 6px 12px; font-size: 12px;">Thank You</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 2; background: var(--accent-secondary);">
                            ðŸ’¬ Send SMS
                        </button>
                    </div>
                </form>
            `;
            
            showModal('Send SMS to Team Member', smsFormHTML);
        }

        function updateSMSCharCountTeam() {
            const textarea = document.getElementById('sms_message_team');
            const counter = document.getElementById('sms_char_count_team');
            if (textarea && counter) {
                counter.textContent = `${textarea.value.length}/160 characters`;
            }
        }

        function applySMSTeamTemplate(template) {
            const member = appState.currentSMSTeamMember;
            const firstName = member ? member.name.split(' ')[0] : 'there';
            const templates = {
                meeting: `Hi ${firstName}, reminder about our meeting at [TIME] today. See you there!`,
                urgent: `Hi ${firstName}, urgent matter - please call me as soon as possible. Thanks!`,
                update: `Hi ${firstName}, quick update: [YOUR MESSAGE]. Let me know if you have questions.`,
                thanks: `Hi ${firstName}, thanks for your great work on [PROJECT]! Really appreciate it.`
            };
            
            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('sms_message_team').value = selectedTemplate;
                updateSMSCharCountTeam();
            }
        }

        function handleSendSMSToTeamMember(event, memberId) {
            event.preventDefault();
            const member = appState.data.team.find(m => m.id === memberId);
            if (!member) return;
            
            const smsData = {
                to: member.phone,
                message: document.getElementById('sms_message_team').value,
                memberName: member.name,
                memberRole: member.role,
                timestamp: new Date().toISOString()
            };
            
            // Log the SMS send activity
            addRecentActivity('sms', `SMS Sent to Team Member`, `Sent SMS to ${member.name} (${member.role})`, 'info');
            
            saveData();
            closeModal();
            showToast(`âœ… SMS sent to ${member.name}!`, 'success');
            
            // Show confirmation with details
            setTimeout(() => {
                showToast(`ðŸ’¬ Message queued for delivery`, 'info');
            }, 2000);
        }


        // Calendar event delegation (backup for onclick)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('calendar-day') || e.target.closest('.calendar-day')) {
                const calendarDay = e.target.classList.contains('calendar-day') ? e.target : e.target.closest('.calendar-day');
                const dateStr = calendarDay.getAttribute('data-date');
                if (dateStr) {
                    showDayEvents(dateStr);
                }
            }
        });
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                init();
                initializeEventListeners();
            });
        } else {
            init();
            initializeEventListeners();
        }
    </script>
</body>
</html>
